#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Пропускаем инициализацию, чтобы гарантировать получение формы при передаче параметра "АвтоТест".
	Если Параметры.Свойство("АвтоТест") Тогда
		
		Возврат;
		
	КонецЕсли;
	
	Если Параметры.Ключ.Пустая() Тогда
		
		УстановитьОтображениеПоляВладелец(ЗначениеЗаполнено(Объект.Владелец));
		СформироватьАвтоНаименование(ЭтаФорма);
		
	КонецЕсли;
	
	БанкНеВыбран = НСтр("ru = '<заполняется автоматически после ввода БИК>'");
	РазделениеВключено = ОбщегоНазначения.РазделениеВключено();
	ОбработатьВыборБанка(ЭтотОбъект, Истина);
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	УстановитьОтображениеПоляВладелец(Истина);
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура НомерСчетаПриИзменении(Элемент)
	
	Объект.НомерСчета = СокрЛП(Объект.НомерСчета);
	
	УстановитьНаименованиеСчета(ЭтотОбъект, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура БИКБанкаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ОткрытьФормуВыбораБанка();
	
КонецПроцедуры

&НаКлиенте
Процедура БИКБанкаОчистка(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	РеквизитыБанка       = Неопределено;
	Объект.Банк          = Неопределено;
	ОбработатьВыборБанка(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура БИКБанкаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Объект.Банк = ВыбранноеЗначение;
	ОбработатьВыборБанка(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура БИКБанкаОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, Параметры, СтандартнаяОбработка)
	
	НайденныйБанк = НайтиБанкВКлассификатореПоБИКу(СокрЛП(Текст));
	Если НайденныйБанк <> Неопределено Тогда
		Объект.Банк = НайденныйБанк;
		ОбработатьВыборБанка(ЭтотОбъект);
	Иначе
		ПредложитьСтандартныйВыбор(СокрЛП(Текст), Элемент.Имя);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура БанкНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ЗначениеЗаполнено(Объект.Банк) Тогда
		ОткрытьФорму("Справочник.КлассификаторБанков.ФормаОбъекта", Новый Структура("Ключ", Объект.Банк), ЭтотОбъект);
	Иначе
		ОткрытьФормуВыбораБанка();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВсеБанки(Команда)
	
	ОткрытьФормуВыбораБанка();
	
КонецПроцедуры

&НаКлиенте
Процедура НайтиБанк(Команда)
	
	НайденныйБанк = НайтиБанкВКлассификатореПоБИКу(СокрЛП(БИКБанка));
	
	Если НайденныйБанк = Неопределено Тогда
		ПредложитьСтандартныйВыбор(СокрЛП(БИКБанка), "БИКБанка");
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Функция НайтиБанкВКлассификатореПоБИКу(ТекстДляПоиска)
	
	Если ПустаяСтрока(ТекстДляПоиска) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	НайденныйБанк = ПолучитьБанкПоБИКу(ТекстДляПоиска);
	Если НайденныйБанк = Неопределено Тогда
		Возврат НайденныйБанк;
	КонецЕсли;
	
	ДеятельностьБанкаПрекращена = НайденныйБанк.ДеятельностьПрекращена;
	
	Возврат НайденныйБанк.Банк;
	
КонецФункции

&НаКлиенте
Процедура ПредложитьСтандартныйВыбор(ТекстДляПоиска, Поле)
	
	ТекстВопроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Банк с БИК ""%1"" не найден в справочнике банков'"), ТекстДляПоиска);
	
	Кнопки = Новый СписокЗначений;
	Кнопки.Добавить("Выбрать",     НСтр("ru = 'Выбрать из списка'"));
	Если НЕ РазделениеВключено Тогда
		Кнопки.Добавить("Создать", НСтр("ru = 'Создать банк'"));
	КонецЕсли;
	Кнопки.Добавить("Продолжить",  НСтр("ru = 'Продолжить ввод'"));
	Кнопки.Добавить("Отменить",    НСтр("ru = 'Отменить ввод'"));
	
	ДополнительныеПараметры   = Новый Структура("Поле, ТекстДляПоиска", Поле, ТекстДляПоиска);
	ОписаниеОповещенияВопрос = Новый ОписаниеОповещения("ПредложитьСтандартныйВыборЗавершение",
		ЭтотОбъект, ДополнительныеПараметры);
	
	ПоказатьВопрос(
		ОписаниеОповещенияВопрос,
		ТекстВопроса,
		Кнопки,,
		"Выбрать",
		НСтр("ru = 'Банк не найден'"));
	
КонецПроцедуры

&НаКлиенте
Процедура ПредложитьСтандартныйВыборЗавершение(Ответ, ДополнительныеПараметры) Экспорт
	
	Если Ответ = "Выбрать" Тогда
		
		ОткрытьФормуВыбораБанка();
		
	ИначеЕсли Ответ = "Создать" Тогда
		
		ПараметрыФормы = Новый Структура("Код, РучноеИзменение", СокрЛП(ДополнительныеПараметры.ТекстДляПоиска), Истина);
		ОткрытьФорму("Справочник.КлассификаторБанков.ФормаОбъекта",
			ПараметрыФормы, ЭтотОбъект,,,,, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	ИначеЕсли Ответ = "Отменить" Тогда
		Если ЗначениеЗаполнено(Объект.Банк) Тогда
			ЭтотОбъект[ДополнительныеПараметры.Поле] = РеквизитыБанка.Код;
		Иначе
			ЭтотОбъект[ДополнительныеПараметры.Поле] = "";
		КонецЕсли;
		
	Иначе
		ТекущийЭлемент = Элементы[ДополнительныеПараметры.Поле];
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеПоляВладелец(Значение)
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"Владелец",
		"ТолькоПросмотр",
		Значение);
		
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция СформироватьАвтоНаименование(Форма, Знач Текст = "")
	
	Элементы	= Форма.Элементы;
	Объект		= Форма.Объект;
	
	Элементы.Наименование.СписокВыбора.Очистить();
	НомерСчетаТекущий = СокрЛП(Объект.НомерСчета);
	
	СтрокаНаименования = "";
	Если ЗначениеЗаполнено(Форма.БИКБанка) Тогда
		СтрокаНаименования = Строка(Форма.БИКБанка);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Форма.Банк) Тогда
		СтрокаНаименования = ?(ПустаяСтрока(СтрокаНаименования), "", СтрокаНаименования + ", ") + СокрЛП(Форма.Банк);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Форма.Объект.НомерСчета) Тогда
		СтрокаНаименования = ?(ПустаяСтрока(СтрокаНаименования), "", СтрокаНаименования + ", ") + СокрЛП(Форма.Объект.НомерСчета);
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(СтрокаНаименования) Тогда
		Элементы.Наименование.СписокВыбора.Добавить(СокрЛП(СтрокаНаименования));
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(Текст) И Элементы.Наименование.СписокВыбора.НайтиПоЗначению(Текст) = Неопределено Тогда
		Элементы.Наименование.СписокВыбора.Добавить(СокрЛП(Текст));
	КонецЕсли;
	
	Возврат СтрокаНаименования;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьБанкПоБИКу(БИК)
	
	Если НЕ ЗначениеЗаполнено(БИК) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("БИК", БИК);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КлассификаторБанков.Ссылка КАК Ссылка,
	|	КлассификаторБанков.ДеятельностьПрекращена
	|ИЗ
	|	Справочник.КлассификаторБанков КАК КлассификаторБанков
	|ГДЕ
	|	КлассификаторБанков.Код = &БИК";
		
	НайденныйБанк = Неопределено;
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		НайденныйБанк = Новый Структура("Банк, ДеятельностьПрекращена", Выборка.Ссылка, Выборка.ДеятельностьПрекращена);
	КонецЕсли;
	
	Возврат НайденныйБанк
	
КонецФункции

&НаКлиенте
Процедура ОткрытьФормуВыбораБанка()
	
	ПараметрыФормы = Новый Структура(
		"ТекущаяСтрока, ПараметрВыборГруппИЭлементов",
		Объект.Банк, ИспользованиеГруппИЭлементов.Элементы);
		
	ОткрытьФорму("Справочник.КлассификаторБанков.ФормаВыбора", ПараметрыФормы, Элементы.БИКБанка);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОбработатьВыборБанка(Форма, ВызватьУправлениеФормой = Истина)
	
	Форма.РеквизитыБанка				= ПолучитьРеквизитыБанка(Форма.Объект.Банк);
	Форма.БИКБанка						= Форма.РеквизитыБанка.Код;
	Форма.ДеятельностьБанкаПрекращена	= Форма.РеквизитыБанка.ДеятельностьПрекращена;
	
	Если ВызватьУправлениеФормой Тогда
		УправлениеФормой(Форма);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеФормой(Форма)
	
	Объект		= Форма.Объект;
	Элементы	= Форма.Элементы;
	
	Если ЗначениеЗаполнено(Объект.Банк) Тогда
		Форма.Банк = Форма.РеквизитыБанка.Наименование + " " + Форма.РеквизитыБанка.Город;
		Элементы.СтраницыБанк.ТекущаяСтраница = Элементы.СтраницаБанк;
	Иначе
		Форма.Банк = "";
		Элементы.СтраницыБанк.ТекущаяСтраница = Элементы.СтраницаБанкНеВыбран;
	КонецЕсли;
	
	УстановитьНаименованиеСчета(Форма);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьНаименованиеСчета(Форма, ИзменениеНомераСчета = Ложь)
	
	Объект = Форма.Объект;
	
	Если ПустаяСтрока(Объект.Наименование) ИЛИ Объект.Наименование = Форма.АвтоНаименование Тогда
		Форма.АвтоНаименование  = СформироватьАвтоНаименование(Форма);
		Если НЕ ПустаяСтрока(Форма.АвтоНаименование) И Форма.АвтоНаименование <> Объект.Наименование Тогда
			Объект.Наименование = Форма.АвтоНаименование;
		КонецЕсли;
	Иначе
		Если ИзменениеНомераСчета И НЕ ПустаяСтрока(Форма.НомерСчетаТекущий) Тогда
			Объект.Наименование = СтрЗаменить(Объект.Наименование, Форма.НомерСчетаТекущий, СокрЛП(Объект.НомерСчета));
		КонецЕсли;
		
		Форма.АвтоНаименование = СформироватьАвтоНаименование(Форма, Объект.Наименование);
	КонецЕсли;
	
	Форма.НомерСчетаТекущий = СокрЛП(Объект.НомерСчета);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьРеквизитыБанка(Знач Банк)
	
	СтрокаРеквизитов    = Новый Структура("Код, Наименование, Город, ДеятельностьПрекращена");
	СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Банк, СтрокаРеквизитов);
	
	Возврат СтруктураРеквизитов;
	
КонецФункции

#КонецОбласти

