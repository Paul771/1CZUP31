
////////////////////////////////////////////////////////////////////////////////
// ОбменСБанкамиСлужебный: механизм обмена электронными документами с банками.
//
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

// Получает данные сертификата в двоичном формате
//
// Параметры:
//  ДвоичныеДанныеСертификата - ДвоичныеДанные - двоичные данные файла сертификата в формате PEM.
// 
// Возвращаемое значение:
//    ДвоичныеДанные - данные сертификата в двоичном формате;
//    Неопределено - не удалось прочитать данные сертификата.
//
Функция ДанныеСертификатаВФорматеDER(Знач ДвоичныеДанныеСертификата) Экспорт
	
	Попытка
		// Проверка, что сертификат не в DER - формате
		ТекСертификат = Новый СертификатКриптографии(ДвоичныеДанныеСертификата);
		ВозвращаемоеЗначение = ДвоичныеДанныеСертификата;
	Исключение
		ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеСертификата);
		СтрокаBase64 = ЧтениеДанных.ПрочитатьСимволы();
		СтрокаBase64 = СтрЗаменить(СтрокаBase64, "-----BEGIN CERTIFICATE-----" + Символы.ПС,""); 
		СтрокаBase64 = СтрЗаменить(СтрокаBase64, Символы.ПС + "-----END CERTIFICATE-----","");
		Попытка
			ВозвращаемоеЗначение = Base64Значение(СтрокаBase64);
		Исключение
			ВозвращаемоеЗначение = Неопределено;
			ТекстСообщения = НСтр("ru = 'Возникла ошибка при чтении данных сертификата.'");
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ВидОперации = НСтр("ru = 'Чтение настроек обмена с банком.'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробноеПредставлениеОшибки, , "ОбменСБанками");
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
	КонецПопытки;

	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Выполняет последовательность действий для электронных документов.
//
// Параметры:
//  Параметры - Структура - параметры обработки электронных документов, содержит поля:
//   * МассивСсылокНаОбъект - Массив - содержит ссылки на документы, которые необходимо обработать;
//   * МассивОтпечатковСертификатов - Массив - отпечатки доступных сертификатов на клиенте;
//   * Действия - Строка - последовательность необходимых действий с электронным документом;
//   * СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками - ссылка сообщение обмена, который нужно обработать;
//   * СессииОбменСБанками - Соответствие - существующие сессии обмена со Сбербанком
//                         - Неопределено - нет установленных сессий.
//
// Возвращаемое значение:
//  Структура - содержит следующие поля:
//    * ОтправленныеДокументы - Массив - документы-владельцы отправленных электронных документов;
//    * МассивНовыхСообщенийОбмена - Массив - содержит ссылки на сформированные электронные документы для их открытия на клиенте;
//    * КоличествоНовыхЭД - Число - количество сформированных электронных документов;
//    * КолПодготовленных - Число - количество подготовленных электронных документов;
//    * КолОтправленных - Число - количество отправленных электронных документов;
//    * СоотвСертификатовИИхСтруктур - Соответствие - содержит данные сертификатов с сохраненными паролями
//         ** Ключ - СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования - ссылка на элемент справочника сертификатов
//         ** Значение -Структура - данные сертификата, содержит следующие поля:
//           *** Пароль - Строка - пароль сертификата
//           *** ПарольПолучен - Булево - признак, что пароль сохранен и информационной базе
//    * СертификатыСообщенийОбмена - Структура - содержит сертификаты и сообщения, сгруппированные для подписания
//    * СоотвНастроекОбменаИСертификатовАвторизации - Соответствие - содержит настройки обмена с аутентификацией по сертификату, где
//            ** Ключ - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена
//            ** Значение - Массив - содержит ссылки на сертификаты аутентификации
//    * СтруктураКОтправке - Структура - содержит поля:
//      ** БезПодписи - Массив - сообщения обмена, которые не требуется подписывать;
//      ** СПодписью - Массив -   сообщения обмена, которые требуется подписать;
//      ** САвторизациейЛогинПароль - Соответствие - (ключ - НастройкаОбмена, значение - МассивСообщенийОбмена к отправке).
//      ** ЧерезТокенСбербанка - Массив - содержит ссылки на сообщения обмена, которые нужно отправить
//      ** БазоваяАутентификацияСбербанка - Соответствие - данные для отправки по логину и паролю.
//      ** ЧерезВК - Соответствие - данные для отправки через внешнюю компоненту.
//      ** САутентификациейПоСертификату - Соответствие - данные для отправки через внешнюю компоненту.
//  Неопределено - при выполнении процедуры произошла ошибка.
//
Функция ОбработатьЭлектронныеДокументы(Параметры, АдресРезультата) Экспорт
	
	МассивСсылокНаОбъект = Параметры.МассивСсылокНаОбъект;
	МассивОтпечатковСертификатов = Параметры.МассивОтпечатковСертификатов;
	Действия = Параметры.Действия;
	СообщениеОбмена = Параметры.СообщениеОбмена;
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ОтправленныеДокументы", Новый Массив); // документы-владельцы отправленных электронных документов.
	СтруктураВозврата.Вставить("МассивНовыхСообщенийОбмена", Новый Массив); // эти ЭД будут открыты на клиенте
	СтруктураВозврата.Вставить("КоличествоНовыхЭД", 0); // количество сформированных электронных документов.
	СоотвНастроекОбменаИСертификатовАвторизации = Новый Соответствие;
	СтруктураВозврата.Вставить("СоотвНастроекОбменаИСертификатовАвторизации", СоотвНастроекОбменаИСертификатовАвторизации);
	
	СтруктураВозврата.Вставить("КолОтправленных", 0);
	СтруктураВозврата.Вставить("КолПодготовленных", 0);
	СтруктураВозврата.Вставить("НастройкиСЖурналированием", Новый Соответствие);
	СтруктураКОтправке = Новый Структура;
	СтруктураВозврата.Вставить("СтруктураКОтправке", СтруктураКОтправке);

	СтруктураКОтправке.Вставить("БезПодписи", Новый Массив);
	СтруктураКОтправке.Вставить("СПодписью", Новый Массив);
	СтруктураКОтправке.Вставить("САвторизациейЛогинПароль", Новый Соответствие);
	СтруктураКОтправке.Вставить("ЧерезТокенСбербанка", Новый Массив);
	СтруктураКОтправке.Вставить("БазоваяАутентификацияСбербанка", Новый Соответствие);
	СтруктураКОтправке.Вставить("ЧерезВК", Новый Соответствие);
	СтруктураКОтправке.Вставить("ЧерезДополнительнуюОбработку", Новый Соответствие);
	СтруктураКОтправке.Вставить("САутентификациейПоСертификату", Новый Соответствие);
	
	СертификатыСообщенийОбмена = Новый Структура;
	СтруктураВозврата.Вставить("СертификатыСообщенийОбмена", СертификатыСообщенийОбмена);
	
	СоотвСертификатовИИхСтруктур = Новый Соответствие;
	СтруктураВозврата.Вставить("СоотвСертификатовИИхСтруктур", СоотвСертификатовИИхСтруктур);
	
	Если НЕ ОбменСБанкамиСлужебныйВызовСервера.ПравоВыполненияОбмена(Истина) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если НЕ ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ЗначениеФункциональнойОпции("ИспользоватьОбменСБанками") Тогда
		ТекстСообщения = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ТекстСообщенияОНеобходимостиНастройкиСистемы(
			"РАБОТАСБАНКАМИ");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	ВыполнятьКриптооперацииНаСервере = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ВыполнятьКриптооперацииНаСервере();
	
	МассивОтпечатков = Новый Массив;
	МассивОтпечатковКлиент = Новый Массив;
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивОтпечатковКлиент, МассивОтпечатковСертификатов);
	
	Если ЭлектронноеВзаимодействиеКлиентСервер.ЕстьДействие(Действия, "Подписать")
		ИЛИ ЭлектронноеВзаимодействиеКлиентСервер.ЕстьДействие(Действия, "Отправить") Тогда
		
		Если ВыполнятьКриптооперацииНаСервере Тогда
			Попытка
				МассивОтпечатковСертификатовНаСервере = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.МассивОтпечатковСертификатов();
			Исключение
				МассивОтпечатковСертификатовНаСервере = Новый Массив;
			КонецПопытки;
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
				МассивОтпечатковСертификатов, МассивОтпечатковСертификатовНаСервере, Истина);
		КонецЕсли;
		
		ТаблицаДоступныхСертификатов = ТаблицаДоступныхДляПодписиСертификатов(МассивОтпечатковСертификатов);

		МассивОтпечатков = ТаблицаДоступныхСертификатов.ВыгрузитьКолонку("Отпечаток");

	КонецЕсли;
	
	Если ТипЗнч(СообщениеОбмена) <> Тип("Массив")
		И НЕ (ЗначениеЗаполнено(СообщениеОбмена) И (СообщениеОбмена.Направление = Перечисления.НаправленияЭД.Входящий)) Тогда
		ЭлектронноеВзаимодействиеПереопределяемый.ПроверитьГотовностьИсточников(МассивСсылокНаОбъект);
	КонецЕсли;
	
	Если ТипЗнч(СообщениеОбмена) <> Тип("Массив") И МассивСсылокНаОбъект.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	МассивНеобрабатываемыхОбъектов = Новый Массив;
	
	// Формирование ЭД:
	
	Если СообщениеОбмена = Неопределено И ЭлектронноеВзаимодействиеКлиентСервер.ЕстьДействие(Действия, "Сформировать") Тогда
		Если Действия = "Сформировать" ИЛИ Действия = "СформироватьПоказать" Тогда
			УдалитьНедоступныеДляФормированияЭДОбъекты(МассивСсылокНаОбъект);
		КонецЕсли;
		
		НастройкиОбъектов = Новый Соответствие;
		Для Сч = -МассивСсылокНаОбъект.Количество() + 1 По 0 Цикл
			СсылкаНаОбъект = МассивСсылокНаОбъект[-Сч];
			
			НастройкиОбмена = ОпределитьНастройкиОбменаЭДПоИсточнику(СсылкаНаОбъект, Истина, Неопределено);
			Если НЕ ЗначениеЗаполнено(НастройкиОбмена) Тогда
				МассивСсылокНаОбъект.Удалить(-Сч);
			Иначе
				НастройкиОбъектов.Вставить(СсылкаНаОбъект, НастройкиОбмена);
			КонецЕсли;
		КонецЦикла;
		Если МассивСсылокНаОбъект.Количество() = 0 Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		ТекстЗапросаСоздатьЭД =
		"ВЫБРАТЬ
		|	МассивСсылок.ОбъектСсылка
		|ПОМЕСТИТЬ МассивСсылок
		|ИЗ
		|	&МассивСсылок КАК МассивСсылок
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	МассивСсылок.ОбъектСсылка КАК ВладелецЭД
		|ИЗ
		|	МассивСсылок КАК МассивСсылок
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияОбменСБанками КАК СостоянияЭД
		|		ПО МассивСсылок.ОбъектСсылка = СостоянияЭД.СсылкаНаОбъект";
		
		Если Действия = "СформироватьПодписатьОтправить" Тогда
			ОпределитьНеобрабатываемыеОбъекты(НастройкиОбъектов, МассивНеобрабатываемыхОбъектов);
			ТекстЗапросаСоздатьЭД = ТекстЗапросаСоздатьЭД + " ГДЕ
			|СостоянияЭД.СсылкаНаОбъект ЕСТЬ NULL 
			|ИЛИ (СостоянияЭД.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОбменСБанками.НеСформирован)
			|		ИЛИ СостоянияЭД.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОбменСБанками.Отклонен)
			|		ИЛИ СостоянияЭД.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОбменСБанками.ОшибкаПередачи))";
		КонецЕсли;
		Запрос.Текст = ТекстЗапросаСоздатьЭД;
		Измерение = Метаданные.РегистрыСведений.СостоянияОбменСБанками.Измерения.Найти("СсылкаНаОбъект");
		ТЗ_Ссылки = Новый ТаблицаЗначений;
		КолонкаТЗ = ТЗ_Ссылки.Колонки.Добавить("ОбъектСсылка", Измерение.Тип);
		Для Каждого Элемент Из МассивСсылокНаОбъект Цикл
			Строка = ТЗ_Ссылки.Добавить();
			Строка.ОбъектСсылка = Элемент;
		КонецЦикла;
		Запрос.УстановитьПараметр("МассивСсылок", ТЗ_Ссылки);
		ТЗ_ЭД = Запрос.Выполнить().Выгрузить();
		
		Если ТЗ_ЭД.Количество() > 0 Тогда
			МассивОбъектов = ТЗ_ЭД.ВыгрузитьКолонку("ВладелецЭД");
			МассивНовыхСообщенийОбмена = СформироватьСообщенияОбмена(МассивОбъектов, НастройкиОбъектов);
			СтруктураВозврата.КоличествоНовыхЭД = МассивНовыхСообщенийОбмена.Количество();
		КонецЕсли;
		Если Действия = "Сформировать" ИЛИ Действия = "СформироватьПоказать" Тогда
			СтруктураВозврата.Вставить("МассивНовыхСообщенийОбмена", МассивНовыхСообщенийОбмена);
		КонецЕсли;
	КонецЕсли;

	Запрос = Новый Запрос;
	
	// Формирование временных таблиц - обрабатываемых сообщений обмена, сформированные ВТ используются далее на всех этапах:
	Если ЗначениеЗаполнено(СообщениеОбмена) Тогда
		ТекстОсновногоЗапроса =
			"ВЫБРАТЬ
			|	СообщенияОбмена.Ссылка,
			|	СообщенияОбмена.ВидЭД,
			|	СообщенияОбмена.Банк,
			|	СообщенияОбмена.Направление,
			|	СообщенияОбмена.Организация,
			|	СообщенияОбмена.НастройкаОбмена,
			|	СообщенияОбмена.СообщениеРодитель,
			|	СообщенияОбмена.Статус
			|ПОМЕСТИТЬ ВТ_ЭД
			|ИЗ
			|	Документ.СообщениеОбменСБанками КАК СообщенияОбмена
			|ГДЕ
			|	СообщенияОбмена.Ссылка В(&МассивСсылок)";
		Если ТипЗнч(СообщениеОбмена) <> Тип("Массив") Тогда
			МассивСсылокСообщенийОбмена = Новый Массив;
			МассивСсылокСообщенийОбмена.Добавить(СообщениеОбмена);
		Иначе
			МассивСсылокСообщенийОбмена = СообщениеОбмена;
		КонецЕсли;
		
		Запрос.УстановитьПараметр("МассивСсылок", МассивСсылокСообщенийОбмена);
	Иначе
		ТекстОсновногоЗапроса =
			"ВЫБРАТЬ
			|	СообщенияОбмена.Ссылка,
			|	СообщенияОбмена.ВидЭД,
			|	СообщенияОбмена.Банк,
			|	СообщенияОбмена.Направление,
			|	СообщенияОбмена.Организация,
			|	СообщенияОбмена.НастройкаОбмена,
			|	СообщенияОбмена.СообщениеРодитель,
			|	СообщенияОбмена.Статус
			|ПОМЕСТИТЬ ВТ_ЭД
			|ИЗ
			|	РегистрСведений.СостоянияОбменСБанками КАК СостоянияЭД
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СообщениеОбменСБанками КАК СообщенияОбмена
			|		ПО СостоянияЭД.СообщениеОбмена = СообщенияОбмена.Ссылка
			|ГДЕ
			|	СостоянияЭД.СсылкаНаОбъект В(&МассивСсылок)";

		Если МассивНеобрабатываемыхОбъектов.Количество() > 0 Тогда
			ДопУсловие = " И НЕ(СообщенияОбмена.Ссылка В (&МассивНеобрабатываемыхОбъектов))";
			Запрос.УстановитьПараметр("МассивНеобрабатываемыхОбъектов", МассивНеобрабатываемыхОбъектов);
			ТекстОсновногоЗапроса = ТекстОсновногоЗапроса + ДопУсловие;
		КонецЕсли;
		Запрос.УстановитьПараметр("МассивСсылок", МассивСсылокНаОбъект);
	КонецЕсли;
	
	// Получим из входящих параметров СоотвСертификатовИИхСтруктур.
	СертификатыСПаролями = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ПарольКСертификату(,МассивОтпечатковСертификатов);
	ТекущийПользователь = Пользователи.ТекущийПользователь();
	Для Каждого Элемент Из СертификатыСПаролями Цикл
		Структура = Новый Структура("ПарольСертификата, ПарольПолучен", Элемент.Значение, Истина);
		СоотвСертификатовИИхСтруктур.Вставить(Элемент.Ключ, Структура);
	КонецЦикла;
	
	СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАвторизацией = Новый Соответствие;
	СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату = Новый Соответствие;
	
	///////////////////////////////////////
	// Подписание электронных документов
	
	ДобавитьОтпечаткиСертификатовСбербанка(МассивОтпечатков);
	Запрос.УстановитьПараметр("МассивОтпечатков", МассивОтпечатков);
	
	Если ЭлектронноеВзаимодействиеКлиентСервер.ЕстьДействие(Действия, "Подписать") Тогда
		
		// Основной запрос - выборка из временных таблиц:
		ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	НастройкиОбменаСертификаты.СертификатЭП КАК СертификатЭП,
		|	НастройкиОбменаСертификаты.Ссылка КАК НастройкаОбмена
		|ПОМЕСТИТЬ ВТ_СертификатыИзНастроек
		|ИЗ
		|	ВТ_ЭД КАК ВТ_ЭД
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификаты
		|		ПО ВТ_ЭД.НастройкаОбмена = НастройкиОбменаСертификаты.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Сертификаты.Ссылка КАК Ссылка,
		|	Сертификаты.Отпечаток КАК Отпечаток,
		|	Сертификаты.Отозван КАК Отозван,
		|	Сертификаты.ДанныеСертификата КАК ДанныеСертификата,
		|	Сертификаты.Организация КАК Организация,
		|	Сертификаты.Наименование КАК Наименование,
		|	ПрограммыБанков.ПрограммаБанка КАК ПрограммаБанка
		|ПОМЕСТИТЬ ВТ_РеквизитыСертификатов
		|ИЗ
		|	Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_СертификатыИзНастроек КАК СертификатыИзНастроек
		|		ПО Сертификаты.Ссылка = СертификатыИзНастроек.СертификатЭП
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СведенияОСертификатахОбменСБанками КАК ПрограммыБанков
		|		ПО (ПрограммыБанков.СертификатЭП = Сертификаты.Ссылка)
		|ГДЕ
		|	НЕ Сертификаты.Отозван
		|	И НЕ Сертификаты.ПометкаУдаления
		|	И &ПроверкаПользователя
		|	И Сертификаты.Отпечаток В(&МассивОтпечатков)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Сертификаты.Ссылка,
		|	Сертификаты.Отпечаток,
		|	Сертификаты.Отозван,
		|	Сертификаты.ДанныеСертификата,
		|	Сертификаты.Организация,
		|	Сертификаты.Наименование,
		|	ПрограммыБанков.ПрограммаБанка
		|ИЗ
		|	Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_СертификатыИзНастроек КАК СертификатыИзНастроек
		|		ПО Сертификаты.Ссылка = СертификатыИзНастроек.СертификатЭП
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СведенияОСертификатахОбменСБанками КАК ПрограммыБанков
		|		ПО (ПрограммыБанков.СертификатЭП = Сертификаты.Ссылка)
		|ГДЕ
		|	НЕ Сертификаты.Отозван
		|	И НЕ Сертификаты.ПометкаУдаления
		|	И &ПроверкаПользователя
		|	И ПрограммыБанков.ПрограммаБанка В(&СписокПрограммБанков)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.СертификатПодписи КАК СертификатПодписи,
		|	ВложенныйЗапрос.Отпечаток КАК Отпечаток,
		|	ВложенныйЗапрос.Отозван КАК Отозван,
		|	ВложенныйЗапрос.ДанныеСертификата КАК ДанныеСертификата,
		|	ВложенныйЗапрос.ОрганизацияВСертификате КАК ОрганизацияВСертификате,
		|	ВложенныйЗапрос.ВидДокумента КАК ВидДокумента,
		|	ВложенныйЗапрос.ПрограммаБанка КАК ПрограммаБанка,
		|	ВложенныйЗапрос.Наименование КАК Наименование,
		|	ВложенныйЗапрос.СсылкаНаСообщениеОбмена КАК СсылкаНаСообщениеОбмена
		|ПОМЕСТИТЬ ВТ_Сертификаты
		|ИЗ
		|	(ВЫБРАТЬ
		|		Сертификаты.Ссылка КАК СертификатПодписи,
		|		Сертификаты.Отпечаток КАК Отпечаток,
		|		Сертификаты.Отозван КАК Отозван,
		|		Сертификаты.ДанныеСертификата КАК ДанныеСертификата,
		|		Сертификаты.Организация КАК ОрганизацияВСертификате,
		|		ВидыЭДЭП.ВидЭД КАК ВидДокумента,
		|		Сертификаты.ПрограммаБанка КАК ПрограммаБанка,
		|		Сертификаты.Наименование КАК Наименование,
		|		ВТ_ЭД.Ссылка КАК СсылкаНаСообщениеОбмена
		|	ИЗ
		|		РегистрСведений.ПодписываемыеВидыЭД КАК ВидыЭДЭП
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ЭД КАК ВТ_ЭД
		|			ПО (ВидыЭДЭП.Использовать)
		|				И (ВТ_ЭД.ВидЭД = ВидыЭДЭП.ВидЭД)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_РеквизитыСертификатов КАК Сертификаты
		|			ПО ВидыЭДЭП.СертификатЭП = Сертификаты.Ссылка
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_СертификатыИзНастроек КАК ВТ_СертификатыИзНастроек
		|			ПО (ВТ_СертификатыИзНастроек.НастройкаОбмена = ВТ_ЭД.НастройкаОбмена)
		|				И (ВТ_СертификатыИзНастроек.СертификатЭП = Сертификаты.Ссылка)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СостояниеПодписанияЭД КАК СостояниеПодписанияЭД
		|			ПО (ВТ_ЭД.Ссылка = СостояниеПодписанияЭД.Объект)
		|				И (СостояниеПодписанияЭД.Текущий)
		|				И (СостояниеПодписанияЭД.Подписант В (&ТекущийПользователь, &ПустойПользователь, &ПользовательНеУказан))
		|				И (СостояниеПодписанияЭД.Сертификат = Сертификаты.Ссылка
		|					ИЛИ СостояниеПодписанияЭД.Сертификат = ЗНАЧЕНИЕ(Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования.ПустаяСсылка))) КАК ВложенныйЗапрос
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ЭД.Организация КАК Организация,
		|	ВТ_ЭД.Банк КАК Банк,
		|	ВТ_ЭД.Ссылка КАК СсылкаНаСообщениеОбмена,
		|	ВТ_ЭД.ВидЭД КАК ВидЭД,
		|	ВЫБОР
		|		КОГДА ВТ_ЭД.НастройкаОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.АсинхронныйОбмен)
		|				И ВТ_ЭД.НастройкаОбмена.АутентификацияПоСертификату = ЛОЖЬ
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ТребуетсяАутентификацияЛогинПароль,
		|	ВЫБОР
		|		КОГДА ВТ_ЭД.НастройкаОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.АсинхронныйОбмен)
		|				И НастройкиОбмена.АутентификацияПоСертификату = ИСТИНА
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ТребуетсяАутентификацияПоСертификату,
		|	ВТ_Сертификаты.СертификатПодписи КАК СертификатПодписи,
		|	ВТ_Сертификаты.Отпечаток КАК Отпечаток,
		|	ВТ_Сертификаты.Отозван КАК Отозван,
		|	ВТ_Сертификаты.Наименование КАК НаименованиеСертификата,
		|	ВТ_Сертификаты.ДанныеСертификата КАК ДанныеСертификата,
		|	НастройкиОбмена.ПрограммаБанка КАК ПрограммаБанка,
		|	ЭД_ЭП.Отпечаток КАК УстановленныеПодписи,
		|	НастройкиОбмена.Ссылка КАК НастройкаОбмена
		|ПОМЕСТИТЬ ВТ
		|ИЗ
		|	ВТ_ЭД КАК ВТ_ЭД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Сертификаты КАК ВТ_Сертификаты
		|		ПО ВТ_ЭД.ВидЭД = ВТ_Сертификаты.ВидДокумента
		|			И (ВТ_Сертификаты.СсылкаНаСообщениеОбмена = ВТ_ЭД.Ссылка)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками КАК НастройкиОбмена
		|		ПО ВТ_ЭД.НастройкаОбмена = НастройкиОбмена.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками.ИсходящиеДокументы КАК НастройкиОбменаИсходящие
		|		ПО ВТ_ЭД.НастройкаОбмена = НастройкиОбменаИсходящие.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭлектронныеПодписи КАК ЭД_ЭП
		|		ПО ВТ_ЭД.Ссылка = ЭД_ЭП.ПодписанныйОбъект.ВладелецФайла
		|ГДЕ
		|	НастройкиОбменаИсходящие.ИспользоватьЭП
		|	И НЕ НастройкиОбмена.ПометкаУдаления
		|	И НЕ НастройкиОбмена.Недействительна
		|	И ВТ_ЭД.Статус В(&МассивСтатусов)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ВТ.СсылкаНаСообщениеОбмена КАК СсылкаНаСообщениеОбмена,
		|	ВТ.Организация КАК Организация,
		|	ВТ.Банк КАК Банк,
		|	ВТ.НастройкаОбмена КАК НастройкаОбмена,
		|	ВТ.ВидЭД КАК ВидЭД,
		|	ВТ.ПрограммаБанка КАК ПрограммаБанка,
		|	ВТ.ТребуетсяАутентификацияЛогинПароль КАК ТребуетсяАутентификацияЛогинПароль,
		|	ВТ.ТребуетсяАутентификацияПоСертификату КАК ТребуетсяАутентификацияПоСертификату
		|ИЗ
		|	ВТ КАК ВТ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ.СсылкаНаСообщениеОбмена КАК СсылкаНаСообщениеОбмена,
		|	ВТ.СертификатПодписи КАК СертификатПодписи,
		|	ВТ.Отпечаток КАК Отпечаток,
		|	ВТ.Отозван КАК Отозван,
		|	ВТ.Организация КАК Организация,
		|	ВТ.ДанныеСертификата КАК ДанныеСертификата,
		|	ВТ.ПрограммаБанка КАК ПрограммаБанка,
		|	ВТ.НаименованиеСертификата КАК НаименованиеСертификата,
		|	ЛОЖЬ КАК ПарольПолучен,
		|	НЕОПРЕДЕЛЕНО КАК ПарольСертификата,
		|	ВТ.ТребуетсяАутентификацияЛогинПароль КАК ТребуетсяАутентификацияЛогинПароль
		|ИЗ
		|	ВТ КАК ВТ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НаименованиеСертификата
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ.СсылкаНаСообщениеОбмена КАК СсылкаНаСообщениеОбмена,
		|	ВТ.УстановленныеПодписи КАК УстановленныеПодписи,
		|	ВТ.Организация КАК Организация
		|ИЗ
		|	ВТ КАК ВТ
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|		ПО ВТ.УстановленныеПодписи = Сертификаты.Отпечаток
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТ";
		
		МассивСтатусов = Новый Массив;
		МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Сформирован);
		МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.ЧастичноПодписан);
		
		Запрос.УстановитьПараметр("МассивСтатусов", МассивСтатусов);
		
		СписокПрограммБанков = Новый Массив;
		СписокПрограммБанков.Добавить(Перечисления.ПрограммыБанка.ОбменЧерезДопОбработку);
		СписокПрограммБанков.Добавить(Перечисления.ПрограммыБанка.СбербанкОнлайн);
		СписокПрограммБанков.Добавить(Перечисления.ПрограммыБанка.ОбменЧерезВК);

		Запрос.УстановитьПараметр("СписокПрограммБанков", СписокПрограммБанков);
		
		Запрос.Текст = ТекстОсновногоЗапроса +
			";
			 |////////////////
			 |" + ТекстЗапроса;
			 
		Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПроверкаПользователя", "ИСТИНА");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПроверкаПользователя",
				"Сертификаты.Пользователь В (&ПустойПользователь, &ТекущийПользователь, &ПользовательНеУказан)");
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТекущийПользователь", Пользователи.АвторизованныйПользователь());
		Запрос.УстановитьПараметр("ПустойПользователь", Справочники.Пользователи.ПустаяСсылка());
		Запрос.УстановитьПараметр("ПользовательНеУказан", Пользователи.СсылкаНеуказанногоПользователя());

		УстановитьПривилегированныйРежим(Истина);
		Результат = Запрос.ВыполнитьПакет();
		УстановитьПривилегированныйРежим(Ложь);
		ДоступныеСертификаты = Результат[3].Выгрузить();
		ТЗ_Сертификатов = Результат[6].Выгрузить();
		ТЗ_УстановленныхПодписей = Результат[7].Выгрузить();
		Выборка = Результат[5].Выбрать();
		ТЗ_ЭД = Новый ТаблицаЗначений;
		ТЗ_ЭД.Колонки.Добавить("СсылкаНаСообщениеОбмена");
		ТЗ_ЭД.Колонки.Добавить("НастройкаОбмена");
		ТЗ_ЭД.Колонки.Добавить("СертификатыПодписи");
		
		Если ТЗ_Сертификатов.Количество() = 0 И ЗначениеЗаполнено(СообщениеОбмена) Тогда
			ОшибкаНастройкиКриптографии = Ложь;
			ОшибкаНастройкиСертификата = Ложь;
			Если ДоступныеСертификаты[0].Количество > 0 Тогда
				НастройкаОбмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеОбмена, "НастройкаОбмена");
				ШаблонСообщения = НСтр("ru = 'В настройке обмена: %1
											|не найден ни один из доступных сертификатов ЭП.'");
				ТекстСообщения = СтрШаблон(ШаблонСообщения, НастройкаОбмена);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			КонецЕсли;
		КонецЕсли;
		
		// Для связки Сообщения, НастройкиОбмена и Сертификата, в числе прочих нужно соответствие,
		// ключом которого является ссылка на СообщениеОбмена, значение - Настройка обмена.
		// Например, 2 Сообщения обмена могут быть подписаны 2-я сертификатами (т.е пользователь должен выбрать,
		// каким сертификатом он будет подписывать эти сообщения обмена),
		// при этом сообщения обмена относятся к разным настройкам обмена, если пользователь отказался подписывать
		// эти сообщения обмена, то это сообщение обмена нужно удалить из массива на отправку,
		// для этого найдем его настройку обмена в соответствии (СообщениеОбмена - НастройкаОбмена),
		// по настройке обмена найдем это сообщение обмена в
		// соответствии НастройкиОбмена - Массивы сообщений обмена к отправке и удалим из массива нужное сообщение обмена.
		
		// Ключ - Строка (сумма УИД сертификатов: Строка(Сертификат1.УникальныйИдентификатор())
		// + Строка(Сертификат2.УникальныйИдентификатор()) + ...), Значение - Структура массивов (МассивСертификатов
		// и Массив сообщений обмена).
		// Смысл данной структуры в том, что для подписания разных ЭД возможно будет доступен одинаковый
		// набор сертификатов. НЕ ПРАВИЛЬНО 2 раза спрашивать пользователя,
		// каким из 2-х сертификатов он хочет подписывать документы, поэтому, надо для этой пары
		// сертификатов сформировать массив ЭД, для подписания которых доступна именно эта пара сертификатов.
		// Чтобы сделать запись в структуре уникальной и иметь возможность искать нужную запись по ключу,
		// ключ сделан составным (в результатах запроса сертификаты упорядочены по наименованию).
		// В данном соответствии будем хранить ключевые имена ошибок, возникших в процессе подписания документа:
		//   Ключ - ДокументСсылка.СообщениеОбменСБанками - ссылка на подписываемый электронный документ;
		//   Значение - Строка - ключевое имя ошибки.
		СоотвСообщенийОбменаИОшибокПодписи = Новый Соответствие;
		
		// Если в системе настроена немедленная отправка и есть действие "Отправить", то из подписываемых ЭД
		// надо выделить те, которые для отправки требуют авторизации и будут подписываться на клиенте.
		// Для этого ТЗ_ЭД обработаем в 2 прохода (1- ЭД требующие авторизации, 2- не требующие).
		ВыделятьСообщенияКОтправкеСАвторизацией = ЭлектронноеВзаимодействиеКлиентСервер.ЕстьДействие(Действия, "Отправить");
		
		МассивСообщенийОбмена = Новый Массив;
		Если Выборка.Количество() > 0 Тогда
			Пока Выборка.Следующий() Цикл
				СсылкаНаСообщениеОбмена = Выборка.СсылкаНаСообщениеОбмена;
				Отбор = Новый Структура("СсылкаНаСообщениеОбмена", СсылкаНаСообщениеОбмена);
				КопияТЗ = ТЗ_Сертификатов.Скопировать(Отбор);
				МассивОтпечатковИсключения = Новый Массив;
				МассивСертификатов = Новый Массив;
				ТЗ_Отпечатков = ТЗ_УстановленныхПодписей.Скопировать(Отбор);
				Если ТЗ_Отпечатков.Количество() > 0 Тогда
					МассивОтпечатковИсключения = ТЗ_Отпечатков.ВыгрузитьКолонку("УстановленныеПодписи");
				КонецЕсли;
				ИДМассиваСообщений = "k";
				СтандартноеПодписание = Истина;
				Если Выборка.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн
						ИЛИ Выборка.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезДопОбработку
						ИЛИ Выборка.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК Тогда
					// В зависимости от настройки, для подписания могут использоваться алгоритмы,
					// отличные от стандартных, поэтому добавим в идентификатор структуры УИД настройки обмена:
					СтандартноеПодписание = Ложь;
					ИДМассиваСообщений = ИДМассиваСообщений + Строка(Выборка.НастройкаОбмена.УникальныйИдентификатор());
				КонецЕсли;
				ПарольПолучен = Ложь;
				ПодозрениеНаОшибкиМаршрутаПодписания = Ложь;
				Для Каждого СтрокаСертификата Из КопияТЗ Цикл
					Если МассивОтпечатковИсключения.Найти(СтрокаСертификата.Отпечаток) <> Неопределено
						ИЛИ МассивСертификатов.Найти(СтрокаСертификата.СертификатПодписи) <> Неопределено Тогда
						// Если есть доступные сертификаты, но подписи по ним уже установлены
						Если МассивОтпечатковИсключения.Найти(СтрокаСертификата.Отпечаток) <> Неопределено Тогда
							ПодозрениеНаОшибкиМаршрутаПодписания = Истина;
						КонецЕсли;
						Продолжить;
					КонецЕсли;
					МассивСертификатов.Добавить(СтрокаСертификата.СертификатПодписи);
					ИДМассиваСообщений = ИДМассиваСообщений + Строка(СтрокаСертификата.СертификатПодписи.УникальныйИдентификатор());
					
					СтруктураСертификата = Новый Структура("СертификатПодписи, ПрограммаБанка,
						|ПарольПолучен, ПарольСертификата, Отпечаток, Отозван, ДанныеСертификата");
					ЗаполнитьЗначенияСвойств(СтруктураСертификата, СтрокаСертификата);
					ПараметрыВСоотв = СоотвСертификатовИИхСтруктур.Получить(СтрокаСертификата.СертификатПодписи);
					Если ПараметрыВСоотв <> Неопределено И ПараметрыВСоотв.ПарольПолучен Тогда
						ПарольПолучен = Истина;
						ЗаполнитьЗначенияСвойств(СтруктураСертификата, ПараметрыВСоотв, "ПарольПолучен, ПарольСертификата");
					КонецЕсли;
					СоотвСертификатовИИхСтруктур.Вставить(СтрокаСертификата.СертификатПодписи, СтруктураСертификата);
				КонецЦикла;
				Если МассивСертификатов.Количество() > 0 Тогда
					НоваяСтрока = ТЗ_ЭД.Добавить();
					НоваяСтрока.СсылкаНаСообщениеОбмена = СсылкаНаСообщениеОбмена;
					НоваяСтрока.НастройкаОбмена = Выборка.НастройкаОбмена;
					НоваяСтрока.СертификатыПодписи = МассивСертификатов;
					
					СтруктураМассивов = "";
					ИДМассиваСообщений = СтрЗаменить(ИДМассиваСообщений, "-", "_");
					Если НЕ СертификатыСообщенийОбмена.Свойство(ИДМассиваСообщений, СтруктураМассивов)
						ИЛИ ТипЗнч(СтруктураМассивов) <> Тип("Структура") Тогда
						СтруктураСертификатов = Новый Структура("МассивСертификатов", МассивСертификатов);
						СертификатыСообщенийОбмена.Вставить(ИДМассиваСообщений, СтруктураСертификатов);
						СтруктураМассивов = СертификатыСообщенийОбмена[ИДМассиваСообщений];
					КонецЕсли;
					Если СтандартноеПодписание Тогда
						СообщенияОбменаИПрисоединенныеФайлы = Неопределено;
						Если НЕ СтруктураМассивов.Свойство("СообщенияОбменаИПрисоединенныеФайлы", СообщенияОбменаИПрисоединенныеФайлы)
							ИЛИ ТипЗнч(СообщенияОбменаИПрисоединенныеФайлы) <> Тип("Соответствие") Тогда
							СтруктураМассивов.Вставить("СообщенияОбменаИПрисоединенныеФайлы", Новый Соответствие);
							СообщенияОбменаИПрисоединенныеФайлы = СтруктураМассивов.СообщенияОбменаИПрисоединенныеФайлы;
						КонецЕсли;
						ПрисоединенныйФайл = ОбменСБанкамиСлужебныйВызовСервера.ПрисоединенныйФайл(СсылкаНаСообщениеОбмена);
						СообщенияОбменаИПрисоединенныеФайлы.Вставить(СсылкаНаСообщениеОбмена, ПрисоединенныйФайл);
					Иначе
						ДанныеДляСпецОбработки = Неопределено;
						Если НЕ СертификатыСообщенийОбмена[ИДМассиваСообщений].Свойство("ДанныеДляСпецОбработки",ДанныеДляСпецОбработки)
							ИЛИ ТипЗнч(ДанныеДляСпецОбработки) <> Тип("Соответствие") Тогда
							
							СертификатыСообщенийОбмена[ИДМассиваСообщений].Вставить("ДанныеДляСпецОбработки", Новый Соответствие);
							ДанныеДляСпецОбработки = СертификатыСообщенийОбмена[ИДМассиваСообщений].ДанныеДляСпецОбработки;
						КонецЕсли;
						НастройкиОбменаИСообщенияОбмена = ДанныеДляСпецОбработки.Получить(Выборка.ПрограммаБанка);
						Если ТипЗнч(НастройкиОбменаИСообщенияОбмена) <> Тип("Соответствие") Тогда
							ДанныеДляСпецОбработки.Вставить(Выборка.ПрограммаБанка, Новый Соответствие);
							НастройкиОбменаИСообщенияОбмена = ДанныеДляСпецОбработки[Выборка.ПрограммаБанка];
						КонецЕсли;
						МассивБанковскихСообщенийОбмена = НастройкиОбменаИСообщенияОбмена.Получить(Выборка.НастройкаОбмена);
						Если ТипЗнч(МассивБанковскихСообщенийОбмена) <> Тип("Массив") Тогда
							НастройкиОбменаИСообщенияОбмена.Вставить(Выборка.НастройкаОбмена, Новый Массив);
							МассивБанковскихСообщенийОбмена = НастройкиОбменаИСообщенияОбмена[Выборка.НастройкаОбмена];
						КонецЕсли;
						МассивБанковскихСообщенийОбмена.Добавить(СсылкаНаСообщениеОбмена);
					КонецЕсли;
					Если ВыделятьСообщенияКОтправкеСАвторизацией И Выборка.ТребуетсяАутентификацияПоСертификату Тогда
						// Подписание массива ЭД по текущему сертификату будет выполняться на клиенте, поэтому, после подписания
						// надо будет попытаться их отправить, предварительно получив сертификат аутентификации по настройке обмена.
						МассивСообщенийОбмена = СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату.Получить(
							Выборка.НастройкаОбмена);
						Если МассивСообщенийОбмена = Неопределено Тогда
							МассивСообщенийОбмена = Новый Массив;
						КонецЕсли;
						Если МассивСообщенийОбмена.Найти(СсылкаНаСообщениеОбмена) = Неопределено Тогда
							МассивСообщенийОбмена.Добавить(СсылкаНаСообщениеОбмена);
						КонецЕсли;
						СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату.Вставить(
							Выборка.НастройкаОбмена, МассивСообщенийОбмена);
					ИначеЕсли Выборка.ТребуетсяАутентификацияЛогинПароль Тогда
						МассивСообщенийОбмена = СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАвторизацией.Получить(
							Выборка.НастройкаОбмена);
					
						Если МассивСообщенийОбмена = Неопределено Тогда
							МассивСообщенийОбмена = Новый Массив;
						КонецЕсли;
						Если МассивСообщенийОбмена.Найти(СсылкаНаСообщениеОбмена) = Неопределено Тогда
							МассивСообщенийОбмена.Добавить(СсылкаНаСообщениеОбмена);
						КонецЕсли;
						СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАвторизацией.Вставить(
							Выборка.НастройкаОбмена, МассивСообщенийОбмена);
					ИначеЕсли Выборка.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
						Если СтруктураКОтправке.ЧерезТокенСбербанка.Найти(СсылкаНаСообщениеОбмена) = Неопределено Тогда
							СтруктураКОтправке.ЧерезТокенСбербанка.Добавить(СсылкаНаСообщениеОбмена);
						КонецЕсли;
					ИначеЕсли Выборка.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК Тогда
						
						МассивСообщенийОбмена = Новый Массив;
						МассивСообщенийОбмена.Добавить(СсылкаНаСообщениеОбмена);
						Если СтруктураКОтправке.ЧерезВК.Получить(Выборка.НастройкаОбмена) = Неопределено Тогда
							ДанныеДляОтправки = Новый Структура;
							ДанныеДляОтправки.Вставить("МассивСообщенийОбмена", МассивСообщенийОбмена);
							ДанныеДляОтправки.Вставить("МассивСообщенийТребующихПодтверждение", Новый Массив);
							СтруктураКОтправке.ЧерезВК.Вставить(Выборка.НастройкаОбмена, ДанныеДляОтправки);
						Иначе
							ИсходныеДанные = СтруктураКОтправке.ЧерезВК.Получить(Выборка.НастройкаОбмена);
							ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
								ИсходныеДанные.МассивСообщенийОбмена, МассивСообщенийОбмена, Истина);
							СтруктураКОтправке.ЧерезВК.Вставить(Выборка.НастройкаОбмена, ИсходныеДанные);
						КонецЕсли;
					ИначеЕсли Выборка.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезДопОбработку Тогда
						МассивСообщенийОбмена = Новый Массив;
						МассивСообщенийОбмена.Добавить(СсылкаНаСообщениеОбмена);
						Если СтруктураКОтправке.ЧерезДополнительнуюОбработку.Получить(Выборка.НастройкаОбмена) = Неопределено Тогда
							ДанныеДляОтправки = Новый Структура;
							ДанныеДляОтправки.Вставить("МассивСообщенийОбмена", МассивСообщенийОбмена);
							ДанныеДляОтправки.Вставить("МассивСообщенийТребующихПодтверждение", Новый Массив);
							СтруктураКОтправке.ЧерезДополнительнуюОбработку.Вставить(Выборка.НастройкаОбмена, ДанныеДляОтправки);
						Иначе
							ИсходныеДанные = СтруктураКОтправке.ЧерезДополнительнуюОбработку.Получить(Выборка.НастройкаОбмена);
							ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
								ИсходныеДанные.МассивСообщенийОбмена, МассивСообщенийОбмена, Истина);
							СтруктураКОтправке.ЧерезДополнительнуюОбработку.Вставить(Выборка.НастройкаОбмена, ИсходныеДанные);
						КонецЕсли;
					Иначе
						Для Каждого Элемент Из СообщенияОбменаИПрисоединенныеФайлы Цикл
							Если СтруктураКОтправке.СПодписью.Найти(Элемент.Ключ) = Неопределено Тогда
								СтруктураКОтправке.СПодписью.Добавить(Элемент.Ключ);
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				ИначеЕсли ПодозрениеНаОшибкиМаршрутаПодписания Тогда
					СоотвСообщенийОбменаИОшибокПодписи.Вставить(СсылкаНаСообщениеОбмена, "ОшибкиВМаршруте");
				КонецЕсли;
			КонецЦикла;
		ИначеЕсли Действия = "Подписать" И МассивСсылокНаОбъект.Количество() = 1 Тогда
			ТекстСообщения = НСтр("ru = 'Требуется подпись другого пользователя.'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
		
		Если СоотвСообщенийОбменаИОшибокПодписи.Количество() > 0 Тогда
			СтруктураВозврата.Вставить("СоотвСообщенийОбменаИОшибокПодписи", СоотвСообщенийОбменаИОшибокПодписи);
		КонецЕсли;
		
	КонецЕсли;
	
	//////////////////////////////////////////////////////
	// Отправка электронных документов

	КолОтправленных = 0;
	КолПодготовленных = 0;
	Если ЭлектронноеВзаимодействиеКлиентСервер.ЕстьДействие(Действия, "Отправить") Тогда
		
		СтМассивовСтруктурСертификатов = Новый Структура("МассивОтпечатковКлиент", МассивОтпечатковКлиент);
		
		ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	НастройкиОбменаСертификаты.СертификатЭП КАК СертификатЭП,
		|	НастройкиОбменаСертификаты.Ссылка КАК НастройкаОбмена
		|ПОМЕСТИТЬ ВТ_Сертификаты
		|ИЗ
		|	ВТ_ЭД КАК ВТ_ЭД
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификаты
		|		ПО ВТ_ЭД.НастройкаОбмена = НастройкиОбменаСертификаты.Ссылка
		|ГДЕ
		|	НастройкиОбменаСертификаты.Ссылка.АутентификацияПоСертификату
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Сертификаты.Ссылка КАК СертификатПодписи,
		|	Сертификаты.Отпечаток КАК Отпечаток,
		|	Сертификаты.Отозван КАК Отозван,
		|	Сертификаты.ДанныеСертификата КАК ДанныеСертификата,
		|	Сертификаты.Организация КАК ОрганизацияВСертификате,
		|	Сертификаты.Наименование КАК Наименование,
		|	СертификатыИзНастроек.НастройкаОбмена КАК НастройкаОбмена
		|ИЗ
		|	ВТ_Сертификаты КАК СертификатыИзНастроек
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|		ПО (Сертификаты.Ссылка = СертификатыИзНастроек.СертификатЭП)
		|ГДЕ
		|	НЕ Сертификаты.Отозван
		|	И НЕ Сертификаты.ПометкаУдаления
		|	И &ПроверкаПользователя
		|	И Сертификаты.Отпечаток В(&МассивОтпечатков)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ЭД.Ссылка КАК СсылкаНаСообщениеОбмена,
		|	ВТ_ЭД.Статус КАК Статус,
		|	ВТ_ЭД.НастройкаОбмена КАК НастройкаОбмена,
		|	ВЫБОР
		|		КОГДА НастройкиОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.АсинхронныйОбмен)
		|				И НЕ НастройкиОбмена.АутентификацияПоСертификату
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ТребуетсяАвторизацияЛогинПароль,
		|	ВЫБОР
		|		КОГДА НастройкиОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.СбербанкОнлайн)
		|				И НастройкиОбмена.ИспользуетсяКриптография
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ТребуетсяТокенСбербанка,
		|	ВЫБОР
		|		КОГДА НастройкиОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.СбербанкОнлайн)
		|				И НЕ НастройкиОбмена.ИспользуетсяКриптография
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК БазоваяАутентификацияСбербанка,
		|	ВЫБОР
		|		КОГДА НастройкиОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.АсинхронныйОбмен)
		|				И НастройкиОбмена.ИспользуетсяКриптография
		|				И НастройкиОбмена.АутентификацияПоСертификату
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ТребуетсяАутентификацияПоСертификату,
		|	ВЫБОР
		|		КОГДА НастройкиОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.ОбменЧерезВК)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ОтправкаЧерезВК,
		|	ВЫБОР
		|		КОГДА НастройкиОбмена.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.ОбменЧерезДопОбработку)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ОтправкаЧерезДополнительнуюОбработку,
		|	НастройкиОбменаИсходящие.ИспользоватьЭП КАК ТребуетсяПодпись
		|ИЗ
		|	ВТ_ЭД КАК ВТ_ЭД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками КАК НастройкиОбмена
		|		ПО ВТ_ЭД.НастройкаОбмена = НастройкиОбмена.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками.ИсходящиеДокументы КАК НастройкиОбменаИсходящие
		|		ПО ВТ_ЭД.НастройкаОбмена = НастройкиОбменаИсходящие.Ссылка
		|			И ВТ_ЭД.ВидЭД = НастройкиОбменаИсходящие.ИсходящийДокумент
		|ГДЕ
		|	ВТ_ЭД.Статус В(&СтатусыКОтправке)";
		
		МассивСтатусовКОтправке = Новый Массив;
		МассивСтатусовКОтправке.Добавить(Перечисления.СтатусыОбменСБанками.Подписан);
		МассивСтатусовКОтправке.Добавить(Перечисления.СтатусыОбменСБанками.ПодготовленКОтправке);
		МассивСтатусовКОтправке.Добавить(Перечисления.СтатусыОбменСБанками.НеПодтвержден);
		МассивСтатусовКОтправке.Добавить(Перечисления.СтатусыОбменСБанками.Сформирован);
				
		МассивСтатусовСПодписью = Новый Массив;
		МассивСтатусовСПодписью.Добавить(Перечисления.СтатусыОбменСБанками.Подписан);
		МассивСтатусовСПодписью.Добавить(Перечисления.СтатусыОбменСБанками.ПодготовленКОтправке);
		МассивСтатусовСПодписью.Добавить(Перечисления.СтатусыОбменСБанками.НеПодтвержден);
		
		МассивСтатусовБезПодписи = Новый Массив;
		МассивСтатусовБезПодписи.Добавить(Перечисления.СтатусыОбменСБанками.Сформирован);
		МассивСтатусовБезПодписи.Добавить(Перечисления.СтатусыОбменСБанками.НеПодтвержден);
		МассивСтатусовБезПодписи.Добавить(Перечисления.СтатусыОбменСБанками.ПодготовленКОтправке);
			
		Если Действия = "ОтправитьПовторно" Тогда
			МассивСтатусовСПодписью.Добавить(Перечисления.СтатусыОбменСБанками.ОшибкаПередачи);
			МассивСтатусовБезПодписи.Добавить(Перечисления.СтатусыОбменСБанками.ОшибкаПередачи);
			МассивСтатусовКОтправке.Добавить(Перечисления.СтатусыОбменСБанками.ОшибкаПередачи);
		КонецЕсли;
		
		Запрос.УстановитьПараметр("СтатусыКОтправке", МассивСтатусовКОтправке);
		Запрос.УстановитьПараметр("МассивОтпечатков", МассивОтпечатков);
		
		Запрос.Текст = ТекстОсновногоЗапроса 
						+ "
						|;
						|//////////
						|" + ТекстЗапроса;

		Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПроверкаПользователя", "ИСТИНА");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПроверкаПользователя",
				"Сертификаты.Пользователь В (&ПустойПользователь, &ТекущийПользователь, &ПользовательНеУказан)");
			Запрос.УстановитьПараметр("ТекущийПользователь", Пользователи.АвторизованныйПользователь());
			Запрос.УстановитьПараметр("ПустойПользователь", Справочники.Пользователи.ПустаяСсылка());
			Запрос.УстановитьПараметр("ПользовательНеУказан", Пользователи.СсылкаНеуказанногоПользователя());
		КонецЕсли;
		
		УстановитьПривилегированныйРежим(Истина);
		Результат = Запрос.ВыполнитьПакет();
		УстановитьПривилегированныйРежим(Ложь);
		
		// Определение сертификатов, которые будут использованы для аутентификации на сервере банка.
		ТаблицаСертификатовАутентификации = Результат[2].Выгрузить();
		МассивНастроекОбмена = ТаблицаСертификатовАутентификации.ВыгрузитьКолонку("НастройкаОбмена");
		
		СоотвСертификатовИПаролей = Новый Соответствие;
		
		СоотвНастроекОбменаИСоответствийСертификатовИПараметров = СоотвНастроекОбменаИСоответствийСертификатовИПараметровДляАвторизацииСервер(
			МассивНастроекОбмена, СтМассивовСтруктурСертификатов, СоотвСертификатовИПаролей);
		
		Если СоотвНастроекОбменаИСоответствийСертификатовИПараметров.Количество() Тогда
			Для Каждого Элемент Из ТаблицаСертификатовАутентификации Цикл
				СоотвСертификатовИПараметров = СоотвНастроекОбменаИСоответствийСертификатовИПараметров.Получить(Элемент.НастройкаОбмена);
				Для Каждого КлючИЗначение Из СоотвСертификатовИПараметров Цикл
					Сертификат = КлючИЗначение.Ключ;
					Если Сертификат <> Элемент.СертификатПодписи Тогда
						Продолжить;
					КонецЕсли;
					СтруктураСертификата = КлючИЗначение.Значение;
					
					СоотвСертификатовИИхСтруктур.Вставить(Сертификат, СтруктураСертификата);
					
					МассивСертификатов = СоотвНастроекОбменаИСертификатовАвторизации.Получить(Элемент.НастройкаОбмена);
					Если МассивСертификатов = Неопределено Тогда
						МассивСертификатов = Новый Массив;
						СоотвНастроекОбменаИСертификатовАвторизации.Вставить(Элемент.НастройкаОбмена, МассивСертификатов);
					КонецЕсли;
					МассивСертификатов.Добавить(Сертификат);
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;
			
		СтруктураВозврата.Вставить("СоотвСертификатовИИхСтруктур", СоотвСертификатовИИхСтруктур);
		
		ТЗ_ЭД_КОтправке = Результат[3].Выгрузить();
		
		КолОтправленных = 0;
		КолПодготовленных = 0;
		Если ТЗ_ЭД_КОтправке.Количество() > 0 Тогда
			
			Отбор = Новый Структура();
			Отбор.Вставить("ТребуетсяПодпись", Ложь);
			Отбор.Вставить("ТребуетсяАвторизацияЛогинПароль", Ложь);
			Отбор.Вставить("ТребуетсяАутентификацияПоСертификату", Ложь);
			Отбор.Вставить("ОтправкаЧерезВК", Ложь);
			ВременнаяТЗ = ТЗ_ЭД_КОтправке.Скопировать(Отбор);
			ЗаполнитьМассивСОтборомПоСтатусу(ВременнаяТЗ, МассивСтатусовБезПодписи, СтруктураКОтправке.БезПодписи);
	
			Отбор = Новый Структура("ТребуетсяПодпись", Истина);
			ВременнаяТЗ = ТЗ_ЭД_КОтправке.Скопировать(Отбор);
			ЗаполнитьМассивСОтборомПоСтатусу(ВременнаяТЗ, МассивСтатусовСПодписью, СтруктураКОтправке.СПодписью);

			Отбор = Новый Структура("ТребуетсяТокенСбербанка", Истина);
			ВременнаяТЗ = ТЗ_ЭД_КОтправке.Скопировать(Отбор);
			ЗаполнитьМассивСОтборомПоСтатусу(ВременнаяТЗ, МассивСтатусовСПодписью, СтруктураКОтправке.ЧерезТокенСбербанка);
			
			// Используется для отправки документов через ВК
			МассивСообщенийОбменаКОтправке = Новый Массив;
			Отбор = Новый Структура("ОтправкаЧерезВК", Истина);
			ВремТз = Тз_Эд_КОтправке.Скопировать(Отбор);
			ТзНастроекОбмена = ВремТз.Скопировать();
			ТзНастроекОбмена.Свернуть("НастройкаОбмена");
			МассивНастроекОбмена = ТзНастроекОбмена.ВыгрузитьКолонку("НастройкаОбмена");
			Для Каждого НастройкаОбмена Из МассивНастроекОбмена Цикл
				Отбор = Новый Структура("НастройкаОбмена", НастройкаОбмена);
				ВременнаяТЗПоНастройкеОбмена = ВремТз.Скопировать(Отбор);
				Если ВременнаяТЗПоНастройкеОбмена.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли;

				МассивСообщенийОбмена = Новый Массив;
				МассивСообщенийТребующихПодтверждение = Новый Массив;
				
				Для Каждого ЭлементВыборки Из ВременнаяТЗПоНастройкеОбмена Цикл
					Если ЭлементВыборки.Статус = Перечисления.СтатусыОбменСБанками.НеПодтвержден Тогда
						МассивСообщенийТребующихПодтверждение.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
					ИначеЕсли МассивСтатусовСПодписью.Найти(ЭлементВыборки.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
					КонецЕсли;
				КонецЦикла;
				
				Если СтруктураКОтправке.ЧерезВК.Получить(НастройкаОбмена) = Неопределено Тогда
					ДанныеДляОтправки = Новый Структура;
					ДанныеДляОтправки.Вставить("МассивСообщенийОбмена", МассивСообщенийОбмена);
					ДанныеДляОтправки.Вставить("МассивСообщенийТребующихПодтверждение", МассивСообщенийТребующихПодтверждение);
					СтруктураКОтправке.ЧерезВК.Вставить(НастройкаОбмена, ДанныеДляОтправки);
				Иначе
					ИсходныеДанные = СтруктураКОтправке.ЧерезВК.Получить(НастройкаОбмена);
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ИсходныеДанные.МассивСообщенийОбмена, МассивСообщенийОбмена, Истина);
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
						ИсходныеДанные.МассивСообщенийТребующихПодтверждение, МассивСообщенийТребующихПодтверждение, Истина);
					СтруктураКОтправке.ЧерезВК.Вставить(НастройкаОбмена, ИсходныеДанные);
				КонецЕсли;
			КонецЦикла;
			
			// Используется для отправки документов через дополнительную обработку
			МассивСообщенийОбменаКОтправке = Новый Массив;
			Отбор = Новый Структура("ОтправкаЧерезДополнительнуюОбработку", Истина);
			ВремТз = Тз_Эд_КОтправке.Скопировать(Отбор);
			ТзНастроекОбмена = ВремТз.Скопировать();
			ТзНастроекОбмена.Свернуть("НастройкаОбмена");
			МассивНастроекОбмена = ТзНастроекОбмена.ВыгрузитьКолонку("НастройкаОбмена");
			Для Каждого НастройкаОбмена Из МассивНастроекОбмена Цикл
				Отбор = Новый Структура("НастройкаОбмена", НастройкаОбмена);
				ВременнаяТЗПоНастройкеОбмена = ВремТз.Скопировать(Отбор);
				Если ВременнаяТЗПоНастройкеОбмена.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли;
								
				МассивСообщенийОбмена = Новый Массив;
				МассивСообщенийТребующихПодтверждение = Новый Массив;
				
				Для Каждого ЭлементВыборки Из ВременнаяТЗПоНастройкеОбмена Цикл
					Если ЭлементВыборки.Статус = Перечисления.СтатусыОбменСБанками.НеПодтвержден Тогда
						МассивСообщенийТребующихПодтверждение.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
						СтруктураКОтправке.СПодписью.Удалить(СтруктураКОтправке.СПодписью.Найти(ЭлементВыборки.СсылкаНаСообщениеОбмена));
					ИначеЕсли МассивСтатусовСПодписью.Найти(ЭлементВыборки.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
					КонецЕсли;
				КонецЦикла;
				
				СтруктураКОтправке.ЧерезДополнительнуюОбработку.Вставить(НастройкаОбмена, ДанныеДляОтправки);
				
				Если СтруктураКОтправке.ЧерезДополнительнуюОбработку.Получить(НастройкаОбмена) = Неопределено Тогда
					ДанныеДляОтправки = Новый Структура;
					ДанныеДляОтправки.Вставить("МассивСообщенийОбмена", МассивСообщенийОбмена);
					ДанныеДляОтправки.Вставить("МассивСообщенийТребующихПодтверждение", МассивСообщенийТребующихПодтверждение);
					СтруктураКОтправке.ЧерезДополнительнуюОбработку.Вставить(НастройкаОбмена, ДанныеДляОтправки);
				Иначе
					ИсходныеДанные = СтруктураКОтправке.ЧерезДополнительнуюОбработку.Получить(НастройкаОбмена);
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ИсходныеДанные.МассивСообщенийОбмена, МассивСообщенийОбмена, Истина);
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
						ИсходныеДанные.МассивСообщенийТребующихПодтверждение, МассивСообщенийТребующихПодтверждение, Истина);
					СтруктураКОтправке.ЧерезДополнительнуюОбработку.Вставить(НастройкаОбмена, ИсходныеДанные);
				КонецЕсли;
			КонецЦикла;
		
			// Используется для отправки документов в Сбербанк с аутентификацией по логину-паролю.
			МассивСообщенийОбменаКОтправке = Новый Массив;
			Отбор = Новый Структура("БазоваяАутентификацияСбербанка", Истина);
			ВремТз = Тз_Эд_КОтправке.Скопировать(Отбор);
			ТзНастроекОбмена = ВремТз.Скопировать();
			ТзНастроекОбмена.Свернуть("НастройкаОбмена");
			МассивНастроекОбмена = ТзНастроекОбмена.ВыгрузитьКолонку("НастройкаОбмена");
			Для Каждого НастройкаОбмена Из МассивНастроекОбмена Цикл
				Отбор = Новый Структура("НастройкаОбмена", НастройкаОбмена);
				ВременнаяТЗПоНастройкеОбмена = ВремТз.Скопировать(Отбор);
				Если ВременнаяТЗПоНастройкеОбмена.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли;
				
				МассивСообщенийОбмена = Новый Массив;
				МассивСообщенийТребующихПодтверждение = Новый Массив;
				
				Для Каждого ЭлементВыборки Из ВременнаяТЗПоНастройкеОбмена Цикл
					Если ЭлементВыборки.Статус = Перечисления.СтатусыОбменСБанками.НеПодтвержден Тогда
						МассивСообщенийТребующихПодтверждение.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
					ИначеЕсли ЭлементВыборки.ТребуетсяПодпись
						И МассивСтатусовСПодписью.Найти(ЭлементВыборки.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
					ИначеЕсли НЕ ЭлементВыборки.ТребуетсяПодпись
						И МассивСтатусовБезПодписи.Найти(ЭлементВыборки.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(ЭлементВыборки.СсылкаНаСообщениеОбмена);
					КонецЕсли;
				КонецЦикла;
				
				ИмяВнешнегоМодуля = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ИмяВнешнегоМодуля");
				ДанныеДляОтправки = Новый Структура;
				ДанныеДляОтправки.Вставить("ИмяВнешнегоМодуля", ИмяВнешнегоМодуля);
				ДанныеДляОтправки.Вставить("МассивСообщенийОбмена", МассивСообщенийОбмена);
				ДанныеДляОтправки.Вставить("МассивСообщенийТребующихПодтверждение", МассивСообщенийТребующихПодтверждение);
				
				Если Параметры.СессииОбменСБанками <> Неопределено Тогда
					// Если есть активная сессия, то документ отправляется в банк без возврата на клиента.
					ТекущаяСессия = Параметры.СессииОбменСБанками.Получить(НастройкаОбмена);
					Если ТекущаяСессия <> Неопределено Тогда
						ДанныеДляОтправки.Вставить("НастройкаОбмена", НастройкаОбмена);
						ДанныеДляОтправки.Вставить("ТекущаяСессия", ТекущаяСессия);
						ДанныеДляОтправки.Вставить("ПолучитьСтатусыДокументов", Истина);
						ДанныеДляОтправки.Вставить("АдресРезультата");
						ДанныеДляОтправки.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение);
						
						ОтправитьДокументыВСбербанкБазоваяАутентификация(ДанныеДляОтправки);
						РезультатОтправки = ПолучитьИзВременногоХранилища(ДанныеДляОтправки.АдресРезультата);
						Если НЕ РезультатОтправки.ТребуетсяАутентификация Тогда
							ДанныеДляОтправки.Вставить("РезультатОтправки", РезультатОтправки);
							ТребуютSMS = СообщенияОбменаТребующиеSMSПодтверждения(ДанныеДляОтправки.МассивСообщенийОбмена);
							ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
								ДанныеДляОтправки.МассивСообщенийТребующихПодтверждение, ТребуютSMS);
						КонецЕсли;
						СтруктураКОтправке.БазоваяАутентификацияСбербанка.Вставить(НастройкаОбмена, ДанныеДляОтправки);
						ПараметрыЖурналирования = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыЖурналирования(НастройкаОбмена);
						Если ПараметрыЖурналирования.ИспользоватьЖурналирование Тогда
							СтруктураВозврата.НастройкиСЖурналированием.Вставить(НастройкаОбмена, ПараметрыЖурналирования.КаталогДляЖурналирования);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				СтруктураКОтправке.БазоваяАутентификацияСбербанка.Вставить(НастройкаОбмена, ДанныеДляОтправки);
			
			КонецЦикла;
			
			/// Если есть расшифрованные маркеры по сертификатам авторизации,
			//// то здесь же отправим ЭД по данным сертификатам.
			МассивСообщенийОбменаКОтправкеССервера = Новый Массив;
			ЛокальноеСоотвНастроекОбменаИСтруктур = Новый Соответствие;
			
			// Используется для отправки документов в банк по схеме логин-пароль
			МассивСообщенийОбменаКОтправкеССервераБезПодписи = Новый Массив;
			Отбор = Новый Структура("ТребуетсяАвторизацияЛогинПароль", Истина);
			ВременнаяТЗ = ТЗ_ЭД_КОтправке.Скопировать(Отбор);
			ТЗНастроекОбмена = ВременнаяТЗ.Скопировать();
			ТЗНастроекОбмена.Свернуть("НастройкаОбмена");
			МассивНастроекОбмена = ТЗНастроекОбмена.ВыгрузитьКолонку("НастройкаОбмена");
			Для Каждого НастройкаОбмена Из МассивНастроекОбмена Цикл
				Отбор = Новый Структура("НастройкаОбмена", НастройкаОбмена);
				ВременнаяТЗПоНастройкеОбмена = ВременнаяТЗ.Скопировать(Отбор);
				Если ВременнаяТЗПоНастройкеОбмена.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли;
				МассивСообщенийОбмена = Новый Массив;
				Для Каждого Элемент Из ВременнаяТЗПоНастройкеОбмена Цикл
					Если Элемент.Статус = Перечисления.СтатусыОбменСБанками.НеПодтвержден Тогда
						Продолжить;
					ИначеЕсли Элемент.ТребуетсяПодпись И МассивСтатусовСПодписью.Найти(Элемент.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(Элемент.СсылкаНаСообщениеОбмена);
					ИначеЕсли НЕ Элемент.ТребуетсяПодпись И МассивСтатусовБезПодписи.Найти(Элемент.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(Элемент.СсылкаНаСообщениеОбмена);
					КонецЕсли;					
				КонецЦикла;
					
				Если ЗначениеЗаполнено(СоотвСертификатовИПаролей)
					И НЕ СоотвСертификатовИПаролей.Получить(НастройкаОбмена) = Неопределено
					И НЕ ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ПрограммаБанка") = Перечисления.ПрограммыБанка.АсинхронныйОбмен Тогда
					ЛокальноеСоотвНастроекОбменаИСтруктур.Вставить(НастройкаОбмена, СоотвСертификатовИПаролей.Получить(НастройкаОбмена));
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивСообщенийОбменаКОтправкеССервераБезПодписи, МассивСообщенийОбмена);
				Иначе
					СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАвторизацией.Вставить(
						НастройкаОбмена, МассивСообщенийОбмена);
				КонецЕсли;
			КонецЦикла;
			
			// Используется для отправки документов в банк с аутентификацией по сертификату
			МассивСообщенийОбменаКОтправкеССервераБезПодписи = Новый Массив;
			Отбор = Новый Структура("ТребуетсяАутентификацияПоСертификату", Истина);
			ВременнаяТЗ = ТЗ_ЭД_КОтправке.Скопировать(Отбор);
			ТЗНастроекОбмена = ВременнаяТЗ.Скопировать();
			ТЗНастроекОбмена.Свернуть("НастройкаОбмена");
			МассивНастроекОбмена = ТЗНастроекОбмена.ВыгрузитьКолонку("НастройкаОбмена");
			Для Каждого НастройкаОбмена Из МассивНастроекОбмена Цикл
				Отбор = Новый Структура("НастройкаОбмена", НастройкаОбмена);
				ВременнаяТЗПоНастройкеОбмена = ВременнаяТЗ.Скопировать(Отбор);
				Если ВременнаяТЗПоНастройкеОбмена.Количество() = 0 Тогда
					Продолжить;
				КонецЕсли;
				
				МассивСообщенийОбмена = СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату.Получить(
					НастройкаОбмена);
				Если МассивСообщенийОбмена = Неопределено Тогда
					МассивСообщенийОбмена = Новый Массив;
				КонецЕсли;
				
				Для Каждого Элемент Из ВременнаяТЗПоНастройкеОбмена Цикл
					Если Элемент.ТребуетсяПодпись И МассивСтатусовСПодписью.Найти(Элемент.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(Элемент.СсылкаНаСообщениеОбмена);
					ИначеЕсли НЕ Элемент.ТребуетсяПодпись И МассивСтатусовБезПодписи.Найти(Элемент.Статус) <> Неопределено Тогда
						МассивСообщенийОбмена.Добавить(Элемент.СсылкаНаСообщениеОбмена);
					КонецЕсли;
				КонецЦикла;

				СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату.Вставить(
					НастройкаОбмена, МассивСообщенийОбмена);
			КонецЦикла;
			
			Если СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату.Количество() Тогда
				СоотвНастроекОбменаИСоответствийСертификатовИПараметров = СоотвНастроекОбменаИСоответствийСертификатовИПараметровДляАвторизацииСервер(
					МассивНастроекОбмена, СтМассивовСтруктурСертификатов, СоотвСертификатовИПаролей);
				// Если есть сертификат авторизации, то попытаемся, после подписания массива ЭД на клиенте,
				// сразу же отправить ЭД, иначе, после подписания, ЭД упакуем в ПЭД и поместим в очередь на отправку.
				Для Каждого Элемент Из СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату Цикл
					НастройкаОбмена = Элемент.Ключ;
					
					СоотвСертификатовИПараметров = СоотвНастроекОбменаИСоответствийСертификатовИПараметров.Получить(НастройкаОбмена);
					
					Если СоотвСертификатовИПараметров = Неопределено Тогда
						Продолжить;
					КонецЕсли;
					
					Для Каждого КлючИЗначение Из СоотвСертификатовИПараметров Цикл
						Сертификат           = КлючИЗначение.Ключ;
						СтруктураСертификата = КлючИЗначение.Значение;
						
						ИдентификаторСессии = Неопределено;
						МаркерЗашифрованный = Неопределено;
						Если ТипЗнч(СтруктураСертификата) = Тип("Структура")
							И (СтруктураСертификата.Свойство("ИдентификаторСессии", ИдентификаторСессии)
								ИЛИ СтруктураСертификата.Свойство("МаркерЗашифрованный", МаркерЗашифрованный))
							И (ЗначениеЗаполнено(ИдентификаторСессии) ИЛИ ЗначениеЗаполнено(МаркерЗашифрованный)) Тогда
							
							СоотвСертификатовИИхСтруктур.Вставить(Сертификат, СтруктураСертификата);
								
							МассивСертификатов = СоотвНастроекОбменаИСертификатовАвторизации.Получить(НастройкаОбмена);
							Если МассивСертификатов = Неопределено Тогда
								МассивСертификатов = Новый Массив;
								СоотвНастроекОбменаИСертификатовАвторизации.Вставить(НастройкаОбмена, МассивСертификатов);
							КонецЕсли;
							МассивСертификатов.Добавить(Сертификат);
						КонецЕсли;
					КонецЦикла;
				КонецЦикла;
			КонецЕсли;
				
			Если МассивСообщенийОбменаКОтправкеССервераБезПодписи.Количество() > 0 Тогда
				СтРезультата = ОбменСБанкамиСлужебныйВызовСервера.СоздатьИОтправитьДокументыПЭД(
					МассивСообщенийОбменаКОтправкеССервераБезПодписи, ЛокальноеСоотвНастроекОбменаИСтруктур);
				КолОтправленных = КолОтправленных + СтРезультата.КолОтправленных;
				КолПодготовленных = КолПодготовленных + СтРезультата.КолПодготовленных;
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
					СтруктураВозврата.ОтправленныеДокументы, СтРезультата.ОтправленныеДокументы);
			КонецЕсли;
			
			Если МассивСообщенийОбменаКОтправкеССервера.Количество() > 0 Тогда
				СтРезультата = ОбменСБанкамиСлужебныйВызовСервера.СоздатьИОтправитьДокументыПЭД(
					МассивСообщенийОбменаКОтправкеССервера, ЛокальноеСоотвНастроекОбменаИСтруктур);
				КолОтправленных = КолОтправленных + СтРезультата.КолОтправленных;
				КолПодготовленных = КолПодготовленных + СтРезультата.КолПодготовленных;
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
					СтруктураВозврата.ОтправленныеДокументы, СтРезультата.ОтправленныеДокументы);
			КонецЕсли;
			Для Каждого Элемент Из СтруктураКОтправке Цикл
				
				Если Элемент.Ключ = "ЧерезТокенСбербанка" Тогда
					Продолжить;
				КонецЕсли;
				
				МассивКОтправке = Новый Массив;
				СтруктураКОтправке.Свойство(Элемент.Ключ, МассивКОтправке);
				МассивСообщенийОбмена = Элемент.Значение;
				Если ТипЗнч(МассивСообщенийОбмена) = Тип("Массив") И МассивСообщенийОбмена.Количество() > 0 Тогда
					СтРезультата = ОбменСБанкамиСлужебныйВызовСервера.СоздатьИОтправитьДокументыПЭД(
						МассивСообщенийОбмена, ЛокальноеСоотвНастроекОбменаИСтруктур);
					КолОтправленных = КолОтправленных + СтРезультата.КолОтправленных;
					КолПодготовленных = КолПодготовленных + СтРезультата.КолПодготовленных;
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
						СтруктураВозврата.ОтправленныеДокументы, СтРезультата.ОтправленныеДокументы);
					МассивКОтправке = СтРезультата.МассивПакетовДляОбработкиНаКлиенте;
				КонецЕсли;
				СтруктураКОтправке.Вставить(Элемент.Ключ, МассивКОтправке);
			КонецЦикла;
		КонецЕсли;

		СтруктураКОтправке.САвторизациейЛогинПароль = СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАвторизацией;
		СтруктураКОтправке.САутентификациейПоСертификату = СоотвНастроекОбменаИМассивовСообщенийОбменаКОтправкеСАутентификациейПоСертификату;

	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресРезультата);
	
КонецФункции

// Отмечает исполненные платежные документы
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком
//  ПрограммаБанка - ПеречислениеСсылка.ПрограммыБанка - текущая программа банка
//  МассивВнешнихИдентификаторов - Массив - содержит идентификаторы платежных документов.
//
Процедура ОтметитьИсполненныеПлатежныеДокументы(НастройкаОбмена, ПрограммаБанка, МассивВнешнихИдентификаторов) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СообщениеОбменСБанками.Ссылка КАК Ссылка
	               |ИЗ
	               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	               |ГДЕ
	               |	СообщениеОбменСБанками.НастройкаОбмена = &НастройкаОбмена
	               |	И СообщениеОбменСБанками.ВидЭД = ЗНАЧЕНИЕ(Перечисление.ВидыЭДОбменСБанками.ПлатежноеПоручение)
	               |	И СообщениеОбменСБанками.ВнешнийИдентификатор В(&МассивИдентификаторов)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	СообщениеОбменСБанками.Ссылка
	               |ИЗ
	               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	               |ГДЕ
	               |	СообщениеОбменСБанками.НастройкаОбмена = &НастройкаОбмена
	               |	И СообщениеОбменСБанками.ВидЭД = ЗНАЧЕНИЕ(Перечисление.ВидыЭДОбменСБанками.ПлатежноеТребование)
	               |	И СообщениеОбменСБанками.ВнешнийИдентификатор В(&МассивИдентификаторов)";
	
	Запрос.УстановитьПараметр("МассивИдентификаторов", МассивВнешнихИдентификаторов);
	Запрос.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
	
	Если ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВнешнийИдентификатор", "Идентификатор");
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура("Статус", Перечисления.СтатусыОбменСБанками.Подтвержден);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(Выборка.Ссылка, СтруктураПараметров);
	КонецЦикла;
	
КонецПроцедуры

#Область Сбербанк

// Возвращает параметры установленной сессии со Сбербанком
//
// Параметры:
//  Ключ - Произвольный - ключ, в разрезе которого сохранены параметры сессии.
// 
// Возвращаемое значение:
//  Структура - параметры установленный сессии с банком.
//
Функция ПараметрыУстановленнойСессииСбербанк(Ключ) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	Возврат ПараметрыСеанса.СессииОбменСБанками.Получить(Ключ);
	
КонецФункции

// Заполняет фрод параметры в XDTO
//
// Параметры:
//  ФродЭлемент - ОбъектXDTO - объект, в котором требуется заполнить фрод-параметры.
//  Параметры - Структура - параметры фрод-мониторинга.
//  Логин - Строка - текущий логин пользователя.
//
Процедура ЗаполнитьФродПараметрыВXDTO(ФродЭлемент, Параметры, Логин = Неопределено) Экспорт
	
	СистемнаяИнформация = Новый СистемнаяИнформация;
	
	Язык = Сред(КодЛокализацииИнформационнойБазы(), 1, 2);
	
	СтрокаФрод = "version=3.4.1.0_1&pm_fpua=" + Параметры.РазрядностьОС + "|0|" + Параметры.РазрядностьПроцессора + "|"
		+ Язык + "|" + ОбменСБанкамиСлужебныйПовтИсп.ВерсияПрограммыКлиентаДляБанка() + "&pm_fpsc=" + Параметры.ГлубинаЦвета
		+ "|" + Параметры.ШиринаМонитора + "|" + Параметры.ВысотаМонитора + "|" + Параметры.ШиринаРабочегоСтола + "&pm_fpsw"
		+ Параметры.УстановленныеКомпоненты + "&pm_fptz=" + Параметры.СмещениеЧасовогоПояса + "&pm_fpln=lang=" + Язык
		+ "|syslang=" + Параметры.ЯзыкСистемы + "|userlang=" + Параметры.ЯзыкПользователя
		+ "&pm_fpjv=0&pm_fpco=0&pm_fpasw=&pm_fpan=SBB&pm_fpacn=SBB&pm_fpol=" + Параметры.Онлайн
		+ "&pm_fposp=&pm_fpup=&pm_fpsaw=" + Параметры.ШиринаМонитора + "&pm_fpspd=" + Параметры.ГлубинаЦвета
		+ "&pm_fpsbd=&pm_fpsdx=" + Параметры.ПлотностьПикселяX + "&pm_fpsdy=" + Параметры.ПлотностьПикселяY + "&pm_fpslx="
		+ Параметры.ПлотностьПикселяX + "&pm_fpsly=" + Параметры.ПлотностьПикселяY + "&pm_fpsfse="
		+ Параметры.СглаживаниеШрифтов + "&pm_fpsui=&pm_os=Windows&pm_brmjv=" + СистемнаяИнформация.ВерсияПриложения
		+ "&pm_br=SBB&pm_inpt=&pm_expt=";
		
	СтрокаФродКодированная = КодироватьСтроку(СтрокаФрод, СпособКодированияСтроки.КодировкаURL);
	ТекстОшибки = "";
	
	Если ФродЭлемент.Свойства().Получить("Login") <> Неопределено Тогда
		Login = ?(ЗначениеЗаполнено(Логин), Логин, ";");
		ЗаполнитьСвойствоXDTO(ФродЭлемент, "Login", Login, Истина, ТекстОшибки);
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(ФродЭлемент, "DevicePrint", СтрокаФродКодированная, Истина, ТекстОшибки);
	
	СвойстваКомпьютера = Параметры.ИдентификаторКомпьютера + ";" + Параметры.ИдентификаторПроцессора + ";"
		+ Параметры.ИдентификаторBIOS + ";" + Параметры.ИдентификаторДиска;
	
	Если ФродЭлемент.Свойства().Получить("ChannelIndicator") <> Неопределено Тогда
		ЗаполнитьСвойствоXDTO(ФродЭлемент, "ChannelIndicator", "UPG_1C", Истина, ТекстОшибки);
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(ФродЭлемент, "IpMACAddresses", Параметры.IP + ";" + Параметры.MAC, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ФродЭлемент, "GeolocationInfo", ";;;;4", Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ФродЭлемент, "PcProp", СвойстваКомпьютера, Истина, ТекстОшибки);
	
	ИнформацияОТокене = Параметры.КонфигурационнаяСтрока;
	Если Параметры.Свойство("НомерКонтейнера") И ЗначениеЗаполнено(ИнформацияОТокене) Тогда
		МассивПараметровТокена = СтрРазделить(ИнформацияОТокене, "&");
		ПараметрыТокена = Новый Структура;
		Для Каждого Строка Из МассивПараметровТокена Цикл
			ПозицияРавно = СтрНайти(Строка, "=");
			ПозицияПервойКавычки = СтрНайти(Строка, """");
			ДлинаЗначения = СтрДлина(Строка) - ПозицияПервойКавычки - 1;
			ПараметрыТокена.Вставить(Сред(Строка, 1, ПозицияРавно - 1), Сред(Строка, ПозицияПервойКавычки + 1, ДлинаЗначения));
		КонецЦикла;
		TokenInfo = "TOKEN;" + ПараметрыТокена.devcfg + ";" + ПараметрыТокена.rnginitdate + ";" + ПараметрыТокена.serial
			+ ";" + ПараметрыТокена.buildid + ";" + Параметры.НомерКонтейнера;
		ЗаполнитьСвойствоXDTO(ФродЭлемент, "TokenInfo", TokenInfo, Истина, ТекстОшибки);
	Иначе
		ЗаполнитьСвойствоXDTO(ФродЭлемент, "TokenInfo", ";", Истина, ТекстОшибки);
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(ФродЭлемент, "HttpAcceptLanguage", КодЛокализацииИнформационнойБазы(), Истина, ТекстОшибки);
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;

КонецПроцедуры

// Процедура - Добавить запись в журнал
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком;
//  Операция - Строка - выполняемый метод сервиса;
//  Фабрика - ФабрикаXDTO - используемая фабрика;
//  Запрос - ОбъектXDTO - отправленные данные;
//  Ответ - ОбъектXDTO - полученный ответ.
//
Процедура ДобавитьЗаписьВЖурнал(НастройкаОбмена, Операция, Фабрика, Отправлено, Получено) Экспорт
	
	Если Не ЗначениеЗаполнено(НастройкаОбмена) Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыЖурналирования = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыЖурналирования(НастройкаОбмена);
	Если Не ПараметрыЖурналирования.ИспользоватьЖурналирование Тогда
		Возврат;
	КонецЕсли;
	
	ШаблонЗаписи = "=======================================================================================================
					|%1
					|%2
					|==>
					|%3
					|<==
					|%4
					|";
	Если ТипЗнч(Отправлено) = Тип("Строка") Тогда
		ТекстЗапроса = Отправлено;
	Иначе
		ТекстЗапроса = СтрокаИзОбъектаXDTO(Фабрика, Отправлено);
	КонецЕсли;
	
	Если Получено <> Неопределено Тогда
		Если ТипЗнч(Получено) = Тип("Строка") Тогда
			ТекстОтвета = Получено;
		Иначе
			ТекстОтвета = СтрокаИзОбъектаXDTO(Фабрика, Получено);
		КонецЕсли;
	КонецЕсли;
	
	ЗаписьЛога = СтрШаблон(ШаблонЗаписи, ТекущаяДатаСеанса(), Операция, ТекстЗапроса, ТекстОтвета);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЕстьNULL(МАКСИМУМ(ЖурналОбменСБанками.Индекс), 0) КАК Индекс
	               |ИЗ
	               |	РегистрСведений.ЖурналОбменСБанками КАК ЖурналОбменСБанками
	               |ГДЕ
	               |	ЖурналОбменСБанками.НастройкаОбмена = &НастройкаОбмена
	               |	И ЖурналОбменСБанками.Пользователь = &Пользователь";
	Запрос.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
	ТекущийПользователь = Пользователи.АвторизованныйПользователь();
	Запрос.УстановитьПараметр("Пользователь", ТекущийПользователь);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Индекс = 0;
	Если Выборка.Следующий() Тогда
		Индекс = Выборка.Индекс + 1;
	КонецЕсли;
	
	МенеджерЗаписи = РегистрыСведений.ЖурналОбменСБанками.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Индекс = Индекс;
	МенеджерЗаписи.НастройкаОбмена = НастройкаОбмена;
	МенеджерЗаписи.Пользователь = ТекущийПользователь;
	МенеджерЗаписи.Запись = ЗаписьЛога;
	МенеджерЗаписи.Записать();
	
КонецПроцедуры

// Формирует текст запроса состояния документов.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - настройка обмена с банком.
//  ИдентификаторыДокументов - Массив - список идентификаторов документов
//              * Строка - идентификатор документа.
// 
// Возвращаемое значение:
//      Строка - текст запроса состояния документов.
//
Функция ТекстЗапросаСостоянияДокументовСбербанк(НастройкаОбмена, ИдентификаторыДокументов) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ИдентификаторОрганизации");
	
	Request = ОбъектТипаCML(ФабрикаXDTO, "Request", "http://bssys.com/upg/request");
	ИдентификаторЗапроса = Новый УникальныйИдентификатор;
	ТекстОшибки = "";
	ЗаполнитьСвойствоXDTO(Request, "requestId", Строка(ИдентификаторЗапроса), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "orgId", ИдентификаторОрганизации, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "version", ВерсияФорматаСбербанк(), Истина, ТекстОшибки);
	Отправитель = ПредставлениеОтправителяСбербанк();
	ЗаполнитьСвойствоXDTO(Request, "sender", Отправитель, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "receiver", "SBBOL_DBO", Истина, ТекстОшибки);
	
	DocIds = ОбъектТипаCML(ФабрикаXDTO, "Request.DocIds", "http://bssys.com/upg/request");
	Для Каждого ИдентификаторДокумента Из ИдентификаторыДокументов Цикл
		DocId = ОбъектТипаCML(ФабрикаXDTO, "Request.DocIds.DocId", "http://bssys.com/upg/request");
		ЗаполнитьСвойствоXDTO(DocId, "docid", ИдентификаторДокумента, Истина, ТекстОшибки);
		DocIds.DocId.Добавить(DocId);
	КонецЦикла;
	
	ЗаполнитьСвойствоXDTO(Request, "DocIds", DocIds, Истина, ТекстОшибки);
	
	Request.Проверить();
	
	Запись = Новый ЗаписьXML;
	Запись.УстановитьСтроку();
	ФабрикаXDTO.ЗаписатьXML(Запись, Request);
	ТекстЗапроса = Запись.Закрыть();
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Получает представление программы для сервиса сбербанка
//
// Возвращаемое значение:
//    Строка - представление программы для сервиса Сбербанка.
//
Функция ПредставлениеОтправителяСбербанк() Экспорт
	
	ИспользуетсяТестовыйРежим = Ложь;
	ОбменСБанкамиПереопределяемый.ПроверитьИспользованиеТестовогоРежима(ИспользуетсяТестовыйРежим);
	
	Если ИспользуетсяТестовыйРежим Тогда
		Возврат "1CEnterprise8";
	КонецЕсли;
	
	Возврат "1С: Предприятие 8";
	
КонецФункции

// Получает версию формата обмена Сбербанка
//
// Возвращаемое значение:
//    Строка - версия формата обмена.
//
Функция ВерсияФорматаСбербанк() Экспорт
	
	Возврат "01.010.00";
	
КонецФункции

// Формирует список служебных реквизиты выписки Сбербанка.
// 
// Возвращаемое значение:
//  Массив - в элементах строковые названия реквизитов операции в выписке.
//
Функция СлужебныеРеквизитыВыпискиСбербанк() Экспорт

	МассивРеквизитов = Новый Массив;
	МассивРеквизитов.Добавить("s_Type");
	МассивРеквизитов.Добавить("s_OriginatorE");
	МассивРеквизитов.Добавить("s_DestinatorE");
	МассивРеквизитов.Добавить("s_Number");
	МассивРеквизитов.Добавить("s_Sent");
	МассивРеквизитов.Добавить("s_Rcpt");
	МассивРеквизитов.Добавить("s_32A");
	МассивРеквизитов.Добавить("s_33B");
	МассивРеквизитов.Добавить("s_71A");
	МассивРеквизитов.Добавить("s_71F");
	МассивРеквизитов.Добавить("s_71G");
	МассивРеквизитов.Добавить("s_SA");
	МассивРеквизитов.Добавить("s_S3");
	МассивРеквизитов.Добавить("s_RA");
	МассивРеквизитов.Добавить("s_S4");
	МассивРеквизитов.Добавить("s_S2");
	МассивРеквизитов.Добавить("s_R3");
	МассивРеквизитов.Добавить("s_R4");
	МассивРеквизитов.Добавить("s_R2");
	МассивРеквизитов.Добавить("s_B3");
	МассивРеквизитов.Добавить("s_B2");
	МассивРеквизитов.Добавить("s_20");
	МассивРеквизитов.Добавить("s_21");
	МассивРеквизитов.Добавить("s_23B");
	МассивРеквизитов.Добавить("s_23E");
	МассивРеквизитов.Добавить("s_26T");
	МассивРеквизитов.Добавить("s_36");
	МассивРеквизитов.Добавить("s_72");
	МассивРеквизитов.Добавить("s_PAYERNAME");
	МассивРеквизитов.Добавить("s_SS");
	МассивРеквизитов.Добавить("s_PAYERBANKNAME");
	МассивРеквизитов.Добавить("s_IS");
	МассивРеквизитов.Добавить("s_IB");
	МассивРеквизитов.Добавить("s_RS");
	МассивРеквизитов.Добавить("s_RECEIVERBANKNAME");
	МассивРеквизитов.Добавить("s_RECEIVERNAME");
	МассивРеквизитов.Добавить("s_77B");
	МассивРеквизитов.Добавить("s_PAYERCORACC");
	МассивРеквизитов.Добавить("s_IK");
	МассивРеквизитов.Добавить("s_RECEIVERCORACC");
	МассивРеквизитов.Добавить("s_GROUND");
	МассивРеквизитов.Добавить("s_PAYERINN");
	МассивРеквизитов.Добавить("s_IC");
	МассивРеквизитов.Добавить("urgent");
	МассивРеквизитов.Добавить("s_FILIAL");
	Возврат МассивРеквизитов;
	
КонецФункции

// Скачивает внешнюю компоненту через интернет в фоновом процессе и определяет URL инфо-файла.
//
// Параметры:
//  Параметры - Структура - параметры загрузки внешней компоненты.
//                 * URLВК - Строка - адрес внешней компоненты
//  Адрес - Строка - адрес временного хранилища, содержащий URL информационного файла.
//
Процедура ОпределитьURLИнфоФайла(Параметры, Адрес = Неопределено) Экспорт
	
	ПараметрыПолучения = Новый Структура("Таймаут", 1260);
	РезультатВК = ПолучениеФайловИзИнтернета.СкачатьФайлВоВременноеХранилище(Параметры.URLВК, ПараметрыПолучения);
	Если РезультатВК.Статус Тогда
		ИнформацияОВК = ДополнительныеВнешниеКомпонентыВызовСервера.ИнформацияОВнешнейКомпоненте(РезультатВК.Путь);
		Если ИнформацияОВК = Неопределено Тогда
			ВызватьИсключение НСтр("ru = 'Файл внешней компоненты банка имеет некорректное содержимое.'")
		КонецЕсли;
		ПоместитьВоВременноеХранилище(ИнформацияОВК.URLИнфо, Адрес);
	Иначе
		ТекстСообщения = НСтр("ru = 'Не удалось скачать файл внешней компоненты.
									|Описание: %1'");
		ТекстОшибки =  НСтр("ru = 'Не удалось скачать файл внешней компоненты.
							|Описание: %1
							|URL: %2'");
		Если РезультатВК.Свойство("КодСостояния") Тогда
			ТекстСообщения = ТекстСообщения + Символы.ПС + НСтр("ru = 'Код ошибки: %2'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, РезультатВК.СообщениеОбОшибке, РезультатВК.КодСостояния);
			ТекстОшибки = ТекстОшибки + Символы.ПС + НСтр("ru = 'Код ошибки: %3'");
			ТекстОшибки = СтрШаблон(ТекстОшибки, РезультатВК.СообщениеОбОшибке, Параметры.URLВК, РезультатВК.КодСостояния);
		Иначе
			ТекстСообщения = СтрШаблон(ТекстСообщения, РезультатВК.СообщениеОбОшибке);
			ТекстОшибки = СтрШаблон(ТекстОшибки, РезультатВК.СообщениеОбОшибке, Параметры.URLВК);
		КонецЕсли;
		ВидОперации = НСтр("ru = 'Загрузка внешней компоненты через интернет'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, , "ОбменСБанками");
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
КонецПроцедуры

// Получает статус платежного документа
//
// Параметры:
//  Параметры - Структура - параметры выполнения процедуры:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком
//    * СообщениеОбмена - ДокументСсылка.СообщенияОбменСБанками - сообщение с исходным платежным документом
//    * ТекущаяСессия - Структура - параметры установленной сессии
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата.
//    * Структура - возвращаемые параметры:
//       ** ТребуетсяАутентификация - Булево - требуется аутентификация, т.к. сессия "протухла".
//       ** Тикет - Строка - тикет ответа на запрос.
//
Процедура ОтправитьЗапросСтатусаПлатежногоДокумента(Параметры, АдресРезультата) Экспорт
	
	Результат = Новый Структура("ТребуетсяАутентификация, Тикет", Ложь, Неопределено);
	
	Если Параметры.ТекущаяСессия = Неопределено Тогда
		Результат.ТребуетсяАутентификация = Истина;
		ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	ВнешнийИдентификатор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.СообщениеОбмена, "ВнешнийИдентификатор");
	МассивИдентификаторов = Новый Массив;
	МассивИдентификаторов.Добавить(ВнешнийИдентификатор);
	ТекстЗапроса = ТекстЗапросаСостоянияДокументовСбербанк(Параметры.НастройкаОбмена, МассивИдентификаторов);
	
	Данные = Новый Массив;
	Данные.Добавить(ТекстЗапроса);
	Тикеты = Неопределено;
	
	ОтправитьДанныеВСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Данные, Тикеты,
		Результат.ТребуетсяАутентификация);
	
	Если Тикеты.Количество() Тогда
		Результат.Тикет = Тикеты.Получить(0);
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
	
КонецПроцедуры

// Отправляет в Сбербанк запрос на генерацию SMS подтверждения платежного документа
//
// Параметры:
//  Параметры - Структура - параметры выполнения процедуры:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком
//    * СообщениеОбмена - ДокументСсылка.СообщенияОбменСБанками - сообщение с исходным платежным документом
//    * ТекущаяСессия - Структура - параметры установленной сессии
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата.
//    * Структура - возвращаемые параметры:
//       ** ТребуетсяАутентификация - Булево - требуется аутентификация, т.к. сессия "протухла".
//       ** Тикет - Строка - тикет ответа на запрос.
//
Процедура ОтправитьЗапросНаГенерациюSMSСбербанк(Параметры, АдресРезультата) Экспорт
	
	Результат = Новый Структура("ТребуетсяАутентификация, Тикет", Ложь, Неопределено);
	
	Если Параметры.ТекущаяСессия = Неопределено Тогда
		Результат.ТребуетсяАутентификация = Истина;
		ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	ВнешнийИдентификатор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.СообщениеОбмена, "ВнешнийИдентификатор");
	МассивИдентификаторов = Новый Массив;
	МассивИдентификаторов.Добавить(ВнешнийИдентификатор);
	ТекстЗапроса = ТекстЗапросаГенерацииSMSСбербанк(Параметры.НастройкаОбмена, ВнешнийИдентификатор);
	
	Данные = Новый Массив;
	Данные.Добавить(ТекстЗапроса);
	Тикеты = Неопределено;
	ОтправитьДанныеВСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Данные, Тикеты,
		Результат.ТребуетсяАутентификация);
	
	Если Тикеты.Количество() Тогда
		Результат.Тикет = Тикеты.Получить(0);
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
	
КонецПроцедуры

// Отправляет в Сбербанк запрос на проверку SMS
//
// Параметры:
//  Параметры - Структура - параметры выполнения процедуры:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком
//    * СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками - платежный документ
//    * ИдентификаторКриптопрофиля - Строка - идентификатор, полученный из банка
//    * SMSКод - Строка - код, введенный пользователем
//    * ТекущаяСессия - Структура - параметры установленной сессии
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата.
//
Процедура ОтправитьЗапросНаПроверкуSMSСбербанк(Параметры, АдресРезультата) Экспорт
	
	Результат = Новый Структура("ТребуетсяАутентификация, Тикет", Ложь, Неопределено);

	ВнешнийИдентификатор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.СообщениеОбмена, "ВнешнийИдентификатор");

	ТекстЗапроса = ТекстЗапросаПроверкиSMSСбербанк(Параметры.НастройкаОбмена, ВнешнийИдентификатор,
		Параметры.ИдентификаторКриптопрофиля, Параметры.SMSКод, Параметры.ТекущаяСессия);
	
	Данные = Новый Массив;
	Данные.Добавить(ТекстЗапроса);
	Тикеты = Неопределено;
	ОтправитьДанныеВСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Данные, Тикеты,
		Результат.ТребуетсяАутентификация);
		
	Если Тикеты.Количество() Тогда
		Результат.Тикет = Тикеты.Получить(0);
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
	
КонецПроцедуры

// Выполняет синхронизацию со Сбербанком
//
// Параметры:
//  Параметры - Структура - параметры отправки запроса, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком;
//    * ТекущаяСессия - Структура - параметры установленной сессии со Сбербанком
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата.
//    * Структура - результат выполнения процедуры
//       ** Успех - Булево - признак успешности выполнения синхронизации
//       ** ТребуетсяАутентификация - Булево - сессия "протухла" и требуется повторить аутентификацию
//       ** ИтогКолПолученных - Число - количество полученных документов.
//
Процедура СинхронизироватьДокументыСбербанк(Параметры, АдресРезультата) Экспорт
	
	Результат = Новый Структура("Успех, ТребуетсяАутентификация, ИтогКолПолученных", Ложь, Ложь, 0);
	
	Если Параметры.ТекущаяСессия = Неопределено Тогда
		Результат.ТребуетсяАутентификация = Истина;
		ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	ИдентификаторЗапроса = Строка(Новый УникальныйИдентификатор);
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
		Параметры.НастройкаОбмена, "ИдентификаторОрганизации");
	ТекстЗапроса = ОбменСБанкамиСлужебныйВызовСервера.ТекстЗапросаНочнойВыписки(
		Параметры.НастройкаОбмена, ИдентификаторЗапроса, ИдентификаторОрганизации);
	Данные = Новый Массив;
	Данные.Добавить(ТекстЗапроса);
	Тикеты = Неопределено; ТребуетсяАутентификация = Ложь;
	
	ПараметрыЖурналирования = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыЖурналирования(Параметры.НастройкаОбмена);
	ОтправитьДанныеВСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Данные, Тикеты,
		ТребуетсяАутентификация);
	
	Если ТребуетсяАутентификация Тогда
		Результат.ТребуетсяАутентификация = Истина;
		ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	ОбменСБанкамиСлужебныйВызовСервера.СохранитьИдентификаторы(
		Тикеты, Параметры.НастройкаОбмена, Перечисления.ВидыЭДОбменСБанками.ЗапросНочнойВыписки);
	
	// Получаем результаты по всем ранее отправленным запросам, т.к ответ на стороне банка формируется долго.
	МассивТикетов = ОбменСБанкамиСлужебныйВызовСервера.МассивИдентификаторовЗапроса(
		Параметры.НастройкаОбмена, Перечисления.ВидыЭДОбменСБанками.ЗапросНочнойВыписки);
	ПолучитьИзвещенияПоТикетамСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии,
		ИдентификаторОрганизации, МассивТикетов, Результат.ИтогКолПолученных);
	
	ПолучитьСтатусыПлатежныхДокументовСбербанк(
		Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Результат.ИтогКолПолученных);
		
	Результат.Успех = Истина;
	ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
	
КонецПроцедуры

// Отправляет запрос новых документов в Сбербанк
//
// Параметры:
//  Параметры - Структура - параметры отправки запроса, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком;
//    * ТекущаяСессия - Структура - параметры установленной сессии со Сбербанком
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата
//    * Массив - тикеты, полученные из банка:
//        * Строка - значение тикета.
//
Процедура ОтправитьЗапросНовыхДокументовСбербанк(Параметры, АдресРезультата) Экспорт
	
	ИдентификаторЗапроса = Строка(Новый УникальныйИдентификатор);
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.НастройкаОбмена, "ИдентификаторОрганизации");
	ТекстЗапроса = ОбменСБанкамиСлужебныйВызовСервера.ТекстЗапросаНочнойВыписки(
		Параметры.НастройкаОбмена, ИдентификаторЗапроса, ИдентификаторОрганизации);
	Данные = Новый Массив;
	Данные.Добавить(ТекстЗапроса);
	Тикеты = Неопределено;
	ОтправитьДанныеВСбербанк(
		Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Данные, Тикеты, Неопределено);
	ПоместитьВоВременноеХранилище(Тикеты, АдресРезультата);
	
КонецПроцедуры

// Формирует текст запроса состояния запросов выписок Сбербанка
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - настройка обмена с банком
//  МассивСообщенийОбмена - Массив - сообщения обмена, содержащие запросы выписок.
// 
// Возвращаемое значение:
//  Строка - текст запроса
//
Функция ТекстЗапросаСостоянияЗапросовВыписокСбербанк(НастройкаОбмена, МассивСообщенийОбмена) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СообщениеОбменСБанками.Статус,
	               |	СообщениеОбменСБанками.ПричинаОтклонения,
	               |	СообщениеОбменСБанками.ВнешнийИдентификатор
	               |ИЗ
	               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	               |ГДЕ
	               |	СообщениеОбменСБанками.Ссылка В(&МассивСообщенийОбмена)
	               |	И НЕ СообщениеОбменСБанками.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОбменСБанками.Исполнен)";
	
	Запрос.УстановитьПараметр("МассивСообщенийОбмена", МассивСообщенийОбмена);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	МассивИдентификаторов = Новый Массив;
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.Статус = Перечисления.СтатусыОбменСБанками.ОтклоненБанком Тогда
			ТекстСообщения = НСтр("ru = 'Запрос выписки отклонен по причине: %1'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, Выборка.ПричинаОтклонения);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
		МассивИдентификаторов.Добавить(Выборка.ВнешнийИдентификатор);
	КонецЦикла;
	
	Если МассивИдентификаторов.Количество() Тогда
		ТекстВозврата = ТекстЗапросаСостоянияДокументовСбербанк(НастройкаОбмена, МассивИдентификаторов);
	КонецЕсли;
	
	Возврат ТекстВозврата;
	
КонецФункции

// Отправляет запросы статусов запросов в Сбербанк
//
// Параметры:
//  Параметры - Структура - параметры обработки, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком;
//    * ТекущаяСессия - Структура - параметры установленной сессии;
//    * МассивСообщенийОбмена - Массив - сообщения обмена, содержащие исходные запросы выписок
//        * ДокументСсылка.СообщенияОбменСБанками - сообщение обмена с банком
//  АдресРезультата - Строка - адрес для помещения результата работы процедуры в фоновом процессе.
//
Процедура ОтправитьЗапросыСтатусовЗапросовСбербанк(Параметры, АдресРезультата) Экспорт
	
	ТекстЗапроса = ТекстЗапросаСостоянияЗапросовВыписокСбербанк(
		Параметры.НастройкаОбмена, Параметры.МассивСообщенийОбмена);
		
	Если ТекстЗапроса = Неопределено Тогда // все запросы имеют конечный статус
		ПоместитьВоВременноеХранилище(Неопределено, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	Данные = Новый Массив;
	Данные.Добавить(ТекстЗапроса);
	Тикеты = Неопределено;
	ТребуетсяАутентификация = Ложь;
	ПараметрыЖурналирование = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыЖурналирования(Параметры.НастройкаОбмена);
	ОтправитьДанныеВСбербанк(
		Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, Данные, Тикеты, ТребуетсяАутентификация);
		
	Если ТребуетсяАутентификация Тогда
		ТекстСообщения = НСтр("ru = 'Операция прервана, так как произведен вход под такой же учетной записью с другого места.
									|Смените пароль, если источник входа в систему банка не известен.'");
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(Тикеты, АдресРезультата);
	
КонецПроцедуры

// Получает статусы запросов по тикетам.
//
// Параметры:
//  Параметры - Структура - параметры обработки, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком.
//    * МассивТикетов - Массив - тикеты, по которым необходимо получить извещения:
//         ** Строка - текущий тикет.
//    * ТекущаяСессия - Структура - параметры установленной сессии
//  АдресРезультата - Строка - адрес, по которому будут помещены результаты выполнения.
//
Процедура ПолучитьСтатусыЗапросовСбербанк(Параметры, АдресРезультата) Экспорт
	
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
		Параметры.НастройкаОбмена, "ИдентификаторОрганизации");
		
	МассивОтветов = Новый Массив;
	ПолучитьОтветыПоТикетамСбербанк(Параметры.НастройкаОбмена, Параметры.МассивТикетов,
		Параметры.ТекущаяСессия.ИдентификаторСессии, ИдентификаторОрганизации, МассивОтветов);
		
	Индекс = 0;
	МассивНеобработанныхТикетов = Новый Массив;
		
	Для Каждого Ответ Из МассивОтветов Цикл
		
		Если Ответ = "<!--NOT PROCESSED YET-->" ИЛИ Ответ = "<!--NOT_PROCESSED_YET-->" Тогда
			МассивНеобработанныхТикетов.Добавить(Параметры.МассивТикетов.Получить(Индекс));
		ИначеЕсли Ответ = "<!--REQUEST NOT FOUND-->" ИЛИ Ответ = "<!--REQUEST_NOT_FOUND-->" Тогда
			ТекстОшибки = НСтр("ru = 'На сервере банка произошла ошибка. Повторите операцию позже.'");
			ВызватьИсключение ТекстОшибки
		ИначеЕсли Сред(Ответ, 1, 23) = "00000000-0000-0000-0000" Тогда
			ТекстСообщения = ОбменСБанкамиКлиентСервер.ТекстСообщенияСбербанк(Ответ);
			ВызватьИсключение ТекстСообщения;
		Иначе
			МассивНовыхСообщенийОбмена = Новый Массив;
			КоличествоТомов = 0;
			ИдентификаторЗапроса = Параметры.МассивТикетов.Получить(Индекс);
			ОбменСБанкамиСлужебныйВызовСервера.ОбработатьОтветСбербанка(
				Ответ, Параметры.НастройкаОбмена, МассивНовыхСообщенийОбмена, КоличествоТомов);
			Если КоличествоТомов > 0 Тогда
				ПолучитьБольшойПакетСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии,
					ИдентификаторОрганизации, ИдентификаторЗапроса, КоличествоТомов, МассивНовыхСообщенийОбмена);
			КонецЕсли;
		КонецЕсли;
		Индекс = Индекс + 1;
	КонецЦикла;
	
	ПоместитьВоВременноеХранилище(МассивНеобработанныхТикетов, АдресРезультата);
	
КонецПроцедуры

// Получает идентификатор криптопрофиля по тикету.
//
// Параметры:
//  Параметры - Структура - параметры обработки, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком.
//    * Тикет - Строка - текущий тикет.
//    * ТекущаяСессия - Структура - параметры установленной сессии
//  АдресРезультата - Строка - адрес, по которому будут помещены результаты выполнения.
//
Процедура ПолучитьИдентификаторКриптопрофиляСбербанк(Параметры, АдресРезультата) Экспорт
	
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
		Параметры.НастройкаОбмена, "ИдентификаторОрганизации");
		
	МассивТикетов = Новый Массив;
	МассивТикетов.Добавить(Параметры.Тикет);
		
	МассивОтветов = Новый Массив;
	
	ПолучитьОтветыПоТикетамСбербанк(Параметры.НастройкаОбмена, МассивТикетов, Параметры.ТекущаяСессия.ИдентификаторСессии,
		ИдентификаторОрганизации, МассивОтветов);
		
	Ответ = МассивОтветов.Получить(0);
		
	Если Ответ = "<!--NOT PROCESSED YET-->" ИЛИ Ответ = "<!--NOT_PROCESSED_YET-->" Тогда
	ИначеЕсли Ответ = "<!--REQUEST NOT FOUND-->" ИЛИ Ответ = "<!--REQUEST_NOT_FOUND-->" Тогда
		ТекстОшибки = НСтр("ru = 'На сервере банка произошла ошибка. Повторите операцию позже.'");
		ВызватьИсключение ТекстОшибки
	Иначе
		
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.УстановитьСтроку(Ответ);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML);
	
		Если ЭД.Свойства().Получить("Errors") <> Неопределено Тогда
			ТекстСообщения = "";
			ОбменСБанкамиСлужебныйВызовСервера.ОбработатьИзвещениеСОшибкойСбербанк(Ответ, ТекстСообщения);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
		
		Если ЭД.Tickets.Ticket.Info.statusStateCode = "FAIL" Тогда
			ТекстСообщения = НСтр("ru = 'Получена ошибка из банка:
										|""%1""'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, ЭД.Tickets.Ticket.Info.MsgFromBank.Message);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
	
		ИдентификаторКриптопрофиля = ЭД.SmsCryptoProfile;
	КонецЕсли;
		
	ПоместитьВоВременноеХранилище(ИдентификаторКриптопрофиля, АдресРезультата);
	
КонецПроцедуры

// Получает результат проверки SMS из банка.
//
// Параметры:
//  Параметры - Структура - параметры обработки, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком.
//    * Тикет - Строка - текущий тикет.
//    * ТекущаяСессия - Структура - параметры установленной сессии
//    * СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками - платежный документ
//  АдресРезультата - Строка - адрес, по которому будут помещены результаты выполнения.
//
Процедура ПолучитьРезультатПроверкиSMSСбербанк(Параметры, АдресРезультата) Экспорт
	
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
		Параметры.НастройкаОбмена, "ИдентификаторОрганизации");
		
	МассивТикетов = Новый Массив;
	МассивТикетов.Добавить(Параметры.Тикет);
		
	МассивОтветов = Новый Массив;
	ПолучитьОтветыПоТикетамСбербанк(Параметры.НастройкаОбмена, МассивТикетов, Параметры.ТекущаяСессия.ИдентификаторСессии,
		ИдентификаторОрганизации, МассивОтветов);
		
	Ответ = МассивОтветов.Получить(0);
		
	Если Ответ = "<!--NOT PROCESSED YET-->" ИЛИ Ответ = "<!--NOT_PROCESSED_YET-->" Тогда
		ПоместитьВоВременноеХранилище(Неопределено, АдресРезультата);
	ИначеЕсли Ответ = "<!--REQUEST NOT FOUND-->" ИЛИ Ответ = "<!--REQUEST_NOT_FOUND-->" Тогда
		ТекстОшибки = НСтр("ru = 'На сервере банка произошла ошибка. Повторите операцию позже.'");
		ВызватьИсключение ТекстОшибки
	Иначе
		
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.УстановитьСтроку(Ответ);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML);
		
		Если ЭД.Свойства().Получить("Errors") <> Неопределено Тогда
			Если ЭД.Errors.Error.Code = "106" Тогда
				ВызватьИсключение Нстр("ru = 'Неверно указан одноразовый пароль из SMS для подтверждения платежа.'"); 
			Иначе
				ТекстСообщения = "";
				ОбменСБанкамиСлужебныйВызовСервера.ОбработатьИзвещениеСОшибкойСбербанк(Ответ, ТекстСообщения);
				ВызватьИсключение ТекстСообщения;
			КонецЕсли;
		КонецЕсли;
		
		Тикет = ЭД.Tickets.Ticket;
		ОбменСБанкамиСлужебныйВызовСервера.ПрочитатьТикетСбербанка(Параметры.НастройкаОбмена, Тикет);

		ПоместитьВоВременноеХранилище(ЭД.Tickets.Ticket.Info.statusStateCode = "ACCEPTED", АдресРезультата);

	КонецЕсли;
	
КонецПроцедуры

// Получить ответы по тикетам из Сбербанка
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком.
//  МассивТикетов - Массив - массив тикетов
//     * Строка - тикет
//  ИдентификаторСессии - Строка - идентификатор установленной сессии
//  ИдентификаторОрганизации - Строка - идентификатор организации в системе Сбербанка
//  МассивОтветов - Массив - ответы Сбербанка:
//     * Строка - ответ Сбербанка.
//
Процедура ПолучитьОтветыПоТикетамСбербанк(Знач НастройкаОбмена, Знач МассивТикетов, Знач ИдентификаторСессии, Знач ИдентификаторОрганизации, МассивОтветов) Экспорт
	
	ТекстОшибки = "";
	
	WSПрокси = ОбменСБанкамиСлужебныйПовтИсп.WSПроксиСбербанк();
	
	МаксимальноеКоличествоЗапросов = 20;
	МассивОтветов = Новый Массив;
	ПоОдному = Ложь;
	
	Пока МассивТикетов.Количество() Цикл
	
		ПолучениеСтатусаТип = WSПрокси.ФабрикаXDTO.Тип("http://upg.sbns.bssys.com/", "getRequestStatusSRP");
		ВыбранныйЭлемент = WSПрокси.ФабрикаXDTO.Создать(ПолучениеСтатусаТип);
		
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "sessionId", ИдентификаторСессии, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "orgId", ИдентификаторОрганизации, Истина, ТекстОшибки);
		
		Если ЗначениеЗаполнено(ТекстОшибки) Тогда
			ШаблонСообщения = НСтр("ru = 'Ошибка запроса статуса документа:
										|%1'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, ТекстОшибки);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
		
		Счетчик = 0;
		ОтправленныеТикеты = Новый Массив;
		Для Каждого Тикет Из МассивТикетов Цикл
			ВыбранныйЭлемент.requests.Добавить(Тикет);
			ОтправленныеТикеты.Добавить(Тикет);
			Счетчик = Счетчик + 1;
			Если Счетчик = МаксимальноеКоличествоЗапросов ИЛИ ПоОдному Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		ВыбранныйЭлемент.Проверить();
		
		Попытка
			XDTOРезультат = WSПрокси.getRequestStatusSRP(ВыбранныйЭлемент);
		Исключение
			ДобавитьЗаписьВЖурнал(
				НастройкаОбмена, "getRequestStatusSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
			Если Не ПоОдному Тогда
				ПоОдному = Истина;
				Продолжить;
			КонецЕсли;
			ВызватьИсключение
		КонецПопытки;
		
		МассивТикетов = ОбщегоНазначенияКлиентСервер.РазностьМассивов(МассивТикетов, ОтправленныеТикеты);
		
		ДобавитьЗаписьВЖурнал(НастройкаОбмена, "getRequestStatusSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
			
		Для Каждого Ответ Из XDTOРезультат.return Цикл
			МассивОтветов.Добавить(Ответ);
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

// Подготавливает структуру данных для отправки в Сбербанк. Также осуществляется попытка сразу же отправить запросы.
//
// Параметры:
//   Параметры - Структура - параметры выполнения операции в фоновом процессе, содержит поля:
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка прямого обмена с банком;
//    * ДатаНачала - Дата - дата начала периода запроса выписки;
//    * ДатаОкончания - Дата - дата окончания периода запроса выписки;
//    * НомерСчета - Строка - номер банковского счета или Неопределено;
//    * ФормироватьПринудительно - Булево - формировать запрос даже при наличии выписок за указанный период;
//    * ТекущаяСессия - Структура, Неопределено - параметры текущей сессии.
//   АдресРезультата - Строка - адрес, по которому нужно поместить данные. Содержит структуру с полями:
//     * МассивСообщенийОбмена - Массив - содержит сформированные запросы выписок
//        ** ДокументСсылка.СообщениеОбменСБанками - сформированное сообщение запроса выписки банка.
//     * ГотовыеВыписки - Массив - (возвращаемое значение) найденные готовые выписки за период
//        ** ДокументСсылка.СообщениеОбменСБанками - ссылка на сообщение с выпиской.
//     * ИспользуетсяТокен - Булево - при обмене нужно использовать токен.
//     * МассивТикетов - Массив - полученные из банка тикеты
//        ** Строка - тикет, полученный на запрос.
//
Процедура СформироватьИОтправитьЗапросыВыписокСбербанк(Параметры, АдресРезультата) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("МассивСообщенийОбмена", Новый Массив);
	СтруктураВозврата.Вставить("ГотовыеВыписки", Новый Массив);
	СтруктураВозврата.Вставить("ИспользуетсяТокен", Ложь);
	СтруктураВозврата.Вставить("МассивТикетов", Новый Массив);
	
	ЕстьОшибка = Ложь;
	ИдентификаторЗапроса = "";
	
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		Параметры.НастройкаОбмена, "Организация, Банк, ПрограммаБанка, ИдентификаторОрганизации, ИспользуетсяКриптография");
		
	СтруктураВозврата.ИспользуетсяТокен = РеквизитыНастройкиОбмена.ИспользуетсяКриптография;
		
	МассивБанковскихСчетов = Новый Массив;
	Если ЗначениеЗаполнено(Параметры.НомерСчета) Тогда
		МассивБанковскихСчетов.Добавить(Параметры.НомерСчета);
	Иначе
		ОбменСБанкамиПереопределяемый.ПолучитьНомераБанковскихСчетов(
			РеквизитыНастройкиОбмена.Организация, РеквизитыНастройкиОбмена.Банк, МассивБанковскихСчетов);
	КонецЕсли;
	
	Если НЕ Параметры.ФормироватьПринудительно Тогда
		СтруктураВозврата.ГотовыеВыписки = ГотовыеВыпискиСбербанка(
			Параметры.НастройкаОбмена, МассивБанковскихСчетов, Параметры.ДатаНачала, Параметры.ДатаОкончания);
		Если СтруктураВозврата.ГотовыеВыписки.Количество() Тогда
			ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресРезультата);
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураВозврата.МассивСообщенийОбмена = Новый Массив;
	
	КоличествоДней = (НачалоДня(Параметры.ДатаОкончания) - Параметры.ДатаНачала) / 60 / 60 / 24 + 1;

	Для Счетчик = 1 По КоличествоДней Цикл
		
		Для Каждого НомерСчета Из МассивБанковскихСчетов Цикл
			
			ДатаЗапроса = Параметры.ДатаНачала + (Счетчик - 1) * 60 * 60 * 24;
			ДанныеЗапроса = ДанныеЗапросаВыпискиСбербанк(
				Параметры.НастройкаОбмена, ДатаЗапроса, НомерСчета, ИдентификаторЗапроса);
				
			АдресФайла = ПоместитьВоВременноеХранилище(ДанныеЗапроса);
			ИмяФайла = НСтр("ru = 'Запрос выписки за %1'");
			ИмяФайла = СтрШаблон(ИмяФайла, Формат(ДатаЗапроса, "ДЛФ=D"));
			
			СтруктураРеквизитов = Новый Структура;
			СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
			СтруктураРеквизитов.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки);
			СтруктураРеквизитов.Вставить("НастройкаОбмена", Параметры.НастройкаОбмена);
			СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
			СтруктураРеквизитов.Вставить("ПредставлениеДокумента", ИмяФайла);
			СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресФайла);
			СтруктураРеквизитов.Вставить("Идентификатор", ИдентификаторЗапроса);
			СтруктураРеквизитов.Вставить("СсылкаНаОбъект", Параметры.НастройкаОбмена);
			СтруктураРеквизитов.Вставить("НомерСчета", НомерСчета);
			СтруктураРеквизитов.Вставить("ДатаСообщения", ДатаЗапроса);
			СообщениеЗапрос = Неопределено;
			СохранитьСообщениеОбмена(СтруктураРеквизитов, СообщениеЗапрос);

			Если РеквизитыНастройкиОбмена.ИспользуетсяКриптография Тогда
				ДайджестBase64 = ОбменСБанкамиСлужебныйВызовСервера.ДайджестСбербанк(
					Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки, АдресФайла, Параметры.НастройкаОбмена);

				ПодписанныеДанные = Base64Значение(ДайджестBase64);
				
				АдресХранилища = ПоместитьВоВременноеХранилище(ПодписанныеДанные);
				
				СтруктураРеквизитов = Новый Структура;
				СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
				СтруктураРеквизитов.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ДополнительныеДанные);
				СтруктураРеквизитов.Вставить("НастройкаОбмена", Параметры.НастройкаОбмена);
				СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
				СтруктураРеквизитов.Вставить("ПредставлениеДокумента", НСтр("ru = 'Схема данных'"));
				СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресХранилища);
				СтруктураРеквизитов.Вставить("СообщениеРодитель", СообщениеЗапрос);
				СохранитьСообщениеОбмена(СтруктураРеквизитов);
			КонецЕсли;

			СтруктураВозврата.МассивСообщенийОбмена.Добавить(СообщениеЗапрос);
			
		КонецЦикла;
		
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Параметры.ТекущаяСессия) Тогда // попытка сразу же отправить запросы выписок
		ДанныеДляОтправки = Новый Структура;
		ДанныеДляОтправки.Вставить("МассивСообщенийОбмена", СтруктураВозврата.МассивСообщенийОбмена);
		ДанныеДляОтправки.Вставить("НастройкаОбмена", Параметры.НастройкаОбмена);
		ДанныеДляОтправки.Вставить("ТекущаяСессия", Параметры.ТекущаяСессия);
		ДанныеДляОтправки.Вставить("ПолучитьСтатусыДокументов", Ложь);
		ДанныеДляОтправки.Вставить("АдресРезультата");
		ДанныеДляОтправки.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки);
		ОтправитьДокументыВСбербанкБазоваяАутентификация(ДанныеДляОтправки);
		РезультатОтправки = ПолучитьИзВременногоХранилища(ДанныеДляОтправки.АдресРезультата);
		Если НЕ РезультатОтправки.ТребуетсяАутентификация Тогда
			СтруктураВозврата.МассивТикетов = РезультатОтправки.МассивТикетов;
		КонецЕсли;
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресРезультата);

КонецПроцедуры

// Отправляет документы в Сбербанк на сервере без использования токена.
//
// Параметры:
//  Параметры - Структура - параметры отправки документов, содержит поля:
//     * МассивСообщенийОбмена - Массив - сообщения для отправки в банк
//         ** ДокументСсылка.СообщенияОбменСБанками- сообщение обмена с банком
//     * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком
//     * ТекущаяСессия - Структура - параметры установленной сессии с банком, содержит поля:
//          ** ФродПараметры - ФиксированнаяСтруктура - параметры фрод-мониторинга
//          ** ИдентификаторСессии - Строка - идентификатор установленной сессии
//     * ПолучитьНовыеДокументы - Булево - если Истина, то необходимо получить новые документы после отправки.
//     * ВидЭД - ПеречислениеСсылка.ВидыЭДОбменСБанками - вид отправляемого электронного документа.
//     * АдресРезультата - Строка - адрес временного хранилища для результата, если процедура вызывалась не в фоновом задании.
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата.
//      * Структура - результат выполнения процедуры, содержит следующие поля:
//          ** ОтправленныеДокументы - Массив - содержит ссылки на отправленные документы информационной базы
//               *** ДокументСсылка - владелец электронного документа.
//          ** ИтогКолПолученных - Число - содержит ссылки на отправленные документы информационной базы
//          ** ТребуетсяАутентификация - Булево - признак, что идентификатор сессии протух.
//          ** МассивТикетов - Массив - полученные из банка тикеты:
//               *** Строка - тикет запроса.
//          ** СообщенияТребуютПодтверждения - Массив - сообщения обмена, которые требуют подтверждения.
//               *** ДокументСсылка.СообщениеОбменСБанками - ссылка на сообщение обмена с банком.
//
Процедура ОтправитьДокументыВСбербанкБазоваяАутентификация(Параметры, АдресРезультата = Неопределено) Экспорт

	Результат = Новый Структура;
	Результат.Вставить("ТребуетсяАутентификация", Ложь);
	Результат.Вставить("МассивТикетов", Новый Массив);
	Результат.Вставить("ИтогКолПолученных", 0);
	Результат.Вставить("СообщенияТребуютПодтверждения", Новый Массив);
	Результат.Вставить("ОтправленныеДокументы", Новый Массив);

	Если Параметры.МассивСообщенийОбмена.Количество() = 0 Тогда
		Параметры.АдресРезультата = ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	МассивДанных = Новый Массив;
	
	Для Каждого СообщениеОбмена Из Параметры.МассивСообщенийОбмена Цикл
		ПакетXML = ОбменСБанкамиСлужебныйВызовСервера.ПакетXMLСбербанка(
			СообщениеОбмена, Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ФродПараметры, Параметры.ТекущаяСессия.Логин);
		МассивДанных.Добавить(ПакетXML);
	КонецЦикла;

	ОтправитьДанныеВСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии, МассивДанных,
		Результат.МассивТикетов, Результат.ТребуетсяАутентификация, Параметры.МассивСообщенийОбмена);
	
	Если Результат.ТребуетсяАутентификация Тогда
		Параметры.АдресРезультата = ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
		Возврат;
	КонецЕсли;
	
	// Программа сразу ждет выписки по запросам, поэтому хранить тикеты не требуется.
	Если Параметры.ВидЭД <> Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки Тогда
		ОбменСБанкамиСлужебныйВызовСервера.СохранитьИдентификаторы(
			Результат.МассивТикетов, Параметры.НастройкаОбмена, Параметры.ВидЭД);
	КонецЕсли;

	Для Каждого СообщениеОбмена Из Параметры.МассивСообщенийОбмена Цикл
		ОбменСБанкамиСлужебныйВызовСервера.УстановитьСтатусСообщенияОбмена(
			СообщениеОбмена, Перечисления.СтатусыОбменСБанками.Отправлен);
	КонецЦикла;
	
	ОтправленныеДокументы = ОбменСБанкамиСлужебныйВызовСервера.ВладельцыСообщенийОбмена(Параметры.МассивСообщенийОбмена);
	
	Результат.ОтправленныеДокументы = ОтправленныеДокументы;
	
	Если Параметры.ПолучитьСтатусыДокументов Тогда // только для платежных поручений
		МассивТикетов = Новый Массив;
		ПолучитьСтатусыПлатежныхДокументовСбербанк(Параметры.НастройкаОбмена, Параметры.ТекущаяСессия.ИдентификаторСессии,
			Результат.ИтогКолПолученных, Параметры.МассивСообщенийОбмена);
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Результат.СообщенияТребуютПодтверждения, Параметры.МассивСообщенийОбмена);
	КонецЕсли;
	
	Параметры.АдресРезультата = ПоместитьВоВременноеХранилище(Результат, АдресРезультата);
	
КонецПроцедуры

// Отправляет данные в сбербанк без использования токена.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком.
//  ИдентификаторСессии - Строка - идентификатор открытой сессии
//  Данные - Массив - данные документов, отправляемых в банк
//   * Строка - данные документа, отправляемого в банк
//  Тикеты - Массив - тикеты, полученные из банка
//   * Строка - тикет на запрос
//  ТребуетсяАутентификация - Булево - (возвращаемое значение) признак, что идентификатор сессии протух.
//  МассивСообщенийОбмена - Массив - отправляемые в банк электронные документы
//     * ДокументСсылка.СообщенияОбменСБанками - ссылка на сообщение обмена.
//
Процедура ОтправитьДанныеВСбербанк(Знач НастройкаОбмена, Знач ИдентификаторСессии, Знач Данные, Тикеты, ТребуетсяАутентификация = Ложь, МассивСообщенийОбмена = Неопределено) Экспорт
	
	Тикеты = Новый Массив;
	
	ТекстОшибки = "";
	Если МассивСообщенийОбмена = Неопределено Тогда // для запросов не нужен большой таймаут
		WSПрокси = ОбменСБанкамиСлужебныйПовтИсп.WSПроксиСбербанк();
	Иначе
		// Документы отправляются через длительные операции, таймаут не устанавливается
		WSПрокси = ОбменСБанкамиСлужебныйПовтИсп.WSПроксиСбербанк(0);
	КонецЕсли;
	
	МаксимальноеКоличествоЭлементов = 100;
	Индекс = 0;
	
	Пока Данные.Количество() Цикл
	
		ОтправкаЗапросаТип = WSПрокси.ФабрикаXDTO.Тип("http://upg.sbns.bssys.com/", "sendRequestsSRP");
		ВыбранныйЭлемент = WSПрокси.ФабрикаXDTO.Создать(ОтправкаЗапросаТип);
		
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "sessionId", ИдентификаторСессии, Истина, ТекстОшибки);
		Счетчик = 0;
		ОтправленныеДанные = Новый Массив;
		Для Каждого ДанныеДокумента Из Данные Цикл
			ВыбранныйЭлемент.requests.Добавить(ДанныеДокумента);
			ОтправленныеДанные.Добавить(ДанныеДокумента);
			Счетчик = Счетчик + 1;
			Если Счетчик = МаксимальноеКоличествоЭлементов Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Данные = ОбщегоНазначенияКлиентСервер.РазностьМассивов(Данные, ОтправленныеДанные);
		
		Если ЗначениеЗаполнено(ТекстОшибки) Тогда
			ШаблонСообщения = НСтр("ru = 'Ошибка формирования пакета данных:
										|%1'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, ТекстОшибки);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
		
		ВыбранныйЭлемент.Проверить();
		
		Попытка
			XDTOРезультат = WSПрокси.sendRequestsSRP(ВыбранныйЭлемент);
		Исключение
			ДобавитьЗаписьВЖурнал(НастройкаОбмена, "sendRequestsSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
			ВызватьИсключение;
		КонецПопытки;
		
		ДобавитьЗаписьВЖурнал(НастройкаОбмена, "sendRequestsSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
		
		Для Каждого Ответ Из XDTOРезультат.return Цикл
			Если Ответ = "00000000-0000-0000-0000-000000000002" Тогда
				ТребуетсяАутентификация = Истина;
				Возврат;
			ИначеЕсли Сред(Ответ, 1, 23) = "00000000-0000-0000-0000" Тогда
				ТекстСообщения = ОбменСБанкамиКлиентСервер.ТекстСообщенияСбербанк(Ответ);
				ВызватьИсключение ТекстСообщения;
			ИначеЕсли Ответ = "<!--REQUESTID_DUBLIC-->" Тогда
				Если МассивСообщенийОбмена = Неопределено Тогда
					ТекстСообщения = НСтр("ru = 'Электронный документ с таким идентификатором уже есть в базе банка.'") ;
					ВызватьИсключение ТекстСообщения;
				Иначе // вероятно отправка была прервана пользователем
					СообщениеОбмена = МассивСообщенийОбмена.Получить(Индекс);
					Тикеты.Добавить(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеОбмена, "Идентификатор"));
				КонецЕсли;
			ИначеЕсли СтрДлина(Ответ) = 36 Тогда // уникальный идентификатор
				Тикеты.Добавить(Ответ);
			Иначе
				ТекстОшибки = "";
				ОбменСБанкамиСлужебныйВызовСервера.ОбработатьИзвещениеСОшибкойСбербанк(Ответ, ТекстОшибки);
				ВызватьИсключение ТекстОшибки;
			КонецЕсли;
			Индекс = Индекс + 1;
		КонецЦикла;
		
	КонецЦикла
	
КонецПроцедуры

#КонецОбласти

#Область НастройкиОбменаСБанками

// Загружает актуальный список банков с сайта 1С.
//
Процедура ЗагрузитьСписокБанковССайта() Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	АдресСервера = "https://directbank.1c.ru/downloads/bankslist.mxl";
	
	ПараметрыПолучения = Новый Структура;
	ПараметрыПолучения.Вставить("Таймаут", 60);
	
	Результат = ПолучениеФайловИзИнтернета.СкачатьФайлВоВременноеХранилище(АдресСервера, ПараметрыПолучения);
	
	Если Результат.Статус Тогда
		
		Данные = ПолучитьИзВременногоХранилища(Результат.Путь);
		
		// Проверка, что файл корректный.
		ВремФайл = ПолучитьИмяВременногоФайла("mxl");
		Данные.Записать(ВремФайл);
		Макет = Новый ТабличныйДокумент;
		Попытка
			Макет.Прочитать(ВремФайл);
		Исключение
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ВидОперации = НСтр("ru = 'Чтение файла списка банков, поддерживающих обмен через сервис 1С:ДиректБанк.'");
			КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			ШаблонОшибки = НСтр("ru = 'Ошибка выполнения операции: %1
							|%2'");
			ТекстОшибки = СтрШаблон(ШаблонОшибки, ВидОперации, КраткоеПредставлениеОшибки);
			
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробноеПредставлениеОшибки, ТекстОшибки, "ОбменСБанками");
			
			Возврат;
		КонецПопытки;
	
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
		
		ДанныеВнешнихФайлов = Константы.ОбщиеФайлыОбменСБанками.Получить().Получить();
	
		Если ДанныеВнешнихФайлов = Неопределено Тогда
			ДанныеВнешнихФайлов = Новый Структура;
		КонецЕсли;

		ДанныеВнешнихФайлов.Вставить("СписокБанков", Данные);
	
		ХранилищеДанных = Новый ХранилищеЗначения(ДанныеВнешнихФайлов);
	
		Константы.ОбщиеФайлыОбменСБанками.Установить(ХранилищеДанных);
	
		ОбновитьПовторноИспользуемыеЗначения();
		
	ИначеЕсли ЗначениеЗаполнено(Результат.СообщениеОбОшибке) Тогда
		
		ВидОперации = НСтр("ru = 'Загрузка списка банков, поддерживающих обмен DirectBank'");
		ШаблонОшибки = НСтр("ru = 'Выполнение операции: %1
							|%2'");
		ТекстОшибки = СтрШаблон(ШаблонОшибки, ВидОперации, Результат.СообщениеОбОшибке);
		УровеньВажностиСобытия = УровеньЖурналаРегистрации.Предупреждение;
		Шаблон = НСтр("ru = 'Электронное взаимодействие.Обмен с банками'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		ЗаписьЖурналаРегистрации(Шаблон, УровеньВажностиСобытия, , , ТекстОшибки);

	КонецЕсли;
	
КонецПроцедуры


// Формирует таблицу банков для которых возможна настройка обмена через 1С:ДиректБанк.
//
// Параметры:
//  ПараметрыОтбора - Структура - структура с ключами:
//   * Организация    - ОпределяемыйТип.Организация - организация, по которой необходимо установить фильтр (необязательный);
//   * Банк           - ОпределяемыйТип.СправочникБанки - банк, по которому необходимо установить фильтр (необязательный);
//   * БанковскийСчет - СправочникСсылка.БанковскиеСчетаОрганизаций - банковский счет, по которому необходимо установить фильтр (необязательный).
//  Проект - Строка - Признак проекта, которые поддерживает банк.
//
// Возвращаемое значение:
//   Таблица или Неопределено - банки доступные для настройки обмена через 1С:ДиректБанк.
Функция БанкиДляНастройкиОбменаЧерезДиректБанк(ПараметрыОтбора = Неопределено, Проект = "1") Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	ИмяСправочникаБанковскиеСчета = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяПрикладногоСправочника("БанковскиеСчетаОрганизаций");
	ИмяСправочникаОрганизации = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяПрикладногоСправочника("Организации");
	
	Если ИмяСправочникаБанковскиеСчета = Неопределено
		ИЛИ ИмяСправочникаОрганизации  = Неопределено Тогда 
		
		Возврат Неопределено;
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	БанковскиеСчета.Владелец КАК Организация,
		|	БанковскиеСчета.Банк КАК Банк,
		|	БанковскиеСчета.Банк.Код КАК БИК
		|ПОМЕСТИТЬ ВТ_БанкиДляОбмена
		|ИЗ
		|	&БанковскиеСчетаОрганизаций КАК БанковскиеСчета
		|ГДЕ
		|	НЕ БанковскиеСчета.ПометкаУдаления
		|	И БанковскиеСчета.Владелец = &Ссылка_Справочник_Организации
		|{ГДЕ
		|	БанковскиеСчета.Владелец КАК Организация,
		|	БанковскиеСчета.Банк КАК Банк,
		|	БанковскиеСчета.Ссылка КАК БанковскийСчет}
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	Банк
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_БанкиДляОбмена.Организация КАК Организация,
		|	ВТ_БанкиДляОбмена.Банк КАК Банк,
		|	ВТ_БанкиДляОбмена.БИК КАК БИК
		|ИЗ
		|	ВТ_БанкиДляОбмена КАК ВТ_БанкиДляОбмена
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками КАК НастройкиОбменСБанками
		|		ПО ВТ_БанкиДляОбмена.Банк = НастройкиОбменСБанками.Банк
		|			И ВТ_БанкиДляОбмена.Организация = НастройкиОбменСБанками.Организация
		|			И (НЕ НастройкиОбменСБанками.Недействительна)
		|			И (НЕ НастройкиОбменСБанками.ПометкаУдаления)
		|ГДЕ
		|	НастройкиОбменСБанками.Банк ЕСТЬ NULL";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&БанковскиеСчетаОрганизаций", "Справочник." + ИмяСправочникаБанковскиеСчета);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "= &Ссылка_Справочник_Организации", "ССЫЛКА Справочник." + ИмяСправочникаОрганизации);
		
	Построитель = Новый ПостроительЗапроса(ТекстЗапроса);
	
	Если ЗначениеЗаполнено(ПараметрыОтбора) Тогда
		Для Каждого Параметр Из ПараметрыОтбора Цикл
			ЭлементОтбора = Построитель.Отбор.Добавить(Параметр.Ключ);
			ЭлементОтбора.Использование = Истина;
			ЭлементОтбора.ВидСравнения = ВидСравнения.Равно;
			ЭлементОтбора.Значение = Параметр.Значение;
		КонецЦикла;
	КонецЕсли;
	
	Построитель.Выполнить();
	РезультатЗапроса = Построитель.Результат;
		
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	БанкиБезНастройкиОбмена = РезультатЗапроса.Выгрузить();
		
	БанкиCПоддержкойDirectBank = БанкиБезНастройкиОбмена.СкопироватьКолонки("Организация,Банк");
	
	ТабДок = ОбменСБанкамиСлужебныйПовтИсп.СписокБанков();

	КоличествоЗаписей = ТабДок.ВысотаТаблицы;
	
	Для Индекс = 2 По КоличествоЗаписей Цикл
		
		СпособПолученияНастроекСтрокой = ТабДок.Область(Индекс, 4).Текст;
		Если ПустаяСтрока(СпособПолученияНастроекСтрокой) Тогда
			Продолжить;
		КонецЕсли;
		
		ПроектыСтрокой = ТабДок.Область(Индекс, 8).Текст;
		
		Если СтрНайти(ПроектыСтрокой, Проект) Тогда
			
			БИКБанка = ТабДок.Область(Индекс, 2).Текст;
			СтруктураОтбора = Новый Структура("БИК", БИКБанка);
			НайденныеСтроки = БанкиБезНастройкиОбмена.НайтиСтроки(СтруктураОтбора);
			
			Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				НоваяСтрока = БанкиCПоддержкойDirectBank.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, НайденнаяСтрока, "Организация,Банк");
				БанкиБезНастройкиОбмена.Удалить(НайденнаяСтрока);
			КонецЦикла;
			
			Если БанкиБезНастройкиОбмена.Количество() = 0 Тогда
				Прервать;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
		
	Возврат БанкиCПоддержкойDirectBank;
	
КонецФункции

#КонецОбласти

#Область ОбменЧерезВнешнююОбработку

// Сохраняет внешнюю обработку в базе данных.
//
// Параметры:
//    АдресВнешнегоМодуля - АдресВременногоХранилища - содержит двоичные данные внешнего модуля;
//    Версия - Строка - версия внешнего модуля;
//    ИмяМодуля - Строка - имя внешнего модуля;
//    Наименование - Строка - наименование внешнего модуля.
//
Процедура СохранитьВнешнююОбработку(АдресВнешнегоМодуля, Версия, ИмяМодуля, Наименование) Экспорт

	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеВнешнихМодулей = Константы.ВнешниеФайлыОбменСБанками.Получить().Получить();
	
	Если ДанныеВнешнихМодулей = Неопределено Тогда
		ДанныеВнешнихМодулей = Новый Структура;
	КонецЕсли;

	Если НЕ ДанныеВнешнихМодулей.Свойство("ВнешниеОбработки") Тогда
		ДанныеВнешнихМодулей.Вставить("ВнешниеОбработки", Новый Соответствие);
	КонецЕсли;
	
	ДвоичныеДанныеМодуля = ПолучитьИзВременногоХранилища(АдресВнешнегоМодуля);
	СтруктураДанных = Новый Структура();
	СтруктураДанных.Вставить("Версия", Версия);
	СтруктураДанных.Вставить("Наименование", Наименование);
	СтруктураДанных.Вставить("ДвоичныеДанныеМодуля", ДвоичныеДанныеМодуля);
	
	ДанныеВнешнихМодулей.ВнешниеОбработки.Вставить(ИмяМодуля, СтруктураДанных);
	
	ХранилищеДанных = Новый ХранилищеЗначения(ДанныеВнешнихМодулей);
	
	Константы.ВнешниеФайлыОбменСБанками.Установить(ХранилищеДанных);
	
	ОбновитьПовторноИспользуемыеЗначения();
	
КонецПроцедуры

// Подключает внешнюю обработку.
//
// Параметры:
//   АдресФайла - АдресВременногоХранилища - содержит двоичные данные файла внешней обработки;
//   ИмяОбъекта - Строка - возвращает имя подключенной внешней обработки.
//
Процедура ПодключитьВнешнююОбработку(Знач АдресФайла, ИмяОбъекта) Экспорт

	Попытка
		Менеджер = ВнешниеОбработки;
		Если ОбщегоНазначения.ЕстьЗащитаОтОпасныхДействий() Тогда
			ИмяОбъекта = Менеджер.Подключить(АдресФайла, , Ложь, ОбщегоНазначения.ОписаниеЗащитыБезПредупреждений());
		Иначе
			ИмяОбъекта = Менеджер.Подключить(АдресФайла, , Ложь);
		КонецЕсли;
	Исключение
		ВидОперации = НСтр("ru = 'Подключение внешней обработки'");
		ТекстСообщения = НСтр("ru = 'При подключении внешнего модуля произошла ошибка'");
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, ТекстСообщения, "ОбменСБанками");
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область СтроковыеКонстанты

// Возвращает пространство имен используемой схемы для асинхронного обмена с банком.
//
// Параметры:
//  ВерсияФормата - Строка - версия формата обмена.
// 
// Возвращаемое значение:
// Строка - пространство имен.
//
Функция ПространствоИменАсинхронногоОбмена(ВерсияФормата) Экспорт
	
	Если ВерсияФормата = "2.1.1" ИЛИ ВерсияФормата = "2.1.2" Тогда
		URI = "http://directbank.1c.ru/XMLSchema";
	Иначе
		URI = "http://bank.1c.ru/XMLSchema";
	КонецЕсли;
	Возврат URI;
	
КонецФункции

#КонецОбласти

#Область ОбработкаСообщенийОбмена

// Только для внутреннего использования
Функция СлужебноеСообщениеБанка(ИсходноеСообщение) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	СообщениеОбменСБанками.Ссылка
	               |ИЗ
	               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	               |ГДЕ
	               |	СообщениеОбменСБанками.ВидЭД = ЗНАЧЕНИЕ(Перечисление.ВидыЭДОбменСБанками.ДополнительныеДанные)
	               |	И СообщениеОбменСБанками.СообщениеРодитель = &ИсходноеСообщение";
	Запрос.УстановитьПараметр("ИсходноеСообщение", ИсходноеСообщение);
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Следующий() Тогда
		Возврат Результат.Ссылка;
	КонецЕсли
	
КонецФункции

Функция ДокументПодписываетсяПоМаршруту(СообщениеОбмена) Экспорт

	Если ТипЗнч(СообщениеОбмена) = Тип("ДокументОбъект.СообщениеОбменСБанками") Тогда
		ВидЭД = СообщениеОбмена.ВидЭД;
	Иначе
		ВидЭД = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеОбмена, "ВидЭД");
	КонецЕсли;
	
	Возврат ОбменСБанкамиСлужебныйПовтИсп.ВидыДокументовПодписываемыхПоМаршруту(Ложь).Найти(ВидЭД) <> Неопределено;

КонецФункции

// Создает сообщение обмена
//
// ПараметрыСообщения - Структура - реквизиты сообщения, названия ключей соответствуют названиям реквизитов.
// НовоеСообщениеСсылка - ДокументСсылка.СообщениеОбменСБанками - (возвращаемое значение) ссылка на созданный документ.
//
// Возвращаемое значение:
// Булево - признак того, что новое сообщение обмена сохранено.
//
Процедура СохранитьСообщениеОбмена(Знач ПараметрыСообщения, НовоеСообщениеСсылка = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	Если ПараметрыСообщения.Свойство("ВнешнийИдентификатор")
		И ПараметрыСообщения.Свойство("НастройкаОбмена") Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ВнешнийИдентификатор", ПараметрыСообщения.ВнешнийИдентификатор);
		Запрос.УстановитьПараметр("НастройкаОбмена", ПараметрыСообщения.НастройкаОбмена);
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		               |	СообщениеОбменСБанками.Ссылка
		               |ИЗ
		               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
		               |ГДЕ
		               |	СообщениеОбменСБанками.НастройкаОбмена = &НастройкаОбмена
		               |	И СообщениеОбменСБанками.ВнешнийИдентификатор = &ВнешнийИдентификатор
		               |	И НЕ СообщениеОбменСБанками.ПометкаУдаления";
		Если Не Запрос.Выполнить().Пустой() Тогда
			Выборка = Запрос.Выполнить().Выбрать();
			Выборка.Следующий();
			ТекстСообщения = НСтр("ru = 'В информационной базе уже есть электронный документ с таким же внешним идентификатором.
										|Электронный документ: %1
										|Внешний идентификатор: %2'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, Выборка.Ссылка, ПараметрыСообщения.ВнешнийИдентификатор);
			ВидОперации = НСтр("ru = 'Сохранение сообщения обмена в информационной базе.'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ТекстСообщения, , "ОбменСБанками", Выборка.Ссылка);
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	НовоеСообщениеОбъект = Документы.СообщениеОбменСБанками.СоздатьДокумент();
	
	Если ПараметрыСообщения.Свойство("Статус") Тогда
		ПараметрыСообщения.Вставить("ДатаИзмененияСтатуса", ТекущаяДатаСеанса());
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(НовоеСообщениеОбъект, ПараметрыСообщения);
	
	Если (Не ПараметрыСообщения.Свойство("Организация") ИЛИ Не ПараметрыСообщения.Свойство("Банк"))
		И ПараметрыСообщения.Свойство("НастройкаОбмена") Тогда
		РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
			ПараметрыСообщения.НастройкаОбмена, "Организация, Банк");
		ЗаполнитьЗначенияСвойств(НовоеСообщениеОбъект, РеквизитыНастройкиОбмена);
	КонецЕсли;
	
	НовоеСообщениеОбъект.Дата = ТекущаяДатаСеанса();
	НовоеСообщениеОбъект.Записать();
	НовоеСообщениеСсылка = НовоеСообщениеОбъект.Ссылка;
	Название = СтроковыеФункцииКлиентСервер.СтрокаЛатиницей(ПараметрыСообщения.ПредставлениеДокумента);
	НазваниеФайла = ОбщегоНазначенияКлиентСервер.ЗаменитьНедопустимыеСимволыВИмениФайла(Название, "");
	
	ПараметрыФайла = Новый Структура();
	ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
	ПараметрыФайла.Вставить("ВладелецФайлов", НовоеСообщениеСсылка);
	ПараметрыФайла.Вставить("ИмяБезРасширения", НазваниеФайла);
	ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
	ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
	
	РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, ПараметрыСообщения.АдресФайлаВоВременномХранилище);
	
	Если ПараметрыСообщения.Свойство("Основной") И ПараметрыСообщения.Свойство("СсылкаНаОбъект") Тогда
		МенеджерЗаписи = РегистрыСведений.СостоянияОбменСБанками.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.СсылкаНаОбъект = ПараметрыСообщения.СсылкаНаОбъект;
		МенеджерЗаписи.СообщениеОбмена = НовоеСообщениеСсылка;
		МенеджерЗаписи.Состояние = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НовоеСообщениеСсылка, "Состояние");
		МенеджерЗаписи.Записать();
	КонецЕсли;
	
	Если ПараметрыСообщения.Свойство("СсылкаНаОбъект") Тогда
		МенеджерЗаписи = РегистрыСведений.СвязанныеОбъектыОбменСБанками.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.СсылкаНаОбъект = ПараметрыСообщения.СсылкаНаОбъект;
		МенеджерЗаписи.СообщениеОбмена = НовоеСообщениеСсылка;
		МенеджерЗаписи.Записать();
	ИначеЕсли ПараметрыСообщения.Свойство("СообщениеРодитель") Тогда
		ОбъектПривязки = ОбменСБанкамиСлужебныйВызовСервера.ОбъектПривязки(ПараметрыСообщения.СообщениеРодитель);
		Если ЗначениеЗаполнено(ОбъектПривязки) Тогда
			МенеджерЗаписи = РегистрыСведений.СвязанныеОбъектыОбменСБанками.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.СсылкаНаОбъект = ОбъектПривязки;
			МенеджерЗаписи.СообщениеОбмена = НовоеСообщениеСсылка;
			МенеджерЗаписи.Записать();
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область Транспорт

// Отправляет пакеты ЭДО в банк.
//
// Параметры:
//  МассивПакетовЭДО - Массив - список пакетов для отправки в банк;
//    * ДокументСсылка.ПакетОбменСБанками - отправляемый пакет электронных документов.
//  СоотвНастроекОбменаИПараметровСертификатов - Соответствие - параметры настроек обмена;
//  ТекстСообщения - Строка - возвращает тест ошибки для вывода пользователю.
// 
// Возвращаемое значение:
//  Структура - результат отправки пакетов. Содержит следующие поля:
//   * КоличествоОтправлено - Число - количество отправленных электронных документов.
//   * ОтправленныеДокументы - Массив - список документов, для которых отправлены актуальные электронные документы.
//     ** Элемент - ОпределяемыйТип.ВладельцыОбменСБанками - ссылка на документ-владелец отправленного электронного документа.
//
Функция ОтправкаПакетовЭДО(Знач МассивПакетовЭДО, Знач СоотвНастроекОбменаИПараметровСертификатов, ТекстСообщения = "") Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	СтруктураВозврата = Новый Структура("КоличествоОтправлено, ОтправленныеДокументы", 0, Новый Массив);
	
	МассивОтправленныхСообщенийОбмена = Новый Массив;
	
	Для Каждого ПакетОбменСБанками Из МассивПакетовЭДО Цикл
		
		НастройкаОбмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПакетОбменСБанками, "НастройкаОбмена");
				
		РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(НастройкаОбмена,
			"АдресСервера, РесурсИсходящихДокументов, РесурсВходящихДокументов, ИспользуетсяКриптография, ПрограммаБанка,
			|ИдентификаторОрганизации, ВерсияФормата");
				
		Если Не РеквизитыНастройкиОбмена.ИспользуетсяКриптография
			И (СоотвНастроекОбменаИПараметровСертификатов = Неопределено
				ИЛИ СоотвНастроекОбменаИПараметровСертификатов.Получить(НастройкаОбмена) = Неопределено) Тогда
			Продолжить;
		КонецЕсли;
		
		Настройки = Новый Структура("Адрес", РеквизитыНастройкиОбмена.АдресСервера);
			
		Если НЕ РеквизитыНастройкиОбмена.ИспользуетсяКриптография
			И РеквизитыНастройкиОбмена.ПрограммаБанка = Перечисления.ПрограммыБанка.АльфаБанкОнлайн Тогда
			ПараметрыАвторизации = СоотвНастроекОбменаИПараметровСертификатов.Получить(НастройкаОбмена);
			ХэшАвторизации = ОбменСБанкамиСлужебныйВызовСервера.СтрокаBase64БезBOM(
				ПараметрыАвторизации.Логин+ ":" + ПараметрыАвторизации.Пароль);
			Настройки.Вставить("Хэш", ХэшАвторизации);
		КонецЕсли;
			
		Данные = ОбменСБанкамиСлужебныйВызовСервера.ДвоичныеДанныеПрисоединенногоФайла(ПакетОбменСБанками);
		Если РеквизитыНастройкиОбмена.ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен Тогда
			Настройки.Вставить("Ресурс", "SendPack");
			ПараметрыАвторизации = СоотвНастроекОбменаИПараметровСертификатов.Получить(НастройкаОбмена);
			Если ПараметрыАвторизации = Неопределено ИЛИ НЕ ПараметрыАвторизации.Свойство("ИдентификаторСессии")
				ИЛИ НЕ ЗначениеЗаполнено(ПараметрыАвторизации.ИдентификаторСессии) Тогда
				Продолжить;
			КонецЕсли;
			ИдентификаторСессии = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(
				ПараметрыАвторизации.ИдентификаторСессии);
			Настройки.Вставить("ИдентификаторСессии", ИдентификаторСессии);
			Настройки.Вставить("ИдентификаторОрганизации", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
		Иначе
			Настройки.Вставить("Ресурс", РеквизитыНастройкиОбмена.РесурсИсходящихДокументов);
		КонецЕсли;
				
		ОтветБанка = Неопределено;
		ТекстОшибки = "";
		
		СообщенияОбмена = СообщенияОбменаВПакетеЭДО(ПакетОбменСБанками);
		
		Настройки.Вставить("ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
		
		// Если электронный документ по каким-то причинам отправлен быть не может,
		// то не надо приостанавливать всю цепочку.
		
		НачатьТранзакцию();
		
		Попытка

			СтруктураЭД = Новый Структура("Статус", Перечисления.СтатусыОбменСБанками.Отправлен);
		
			ОбменСБанкамиСлужебныйВызовСервера.ОбновитьСтатусыДокументовПакетаЭДО(
				ПакетОбменСБанками, Перечисления.СтатусыПакетовЭД.Отправлен, СтруктураЭД);

			ОтправитьВБанк(Настройки, Данные, ОтветБанка, ТекстОшибки);
			
			Если ЗначениеЗаполнено(ТекстОшибки) Тогда
				ОтменитьТранзакцию();
				ШаблонВидаОперации = НСтр("ru = 'Отправка пакета в банк по настройке: %1'");
				ВидОперации = СтрШаблон(ШаблонВидаОперации, НастройкаОбмена);
				ТекстСообщения = ТекстОшибки;
				ОбменСБанкамиСлужебныйВызовСервера.УстановитьСтатусПакета(
					ПакетОбменСБанками, Перечисления.СтатусыПакетовЭД.Отменен);
				ОбработатьОшибкуПередачиПакета(СообщенияОбмена, ВидОперации, ТекстОшибки, ТекстСообщения, ПакетОбменСБанками);
				Продолжить;
			КонецЕсли;
					
			СтруктураВозврата.КоличествоОтправлено = СтруктураВозврата.КоличествоОтправлено + 1;
			
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивОтправленныхСообщенийОбмена, СообщенияОбмена);
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			ОтменитьТранзакцию();
			ШаблонСообщения = НСтр("ru = 'Ошибка отправки пакета по настройке: %1
										|%2.'");
			КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			ТекстСообщения = СтрШаблон(
				ШаблонСообщения, НастройкаОбмена, КраткоеПредставлениеОшибки);
			ШаблонВидаОперации = НСтр("ru = 'Отправка пакета по настройке: %1'");
			ВидОперации = СтрШаблон(ШаблонВидаОперации, НастройкаОбмена);
			
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробноеПредставлениеОшибки, ТекстСообщения, "ОбменСБанками", ПакетОбменСБанками);
			
			ТекстОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			СтруктураРеквизитов = Новый Структура;
			СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.ОшибкаПередачи);
			СтруктураРеквизитов.Вставить("ПричинаОтклонения", ТекстОшибки);
			ОбменСБанкамиСлужебныйВызовСервера.ОбновитьСтатусыДокументовПакетаЭДО(
				ПакетОбменСБанками, Перечисления.СтатусыПакетовЭД.Отменен, СтруктураРеквизитов);
		КонецПопытки;
		
		Попытка
			Если РеквизитыНастройкиОбмена.ПрограммаБанка = Перечисления.ПрограммыБанка.АльфаБанкОнлайн Тогда
				ОбработатьОтветИзБанка(ОтветБанка, СообщенияОбмена.Получить(0)); // в пакете может быть только одно сообщение
			Иначе
				Для Каждого СообщениеОбмена Из СообщенияОбмена Цикл
					ОбменСБанкамиСлужебныйВызовСервера.УстановитьСтатусСообщенияОбмена(
						СообщениеОбмена, Перечисления.СтатусыОбменСБанками.Отправлен);
				КонецЦикла;
				ВремФайл = Неопределено;
				ОбменСБанкамиСлужебныйВызовСервера.ОбработатьОтветБанкаНаОтправкуДокументаAsync(
					ОтветБанка, ПакетОбменСБанками, ВремФайл);
			КонецЕсли;
		Исключение
			ШаблонСообщения = НСтр("ru = 'Ошибка чтения ответа банка после отправки пакета по настройке: %1
										|%2.'");
			КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			ТекстСообщения = СтрШаблон(ШаблонСообщения, НастройкаОбмена, КраткоеПредставлениеОшибки);
			ШаблонВидаОперации = НСтр("ru = 'Чтение ответа банка после отправки пакета по настройке: %1'");
			ВидОперации = СтрШаблон(ШаблонВидаОперации, НастройкаОбмена);
			
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ТекстОшибкиВЖурнале = НСтр("ru = 'При чтении ответа банка возникла ошибка:
												|%1
												|Файл ответа: %2'");
			ТекстОшибкиВЖурнале = СтрШаблон(ТекстОшибкиВЖурнале, ПодробноеПредставлениеОшибки, ВремФайл);
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ТекстОшибкиВЖурнале, ТекстСообщения, "ОбменСБанками", ПакетОбменСБанками);
			
			ТекстОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			СтруктураРеквизитов = Новый Структура;
			СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.ОшибкаПередачи);
			СтруктураРеквизитов.Вставить("ПричинаОтклонения", ТекстОшибки);
			ОбменСБанкамиСлужебныйВызовСервера.ОбновитьСтатусыДокументовПакетаЭДО(
				ПакетОбменСБанками, Перечисления.СтатусыПакетовЭД.Отменен, СтруктураРеквизитов);
		КонецПопытки;
			
	КонецЦикла;
	
	Если МассивОтправленныхСообщенийОбмена.Количество() Тогда
		ОтправленныеДокументы = ОбменСБанкамиСлужебныйВызовСервера.ВладельцыСообщенийОбмена(
			МассивОтправленныхСообщенийОбмена);
		СтруктураВозврата.Вставить("ОтправленныеДокументы", ОтправленныеДокументы);
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Получает новые документы из банка
//
// Параметры:
//  Параметры - Структура - параметры выполнения длительной операции
//    * НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком
//    * ИдентификаторСессии - ДвоичныеДанные - идентификатор установленной сессии.
//    * АдресРезультата - Строка - адрес результата для получения в текущем сеансе
//  АдресРезультата - Строка - адрес временного хранилища для помещения результата выполнения процедуры.
//    * Структура - возвращаемые данные:
//         * ТребуетсяПовторнаяАутентификация - Булево - если Истина, то сессия "протухла" и требуется повторная аутентификация
//         * КолПолученныхПакетов - Число - количество полученных пакетов из банка.
//
Процедура ПолучитьНовыеДокументыИзБанка(Параметры, АдресРезультата = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	ДанныеВозврата = ОбменСБанкамиКлиентСервер.ПараметрыПолученияНовыхДокументовАсинхронныйОбмен();
	
	ДанныеОСостоянии = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыОбменаСБанком(Параметры.НастройкаОбмена);
	
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		Параметры.НастройкаОбмена, "АдресСервера, Банк, ИдентификаторОрганизации, ВерсияФормата");
		
	Заголовки = Новый Соответствие;
	
	ИдентификаторСессии = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(
		Параметры.ИдентификаторСессии);
	Заголовки.Вставить("SID", ИдентификаторСессии);
	Заголовки.Вставить("CustomerId", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	Заголовки.Вставить("APIVersion", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	НачальнаяДатаПолученияЭД = ДанныеОСостоянии.ПоследняяДатаПолученияЭД;
	ПоследняяДатаПолученияЭД = НачальнаяДатаПолученияЭД;
	
	ДатаСтрокой = Формат(НачальнаяДатаПолученияЭД, "ДФ='dd.MM.yyyy HH:mm:ss'");
	ДатаСтрокой = КодироватьСтроку(ДатаСтрокой, СпособКодированияСтроки.КодировкаURL);
	
	ПараметрЗапроса = ?(ЗначениеЗаполнено(НачальнаяДатаПолученияЭД), "?date=" + ДатаСтрокой, "");
	
	АдресРесурса = "GetPackList" + ПараметрЗапроса;
	
	Результат = ЭлектронноеВзаимодействиеСлужебный.ПолучитьДанныеССервера(
		РеквизитыНастройкиОбмена.АдресСервера, АдресРесурса, Заголовки);
	
	Если Не Результат.Статус Тогда
		Если ЗначениеЗаполнено(Результат.КодСостояния) Тогда
			
			Если Результат.КодСостояния = 401 Тогда
				ДанныеВозврата.ТребуетсяПовторнаяАутентификация = Истина;
				ПоместитьВоВременноеХранилище(ДанныеВозврата, АдресРезультата);
				Возврат;
			Иначе
				Шаблон = НСтр("ru = 'При получении списка новых документов из банка произошла ошибка.
								|Код ошибки: %1.
								|%2'");
				ТекстОшибки = СтрШаблон(Шаблон, Результат.КодСостояния, Результат.СообщениеОбОшибке);
			КонецЕсли;
		Иначе
			ТекстОшибки = Результат.СообщениеОбОшибке;
		КонецЕсли;
		ВидОперации = НСтр("ru = 'Получение списка новых пакетов из банка.'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			ВидОперации, ТекстОшибки, , "ОбменСБанками", Параметры.НастройкаОбмена);
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ИмяФайлаРезультата = Результат.Тело;
	
	МассивИдентификаторов = Новый Массив;
	
	ПрочитатьИдентификаторыПакетов(Параметры.НастройкаОбмена, ИмяФайлаРезультата, МассивИдентификаторов);
	
	Если МассивИдентификаторов.Количество() = 0 Тогда
		ПоместитьВоВременноеХранилище(ДанныеВозврата, АдресРезультата);
		Возврат;
	КонецЕсли;

	Для Каждого Идентификатор Из МассивИдентификаторов Цикл
		АдресРесурса = "GetPack?id=" + Идентификатор;
		
		Результат = ЭлектронноеВзаимодействиеСлужебный.ПолучитьДанныеССервера(
			РеквизитыНастройкиОбмена.АдресСервера, АдресРесурса, Заголовки);
	
		Если Не Результат.Статус Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(Результат.Тело);
			
			Если ЗначениеЗаполнено(Результат.КодСостояния) Тогда
				Шаблон = НСтр("ru = 'При получении нового документа из банка произошла ошибка.
									|Код ошибки: %1.
									|%2'");
				ТекстОшибки = СтрШаблон(Шаблон, Результат.КодСостояния, Результат.СообщениеОбОшибке);
			Иначе
				ТекстОшибки = Результат.СообщениеОбОшибке;
			КонецЕсли;
			ВидОперации = НСтр("ru = 'Получение пакета по идентификатору.'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ТекстОшибки, , "ОбменСБанками", Параметры.НастройкаОбмена);
			Продолжить;
		КонецЕсли;
	
		ИмяФайлаРезультата = Результат.Тело;
		
		СохранитьПолученныйПакет(Параметры.НастройкаОбмена, ИмяФайлаРезультата, ДанныеВозврата);
		
		ДанныеВозврата.КолПолученныхПакетов = ДанныеВозврата.КолПолученныхПакетов + 1;

	КонецЦикла;

	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(ДанныеВозврата, АдресРезультата);
	
КонецПроцедуры

Процедура ОтправитьЗапросСостоянияЭДВБанк(СтруктураПараметров, АдресХранилища) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	СтруктураВозврата = Новый Структура;
	
	ЗапросСостоянияЭД = СтруктураПараметров.СообщениеОбмена;
	
	НастройкаОбмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗапросСостоянияЭД, "НастройкаОбмена");
	ПараметрыАвторизации = Новый Соответствие;
	ПараметрыАвторизации.Вставить(НастройкаОбмена, СтруктураПараметров);
	ТекстОшибки = "";
	
	ДанныеТабличнойЧасти = Новый Массив;
	ДанныеТабличнойЧасти.Добавить(ЗапросСостоянияЭД);
	
	ПЭД = Неопределено;
	СоздатьПакетОбменСБанками(НастройкаОбмена, ДанныеТабличнойЧасти, ПЭД);
	
	Если НЕ ЗначениеЗаполнено(ПЭД) Тогда
		СтруктураВозврата.Вставить("ЗапросОтправлен", Ложь);
		СтруктураВозврата.Вставить("ЕстьОшибка", Истина);
		ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресХранилища);
		Возврат;
	КонецЕсли;
	
	ЕстьОшибка = Ложь;
	СоздатьЭДПакетаAsync(ПЭД, ЕстьОшибка);
	
	Если ЕстьОшибка Тогда
		СтруктураВозврата.Вставить("ЗапросОтправлен", Ложь);
		СтруктураВозврата.Вставить("ЕстьОшибка", Истина);
		ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресХранилища);
		Возврат;
	КонецЕсли;
	
	МассивПакетов = Новый Массив;
	МассивПакетов.Добавить(ПЭД);
	Результат = ОтправкаПакетовЭДО(МассивПакетов, ПараметрыАвторизации, ТекстОшибки);
	
	КолОтправлено = Результат.КоличествоОтправлено;
	
	СтруктураВозврата.Вставить("ЗапросОтправлен", КолОтправлено > 0);
	СтруктураВозврата.Вставить("ЕстьОшибка", КолОтправлено = 0);
	СтруктураВозврата.Вставить("ТекстСообщения", ТекстОшибки);
	СтруктураВозврата.Вставить("СообщениеОбменаЗапросСостояния", ЗапросСостоянияЭД);
	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресХранилища);
	
КонецПроцедуры

// Запрашивает документы из банка до тех пор, пока не будет получено нужное извещение.
//
// Параметры:
//  СтруктураПараметров - Структура - содержит следующие поля:
//      *СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками - сообщение - запрос;
//      *НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена;
//      *ИдентификаторСессии - Строка - расшифрованный идентификатор сессии;
//  АдресХранилища - Строка - содержит адрес хранилища, в которую помещается структура возврата.
//
Процедура ПолучитьИзвещениеОСостоянииЭДАсинхронно(СтруктураПараметров, АдресХранилища) Экспорт
	
	ДанныеВозврата = ОбменСБанкамиКлиентСервер.ПараметрыПолученияНовыхДокументовАсинхронныйОбмен();
	
	НастройкаОбмена = СтруктураПараметров.НастройкаОбмена;
	
	Пока Истина Цикл
	
		АдресРезультата = ПоместитьВоВременноеХранилище(Неопределено);
		ПолучитьНовыеДокументыИзБанка(СтруктураПараметров, АдресРезультата);
		ДанныеВозврата = ПолучитьИзВременногоХранилища(АдресРезультата);
		
		ЕстьОшибка = Ложь;
		ПрерватьЦикл = Ложь;
		ИзвещениеПолучено = ОбменСБанкамиСлужебныйВызовСервера.ПолученоИзвещениеПоЗапросу(
			СтруктураПараметров.СообщениеОбмена, ЕстьОшибка);
		
		Если ИзвещениеПолучено Тогда
			ПрерватьЦикл = Истина;
		КонецЕсли;
		
		ДанныеВозврата.Вставить("ЕстьОшибка", ЕстьОшибка);
		Если ЕстьОшибка Тогда
			ПрерватьЦикл = Истина;
		КонецЕсли;
		
		Если ПрерватьЦикл Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	ПоместитьВоВременноеХранилище(ДанныеВозврата, АдресХранилища);
	
КонецПроцедуры

// Собирает пакет с запросом выписки и отправляет в банк. В ответ получает выписку банка.
//
// Параметры:
//  СтруктураПараметров - структура, содержит 2 элемента:
//      СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками - электронный документ с запросом выписки,
//      НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - настройка обмена с банком.
//  АдресХранилища - строка, содержит адрес хранилища, содержащий структуру из 2 элементов:
//      ЗапросОтправлен - Булево, признак, что запрос был отправлен,
//      ВыпискаБанка - СправочникСсылка.ЭДПрисоединенныеФайлы - электронный документ с выпиской банка.
//
Процедура ОтправитьЗапросВыпискиВБанк(СтруктураПараметров, АдресХранилища) Экспорт
	
	Перем ВыпискаБанка;
	
	УстановитьПривилегированныйРежим(Истина);
	НастройкаОбмена = СтруктураПараметров.НастройкаОбмена;
	ПрограммаБанка = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ПрограммаБанка");
	СтруктураВозврата = Новый Структура;
	
	Если ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен Тогда
		ЗапроситьВыпискуБанкаАсинхронно(СтруктураПараметров, АдресХранилища);
		Возврат;
	КонецЕсли;
	
	МассивСообщенийОбмена = СтруктураПараметров.МассивСообщенийОбмена;
	СообщениеОбмена = МассивСообщенийОбмена[0];
	
	ЗапросОтправлен = Ложь;
	
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(НастройкаОбмена,
		"АдресСервера, РесурсИсходящихДокументов, РесурсВходящихДокументов, ПрограммаБанка");
	Настройки = Новый Структура("Адрес", РеквизитыНастройкиОбмена.АдресСервера);
	КолОтправленных = 0;
	
	Данные = ОбменСБанкамиСлужебныйВызовСервера.ДвоичныеДанныеПрисоединенногоФайла(СообщениеОбмена);
	URI = "urn:x-obml:1.0";
	ТипMessage = ФабрикаXDTO.Тип("urn:x-obml:1.0", "CMSDETACHED");
	Message = ФабрикаXDTO.Создать(ТипMessage);
	ТипData = ТипMessage.Свойства[0].Тип;
	Data = ФабрикаXDTO.Создать(ТипData);
	Data.ContentType = "application/xml";
	Data.__content = Данные;
	Message.data = Data;
	
	МассивПодписей = ПодписиСообщенияОбмена(СообщениеОбмена);
	
	Для Каждого СтрокаПодписи Из МассивПодписей Цикл
		Message.signature.Добавить(СтрокаПодписи.Подпись.Получить());
	КонецЦикла;
	
	ПотокВПамяти = Новый ПотокВПамяти();
	Запись = Новый ЗаписьXML;
	Запись.ОткрытьПоток(ПотокВПамяти);
	Запись.ЗаписатьОбъявлениеXML();

	ФабрикаXDTO.ЗаписатьXML(Запись, Message, "signed", URI, , НазначениеТипаXML.Явное);
	
	Запись.Закрыть();
	
	Настройки.Вставить("Ресурс", РеквизитыНастройкиОбмена.РесурсВходящихДокументов);
	
	Если ЗначениеЗаполнено(СтруктураПараметров.Логин) Тогда
		ХЭШ = ОбменСБанкамиСлужебныйВызовСервера.СтрокаBase64БезBOM(
			СтруктураПараметров.Логин + ":" + СтруктураПараметров.Пароль);
		Настройки.Вставить("ХЭШ", ХЭШ);
	КонецЕсли;
	
	ВидОперации = НСтр("ru = 'Отправка запроса выписки в банк'");
	
	Попытка
		ОтветБанка = "";
		ТекстОшибки = "";
		ДанныеОтправки = ПотокВПамяти.ЗакрытьИПолучитьДвоичныеДанные();
		ОтправитьВБанк(Настройки, ДанныеОтправки, ОтветБанка, ТекстОшибки);
		
		Если НЕ ПустаяСтрока(ТекстОшибки) Тогда
			ТекстСообщения = ТекстОшибки;
			ОбработатьОшибкуПередачиПакета(МассивСообщенийОбмена, ВидОперации, ТекстОшибки, ТекстСообщения);
			ЕстьОшибка = Истина;
		Иначе
			СтруктураПараметров = Новый Структура;
			СтруктураПараметров.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Отправлен);
			ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеОбмена, СтруктураПараметров);
			ЗапросОтправлен = Истина;
			ОбработатьОтветИзБанка(ОтветБанка, СообщениеОбмена, ВыпискаБанка, ЕстьОшибка);
			ДанныеОтвета = ПолучитьДанныеИзОтветаБанка(ОтветБанка);
			ДанныеЭП = Новый Соответствие;
			ДанныеЭП.Вставить(ВыпискаБанка, ДанныеОтвета.Получить("Подписи"));
			СтруктураВозврата.Вставить("ДанныеЭП", ДанныеЭП);
		КонецЕсли;
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстСообщения = НСтр("ru = 'Не удалось отправить запрос выписки в банк
									|Причина: %1'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, КраткоеПредставлениеОшибки);
		ОбработатьОшибкуПередачиПакета(МассивСообщенийОбмена, ВидОперации, ТекстОшибки, ТекстСообщения);
		ЕстьОшибка = Истина;
	КонецПопытки;
	
	СтруктураВозврата.Вставить("ЗапросОтправлен", ЗапросОтправлен);
	СтруктураВозврата.Вставить("ВыпискаБанка", ВыпискаБанка);
	СтруктураВозврата.Вставить("ЕстьОшибка", ЕстьОшибка);
	СтруктураВозврата.Вставить("ТекстСообщения", ТекстСообщения);

	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресХранилища);
	
КонецПроцедуры

// Собирает пакет с запросом зондом и отправляет в банк. В ответ состояние ЭД.
//
// Параметры:
//  СтруктураПараметров - структура, содержит 2 элемента:
//      СообщениеОбмена - ДокументСсылка.СообщенияОбменСБанками - электронный документ с запросом выписки,
//      НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - настройка обмена с банком.
//  АдресХранилища - строка, содержит адрес хранилища, содержащий структуру с данными возврата.
//
Процедура ОтправитьЗапросЗондВБанк(СтруктураПараметров, АдресХранилища) Экспорт
	
	МассивСообщенийОбмена = Новый Массив;
	МассивСообщенийОбмена.Добавить(СтруктураПараметров.СообщениеОбмена);
	
	ТекстСообщения = "";
	
	ПакетОбменСБанками = Неопределено;
	СоздатьПакетОбменСБанками(СтруктураПараметров.НастройкаОбмена, МассивСообщенийОбмена, ПакетОбменСБанками);
	Если ПакетОбменСБанками = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ЕстьОшибка = Ложь;
	СоздатьЭДПакетаAsync(ПакетОбменСБанками, ЕстьОшибка);
	
	Если ЕстьОшибка Тогда
		Возврат;
	КонецЕсли;
	
	МассивПакетов = Новый Массив;
	МассивПакетов.Добавить(ПакетОбменСБанками);
	СоотвНастроекОбменаИПараметровСертификатов = Новый Соответствие;
	СоотвНастроекОбменаИПараметровСертификатов.Вставить(СтруктураПараметров.НастройкаОбмена, СтруктураПараметров);
	ОтправкаПакетовЭДО(МассивПакетов, СоотвНастроекОбменаИПараметровСертификатов, ТекстСообщения);

КонецПроцедуры

#КонецОбласти

#Область ОбработкаПакетовЭДО

// Осуществляет распаковку полученного пакета.
//
// Параметры:
//  ПакетОбменСБанками - ДокументСсылка.ПакетОбменСБанками - ссылка на распаковываемый пакет;
//  ДанныеВозврата - Структура - см. ОбменСБанкамиКлиентСервер.ПараметрыПолученияНовыхДокументовАсинхронныйОбмен().
//
Процедура РаспаковатьПакетОбменСБанками(ПакетОбменСБанками, ДанныеВозврата) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	ПакетОбменСБанками.НастройкаОбмена
	               |ИЗ
	               |	Документ.ПакетОбменСБанками КАК ПакетОбменСБанками
	               |ГДЕ
	               |	ПакетОбменСБанками.Ссылка = &Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПакетОбменСБанкамиСообщения.Сообщение.ВнешнийИдентификатор КАК ВнешнийИдентификатор
	               |ИЗ
	               |	Документ.ПакетОбменСБанками.Сообщения КАК ПакетОбменСБанкамиСообщения
	               |ГДЕ
	               |	ПакетОбменСБанкамиСообщения.Ссылка = &Ссылка
	               |	И НЕ ПакетОбменСБанкамиСообщения.Сообщение.ПометкаУдаления
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КОЛИЧЕСТВО(ПакетОбменСБанкамиСообщения.Ссылка) КАК КоличествоСообщений
	               |ИЗ
	               |	Документ.ПакетОбменСБанками.Сообщения КАК ПакетОбменСБанкамиСообщения
	               |ГДЕ
	               |	ПакетОбменСБанкамиСообщения.Ссылка = &Ссылка";

	Запрос.УстановитьПараметр("Ссылка", ПакетОбменСБанками);
	Результат = Запрос.ВыполнитьПакет();
	
	ВыборкаПоНастройке = Результат[0].Выбрать();
	ВыборкаПоНастройке.Следующий();
	НастройкаОбмена = ВыборкаПоНастройке.НастройкаОбмена;
	
	МассивВнешнихИдентификаторов = Результат[1].Выгрузить().ВыгрузитьКолонку("ВнешнийИдентификатор");
	
	ВыборкаКоличества = Результат[2].Выбрать();
	ВыборкаКоличества.Следующий();
	Если МассивВнешнихИдентификаторов.Количество() <> ВыборкаКоличества.КоличествоСообщений Тогда
		ПакетОбъект = ПакетОбменСБанками.ПолучитьОбъект();
		МассивСообщенийОбмена = Новый Массив;
		Для Каждого Строка Из ПакетОбъект.Сообщения Цикл
			Если Не ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Строка.Сообщение, "ПометкаУдаления") Тогда
				МассивСообщенийОбмена.Добавить(Строка.Сообщение);
			КонецЕсли;
		КонецЦикла;
		ПакетОбъект.Сообщения.Очистить();
		Для Каждого СообщениеОбмена Из МассивСообщенийОбмена Цикл
			НовСтрока = ПакетОбъект.Сообщения.Добавить();
			НовСтрока.Сообщение = СообщениеОбмена;
		КонецЦикла;
		ПакетОбъект.Записать();
	КонецЕсли;
	
	ДвоичныеДанныеФайла = ОбменСБанкамиСлужебныйВызовСервера.ДвоичныеДанныеПрисоединенногоФайла(ПакетОбменСБанками);
	
	ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
	
	ПакетXML = Новый ЧтениеXML;
	ПакетXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());

	НачатьТранзакцию();
	Попытка
		
		Попытка
			ResultBank = ФабрикаXDTO.ПрочитатьXML(ПакетXML);
			Если ResultBank.Свойства().Получить("formatVersion") = Неопределено Тогда
				ВерсияФормата = ОбменСБанкамиКлиентСервер.УстаревшаяВерсияФорматаАсинхронногоОбмена();
			Иначе
				ВерсияФормата = ResultBank.formatVersion;
			КонецЕсли;
			ПространствоИмен = ПространствоИменАсинхронногоОбмена(ВерсияФормата);
			Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ВерсияФормата);

			ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
			ПакетXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
			ПакетТип = ТипЗначенияCML(Фабрика, ПространствоИмен, "ResultBank");
			ResultBank = Фабрика.ПрочитатьXML(ПакетXML, ПакетТип);
		Исключение
			Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
				ШаблонСообщения = НСтр("ru = 'Возникла ошибка при разборе пакета %1.
											|%2'");
				КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
				ТекстСообщения = СтрШаблон(
					ШаблонСообщения, ПакетОбменСБанками, КраткоеПредставлениеОшибки);
			Иначе
				ТекстСообщения = НСтр("ru = 'Файл, полученный из банка невозможно прочитать так как он содержит ошибку'");
			КонецЕсли;
			ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
										|Подробное представление ошибки:
										|%2'");
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ПодробнаяИнформация = СтрШаблон(ПодробнаяИнформация, ПакетОбменСБанками, ПодробноеПредставлениеОшибки);
			ВидОперации = НСтр("ru = 'Чтение ЭД.'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		
		ПакетXML.Закрыть();
		
		ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
		ОбъектXML = Новый ЧтениеXML;
		
		АктуальныеВидыЭД = ОбменСБанкамиСлужебныйПовтИсп.АктуальныеВидыЭД();
		
		Если НЕ ResultBank.Success = Неопределено 
			И НЕ ResultBank.Success.GetPacketResponse = Неопределено 
			И НЕ ResultBank.Success.GetPacketResponse.Document = Неопределено Тогда
					
			Для Каждого Document Из ResultBank.Success.GetPacketResponse.Document Цикл
				Если МассивВнешнихИдентификаторов.Найти(Document.id) <> Неопределено Тогда
					Продолжить; // данное сообщение уже распаковано и находится в табличной части пакета
				КонецЕсли;
				Если Document.compressed = Истина Тогда
					ЧтениеДанныхАрхив = Новый ЧтениеДанных(Document.data.__content);
					ПапкаДляРаспаковки = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог("Ext", Новый УникальныйИдентификатор);
					Попытка
						ЧтениеZIP = Новый ЧтениеZIPФайла(ЧтениеДанныхАрхив.ИсходныйПоток());
						ЧтениеZIP.ИзвлечьВсе(ПапкаДляРаспаковки);
					Исключение
						Если НЕ ЭлектронноеВзаимодействиеСлужебный.ВозможноИзвлечьФайлы(ЧтениеZIP, ПапкаДляРаспаковки) Тогда
							ТекстСообщения = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке("006");
						Иначе
							ТекстСообщения = НСтр("ru = 'Файл, полученный из банка невозможно прочитать так как он содержит ошибку'");
						КонецЕсли;
						ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
														|Подробное представление ошибки:
														|%2'");
						ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						ПодробнаяИнформация = СтрШаблон(ПодробнаяИнформация, ПакетОбменСБанками, ПодробноеПредставлениеОшибки);
						Операция = НСтр("ru = 'Распаковка пакета'");
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
							Операция, ПодробнаяИнформация, ТекстСообщения, "ОбменСБанками", ПакетОбменСБанками);
						ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
						ВызватьИсключение ТекстСообщения;
					КонецПопытки;
					ЧтениеZIP.Закрыть();

					ФайлыЭД = НайтиФайлы(ПапкаДляРаспаковки, "*");
					Если ФайлыЭД.Количество() > 0 Тогда
						ДвоичныеДанныеФайла = Новый ДвоичныеДанные(ФайлыЭД[0].ПолноеИмя);
						ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
					Иначе
						ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
						Продолжить;
					КонецЕсли;
				Иначе
					ДвоичныеДанныеФайла = Document.data.__content;
				КонецЕсли;
				
				ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
				
				Если Document.dockind = "02" Тогда // Извещение о состоянии электронного документа
					ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
					Попытка
						StatusDocNotice = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
						Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(StatusDocNotice.formatVersion);
						Если Фабрика = Неопределено Тогда
							ВызватьИсключение НСтр("ru = 'Неизвестная версия формата файла.'");
						КонецЕсли;
						ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
						ПространствоИмен = ПространствоИменАсинхронногоОбмена(StatusDocNotice.formatVersion);
						ИзвещениеОСостоянииТип = ТипЗначенияCML(Фабрика, ПространствоИмен, "StatusDocNotice");
						ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
						StatusDocNotice = Фабрика.ПрочитатьXML(ОбъектXML, ИзвещениеОСостоянииТип);
					Исключение
						Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
							ШаблонСообщения = НСтр("ru = 'Возникла ошибка при разборе пакета %1.
														|%2'");
							КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
							ТекстСообщения = СтрШаблон(
								ШаблонСообщения, ПакетОбменСБанками, КраткоеПредставлениеОшибки);
						Иначе
							ТекстСообщения = НСтр("ru = 'Файл, полученный из банка невозможно прочитать так как он содержит ошибку'");
						КонецЕсли;
						ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
														|Подробное представление ошибки:
														|%2'");
						ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						ПодробнаяИнформация = СтрШаблон(ПодробнаяИнформация, ПакетОбменСБанками, ПодробноеПредставлениеОшибки);
						ВидОперации = НСтр("ru = 'Чтение ЭД.'");
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
							ВидОперации, ПодробнаяИнформация, ТекстСообщения, "ОбменСБанками", ПакетОбменСБанками);
						ВызватьИсключение ТекстСообщения;
					КонецПопытки;
					ОбъектXML.Закрыть();
					
					ИДЗапроса = StatusDocNotice.ExtIDStatusRequest;
					ЭтоОтветНаЗапросСостояния = ЗначениеЗаполнено(ИДЗапроса);
					ЭтоОтветНаОтзыв = Ложь;
					
					Если ЭтоОтветНаЗапросСостояния Тогда
						СообщениеЗапрос = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", ИДЗапроса);
					КонецЕсли;
					
					СообщениеЭДО = Неопределено;
					Если ЗначениеЗаполнено(StatusDocNotice.ExtID) Тогда 
						СообщениеЭДО = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", StatusDocNotice.ExtID);
					КонецЕсли;
					
					Если ЭтоОтветНаЗапросСостояния И ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						ВидЗапроса = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеЗапрос, "ВидЭД");
						ЭтоОтветНаОтзыв = ВидЗапроса = Перечисления.ВидыЭДОбменСБанками.ЗапросНаОтзывЭД;
					ИначеЕсли ЗначениеЗаполнено(СообщениеЭДО)
						И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеЭДО, "ВидЭД") = Перечисления.ВидыЭДОбменСБанками.ЗапросЗонд Тогда
						ЭтоОтветНаЗонд = Истина;
					КонецЕсли;
					
					Если ЗначениеЗаполнено(СообщениеЭДО) Тогда
						
						АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
						
						СтруктураРеквизитов = Новый Структура;
						СтруктураРеквизитов.Вставить("СообщениеРодитель", СообщениеЭДО);
						СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Получен);
						СтруктураРеквизитов.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ИзвещениеОСостоянииЭД);
						СтруктураРеквизитов.Вставить("НастройкаОбмена", НастройкаОбмена);
						СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
						НазваниеДокумента = НСтр("ru = 'Извещение о состоянии электронного документа'");
						СтруктураРеквизитов.Вставить("ПредставлениеДокумента", НазваниеДокумента);
						СтруктураРеквизитов.Вставить("Расширение", "xml");
						СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресВХранилище);
						СтруктураРеквизитов.Вставить("ВнешнийИдентификатор", StatusDocNotice.id);
						СсылкаНаОбъект = ОбменСБанкамиСлужебныйВызовСервера.ОбъектПривязки(СтруктураРеквизитов.СообщениеРодитель);
						Если Не СсылкаНаОбъект = Неопределено Тогда 
							СтруктураРеквизитов.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
						КонецЕсли;
						
						НовоеСообщениеОбмена = Неопределено;
						СохранитьСообщениеОбмена(СтруктураРеквизитов, НовоеСообщениеОбмена);
						Если Не ЗначениеЗаполнено(НовоеСообщениеОбмена) Тогда
							Продолжить;
						КонецЕсли;
						
						ДобавитьСообщениеОбменаВПакет(ПакетОбменСБанками, НовоеСообщениеОбмена);
						
						РеквизитыРодителя = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
							СтруктураРеквизитов.СообщениеРодитель, "Статус, ДатаИзмененияВнешнегоСтатуса");
						
						Если Document.signature.Количество() Тогда
							МассивПодписей = Новый Массив;
							Для Каждого ЭП Из Document.signature Цикл
								МассивПодписей.Добавить(ЭП.signedData);
							КонецЦикла;
							ДанныеВозврата.ДанныеЭП.Вставить(НовоеСообщениеОбмена, МассивПодписей);
						КонецЕсли;
						
						Если ЭтоОтветНаЗапросСостояния И ЗначениеЗаполнено(СообщениеЗапрос) И СообщениеЗапрос <> СообщениеЭДО Тогда
							РеквизитыЗапроса = Новый Структура("Статус", Перечисления.СтатусыОбменСБанками.ПолученоИзвещение);
							ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЗапрос, РеквизитыЗапроса);
						КонецЕсли;
						
						Если НЕ StatusDocNotice.Result.Status = Неопределено Тогда
							КодСтатуса = StatusDocNotice.Result.Status.Code;
							РеквизитыДляИзменения = Новый Структура;
							НовыйСтатус = Неопределено;
							Если КодСтатуса = "01" Тогда
								Если НЕ РеквизитыРодителя.Статус = Перечисления.СтатусыОбменСБанками.ПолученоИзвещение Тогда
									НовыйСтатус = Перечисления.СтатусыОбменСБанками.Принят;
								КонецЕсли;
							ИначеЕсли КодСтатуса = "02" Тогда
								Если НЕ РеквизитыРодителя.Статус = Перечисления.СтатусыОбменСБанками.Обработан Тогда
									НовыйСтатус = Перечисления.СтатусыОбменСБанками.Исполнен;
								КонецЕсли;
							ИначеЕсли КодСтатуса = "03" Тогда
								НовыйСтатус = Перечисления.СтатусыОбменСБанками.ОтклоненБанком;
								РеквизитыДляИзменения.Вставить("ПричинаОтклонения", StatusDocNotice.Result.Status.MoreInfo);
							ИначеЕсли КодСтатуса = "04" Тогда
								НовыйСтатус = Перечисления.СтатусыОбменСБанками.Приостановлен;
							ИначеЕсли КодСтатуса = "05" Тогда
								НовыйСтатус = Перечисления.СтатусыОбменСБанками.Аннулирован;
								РеквизитыДляИзменения.Вставить("ПричинаОтклонения", StatusDocNotice.Result.Status.MoreInfo);
							ИначеЕсли КодСтатуса = "06" Тогда
								НовыйСтатус = Перечисления.СтатусыОбменСБанками.НеПодтвержден;
							КонецЕсли;
							Если ЭтоОтветНаОтзыв Тогда
								РеквизитыЗапроса = Новый Структура;
								РеквизитыЗапроса.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Обработан);
								ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЗапрос, РеквизитыЗапроса);
							КонецЕсли;
							
							ДатаИзмененияСтатуса = StatusDocNotice.creationDate;
							Если ЗначениеЗаполнено(НовыйСтатус) И РеквизитыРодителя.ДатаИзмененияВнешнегоСтатуса < ДатаИзмененияСтатуса Тогда
								РеквизитыДляИзменения.Вставить("ДатаИзмененияВнешнегоСтатуса", ДатаИзмененияСтатуса);
								РеквизитыДляИзменения.Вставить("Статус", НовыйСтатус);
								ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЭДО, РеквизитыДляИзменения);
							КонецЕсли;
						ИначеЕсли НЕ StatusDocNotice.Result.Error = Неопределено Тогда
							Если ЭтоОтветНаЗонд = Истина И StatusDocNotice.Result.Error.Code = "9999" Тогда
								РеквизитыДляИзменения = Новый Структура;
								РеквизитыДляИзменения.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Исполнен);
								ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЭДО, РеквизитыДляИзменения);
							ИначеЕсли  StatusDocNotice.Result.Error.Code = "2202" Тогда // такой документ уже есть в базе банка
								ТекущийСтатусСообщения = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеЭДО, "Статус");
								Если ТекущийСтатусСообщения = Перечисления.СтатусыОбменСБанками.ОшибкаПередачи Тогда
									РеквизитыДляИзменения = Новый Структура;
									РеквизитыДляИзменения.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Доставлен);
									ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЭДО, РеквизитыДляИзменения);
								КонецЕсли;
							Иначе
								ДатаИзмененияСтатуса = StatusDocNotice.creationDate;
								ТекстОшибки = ТекстСообщенияОбОшибкеОтветаБанка(StatusDocNotice.Result.Error);
								РеквизитыДляИзменения = Новый Структура;
								РеквизитыДляИзменения.Вставить("ДатаИзмененияВнешнегоСтатуса", ДатаИзмененияСтатуса);
								РеквизитыДляИзменения.Вставить("Статус", Перечисления.СтатусыОбменСБанками.ОтклоненБанком);
								РеквизитыДляИзменения.Вставить("ПричинаОтклонения", ТекстОшибки);
								ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЭДО, РеквизитыДляИзменения);
								
								Если StatusDocNotice.Result.Error.Code = "2207" Тогда
									ИсходноеСообщениеОбмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеЭДО, "СообщениеРодитель");
									РеквизитыДляИзменения.Вставить(
										"ПричинаОтклонения", НСтр("ru = 'Документ отсутствует в информационной базе банка.'"));
									ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(ИсходноеСообщениеОбмена, РеквизитыДляИзменения);
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
						ДокументУчета = ОбменСБанкамиСлужебныйВызовСервера.ДокументУчета(СообщениеЭДО);
						Если ЗначениеЗаполнено(ДокументУчета) Тогда
							СостояниеЭДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеЭДО, "Состояние");
							ДанныеВозврата.ПараметрОповещения.Вставить(ДокументУчета, СостояниеЭДО);
						КонецЕсли;
					Иначе
						ВидОперации = НСтр("ru = 'Чтение извещения о состоянии электронного документа'");
						ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
														|Не найден электронный документ по идентификатору: %2'");
						ПодробнаяИнформация = СтрШаблон(
							ПодробнаяИнформация, ПакетОбменСБанками, StatusDocNotice.ExtID);
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
							ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
						Продолжить;
					КонецЕсли;
				ИначеЕсли Document.dockind = "01" Тогда // Извещение о состоянии пакета
					ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
					Попытка
						StatusPacketNotice = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
						Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(StatusPacketNotice.formatVersion);
						Если Фабрика = Неопределено Тогда
							ВызватьИсключение НСтр("ru = 'Неизвестная версия формата файла.'");
						КонецЕсли;
						ПространствоИмен = ПространствоИменАсинхронногоОбмена(StatusPacketNotice.formatVersion);
						ИзвещениеОСостоянииПакетаТип = ТипЗначенияCML(Фабрика, ПространствоИмен, "StatusPacketNotice");
						ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
						ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
						StatusPacketNotice = Фабрика.ПрочитатьXML(ОбъектXML, ИзвещениеОСостоянииПакетаТип);
					Исключение
						Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
							ШаблонСообщения = НСтр("ru = 'Возникла ошибка при разборе пакета %1.
														|%2'");
							КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
							ТекстСообщения = СтрШаблон(ШаблонСообщения, ПакетОбменСБанками, КраткоеПредставлениеОшибки);
						Иначе
							ТекстСообщения = НСтр("ru = 'Файл, полученный из банка невозможно прочитать так как он содержит ошибку'");
						КонецЕсли;
						ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
														|Подробное представление ошибки:
														|%2'");
						ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						ПодробнаяИнформация = СтрШаблон(ПодробнаяИнформация, ПакетОбменСБанками, ПодробноеПредставлениеОшибки);
						ВидОперации = НСтр("ru = 'Чтение ЭД.'");
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
							ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
						ВызватьИсключение ТекстСообщения
					КонецПопытки;
						
					ОбъектXML.Закрыть();
					Если НЕ StatusPacketNotice.Result.Error = Неопределено Тогда
						ОтправленныйПакетЭД = НайтиПакетОбменСБанками(НастройкаОбмена, StatusPacketNotice.IDResultSuccessResponse);
						Если ЗначениеЗаполнено(ОтправленныйПакетЭД) Тогда
							ТекстОшибки = ТекстСообщенияОбОшибкеОтветаБанка(StatusPacketNotice.Result.Error);
							СтруктураЭД = Новый Структура;
							СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.ОтклоненБанком);
							СтруктураЭД.Вставить("ПричинаОтклонения", ТекстОшибки);
							СообщенияОбмена = Новый Массив;
							ОбменСБанкамиСлужебныйВызовСервера.ОбновитьСтатусыДокументовПакетаЭДО(
								ОтправленныйПакетЭД, Перечисления.СтатусыПакетовЭД.Отменен, СтруктураЭД, СообщенияОбмена);
							Для Каждого СообщениеОбмена Из СообщенияОбмена Цикл
								ДокументУчета = ОбменСБанкамиСлужебныйВызовСервера.ДокументУчета(СообщениеОбмена);
								Если ЗначениеЗаполнено(ДокументУчета) Тогда
									СостояниеЭДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеОбмена, "Состояние");
									ДанныеВозврата.ПараметрОповещения.Вставить(ДокументУчета, СостояниеЭДО);
								КонецЕсли;
							КонецЦикла;
						КонецЕсли;
					ИначеЕсли НЕ StatusPacketNotice.Result.Status = Неопределено Тогда
						ОтправленныйПакетОбменСБанками = НайтиПакетОбменСБанками(НастройкаОбмена, StatusPacketNotice.IDResultSuccessResponse);
						Если ЗначениеЗаполнено(ОтправленныйПакетЭД) Тогда
							Если StatusPacketNotice.Result.Status.Code = "01" Тогда
								СтруктураЭД = Новый Структура;
								СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Доставлен);
								СообщенияОбмена = Новый Массив;
								ОбменСБанкамиСлужебныйВызовСервера.ОбновитьСтатусыДокументовПакетаЭДО(
									ОтправленныйПакетОбменСБанками, Перечисления.СтатусыПакетовЭД.Доставлен, СтруктураЭД, СообщенияОбмена);
								Для Каждого СообщениеОбмена Из СообщенияОбмена Цикл
									ДокументУчета = ОбменСБанкамиСлужебныйВызовСервера.ДокументУчета(СообщениеОбмена);
									Если ЗначениеЗаполнено(ДокументУчета) Тогда
										СостояниеЭДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеОбмена, "Состояние");
										ДанныеВозврата.ПараметрОповещения.Вставить(ДокументУчета, СостояниеЭДО);
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли Document.dockind = "15" Тогда // Выписка банка
					Если АктуальныеВидыЭД.Найти(Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение) = Неопределено Тогда
						// Для ЗУП не требуется получать выписку банка.
						Продолжить;
					КонецЕсли;
					ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
					Попытка
						Statement = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
						Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(Statement.formatVersion);
						Если Фабрика = Неопределено Тогда
							ВызватьИсключение НСтр("ru = 'Неизвестная версия формата файла.'");
						КонецЕсли;
						ПространствоИмен = ПространствоИменАсинхронногоОбмена(Statement.formatVersion);
						ВыпискаТип = ТипЗначенияCML(Фабрика, ПространствоИмен, "Statement");
						ЧтениеДанных = Новый ЧтениеДанных(ДвоичныеДанныеФайла);
						ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
						Statement = Фабрика.ПрочитатьXML(ОбъектXML, ВыпискаТип);
					Исключение
						Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
							ШаблонСообщения = НСтр("ru = 'Возникла ошибка при разборе пакета %1.
														|%2'");
							КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
							ТекстСообщения = СтрШаблон(
								ШаблонСообщения, ПакетОбменСБанками, КраткоеПредставлениеОшибки);
						Иначе
							ТекстСообщения = НСтр("ru = 'Файл, полученный из банка невозможно прочитать так как он содержит ошибку'");
						КонецЕсли;
						ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
														|Подробное представление ошибки:
														|%2'");
						ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						ПодробнаяИнформация = СтрШаблон(ПодробнаяИнформация, ПакетОбменСБанками, ПодробноеПредставлениеОшибки);
						ВидОперации = НСтр("ru = 'Чтение ЭД.'");
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
							ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
						ВызватьИсключение ТекстСообщения
					КонецПопытки;
					ОбъектXML.Закрыть();
					
					ИдентификаторЗапроса = Statement.ExtIDStatementRequest;
					
					Если ЗначениеЗаполнено(ИдентификаторЗапроса) Тогда
						СообщениеЗапрос = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", ИдентификаторЗапроса);
						
						Если НЕ ЗначениеЗаполнено(СообщениеЗапрос) Тогда
							ВидОперации = НСтр("ru = 'Распаковка пакета'");
							ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
															|Не найден  запрос выписки по идентификатору: %2'");
							ПодробнаяИнформация = СтрШаблон(
								ПодробнаяИнформация, ПакетОбменСБанками, ИдентификаторЗапроса);
							ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
								ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
						КонецЕсли;
					КонецЕсли;
				
					Если ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						СтруктураПараметров = Новый Структура("Статус", Перечисления.СтатусыОбменСБанками.Обработан);
						ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЗапрос, СтруктураПараметров);
					КонецЕсли;
				
					АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);

					Если ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						НазваниеЗапроса = Строка(СообщениеЗапрос);
						НазваниеДокумента = СтрЗаменить(
							НазваниеЗапроса, НСтр("ru = 'Запрос выписки'"), НСтр("ru = 'Выписка банка за период'"));
					Иначе
						НазваниеДокумента = НСтр("ru = 'Выписка банка от %1'");
						НазваниеДокумента = СтрШаблон(
							НазваниеДокумента, Формат(ТекущаяДатаСеанса(), "ДЛФ=D"));
					КонецЕсли;
					
					СтруктураРеквизитов = Новый Структура;
					
					Если ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						СтруктураРеквизитов.Вставить("СообщениеРодитель", СообщениеЗапрос);
					КонецЕсли;
					
					СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Получен);
					СтруктураРеквизитов.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка);
					СтруктураРеквизитов.Вставить("НастройкаОбмена", НастройкаОбмена);
					СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
					СтруктураРеквизитов.Вставить("ПредставлениеДокумента", НазваниеДокумента);
					СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресВХранилище);
					СтруктураРеквизитов.Вставить("ВнешнийИдентификатор", Statement.id);
					СтруктураРеквизитов.Вставить("СсылкаНаОбъект", НастройкаОбмена);
						
					НовоеСообщениеОбмена = Неопределено;
					СохранитьСообщениеОбмена(СтруктураРеквизитов, НовоеСообщениеОбмена);
					Если Не ЗначениеЗаполнено(НовоеСообщениеОбмена) Тогда
						Продолжить;
					КонецЕсли;
					
					ДобавитьСообщениеОбменаВПакет(ПакетОбменСБанками, НовоеСообщениеОбмена);
					
					Если Document.signature.Количество() Тогда
						МассивПодписей = Новый Массив;
						Для Каждого signature Из Document.signature Цикл
							МассивПодписей.Добавить(signature.signedData);
						КонецЦикла;
						ДанныеВозврата.ДанныеЭП.Вставить(НовоеСообщениеОбмена, МассивПодписей);
					КонецЕсли;
					СохранитьШтампыБанка(НовоеСообщениеОбмена);
					ОбменСБанкамиСлужебныйВызовСервера.ОпределитьИсполненныеПлатежныеПоручения(НовоеСообщениеОбмена);
				ИначеЕсли Document.dockind = "06" Тогда // настройки обмена
					ДвоичныеДанныеФайла = ЧтениеДанных.Прочитать().ПолучитьДвоичныеДанные();
					АдресХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
					Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "Организация");
					СоздатьНастройкуОбменаИзФайла(АдресХранилища, Организация, Ложь, Ложь, , , НастройкаОбмена);
				ИначеЕсли Document.dockind = "20" Тогда // Подтверждение открытия счетов по зарплатному проекту
					Если АктуальныеВидыЭД.Найти(Перечисления.ВидыЭДОбменСБанками.СписокНаОткрытиеСчетовПоЗарплатномуПроекту) = Неопределено Тогда
						// Для конфигурации без зарплатного проекта данный электронный документ не нужен.
						Продолжить;
					КонецЕсли;
					ДвоичныеДанныеФайла = ЧтениеДанных.Прочитать().ПолучитьДвоичныеДанные();
					АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
						
					ОбъектВладелец = Неопределено;
					ИдентификаторЭДВладельца = Document.extID;
					ДанныеОповещения = Новый Структура;

					ОбменСБанкамиПереопределяемый.ПриПолученииXMLФайла(
						АдресВХранилище, Document.Data.fileName, ОбъектВладелец, ДанныеОповещения);
							
					Если НЕ ЗначениеЗаполнено(ОбъектВладелец) Тогда
						ОбъектВладелец = НастройкаОбмена;
					КонецЕсли;
						
					НазваниеДокумента = НСтр("ru = 'Подтверждение открытия счетов по зарплатному проекту'");
					
					СтруктураРеквизитов = Новый Структура;
					
					СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Получен);
					СтруктураРеквизитов.Вставить(
						"ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПодтверждениеОткрытияСчетовПоЗарплатномуПроекту);
					СтруктураРеквизитов.Вставить("НастройкаОбмена", НастройкаОбмена);
					СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
					СтруктураРеквизитов.Вставить("ПредставлениеДокумента", НазваниеДокумента);
					СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресВХранилище);
					СтруктураРеквизитов.Вставить("ВнешнийИдентификатор", Document.id);
					СтруктураРеквизитов.Вставить("СсылкаНаОбъект", НастройкаОбмена);

					Если ЗначениеЗаполнено(ИдентификаторЭДВладельца) Тогда
						СообщениеРодитель = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", ИдентификаторЭДВладельца);
						Если ЗначениеЗаполнено(СообщениеРодитель) Тогда
							СтруктураРеквизитов.Вставить("СообщениеРодитель", СообщениеРодитель);
							ОбменСБанкамиСлужебныйВызовСервера.УстановитьСтатусСообщенияОбмена(
								СообщениеРодитель, Перечисления.СтатусыОбменСБанками.ПолученоПодтверждение);
							ДокументУчета = ОбменСБанкамиСлужебныйВызовСервера.ДокументУчета(СообщениеРодитель);
							Если ЗначениеЗаполнено(ДокументУчета) Тогда
								СостояниеЭДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеРодитель, "Состояние");
								ДанныеВозврата.ПараметрОповещения.Вставить(ДокументУчета, СостояниеЭДО);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
					
					НовоеСообщениеОбмена = Неопределено;
					СохранитьСообщениеОбмена(СтруктураРеквизитов, НовоеСообщениеОбмена);
					Если Не ЗначениеЗаполнено(НовоеСообщениеОбмена) Тогда
						Продолжить;
					КонецЕсли;
					
					Если ДанныеОповещения.Количество() Тогда
						ДанныеВозврата.МассивОповещений.Добавить(ДанныеОповещения);
					КонецЕсли;
					
					ДобавитьСообщениеОбменаВПакет(ПакетОбменСБанками, НовоеСообщениеОбмена);
					
					Если Document.signature.Количество() Тогда
						МассивПодписей = Новый Массив;
						Для Каждого signature Из Document.signature Цикл
							МассивПодписей.Добавить(signature.signedData);
						КонецЦикла;
						ДанныеВозврата.ДанныеЭП.Вставить(НовоеСообщениеОбмена, МассивПодписей);
					КонецЕсли;
				ИначеЕсли Document.dockind = "22" Тогда // Подтверждение зачисления денежных средств на счета сотрудников
					
					Если АктуальныеВидыЭД.Найти(Перечисления.ВидыЭДОбменСБанками.СписокНаЗачислениеДенежныхСредствНаСчетаСотрудников) = Неопределено Тогда
						// Для конфигурации без зарплатного проекта данный электронный документ не нужен.
						Продолжить;
					КонецЕсли;
					
					ДвоичныеДанныеФайла = ЧтениеДанных.Прочитать().ПолучитьДвоичныеДанные();
					АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
						
					ОбъектВладелец = Неопределено;
					ИдентификаторЭДВладельца = Document.extID;
					ДанныеОповещения = Новый Структура;

					ОбменСБанкамиПереопределяемый.ПриПолученииXMLФайла(
						АдресВХранилище, Document.Data.fileName, ОбъектВладелец, ДанныеОповещения);
							
					Если НЕ ЗначениеЗаполнено(ОбъектВладелец) Тогда
						ОбъектВладелец = НастройкаОбмена;
					КонецЕсли;
						
					НазваниеДокумента = НСтр("ru = 'Подтверждение зачисления денежных средств на счета сотрудников'");
					
					СтруктураРеквизитов = Новый Структура;
					
					СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Получен);
					СтруктураРеквизитов.Вставить(
						"ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПодтверждениеЗачисленияДенежныхСредствНаСчетаСотрудников);
					СтруктураРеквизитов.Вставить("НастройкаОбмена", НастройкаОбмена);
					СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
					СтруктураРеквизитов.Вставить("ПредставлениеДокумента", НазваниеДокумента);
					СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресВХранилище);
					СтруктураРеквизитов.Вставить("ВнешнийИдентификатор", Document.id);
					СтруктураРеквизитов.Вставить("СсылкаНаОбъект", НастройкаОбмена);

					Если ЗначениеЗаполнено(ИдентификаторЭДВладельца) Тогда
						СообщениеРодитель = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", ИдентификаторЭДВладельца);
						Если ЗначениеЗаполнено(СообщениеРодитель) Тогда
							СтруктураРеквизитов.Вставить("СообщениеРодитель", СообщениеРодитель);
							ОбменСБанкамиСлужебныйВызовСервера.УстановитьСтатусСообщенияОбмена(
								СообщениеРодитель, Перечисления.СтатусыОбменСБанками.ПолученоПодтверждение);
							ДокументУчета = ОбменСБанкамиСлужебныйВызовСервера.ДокументУчета(СообщениеРодитель);
							Если ЗначениеЗаполнено(ДокументУчета) Тогда
								СостояниеЭДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СообщениеРодитель, "Состояние");
								ДанныеВозврата.ПараметрОповещения.Вставить(ДокументУчета, СостояниеЭДО);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
					
					НовоеСообщениеОбмена = Неопределено;
					СохранитьСообщениеОбмена(СтруктураРеквизитов, НовоеСообщениеОбмена);
					Если Не ЗначениеЗаполнено(НовоеСообщениеОбмена) Тогда 
						Продолжить;
					КонецЕсли;
					
					Если ДанныеОповещения.Количество() Тогда
						ДанныеВозврата.МассивОповещений.Добавить(ДанныеОповещения);
					КонецЕсли;
					
					ДобавитьСообщениеОбменаВПакет(ПакетОбменСБанками, НовоеСообщениеОбмена);
					
					Если Document.signature.Количество() Тогда
						МассивПодписей = Новый Массив;
						Для Каждого signature Из Document.signature Цикл
							МассивПодписей.Добавить(signature.signedData);
						КонецЦикла;
						ДанныеВозврата.ДанныеЭП.Вставить(НовоеСообщениеОбмена, МассивПодписей);
					КонецЕсли;
				ИначеЕсли Document.dockind = "35" Тогда // Валютная выписка банка
					
					Если АктуальныеВидыЭД.Найти(Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты) = Неопределено Тогда
						// Для конфигурации без валютных платежей данный вид электронного документа не нужен.
						Продолжить;
					КонецЕсли;
					
					ОбъектXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
					Попытка
						Statement = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
					Исключение
						Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
							ШаблонСообщения = НСтр("ru = 'Возникла ошибка при разборе пакета %1.
														|%2'");
							КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
							ТекстСообщения = СтрШаблон(
								ШаблонСообщения, ПакетОбменСБанками, КраткоеПредставлениеОшибки);
						Иначе
							ТекстСообщения = НСтр("ru = 'Файл, полученный из банка невозможно прочитать так как он содержит ошибку'");
						КонецЕсли;
						ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
														|Подробное представление ошибки:
														|%2'");
						ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						ПодробнаяИнформация = СтрШаблон(ПодробнаяИнформация, ПакетОбменСБанками, ПодробноеПредставлениеОшибки);
						ВидОперации = НСтр("ru = 'Чтение ЭД.'");
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
							ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
						ВызватьИсключение ТекстСообщения;
					КонецПопытки;
					ОбъектXML.Закрыть();
					
					ИдентификаторЗапроса = Statement.BkToCstmrStmt.GrpHdr.AddtlInf;
					
					Если ЗначениеЗаполнено(ИдентификаторЗапроса) Тогда
						СообщениеЗапрос = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", ИдентификаторЗапроса);
						
						Если НЕ ЗначениеЗаполнено(СообщениеЗапрос) Тогда
							ВидОперации = НСтр("ru = 'Распаковка пакета'");
							ПодробнаяИнформация = НСтр("ru = 'Ошибка при распаковке пакета %1
															|Не найден  запрос выписки по идентификатору: %2'");
							ПодробнаяИнформация = СтрШаблон(
								ПодробнаяИнформация, ПакетОбменСБанками, ИдентификаторЗапроса);
							ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
								ВидОперации, ПодробнаяИнформация, , "ОбменСБанками", ПакетОбменСБанками);
						КонецЕсли;
					КонецЕсли;
				
					Если ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						СтруктураПараметров = Новый Структура("Статус", Перечисления.СтатусыОбменСБанками.Обработан);
						ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеЗапрос, СтруктураПараметров);
					КонецЕсли;
				
					АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);

					Если ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						НазваниеЗапроса = Строка(СообщениеЗапрос);
						НазваниеДокумента = СтрЗаменить(
							НазваниеЗапроса, НСтр("ru = 'Запрос выписки'"), НСтр("ru = 'Выписка банка за период'"));
					Иначе
						НазваниеДокумента = НСтр("ru = 'Выписка банка от %1'");
						НазваниеДокумента = СтрШаблон(
							НазваниеДокумента, Формат(ТекущаяДатаСеанса(), "ДЛФ=D"));
					КонецЕсли;
					
					СтруктураРеквизитов = Новый Структура;
					
					Если ЗначениеЗаполнено(СообщениеЗапрос) Тогда
						СтруктураРеквизитов.Вставить("СообщениеРодитель", СообщениеЗапрос);
					КонецЕсли;
					
					СтруктураРеквизитов.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Получен);
					СтруктураРеквизитов.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка);
					СтруктураРеквизитов.Вставить("НастройкаОбмена", НастройкаОбмена);
					СтруктураРеквизитов.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
					СтруктураРеквизитов.Вставить("ПредставлениеДокумента", НазваниеДокумента);
					СтруктураРеквизитов.Вставить("АдресФайлаВоВременномХранилище", АдресВХранилище);
					СтруктураРеквизитов.Вставить("ВнешнийИдентификатор", Statement.id);
					СтруктураРеквизитов.Вставить("СсылкаНаОбъект", НастройкаОбмена);

					НовоеСообщениеОбмена = Неопределено;
					
					СохранитьСообщениеОбмена(СтруктураРеквизитов, НовоеСообщениеОбмена);
					Если Не ЗначениеЗаполнено(НовоеСообщениеОбмена) Тогда 
						Продолжить;
					КонецЕсли;

					
					ДобавитьСообщениеОбменаВПакет(ПакетОбменСБанками, НовоеСообщениеОбмена);
					
					Если Document.signature.Количество() Тогда
						МассивПодписей = Новый Массив;
						Для Каждого signature Из Document.signature Цикл
							МассивПодписей.Добавить(signature.signedData);
						КонецЦикла;
						ДанныеВозврата.ДанныеЭП.Вставить(НовоеСообщениеОбмена, МассивПодписей);
					КонецЕсли;
					
					// Изменения состояния исполненных платежных поручений
					МассивИдентификаторовПлатежныхПоручений = Новый Массив;
					Если ТипЗнч(Statement.BkToCstmrStmt.Stmt) = Тип("ОбъектXDTO") Тогда
						Выписки = Новый Массив;
						Выписки.Добавить(Statement.BkToCstmrStmt.Stmt);
					Иначе
						Выписки = Statement.BkToCstmrStmt.Stmt;
					КонецЕсли;

					Для Каждого Stmt Из Выписки Цикл
						Если Stmt.Свойства().Получить("Ntry") <> Неопределено И	Stmt.Ntry <> Неопределено Тогда
							Если ТипЗнч(Stmt.Ntry) = Тип("ОбъектXDTO") Тогда
								Транзакции = Новый Массив;
								Транзакции.Добавить(Stmt.Ntry);
							Иначе
								Транзакции = Stmt.Ntry;
							КонецЕсли;
							Для Каждого Транзакция Из Транзакции Цикл
								Если Транзакция.Свойства().Получить("NtryDtls") <> Неопределено И Транзакция.NtryDtls <> Неопределено Тогда
									Если ТипЗнч(Транзакция.NtryDtls) = Тип("ОбъектXDTO") Тогда
										ДеталиТранзакции = Новый Массив;
										ДеталиТранзакции.Добавить(Транзакция.NtryDtls);
									Иначе
										ДеталиТранзакции = Транзакция.NtryDtls;
									КонецЕсли;
									Для Каждого NtryDtls Из ДеталиТранзакции Цикл
										Если NtryDtls.Свойства().Получить("TxDtls") <> Неопределено И NtryDtls.TxDtls <> Неопределено Тогда
											Если ТипЗнч(NtryDtls.TxDtls) = Тип("ОбъектXDTO") Тогда
												Операции = Новый Массив;
												Операции.Добавить(NtryDtls.TxDtls);
											Иначе
												Операции = NtryDtls.TxDtls;
											КонецЕсли;
											Для Каждого TxDtls Из Операции Цикл
												Если TxDtls.Свойства().Получить("Refs") <> Неопределено И TxDtls.Refs <> Неопределено
													И TxDtls.Refs.Свойства().Получить("MsgId") <> Неопределено И ЗначениеЗаполнено(TxDtls.Refs.MsgId) Тогда
														МассивИдентификаторовПлатежныхПоручений.Добавить(TxDtls.Refs.MsgId);
												КонецЕсли;
											КонецЦикла
										КонецЕсли;
									КонецЦикла;
								КонецЕсли;
							КонецЦикла
						КонецЕсли;
					КонецЦикла;
					ОтметитьИсполненныеПлатежныеДокументы(
						НастройкаОбмена, Перечисления.ПрограммыБанка.АсинхронныйОбмен, МассивИдентификаторовПлатежныхПоручений);
				КонецЕсли;
			КонецЦикла;
		ИначеЕсли НЕ ResultBank.Error = Неопределено Тогда
			ТекстОшибки = ТекстСообщенияОбОшибкеОтветаБанка(ResultBank.Error);
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
		Если НЕ ДанныеВозврата.ЕстьОшибка Тогда
			ОбменСБанкамиСлужебныйВызовСервера.УстановитьСтатусПакета(
				ПакетОбменСБанками, Перечисления.СтатусыПакетовЭД.Распакован);
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Сохраняет полученный пакет в информационной базе.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена;
//  ИмяФайла - Строка - файл, полученный их банка;
//  ДанныеВозврата - Структура - см. описание ОбменСБанкамиКлиентСервер.ПараметрыПолученияНовыхДокументовАсинхронныйОбмен.
//
Процедура СохранитьПолученныйПакет(НастройкаОбмена, ИмяФайла, ДанныеВозврата) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураПараметров = Неопределено;
	
	ОбъектXML = Новый ЧтениеXML;
	
	Попытка
		ОбъектXML.ОткрытьФайл(ИмяФайла);
		ResultBank = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		Если ResultBank.Свойства().Получить("formatVersion") = Неопределено Тогда
			ВерсияФормата = ОбменСБанкамиКлиентСервер.УстаревшаяВерсияФорматаАсинхронногоОбмена();
		Иначе
			ВерсияФормата = ResultBank.formatVersion;
		КонецЕсли;
		ПространствоИмен = ПространствоИменАсинхронногоОбмена(ВерсияФормата);
		Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ВерсияФормата);
		ОбъектXML.ОткрытьФайл(ИмяФайла);
		ResultBank = ТипЗначенияCML(Фабрика, ПространствоИмен, "ResultBank");
		ResultBank = Фабрика.ПрочитатьXML(ОбъектXML, ResultBank);
	Исключение
		ТекстСообщения = НСтр("ru = 'Получены некорректные данные из банка. Для решения проблемы обратитесь в свой банк.'");
		
		ШаблонОшибкиДляЖурнала = НСтр("ru = 'Из банка получен файл с некорректным содержимым.
											|Путь к файлу: %1
											|Текст ошибки: %2.'");
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстОшибки = СтрШаблон(ШаблонОшибкиДляЖурнала, ИмяФайла, ПодробноеПредставлениеОшибки);
		
		ВидОперации = НСтр("ru = 'Чтение полученного из банка электронного документа.'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			ВидОперации, ТекстОшибки, , "ОбменСБанками", НастройкаОбмена);
		
		ВызватьИсключение ТекстСообщения;

	КонецПопытки;
	
	ОбъектXML.Закрыть();
	
	Если НЕ ResultBank.Error = Неопределено Тогда
		ТекстОшибки = ТекстСообщенияОбОшибкеОтветаБанка(ResultBank.Error);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
		ВызватьИсключение ТекстОшибки;
		Возврат;
	КонецЕсли;
	
	Если НЕ ResultBank.Success.GetPacketResponse = Неопределено Тогда
		СтруктураПараметров = Новый Структура;
		СтруктураПараметров.Вставить("НастройкаОбмена", НастройкаОбмена);
		СтруктураПараметров.Вставить("ВнешнийИдентификатор", ResultBank.Success.GetPacketResponse.id);
		СтруктураПараметров.Вставить("Статус", Перечисления.СтатусыПакетовЭД.КРаспаковке);
		СтруктураПараметров.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
		Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "Организация");
		СтруктураПараметров.Вставить("Организация", Организация);
		
		ПакетОбменСБанками = СформироватьНовыйПакетОбменСБанками(СтруктураПараметров);
		Если ЗначениеЗаполнено(ПакетОбменСБанками) Тогда
			ИмяФайлаПакета = "ResultBank_" + СтруктураПараметров.ВнешнийИдентификатор;
			ДвоичныеДанныеЭлемента = Новый ДвоичныеДанные(ИмяФайла);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
			
			АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеЭлемента);
			
			ПараметрыФайла = Новый Структура();
			ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
			ПараметрыФайла.Вставить("ВладелецФайлов", ПакетОбменСБанками);
			ПараметрыФайла.Вставить("ИмяБезРасширения", ИмяФайлаПакета);
			ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
			ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");

			РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, АдресВХранилище);
		Иначе
			ДанныеВозврата.ЕстьОшибка = Истина;
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
			Возврат;
		КонецЕсли;
		
		РаспаковатьПакетОбменСБанками(ПакетОбменСБанками, ДанныеВозврата);
		
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
	
	
КонецПроцедуры

// Определяет параметры распаковки пакетов электронных документов.
//
// Параметры:
//   ПакетыЭД - Массив - пакеты, которые пользователь решил распаковать:
//      * ДокументСсылка.ПакетОбменСБанками - ссылка на пакет.
//
// Возвращаемое значение:
//  Массив - пакеты, которые возможно распаковать:
//      * ДокументСсылка.ПакетОбменСБанками - ссылка на пакет ЭД.
//
Функция ГотовыеКРаспаковкеПакетыЭД(Знач ПакетыЭД) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	МассивВозврата = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПакетЭД.Ссылка КАК СсылкаНаДокумент,
	|	ЭДПрисоединенныеФайлы.Ссылка,
	|	ПакетЭД.Статус
	|ИЗ
	|	Документ.ПакетОбменСБанками КАК ПакетЭД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПакетОбменСБанкамиПрисоединенныеФайлы КАК ЭДПрисоединенныеФайлы
	|		ПО (ЭДПрисоединенныеФайлы.ВладелецФайла = ПакетЭД.Ссылка)
	|ГДЕ
	|	ПакетЭД.Ссылка В(&МассивСсылок)";
	
	Запрос.УстановитьПараметр("МассивСсылок", ПакетыЭД);
	
	ВыборкаПакеты = Запрос.Выполнить().Выбрать();
	
	Пока ВыборкаПакеты.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(ВыборкаПакеты.Ссылка) Тогда
			Операция = НСтр("ru = 'Распаковка пакета'");
			ТекстСообщения = НСтр("ru = 'Нет присоединенного файла для пакета: %1'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, ВыборкаПакеты.СсылкаНаДокумент);
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				Операция, ТекстСообщения, ТекстСообщения, "ОбменСБанками", ВыборкаПакеты.СсылкаНаДокумент);
			Продолжить;
		КонецЕсли;
		
		Если ВыборкаПакеты.Статус <> Перечисления.СтатусыПакетовЭД.КРаспаковке Тогда
			
			ШаблонСообщения = НСтр("ru = 'Статус пакета %1 отличен от значения ""К распаковке"".'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, ВыборкаПакеты.Ссылка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Продолжить;
		КонецЕсли;
		
		МассивВозврата.Добавить(ВыборкаПакеты.СсылкаНаДокумент);
		
	КонецЦикла;
	
	Возврат МассивВозврата;
	
КонецФункции

// Читает файл, полученный из банка и возвращает идентификаторы пакетов, которых еще нет в информационной базе.
// Исходный файл удаляет.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - текущая настройка обмена с банком.
//  ИмяФайла - Строка - путь к файлу, полученному из банка.
//  МассивИдентификаторов - Массив - содержит идентификаторы новых пакетов банка.
//     * Строка - идентификатор пакета.
//
Процедура ПрочитатьИдентификаторыПакетов(НастройкаОбмена, ИмяФайла, МассивИдентификаторов) Экспорт
	
	МассивИдентификаторов = Новый Массив;
	
	ОбъектXML = Новый ЧтениеXML;
		
	Попытка
		ОбъектXML.ОткрытьФайл(ИмяФайла);
		ResultBank = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		Если ResultBank.Свойства().Получить("formatVersion") = Неопределено Тогда
			ВерсияФормата = ОбменСБанкамиКлиентСервер.УстаревшаяВерсияФорматаАсинхронногоОбмена();
		Иначе
			ВерсияФормата = ResultBank.formatVersion;
		КонецЕсли;
		ПространствоИмен = ПространствоИменАсинхронногоОбмена(ВерсияФормата);
		Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ВерсияФормата);
		ОбъектXML.Закрыть();
		ОбъектXML.ОткрытьФайл(ИмяФайла);
		ТипResultBank = ТипЗначенияCML(Фабрика, ПространствоИмен, "ResultBank");
		ResultBank = Фабрика.ПрочитатьXML(ОбъектXML, ТипResultBank);
	Исключение
		КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстСообщения = НСтр("ru = 'При чтении данных, полученных из банка, произошла ошибка.'");
		ТекстОшибки = НСтр("ru = 'При чтении данных, полученных из банка, произошла ошибка.
								|Путь к файлу: %1
								|Подробное представление ошибки: %2'");
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстОшибки = СтрШаблон(ТекстОшибки, ИмяФайла, ПодробноеПредставлениеОшибки);
		ВидОперации = НСтр("ru = 'Чтение списка новых документов'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			ВидОперации, ТекстОшибки, , "ОбменСБанками", НастройкаОбмена);
		ВызватьИсключение ТекстСообщения;
	КонецПопытки;
	
	ОбъектXML.Закрыть();
		
	Если НЕ ResultBank.Success = Неопределено Тогда
		Если НЕ ResultBank.Success.GetPacketListResponse = Неопределено Тогда
			Для Каждого Идентификатор Из ResultBank.Success.GetPacketListResponse.PacketID Цикл
				МассивИдентификаторов.Добавить(Идентификатор);
			КонецЦикла;
			МассивИдентификаторов = ОбщегоНазначенияКлиентСервер.СвернутьМассив(МассивИдентификаторов);
			ПоследняяДатаПолученияЭД = ResultBank.Success.GetPacketListResponse.TimeStampLastPacket;
		Иначе
			Операция = НСтр("ru = 'Чтение ответа банка.'");
			ТекстОшибки = НСтр("ru = 'Получен некорректный ответ из банка
									|Файл ответа: %1'");
			ТекстОшибки = СтрШаблон(ТекстОшибки, ИмяФайла);
			ТекстСообщения = НСтр("ru = 'Получены некорректные данные из банка'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				Операция, ТекстОшибки, , "ОбменСБанками", НастройкаОбмена);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
	ИначеЕсли НЕ ResultBank.Error = Неопределено Тогда
		ТекстОшибки = ТекстСообщенияОбОшибкеОтветаБанка(ResultBank.Error);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеОСостоянии = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыОбменаСБанком(НастройкаОбмена);
	НачальнаяДатаПолученияЭД = ДанныеОСостоянии.ПоследняяДатаПолученияЭД;
	
	// Сдвиг даты в регистре сведений
	Если ЗначениеЗаполнено(ПоследняяДатаПолученияЭД) И ПоследняяДатаПолученияЭД > НачальнаяДатаПолученияЭД Тогда
		МенеджерЗаписи = РегистрыСведений.ПараметрыОбменСБанками.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.НастройкаОбмена = НастройкаОбмена;
		МенеджерЗаписи.Прочитать();
		МенеджерЗаписи.НастройкаОбмена = НастройкаОбмена;
		МенеджерЗаписи.ПоследняяДатаПолученияЭД = ПоследняяДатаПолученияЭД;
		МенеджерЗаписи.Записать();
	КонецЕсли;
	
	КС = Новый КвалификаторыСтроки(80);
	Массив = Новый Массив;
	Массив.Добавить(Тип("Строка"));
	ОписаниеТиповС = Новый ОписаниеТипов(Массив, , КС);
	
	ТаблицаИдентификаторов = Новый ТаблицаЗначений;
	ТаблицаИдентификаторов.Колонки.Добавить("Идентификатор", ОписаниеТиповС);
	
	Для Каждого Идентификатор Из МассивИдентификаторов Цикл
		НовСтрока = ТаблицаИдентификаторов.Добавить();
		НовСтрока.Идентификатор = Идентификатор;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаИдентификаторов.Идентификатор КАК Идентификатор
	|ПОМЕСТИТЬ ТаблицаИдентификаторов
	|ИЗ
	|	&ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПакетЭД.ВнешнийИдентификатор КАК ВнешнийИдентификатор
	|ПОМЕСТИТЬ ЗагруженныеПакеты
	|ИЗ
	|	Документ.ПакетОбменСБанками КАК ПакетЭД
	|ГДЕ
	|	ПакетЭД.ВнешнийИдентификатор В
	|			(ВЫБРАТЬ
	|				ТаблицаИдентификаторов.Идентификатор
	|			ИЗ
	|				ТаблицаИдентификаторов)
	|	И ПакетЭД.НастройкаОбмена = &НастройкаОбмена
	|	И ПакетЭД.Направление = ЗНАЧЕНИЕ(Перечисление.НаправленияЭД.Входящий)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТаблицаИдентификаторов.Идентификатор КАК Идентификатор
	|ИЗ
	|	ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|ГДЕ
	|	НЕ ТаблицаИдентификаторов.Идентификатор В
	|				(ВЫБРАТЬ
	|					ЗагруженныеПакеты.ВнешнийИдентификатор
	|				ИЗ
	|					ЗагруженныеПакеты)";
	Запрос.УстановитьПараметр("ТаблицаИдентификаторов", ТаблицаИдентификаторов);
	Запрос.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
	МассивИдентификаторов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Идентификатор");
	
КонецПроцедуры

// Создает документ ПакетОбменСБанками и заполняет его реквизиты.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - настройка обмена с банком,
//  МассивСообщений - Массив - содержит ссылки на документы СообщениеОбменСБанками,
//  ПакетОбменСБанками - ДокументСсылка.ПакетОбменСБанками - ссылка на созданный документ.
//
Процедура СоздатьПакетОбменСБанками(НастройкаОбмена, МассивСообщений, ПакетОбменСБанками) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ПакетОбменСБанкамиОбъект = Документы.ПакетОбменСБанками.СоздатьДокумент();
	ПакетОбменСБанкамиОбъект.Дата = ТекущаяДатаСеанса();
	ПакетОбменСБанкамиОбъект.Направление = Перечисления.НаправленияЭД.Исходящий;
	ПакетОбменСБанкамиОбъект.НастройкаОбмена = НастройкаОбмена;
	ПакетОбменСБанкамиОбъект.Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "Организация");
	ПакетОбменСБанкамиОбъект.Статус = Перечисления.СтатусыПакетовЭД.ПодготовленКОтправке;
	ПакетОбменСБанкамиОбъект.Идентификатор = Строка(Новый УникальныйИдентификатор);
	
	Для Каждого Сообщение Из МассивСообщений Цикл
		НоваяСтрока = ПакетОбменСБанкамиОбъект.Сообщения.Добавить();
		НоваяСтрока.Сообщение = Сообщение;
	КонецЦикла;
	
	Попытка
		ПакетОбменСБанкамиОбъект.Записать();
		ПакетОбменСБанками = ПакетОбменСБанкамиОбъект.Ссылка;
	Исключение
		КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		Операция = НСтр("ru = 'формирование пакета ЭДО'");
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			Операция, ПодробноеПредставлениеОшибки, КраткоеПредставлениеОшибки, "ОбменСБанками", НастройкаОбмена);
	КонецПопытки;

КонецПроцедуры

// Создает электронный документ для пакета документов.
//
// Параметры:
//  Конверт  - ДокументСсылка.ПакетЭД - ссылка на пакет;
//  ЕстьОшибка - Булево - возвращает Истина, если электронный документ не удалось сформировать;
//  СвойстваСертификатов - Соответствие - свойства сертификатов не x509:
//    * Ключ - Строка - отпечаток сертификата;
//    * Значение - Структура - свойства сертификата:
//          ** СерийныйНомер - Строка - серийный номер сертификата;
//          ** ИмяИздателя - Строка - имя издателя.
//
Процедура СоздатьЭДПакетаAsync(Конверт, ЕстьОшибка, СвойстваСертификатов = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	НастройкаОбмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Конверт, "НастройкаОбмена");

	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкаОбмена, "Организация, Банк, ИдентификаторОрганизации, СжиматьДанныеПакетаЭД, ВерсияФормата");
	СведенияОбОрганизации = Неопределено; 
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(
		РеквизитыНастройкиОбмена.Организация, СведенияОбОрганизации);
	РеквизитыБанка = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыНастройкиОбмена.Банк, "Наименование, Код");

	Если ЗначениеЗаполнено(РеквизитыНастройкиОбмена.ВерсияФормата) Тогда
		ВерсияФормата = РеквизитыНастройкиОбмена.ВерсияФормата;
	Иначе
		ВерсияФормата = ОбменСБанкамиКлиентСервер.АктуальнаяВерсияФорматаАсинхронногоОбмена();
	КонецЕсли;
	
	Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ВерсияФормата);
	
	ПространствоИмен = ПространствоИменАсинхронногоОбмена(ВерсияФормата);
	
	Попытка
		ТекстОшибки = "";
		
		Packet = ОбъектТипаCML(Фабрика, "Packet", ПространствоИмен);
		Sender = ОбъектТипаCML(Фабрика, "ParticipantType", ПространствоИмен);
		CustomerPartyType = ОбъектТипаCML(Фабрика, "CustomerPartyType", ПространствоИмен);
		
		ЗаполнитьСвойствоXDTO(
			CustomerPartyType, "id", РеквизитыНастройкиОбмена.ИдентификаторОрганизации, Истина, ТекстОшибки);
		ПолноеНаименованиеОрганизации = Сред(СведенияОбОрганизации.ПолноеНаименование, 1, 160);
		ЗаполнитьСвойствоXDTO(CustomerPartyType, "name", ПолноеНаименованиеОрганизации, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(CustomerPartyType, "inn", СведенияОбОрганизации.ИНН, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(CustomerPartyType, "kpp", СведенияОбОрганизации.КПП, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(Sender, "Customer", CustomerPartyType, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(Packet, "Sender", Sender, Истина, ТекстОшибки);
		
		Recipient = ОбъектТипаCML(Фабрика, "ParticipantType", ПространствоИмен);
		BankPartyType = ОбъектТипаCML(Фабрика, "BankPartyType", ПространствоИмен);
		ЗаполнитьСвойствоXDTO(BankPartyType, "bic", РеквизитыБанка.Код, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(BankPartyType, "name", РеквизитыБанка.Наименование, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(Recipient, "Bank", BankPartyType, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(Packet, "Recipient", Recipient, Истина, ТекстОшибки);
		
		Для каждого Строка Из Конверт.Сообщения Цикл
			
			СообщениеОбмена = Строка.Сообщение;
			ДанныеЭД = ОбменСБанкамиСлужебныйВызовСервера.ДвоичныеДанныеПрисоединенногоФайла(СообщениеОбмена);
			ИмяФайла = ПолучитьИмяВременногоФайла("xml");
			ДанныеЭД.Записать(ИмяФайла);
			
			РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СообщениеОбмена, "ВидЭД, Идентификатор");
			
			ВидЭД = РеквизитыЭД.ВидЭД;
			
			Если РеквизитыНастройкиОбмена.СжиматьДанныеПакетаЭД Тогда
				ПотокВПамяти = Новый ПотокВПамяти();
				ЗаписьZIP = Новый ЗаписьZipФайла(ПотокВПамяти, , , , УровеньСжатияZIP.Максимальный);
				ЗаписьZIP.Добавить(ИмяФайла);
				ЗаписьZIP.Записать();
				ДанныеЭД = ПотокВПамяти.ЗакрытьИПолучитьДвоичныеДанные();
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
			
			DocumentType = ОбъектТипаCML(Фабрика, "DocumentType", ПространствоИмен);
			ЗаполнитьСвойствоXDTO(DocumentType, "id", РеквизитыЭД.Идентификатор, Истина, ТекстОшибки);
			Если ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение Тогда
				ВидЭДПакета = "10"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование Тогда
				ВидЭДПакета = "11"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки Тогда
				ВидЭДПакета = "14"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросОСостоянииЭД Тогда
				ВидЭДПакета = "03"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросНаОтзывЭД Тогда
				ВидЭДПакета = "04"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросЗонд Тогда
				ВидЭДПакета = "05"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.СписокНаЗачислениеДенежныхСредствНаСчетаСотрудников Тогда
				ВидЭДПакета = "21"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.СписокНаОткрытиеСчетовПоЗарплатномуПроекту Тогда
				ВидЭДПакета = "19"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.СписокУволенныхСотрудников Тогда
				ВидЭДПакета = "23"
			ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты Тогда
				ВидЭДПакета = "30"
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(DocumentType, "docKind", ВидЭДПакета, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(DocumentType, "formatVersion", ВерсияФормата, Истина, ТекстОшибки);
			Если РеквизитыНастройкиОбмена.СжиматьДанныеПакетаЭД Тогда
				ЗаполнитьСвойствоXDTO(DocumentType, "compressed", Истина, , ТекстОшибки);
			КонецЕсли;
			
			data = ОбъектТипаCML(Фабрика, "DocumentType.data", ПространствоИмен);
			ЗаполнитьСвойствоXDTO(data, "__content", ДанныеЭД, Истина, ТекстОшибки);
			
			ЗаполнитьСвойствоXDTO(DocumentType, "data", data, Истина, ТекстОшибки);
			МассивПодписей = ПодписиСообщенияОбмена(СообщениеОбмена);
			
			Для Каждого СтрокаПодписи Из МассивПодписей Цикл
				signature = ОбъектТипаCML(Фабрика, "DocumentType.signature", ПространствоИмен);
				ЗаполнитьСвойствоXDTO(signature, "signedData", СтрокаПодписи.Подпись.Получить(), Истина, ТекстОшибки);
				Если СвойстваСертификатов = Неопределено Тогда
					Сертификат = Новый СертификатКриптографии(СтрокаПодписи.Сертификат.Получить());
					ЗаполнитьСвойствоXDTO(signature, "x509SerialNumber", Сертификат.СерийныйНомер, Истина, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(signature, "x509IssuerName", Сертификат.Издатель.CN, Истина, ТекстОшибки);
				Иначе
					СвойстваСертификата = СвойстваСертификатов.Получить(СтрокаПодписи.Отпечаток);
					Если СвойстваСертификата = Неопределено Тогда
						ВызватьИсключение НСтр("ru = 'Ошибка чтения свойств сертификата'");
					КонецЕсли;
					ЗаполнитьСвойствоXDTO(signature, "x509SerialNumber", СвойстваСертификата.СерийныйНомер, Истина, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(signature, "x509IssuerName", СвойстваСертификата.ИмяИздателя, Истина, ТекстОшибки);
				КонецЕсли;
				
				DocumentType.signature.Добавить(signature);
			КонецЦикла;
			
			Packet.Document.Добавить(DocumentType);
			
		КонецЦикла;
		
		ЗаполнитьСвойствоXDTO(Packet, "id", Строка(Конверт.Идентификатор), Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(Packet, "formatVersion", ВерсияФормата, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(Packet, "creationDate", ТекущаяДатаСеанса(), Истина, ТекстОшибки);
		ВерсияПрограммы = ОбменСБанкамиСлужебныйПовтИсп.ВерсияПрограммыКлиентаДляБанка();
		ЗаполнитьСвойствоXDTO(Packet, "userAgent", ВерсияПрограммы, , ТекстОшибки);
		
		Packet.Проверить();
		
		Если ЗначениеЗаполнено(ТекстОшибки) Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ОбъектКонверт = Конверт.ПолучитьОбъект();
			ОбъектКонверт.ПометкаУдаления = Истина;
			ОбъектКонверт.Записать();
		Иначе
			ДвоичныеДанные = ДвоичныеДанныеИзXDTO(Фабрика, Packet, Ложь);
			СоздатьПрисоединенныйФайл(Конверт, ДвоичныеДанные);
		КонецЕсли;
		
	Исключение
		ОбъектКонверт = Конверт.ПолучитьОбъект();
		ОбъектКонверт.ПометкаУдаления = Истина;
		ОбъектКонверт.Записать();
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ВидОперации = НСтр("ru = 'Формирование ЭД'");
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			ВидОперации, ПодробноеПредставлениеОшибки, ТекстСообщения, "ОбменСБанками", НастройкаОбмена);
		ЕстьОшибка = Истина;
	КонецПопытки;
	
КонецПроцедуры

// Добавляет присоединенный файл для пакета ЭДО.
//  Конверт - ДокументСсылка.ПакетОбменСБанками - созданный пакет.
//
Процедура СоздатьЭДПакетаCMSDETACHED(Конверт) Экспорт
	
	СообщениеОбмена = Конверт.Сообщения[0].Сообщение;
	
	Данные = ОбменСБанкамиСлужебныйВызовСервера.ДвоичныеДанныеПрисоединенногоФайла(СообщениеОбмена);
	
	URI = "urn:x-obml:1.0";
	ТипMessage = ФабрикаXDTO.Тип("urn:x-obml:1.0","CMSDETACHED");
	Message = ФабрикаXDTO.Создать(ТипMessage);
	ТипData = ТипMessage.Свойства[0].Тип;
	Data = ФабрикаXDTO.Создать(ТипData);
	Data.ContentType = "application/xml";
	Data.__content = Данные;
	Message.data = Data;
	
	ЭлектронныеПодписи = ПодписиСообщенияОбмена(СообщениеОбмена);
	
	Для Каждого СтрокаПодписи Из ЭлектронныеПодписи Цикл
		Message.signature.Добавить(СтрокаПодписи.Подпись.Получить());
	КонецЦикла;
	
	Запись = Новый ЗаписьXML;
	Поток = Новый ПотокВПамяти();
	Запись.ОткрытьПоток(Поток);
	Запись.ЗаписатьОбъявлениеXML();
	ФабрикаXDTO.ЗаписатьXML(Запись, Message, "signed", URI, , НазначениеТипаXML.Явное);
	Запись.Закрыть();
	ДвоичныеДанные = Поток.ЗакрытьИПолучитьДвоичныеДанные();
	
	СоздатьПрисоединенныйФайл(Конверт, ДвоичныеДанные);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработкаВходящихДанных

// Возвращает тест ошибки, полученной из банка.
//
// Параметры:
//  Ошибка - ОбъектXDTO - данные об ошибке.
// 
// Возвращаемое значение:
// Строка - подробная информация об ошибке.
//
Функция ТекстСообщенияОбОшибкеОтветаБанка(Ошибка) Экспорт
	
	ШаблонОшибки = НСтр("ru = 'Получена ошибка из банка (%1). Код ошибки %2.
						|%3%4'");
	Дата = Формат(ТекущаяДатаСеанса(), "ДЛФ=DT");
	ДопИнформация = ?(ЗначениеЗаполнено(Ошибка.MoreInfo), ": " + Ошибка.MoreInfo, "");
	ТекстОшибки = СтрШаблон(
		ШаблонОшибки, Дата, Ошибка.Code, Ошибка.Description, ДопИнформация);
	
	Возврат ТекстОшибки;
	
КонецФункции

#КонецОбласти

#Область ЭлектронныеПодписи

// Возвращает подписи электронного документа, прикрепленного к сообщению.
// 
// Параметры:
//    СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками - ссылка на сообщение.
//
// Возвращаемый параметр:
//    Массив - массив данных подписей:
//      * Структура:
//         ** Подпись - ХранилищеЗначения - содержит двоичные данные подписи.
//         ** КомуВыданСертификат - Строка - владелец сертификата.
//         ** ИмяФайлаПодписи - Строка - название файла подписи.
//         ** Сертификат - ХранилищеЗначения - двоичные данные сертификата установленной подписи.
//
Функция ПодписиСообщенияОбмена(СообщениеОбмена) Экспорт
	
	МассивВозврата = Новый Массив;
	МассивФайлов = Новый Массив;
	РаботаСФайлами.ЗаполнитьПрисоединенныеФайлыКОбъекту(СообщениеОбмена, МассивФайлов);
	
	Если МассивФайлов.Количество() Тогда
		Возврат ПолучитьВсеПодписи(МассивФайлов[0]);
	КонецЕсли;
	
	Возврат МассивВозврата;
	
КонецФункции

// Определяет по настройке, подписывается ли данный вид ЭД.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - ссылка на настройку обмена;
//  ВидЭД - ПеречислениеСсылка.ВидыЭД - вид электронного документа.
//
// Возвращаемое значение:
//  Булево - Истина, если документ нужно подписывать.
//
Функция ПодписыватьВидЭД(НастройкаОбмена, ВидЭД) Экспорт
	
	РеквизитыНастройкиОбмена = ОбменСБанкамиСлужебныйВызовСервера.ПараметрыОбменаПоВидуЭД(НастройкаОбмена, ВидЭД);
	Возврат РеквизитыНастройкиОбмена.ТребуетсяПодпись;
	
КонецФункции

#КонецОбласти

#Область МетодыXDTO

// Получение типа XDTO по имени и URI пространства имен.
//
// Параметры:
//  Фабрика - ФабрикаXDTO - Фабрика типов XDTO.
//  URIПространстваИмен - Строка - URI пространства имен запрашиваемого типа.
//  Имя - Строка - Имя запрашиваемого типа. 
// 
// Возвращаемое значение:
// ТипЗначенияXDTO; ТипОбъектаXDTO; Неопределено - тип XDTO.
//
Функция ТипЗначенияCML(Фабрика, URIПространстваИмен, Имя) Экспорт
	
	Попытка
		ТипЗначения = Фабрика.Тип(URIПространстваИмен, Имя);
	Исключение
		ТипЗначения = Неопределено;
	КонецПопытки;
	
	Возврат ТипЗначения;
	
КонецФункции

// Получает объект типа CML.
//
// Параметры:
//  Фабрика - ФабрикаXDTO - Фабрика типов XDTO
//  Путь - Строка - путь к объекту
//  URIПространстваИмен - Строка - URI пространства имен запрашиваемого типа.
// 
// Возвращаемое значение:
//  ЗначениеXDTO - Значение простого типа XDTO.
//
Функция ОбъектТипаCML(Фабрика, Путь, URIПространстваИмен) Экспорт
	
	Если ТипЗнч(Путь) = Тип("Строка") Тогда
		ТипОбъекта = ТипОбъектаCML(Фабрика, URIПространстваИмен, Путь);
	Иначе
		ТипОбъекта = Путь;
	КонецЕсли;
	
	Если ТипОбъекта = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	НовыйОбъект = Фабрика.Создать(ТипОбъекта);
	
	Возврат НовыйОбъект;
	
КонецФункции

// Получает двоичные данные из объекта XDTO.
//
// Параметры:
//  Фабрика - ФабрикаXDTO - Фабрика типов XDTO, с помощью которой производится выгрузка.
//  ЭД - ЗначениеXDTO; ОбъектXDTO; Неопределено- Записываемое значение.
//  УказаниеТипа - Булево - Вариант назначения типа элемента данных XDTO, если Истина, то указание типа Явное.
//  ЛокальноеИмя - Строка - Локальное имя записываемого элемента данных.
//
// Возвращаемое значение:
//  ДвоичныеДанные - данные электронного документа.
//
Функция ДвоичныеДанныеИзXDTO(Фабрика, ЭД, УказаниеТипа = Истина, ЛокальноеИмя = Неопределено) Экспорт
	
	НоваяЗаписьXML = Новый ЗаписьXML;
	ПотокВПамяти = Новый ПотокВПамяти();
	НоваяЗаписьXML.ОткрытьПоток(ПотокВПамяти, "UTF-8");
	НоваяЗаписьXML.ЗаписатьОбъявлениеXML();
	НазначениеТипа = ?(УказаниеТипа, НазначениеТипаXML.Явное, НазначениеТипаXML.Неявное);
	Фабрика.ЗаписатьXML(НоваяЗаписьXML, ЭД, ЛокальноеИмя, , , НазначениеТипа);
	НоваяЗаписьXML.Закрыть();
	Возврат ПотокВПамяти.ЗакрытьИПолучитьДвоичныеДанные();
	
КонецФункции

// Заполняет свойство объекта XDTO.
//
// Параметры
//  ОбъектXDTO   - объект заполнения;
//  ИмяСвойства  - свойство объекта;
//  Значение     - устанавливаемое значение;
//  Обязательное - булево - признак обязательности заполнения свойства;
//  ТекстОшибки  - строка - текст ошибки в случае неудачного заполнения.
//
Процедура ЗаполнитьСвойствоXDTO(ОбъектXDTO, ИмяСвойства, Значение, Обязательное = Ложь, ТекстОшибки = "", УстанавливатьПустыеЗначения = Ложь) Экспорт
	
	Если ТипЗнч(Значение) = Тип("ЗначениеXDTO") ИЛИ ТипЗнч(Значение) = Тип("ОбъектXDTO") Тогда
		УстановитьЗначениеXDTO(ОбъектXDTO, ИмяСвойства, Значение, ТекстОшибки);
	Иначе
		Если Обязательное ИЛИ ЗначениеЗаполнено(Значение) ИЛИ УстанавливатьПустыеЗначения Тогда
			УстановитьЗначениеXDTO(ОбъектXDTO, ИмяСвойства, Значение, ТекстОшибки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ФормированиеЭД

// Формирует данные для электронного документа Справка о подтверждающих документах
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьСправкуОПодтверждающихДокументах(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.СправкаОПодтверждающихДокументах);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	
	СтруктураПараметров.Вставить("Организация", СсылкаНаОбъект.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);

	ТекстОшибки = "";
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, ТекстОшибки);
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(ТекстОшибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникла ошибка:
								|%2'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);
		
	ДобавитьЗначениеВДерево(ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	АдресФайлаВоВременномХранилище = Неопределено;
	
	СформироватьСправкуОПодтверждающихДокументахСбербанк(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	
	СуммаДокумента = ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма");
	СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
	СтруктураЭД.Вставить("Основной", Истина);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);

КонецПроцедуры

// Формирует данные для электронного документа Поручение на продажу валюты
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьРаспоряжениеНаОбязательнуюПродажуВалюты(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.РаспоряжениеНаОбязательнуюПродажуВалюты);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	
	СтруктураПараметров.Вставить("Организация", СсылкаНаОбъект.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);

	ТекстОшибки = "";
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, ТекстОшибки);
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(ТекстОшибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникла ошибка:
								|%2'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);
		
	ДобавитьЗначениеВДерево(ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
		
	АдресФайлаВоВременномХранилище = Неопределено;
	
	СформироватьРаспоряжениеНаОбязательнуюПродажуВалютыСбербанк(
		СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	
	СуммаДокумента = ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма");
	СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
	СтруктураЭД.Вставить("Основной", Истина);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
	
КонецПроцедуры

// Формирует данные для электронного документа Поручение на продажу валюты
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьПоручениеНаПродажуВалюты(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПродажуВалюты);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	
	СтруктураПараметров.Вставить("Организация", СсылкаНаОбъект.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);

	ТекстОшибки = "";
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, ТекстОшибки);
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(ТекстОшибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникла ошибка:
								|%2'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);
		
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	АдресФайлаВоВременномХранилище = Неопределено;
	
	СформироватьПоручениеНаПродажуВалютыСбербанк(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);

	СуммаДокумента = ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма");
	СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
	СтруктураЭД.Вставить("Основной", Истина);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);

КонецПроцедуры

// Формирует данные для электронного документа Поручение на покупку валюты
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьПоручениеНаПокупкуВалюты(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПокупкуВалюты);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	СтруктураПараметров.Вставить("Организация", СсылкаНаОбъект.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);

	ТекстОшибки = "";
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, ТекстОшибки);
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(ТекстОшибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникла ошибка:
								|%2'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);
		
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	АдресФайлаВоВременномХранилище = Неопределено;
	
	СформироватьПоручениеНаПокупкуВалютыСбербанк(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	
	СуммаДокумента = ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма");
	СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
	СтруктураЭД.Вставить("Основной", Истина);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
	
КонецПроцедуры

// Формирует данные для электронного документа Поручение на перевод валюты
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьПоручениеНаПереводВалюты(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	Если НастройкиОбменаЭД.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
		СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	Иначе
		СтруктураЭД.Вставить("Идентификатор", СтрЗаменить(Строка(Новый УникальныйИдентификатор), "-", ""));
	КонецЕсли;
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);

	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);

	ТекстОшибки = "";
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, ТекстОшибки);
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(ТекстОшибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникла ошибка:
								|%2'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	ПрограммаБанка = НастройкиОбменаЭД.ПрограммаБанка;
	
	АдресФайлаВоВременномХранилище = Неопределено;
	
	Если ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен Тогда
		СформироватьПлатежноеПоручениеISO(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	Иначе
		СформироватьПоручениеНаПереводВалютыСбербанк(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	КонецЕсли;
	
	СуммаДокумента = ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма");
	СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
	СтруктураЭД.Вставить("Основной", Истина);
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(
		ДеревоДокумента, "РеквизитыПлатежа.НазначениеПлатежа");
	СтруктураЭД.Вставить("ДополнительнаяИнформация", НазначениеПлатежа);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
	СтруктураПараметров.Вставить("Организация", НастройкиОбменаЭД.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);

КонецПроцедуры

// Формирует данные для электронного документа Платежное требование
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьПлатежноеТребование(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	СтруктураПараметров.Вставить("Организация", НастройкиОбменаЭД.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);

	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки);
	Если ЗначениеЗаполнено(Ошибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(Ошибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникли следующие ошибки:
								|%2'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
		
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
		
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);

	ДобавитьЗначениеВДерево(ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	ПрограммаБанка = НастройкиОбменаЭД.ПрограммаБанка;
	
	АдресФайлаВоВременномХранилище = Неопределено;
	СформироватьПлатежноеТребованиеAsync(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	
	СтруктураЭД.Вставить("СуммаДокумента", ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма"));
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(
		ДеревоДокумента, "РеквизитыПлатежа.НазначениеПлатежа");
	СтруктураЭД.Вставить("ДополнительнаяИнформация", НазначениеПлатежа);
	СтруктураЭД.Вставить("Основной", Истина);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);

КонецПроцедуры

// Формирует данные для электронного документа Платежное поручение
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на документ информационной базы, на основании которого формируется электронный документ;
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами
//  ДеревоДокумента - ДеревоЗначений - данные, помещаемые в электронный документ
//  СтруктураПараметров - Структура - данные, возвращаемые процедурой.
//
Процедура СформироватьПлатежноеПоручение(СсылкаНаОбъект, НастройкиОбменаЭД, ДеревоДокумента, СтруктураПараметров) Экспорт
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	СтруктураЭД.Вставить("Подписывать", НастройкиОбменаЭД.Подписывать);
	
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки);
	
	Если СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ПечатныйНомерДокумента) = 0 Тогда
		ТекстОшибки = НСтр("ru = 'Недопустимый номер документа.'");
		ПараметрыОбработкиОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.НовыеПараметрыОшибки(СсылкаНаОбъект);
		ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.ДобавитьОшибку(Ошибки, ТекстОшибки, ПараметрыОбработкиОшибки);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Ошибки) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.СоединитьОшибки(Ошибки);
		ШаблонСообщения = НСтр("ru = 'При формировании электронного документа для документа %1 возникла ошибка:
									|%2'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, СсылкаНаОбъект, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ИдДокумента", СтруктураЭД.Идентификатор);
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		НастройкиОбменаЭД.НастройкаОбмена, "ИдентификаторОрганизации, ВерсияФормата");
	ДобавитьЗначениеВДерево(
		ДеревоДокумента, "ИдКлиента", РеквизитыНастройкиОбмена.ИдентификаторОрганизации);
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ПредставлениеДокумента = ПредставлениеЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, ПечатныйНомерДокумента);
	
	ДобавитьЗначениеВДерево(ДеревоДокумента, "Номер", СтруктураЭД.НомерДокументаОтправителя);
	ДобавитьЗначениеВДерево(ДеревоДокумента, "ВерсияФормата", РеквизитыНастройкиОбмена.ВерсияФормата);
	
	ПрограммаБанка = НастройкиОбменаЭД.ПрограммаБанка;
	
	АдресФайлаВоВременномХранилище = Неопределено;
	
	Если ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
		СформироватьПлатежноеПоручениеСбербанк(
			СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище, НастройкиОбменаЭД.Подписывать);
	ИначеЕсли ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен
		ИЛИ ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК Тогда
		СформироватьПлатежноеПоручениеAsync(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	Иначе
		СформироватьПлатежноеПоручениеCML(СсылкаНаОбъект, ДеревоДокумента, АдресФайлаВоВременномХранилище);
	КонецЕсли;
	
	СуммаДокумента = ЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма");
	СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
	СтруктураЭД.Вставить("Основной", Истина);
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(ДеревоДокумента, "РеквизитыПлатежа.НазначениеПлатежа");
	СтруктураЭД.Вставить("ДополнительнаяИнформация", НазначениеПлатежа);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ПредставлениеДокумента);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайлаВоВременномХранилище);
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
		СтруктураПараметров.Вставить("Организация", НастройкиОбменаЭД.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);
	
КонецПроцедуры

// Функция формирует документы сообщений обмена
//
// Параметры:
//  МассивОбъектов - массив ссылок на объекты, для которых нужно создать сообщения обмена;
//  ПараметрыОбмена - соответствие, содержащая настройки обмена для объектов.
//
Функция СформироватьСообщенияОбмена(МассивОбъектов, ПараметрыОбмена) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	МассивСтруктурОбмена = СформироватьXMLФайлыДокументов(МассивОбъектов, ПараметрыОбмена);
	МассивСформированныхСообщений = Новый Массив;
	Для Каждого СтруктураОбмена Из МассивСтруктурОбмена Цикл
	
		СообщениеОбмена = Неопределено;
		
		СохранитьСообщениеОбмена(СтруктураОбмена.СтруктураЭД, СообщениеОбмена);
		Если СтруктураОбмена.СтруктураЭД.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн
			И СтруктураОбмена.СтруктураЭД.Подписывать Тогда
			
			Дайджест = ОбменСБанкамиСлужебныйВызовСервера.ДайджестСбербанк(СтруктураОбмена.СтруктураЭД.ВидЭД,
				СтруктураОбмена.СтруктураЭД.АдресФайлаВоВременномХранилище, СтруктураОбмена.СтруктураЭД.НастройкаОбмена);
			АдресХранилища = ПоместитьВоВременноеХранилище(Base64Значение(Дайджест));
			
			ПараметрыСообщения = Новый Структура;
			ПараметрыСообщения.Вставить("ПредставлениеДокумента", НСтр("ru = 'Схема данных'"));
			ПараметрыСообщения.Вставить("АдресФайлаВоВременномХранилище", АдресХранилища);
			ПараметрыСообщения.Вставить("НастройкаОбмена", СтруктураОбмена.СтруктураЭД.НастройкаОбмена);
			ПараметрыСообщения.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ДополнительныеДанные);
			ПараметрыСообщения.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
			ПараметрыСообщения.Вставить("СообщениеРодитель", СообщениеОбмена);
			ПараметрыСообщения.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
			СообщениеДайджест = Неопределено;
			СохранитьСообщениеОбмена(ПараметрыСообщения, СообщениеДайджест);
		КонецЕсли;

		МассивСформированныхСообщений.Добавить(СообщениеОбмена);
		
	КонецЦикла;
	
	Возврат МассивСформированныхСообщений;
	
КонецФункции

// Возвращает дерево с данными файла.
//
// Параметры:
//  ВидЭД - ПеречислениеСсылка.ВидыЭДОбменСБанками - вид электронного документа.
//  ДанныеФайла - ДвоичныеДанные - содержимое файла.
//
// Возвращаемое значение:
//  Структура - данные дерева.
//
Функция СформироватьДеревоРазбора(ВидЭД, ДанныеФайла) Экспорт
	
	ДеревоРазбора = ЭлектронноеВзаимодействиеСлужебный.ИнициализироватьДеревоРазбора();
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
		ДеревоРазбора, "ОбменСБанками");
	НовыйЭД = НайденныйТипВДереве.Строки.Добавить();
	
	Результат = ПрочитатьФайлПоСхеме(ВидЭД, ДанныеФайла, ДеревоРазбора, НовыйЭД);
	
	Если НЕ Результат Тогда // ошибка разбора ЭД
		Возврат Неопределено;
	КонецЕсли;
	
	НайденнаяСтрока = ДеревоРазбора.Строки.Найти("ОбменСБанками", "ТипОбъекта"); // раздел ОбменСБанками
	СтрокаОбъекта = НайденнаяСтрока.Строки[0];
	
	Возврат Новый Структура("ДеревоРазбора, СтрокаОбъекта", ДеревоРазбора, СтрокаОбъекта);
	
	
КонецФункции

// Функция возвращает пересечение массива сертификатов, установленных в личном хранилище
// с массивом сертификатов зарегистрированных в 1с (действующих и доступных текущему пользователю).
// В случае, если передан необязательный параметр НастройкаОбмена, то массив зарегистрированных в 1с сертификатов,
// дополнительно ограничивается условием вхождения в список зарегистрированных по данной настройке.
//
// Параметры:
//  МассивОтпечатков - массив - содержит строки отпечатков сертификатов, установленных в хранилище на Клиенте/Сервере
//    (в зависимости от настроек работы с криптографией).
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками, настройкаОбмена, список сертификатов
//   по которой требуется получить.
//
// Возвращаемое значение - таблица значений.
//
Функция ТаблицаДоступныхДляПодписиСертификатов(МассивОтпечатков, НастройкаОбмена = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	ВозвращаемоеЗначение = Новый ТаблицаЗначений;
	ЗапросПоСертификатам = Новый Запрос;
	Если ЗначениеЗаполнено(НастройкаОбмена) Тогда
		ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Сертификаты.Ссылка,
		|	НЕОПРЕДЕЛЕНО КАК ПарольСертификата,
		|	ЛОЖЬ КАК ПарольПолучен,
		|	Сертификаты.Отпечаток
		|ИЗ
		|	Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификаты
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПодписываемыеВидыЭД КАК ВидыЭДЭП
		|			ПО Сертификаты.Ссылка = ВидыЭДЭП.СертификатЭП
		|		ПО НастройкиОбменаСертификаты.СертификатЭП = Сертификаты.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками КАК НастройкиОбменСБанками
		|		ПО НастройкиОбменаСертификаты.Ссылка = НастройкиОбменСБанками.Ссылка
		|ГДЕ
		|	НастройкиОбменСБанками.Ссылка = &НастройкаОбмена
		|	И Сертификаты.Отпечаток В(&МассивОтпечатков)
		|	И &ПроверкаПользователя
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Сертификаты.Ссылка,
		|	НЕОПРЕДЕЛЕНО,
		|	ЛОЖЬ,
		|	Сертификаты.Отпечаток
		|ИЗ
		|	Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификаты
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПодписываемыеВидыЭД КАК ВидыЭДЭП
		|			ПО Сертификаты.Ссылка = ВидыЭДЭП.СертификатЭП
		|		ПО НастройкиОбменаСертификаты.СертификатЭП = Сертификаты.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками КАК НастройкиОбменСБанками
		|		ПО НастройкиОбменаСертификаты.Ссылка = НастройкиОбменСБанками.Ссылка
		|ГДЕ
		|	НастройкиОбменСБанками.Ссылка = &НастройкаОбмена
		|	И НастройкиОбменСБанками.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.СбербанкОнлайн)
		|	И &ПроверкаПользователя";
		ЗапросПоСертификатам.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
	Иначе
		ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Сертификаты.Ссылка,
		|	НЕОПРЕДЕЛЕНО КАК ПарольСертификата,
		|	ЛОЖЬ КАК ПарольПолучен,
		|	Сертификаты.Отпечаток
		|ИЗ
		|	Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|ГДЕ
		|	НЕ Сертификаты.Отозван
		|	И Сертификаты.Отпечаток В(&МассивОтпечатков)
		|	И &ПроверкаПользователя";
	КонецЕсли;
	
	Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПроверкаПользователя", "ИСТИНА");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПроверкаПользователя",
			"Сертификаты.Пользователь В (&ТекущийПользователь, &ПустойПользователь, &ПользовательНеУказан)");
		ЗапросПоСертификатам.УстановитьПараметр("ТекущийПользователь", Пользователи.АвторизованныйПользователь());
		ЗапросПоСертификатам.УстановитьПараметр("ПустойПользователь", Справочники.Пользователи.ПустаяСсылка());
		ЗапросПоСертификатам.УстановитьПараметр("ПользовательНеУказан",  Пользователи.СсылкаНеуказанногоПользователя());
	КонецЕсли;
	
	ЗапросПоСертификатам.Текст = ТекстЗапроса;
	
	ЗапросПоСертификатам.УстановитьПараметр("МассивОтпечатков", МассивОтпечатков);
	ВозвращаемоеЗначение = ЗапросПоСертификатам.Выполнить().Выгрузить();

	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Обработчик события "ПередЗаписью" владельцев электронных документов.
//
// Параметры:
//  Источник        - Объект - владелец присоединенного файла.
//  Отказ           - Булево - признак отказа от записи.
//  РежимЗаписи     - РежимЗаписиДокумента - режим записи владельца электронного документа.
//  РежимПроведения - РежимПроведенияДокумента - режим проведения владельца электронного документа.
//
Процедура ОбменСБанкамиВладелецЭДПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;

	Если НЕ ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ЗначениеФункциональнойОпции("ИспользоватьОбменСБанками") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.ПакетОбменСБанками") Тогда
		Возврат;
	КонецЕсли;
	
	Если Источник.ЭтоНовый() Тогда
		Источник.ДополнительныеСвойства.Вставить("ЭтоНовыйОбъект", Истина);
	КонецЕсли;
	
	// ЭД делаем только когда есть действующая настройка обмена
	Если Не Источник.ДополнительныеСвойства.Свойство("ЕстьНастройкаОбменСБанками")
			ИЛИ НЕ Источник.ДополнительныеСвойства.ЕстьНастройкаОбменСБанками Тогда
		
		ПараметрыЭД = ЗаполнитьПараметрыЭДПоИсточнику(Источник);
		
		Если ОпределитьНастройкиОбменаЭД(ПараметрыЭД) = Неопределено Тогда // нет действующей настройки обмена
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Источник.ДополнительныеСвойства.Вставить("ЕстьНастройкаОбменСБанками", Истина);
	
	ПризнакИзменения = Источник.ЭтоНовый();
	Если Не ПризнакИзменения Тогда
		Состояние = ОбменСБанкамиСлужебныйВызовСервера.СостояниеЭД(Источник.Ссылка);
	КонецЕсли;
	ПризнакУчастияВОбмене = Истина;
	ЭлектронноеВзаимодействиеПереопределяемый.ПередЗаписьюВладельцаЭлектронногоДокумента(
		Источник, ПризнакИзменения, Состояние, ПризнакУчастияВОбмене, Отказ);
		
	Если Отказ Тогда
		Если ПризнакИзменения Тогда
			ТекстСообщения = НСтр("ru = 'Существует актуальный электронный документ. Запрещено редактирование ключевых реквизитов документа.'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , , Отказ);
		КонецЕсли;
		Возврат;
	КонецЕсли;

	Источник.ДополнительныеСвойства.Вставить("ЗарегистрироватьОбъектОбменСБанками", ПризнакИзменения);
	
КонецПроцедуры

// Обработчик события "ПриЗаписи" владельцев электронных документов.
//
// Параметры:
//  Источник - объект - владелец присоединенного файла,
//  Отказ    - булево - признак отказа от записи.
//
Процедура УстановитьСостояниеПриЗаписиОбъектаИБ(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ГрупповоеПерепроведение = Неопределено;
	Если Источник.ДополнительныеСвойства.Свойство("ГрупповоеПерепроведение", ГрупповоеПерепроведение)
		И ГрупповоеПерепроведение = Истина Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ЗначениеФункциональнойОпции("ИспользоватьОбменСБанками") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.ПакетОбменСБанками") Тогда
		Возврат;
	КонецЕсли;

	Если НЕ Источник.ДополнительныеСвойства.Свойство("ЕстьНастройкаОбменСБанками")
		ИЛИ НЕ Источник.ДополнительныеСвойства.ЕстьНастройкаОбменСБанками Тогда
		ПроверитьНаличиеИУдалитьСостояниеДокумента(Источник.Ссылка);
		Возврат;
	КонецЕсли;
	
	Если НЕ Источник.ДополнительныеСвойства.Свойство("ЗарегистрироватьОбъектОбменСБанками")
		ИЛИ НЕ Источник.ДополнительныеСвойства.ЗарегистрироватьОбъектОбменСБанками Тогда
		Возврат;
	КонецЕсли;
	
	ОбменСБанкамиСлужебныйВызовСервера.УстановитьНовуюВерсиюЭД(Источник.Ссылка);
	
КонецПроцедуры

// Определяет параметры электронного документа по типу владельца.
//
// Параметры:
//  Источник - объекта либо ссылка документа/справочника-источника;
//  ВидЭД - ПеречислениеСсылка.ВидыЭДОбменСБанками - вид электронного документа.
//
// Возвращаемое значение:
//  ПараметрыЭД - структура параметров источника, необходимых для определения
//  настроек обмена ЭД.
//
Функция ЗаполнитьПараметрыЭДПоИсточнику(Источник, ВидЭД = Неопределено) Экспорт
	
	ПараметрыЭД = СтруктураПараметровЭД();
	
	ТипИсточника = ТипЗнч(Источник);
	Если ТипИсточника = Тип("СправочникСсылка.НастройкиОбменСБанками")
		ИЛИ ТипИсточника = Тип("СправочникОбъект.НастройкиОбменСБанками") Тогда
		ПараметрыЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки;
		ПараметрыЭД.НастройкаОбмена  = Источник.Ссылка;
		ПараметрыЭД.Банк  = Источник.Банк;
		ПараметрыЭД.Организация = Источник.Организация;
	Иначе
		ПараметрыЭД.ВидЭД = ВидЭД;
		ОбменСБанкамиПереопределяемый.ЗаполнитьПараметрыЭДПоИсточнику(Источник, ПараметрыЭД);
	КонецЕсли;
	
	Возврат ПараметрыЭД;
	
КонецФункции

// Получает массив ожидаемых статусов электронного документа.
//
// Параметры:
//  НастройкиОбмена - Структура - параметры обмена. Содержит поля:
//    * Направление - ПеречислениеСсылка.НаправленияЭД - направление электронного документа;
//    * ВидЭД - ПеречислениеСсылка.ВидыЭДОбменСБанками - вид электронного документа;
//    * ИспользоватьПодпись - Булево - признак использования электронной подписи;
//    * ИспользуетсяНесколькоПодписей - Булево - при подписании используется более одной подписи;
//    * ПрограммаБанка - ПеречислениеСсылка.ПрограммыБанка - программа банка;
//    * Статус - ПеречислениеСсылка.СтатусыОбменСБанками - текущий статус электронного документа.
// 
// Возвращаемое значение:
// Массив - перечень ожидаемых статусов электронных документов:
//   * ПеречислениеСсылка.СтатусыОбменСБанками - статус электронного документа.
//
Функция МассивСтатусовЭД(НастройкиОбмена) Экспорт
	
	МассивСтатусов = Новый Массив;
	
	Если НастройкиОбмена.Направление = Перечисления.НаправленияЭД.Исходящий Тогда
		Если НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки Тогда
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Сформирован);
			Если НастройкиОбмена.ИспользоватьПодпись Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Подписан);
			КонецЕсли;
			Если НастройкиОбмена.ПрограммаБанка <> Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.ПодготовленКОтправке);
			КонецЕсли;
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Отправлен);
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Доставлен);
		Иначе
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Сформирован);
			Если НастройкиОбмена.Статус = Перечисления.СтатусыОбменСБанками.ЧастичноПодписан Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.ЧастичноПодписан);
			КонецЕсли;
			Если НастройкиОбмена.ИспользоватьПодпись Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Подписан);
			КонецЕсли;
			Если НастройкиОбмена.ПрограммаБанка <> Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.ПодготовленКОтправке);
			КонецЕсли;
			
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Отправлен);
			
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Доставлен);
			
			Если НастройкиОбмена.Статус = Перечисления.СтатусыОбменСБанками.НеПодтвержден Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.НеПодтвержден);
			КонецЕсли;
			
			Если НастройкиОбмена.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК
				ИЛИ НастройкиОбмена.ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен
				ИЛИ НастройкиОбмена.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Принят);
			КонецЕсли;
			
			Если НастройкиОбмена.Статус = Перечисления.СтатусыОбменСБанками.Приостановлен Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Приостановлен);
			КонецЕсли;
			
			МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Исполнен);
			Если НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение
				ИЛИ НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты
				ИЛИ НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПокупкуВалюты
				ИЛИ НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПродажуВалюты
				ИЛИ НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.РаспоряжениеНаОбязательнуюПродажуВалюты
				ИЛИ НастройкиОбмена.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование Тогда
				МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Подтвержден);
			КонецЕсли;
	
		КонецЕсли;
	Иначе
		МассивСтатусов.Добавить(Перечисления.СтатусыОбменСБанками.Получен);
	КонецЕсли;

	Возврат МассивСтатусов;
	
КонецФункции

// Находит существующий или создает новый элемент справочника СертификатыКлючейЭлектроннойПодписиИШифрования.
//
// Параметры:
//  ДанныеСертификата - ДвоичныеДанные, Строка - содержимое сертификата;
//  Организация - СправочникСсылка.Организации - организация;
//  ПрограммаБанка - ПеречислениеСсылка.ПрограммыБанка - программа банка;
//  Параметры - Структура - ДополнительныеДанныеСертификата.
//
// Возвращаемое значение:
//  СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования - ссылка на новый сертификат.
//
Функция НайтиСоздатьСертификатВнешнегоМодуля(ДанныеСертификата, Организация, ПрограммаБанка, Параметры) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СертификатыКлючейЭлектроннойПодписиИШифрования.Ссылка,
	|	СведенияОСертификатахОбменСБанками.ПрограммаБанка
	|ИЗ
	|	Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК СертификатыКлючейЭлектроннойПодписиИШифрования
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СведенияОСертификатахОбменСБанками КАК СведенияОСертификатахОбменСБанками
	|		ПО СведенияОСертификатахОбменСБанками.СертификатЭП = СертификатыКлючейЭлектроннойПодписиИШифрования.Ссылка
	|ГДЕ
	|	СертификатыКлючейЭлектроннойПодписиИШифрования.Отпечаток = &Отпечаток";

	Запрос.УстановитьПараметр("Отпечаток", Параметры.Отпечаток);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() И ПрограммаБанка = Выборка.ПрограммаБанка Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	СертификатОписаниеДанных = Новый ТаблицаЗначений;
	СертификатОписаниеДанных.Колонки.Добавить("Свойство");
	СертификатОписаниеДанных.Колонки.Добавить("Значение");
	
	СертификатОбъект = Справочники.СертификатыКлючейЭлектроннойПодписиИШифрования.СоздатьЭлемент();
	СертификатОбъект.ДанныеСертификата = Новый ХранилищеЗначения(ДанныеСертификата);
	СертификатОбъект.Отпечаток = Параметры.Отпечаток;
	СертификатОбъект.Добавил = ПользователиКлиентСервер.ТекущийПользователь();
	
	СертификатОбъект.Организация = Организация;
	ШаблонНаименования = НСтр("ru = '%1, до %2'");
	ДатаСтрокой = Формат(Параметры.ДатаОкончания, "ДФ=MM.yyyy");
	СертификатОбъект.Наименование = СтрШаблон(ШаблонНаименования, Параметры.ВладелецФИО, ДатаСтрокой);
	
	СертификатОбъект.Подписание = Истина;
	
	ОбновитьЗначение(СертификатОбъект.КомуВыдан, Параметры.ВладелецФИО);
	ОбновитьЗначение(СертификатОбъект.ДействителенДо, Параметры.ДатаОкончания);
	
	ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(Параметры.ВладелецФИО);
	
	ОбновитьЗначение(СертификатОбъект.Фамилия, ФИО.Фамилия, Истина);
	ОбновитьЗначение(СертификатОбъект.Имя, ФИО.Имя, Истина);
	ОбновитьЗначение(СертификатОбъект.Отчество, ФИО.Отчество, Истина);
	ОбновитьЗначение(СертификатОбъект.Должность, Параметры.ВладелецДолжность, Истина);
		
	СертификатОбъект.Записать();
	
	МенеджерЗаписи = РегистрыСведений.СведенияОСертификатахОбменСБанками.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.СертификатЭП = СертификатОбъект.Ссылка;
	МенеджерЗаписи.ПрограммаБанка = ПрограммаБанка;
	МенеджерЗаписи.Записать();
	
	Возврат СертификатОбъект.Ссылка;
	
КонецФункции

// Запускается по регламентному заданию ЗагрузкаСпискаDirectBank.
// Загружает актуальный список банков в константу.
//
Процедура ЗагрузитьСписокDirectBank() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.ЗагрузкаСпискаDirectBank);
	
	ЗагрузитьСписокБанковССайта();

КонецПроцедуры

// Создает настройку обмена с банком в фоновом процессе.
//
// Параметры:
//  СтруктураПараметров - структура, содержит реквизиты настройки обмена с банком:
//      * Организация - СправочникСсылка.Организации - для какой организации создается настройка обмена;
//      * Банк - ОпределяемыеТипы.СправочникБанки - с каким банком будет производится обмен;
//      * АдресСервера - строка - адрес сервера банка;
//      * АутентификацияПоСертификату - Булево - признак аутентификации на сервере банка по сертификату;
//      * ВнешнийМодуль - Строка - адрес временного хранилища, содержащий данные файла внешнего модуля;
//      * ИдентификаторОрганизации - Строка - идентификатор организации на сервере банка;
//      * ИмяПользователя - Строка - логин пользователя;
//      * ИспользуетсяКриптография - Булево - признак использования электронных подписей;
//      * ПрограммаБанка - ПеречислениеСсылка.ПрограммыБанка - используемая программа;
//      * РесурсВходящихДокументов - Строка - ресурс для получения выписки;
//      * РесурсИсходящихДокументов - Строка - ресурс для отправки платежных документов;
//      * СертификатБанка - Строка - адрес временного хранилища, содержащий данные сертификата банка;
//      * Сертификаты - Массив - клиентские сертификаты;
//         * СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования - сертификат подписи;
//  АдресХранилища - строка, содержит адрес хранилища, содержащий ссылку на настройку обмена.
//
Процедура СоздатьНастройкуОбмена(СтруктураПараметров, АдресХранилища) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	НастройкаОбменаСсылка = ОбменСБанкамиСлужебныйВызовСервера.НастройкаОбмена(
		СтруктураПараметров.Организация, СтруктураПараметров.Банк, Ложь, Истина);
		
	Если НЕ ЗначениеЗаполнено(НастройкаОбменаСсылка) Тогда
		НастройкаОбменаОбъект = Справочники.НастройкиОбменСБанками.СоздатьЭлемент();
	Иначе
		НастройкаОбменаОбъект = НастройкаОбменаСсылка.ПолучитьОбъект();
	КонецЕсли;
		
	ЗаполнитьЗначенияСвойств(НастройкаОбменаОбъект, СтруктураПараметров, "Организация, Банк, ИспользуетсяКриптография,
		|ПрограммаБанка, АдресСервера, ИдентификаторОрганизации, ИмяПользователя, АутентификацияПоСертификату,
		|РесурсВходящихДокументов, РесурсИсходящихДокументов, ИмяВнешнегоМодуля, Недействительна, ВерсияФормата");
		
	Если СтруктураПараметров.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн
		И СтруктураПараметров.ИспользуетсяКриптография Тогда
		Попытка 
			ДанныеСертификата = ДанныеСертификатаВФорматеDER(СтруктураПараметров.СертификатСбербанка);
		Исключение
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
			Возврат;
		КонецПопытки;
		НастройкаОбменаОбъект.СертификатБанка = Новый ХранилищеЗначения(ДанныеСертификата);
	ИначеЕсли СтруктураПараметров.ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен
		И НастройкаОбменаОбъект.АутентификацияПоСертификату Тогда
		НастройкаОбменаОбъект.ИспользуетсяКриптография = Истина;
	КонецЕсли;
	
	НастройкаОбменаОбъект.СертификатыПодписейОрганизации.Очистить();
	
	Для Каждого Сертификат Из СтруктураПараметров.Сертификаты Цикл
		НовСтрока = НастройкаОбменаОбъект.СертификатыПодписейОрганизации.Добавить();
		НовСтрока.СертификатЭП = Сертификат;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(СтруктураПараметров.СертификатАутентификации)
		И СтруктураПараметров.Сертификаты.Найти(СтруктураПараметров.СертификатАутентификации) = Неопределено Тогда
		НовСтрока = НастройкаОбменаОбъект.СертификатыПодписейОрганизации.Добавить();
		НовСтрока.СертификатЭП = СтруктураПараметров.СертификатАутентификации;
	КонецЕсли;
	
	ОбменСБанкамиСлужебныйВызовСервера.ЗаполнитьВидыЭДДоступнымиЗначениями(НастройкаОбменаОбъект);
	
	// Сгенерируем маршруты подписания для документов, которые подписываются более чем одной подписью.
	Если СтруктураПараметров.ИспользуетсяКриптография Тогда
		ВидыДокументовСНесколькимиПодписями = ОбменСБанкамиСлужебныйПовтИсп.ВидыДокументовПодписываемыхПоМаршруту();
		
		Для Каждого СтрокаВидаЭД Из НастройкаОбменаОбъект.ИсходящиеДокументы Цикл
			Если Не СтрокаВидаЭД.ИспользоватьЭП Тогда
				Продолжить;
			КонецЕсли;
			ТекущийВидЭД = СтрокаВидаЭД.ИсходящийДокумент;
			Если ВидыДокументовСНесколькимиПодписями.Найти(ТекущийВидЭД) <> Неопределено Тогда
				МаршрутОбъект = НайтиСоздатьМаршрутПодписания(НастройкаОбменаОбъект, ТекущийВидЭД);
				МаршрутОбъект.Наименование = СтрШаблон("%1 - %2 (%3)", НастройкаОбменаОбъект.Организация, 
					НастройкаОбменаОбъект.Банк, ТекущийВидЭД);
				МаршрутОбъект.СхемаПодписания = Перечисления.СхемыПодписанияЭД.ПоПравилам;
				МаршрутОбъект.Организация = НастройкаОбменаОбъект.Организация;
				ДеревоТребований = ЭлектронноеВзаимодействиеСлужебный.ПустоеДеревоТребованийКПодписанию();
				КорневаяСтрока = ДеревоТребований.Строки.Добавить();
				КорневаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.И;
				Для Каждого СтрокаТЧ Из НастройкаОбменаОбъект.СертификатыПодписейОрганизации Цикл
					СтрокаПодписанта = КорневаяСтрока.Строки.Добавить();
					СтрокаПодписанта.Сертификат = СтрокаТЧ.СертификатЭП;
				КонецЦикла;
				ЭлектронноеВзаимодействиеСлужебный.ЗаполнитьТаблицуТребованийКПодписаниюПоДереву(
					МаршрутОбъект.ТаблицаТребований, ДеревоТребований);
				МаршрутОбъект.КлючАвтоматическойНастройки = Справочники.НастройкиОбменСБанками.КлючАвтоматическойНастройки(
					НастройкаОбменаОбъект, ТекущийВидЭД);
				МаршрутОбъект.Записать();
				
				СтрокаВидаЭД.МаршрутПодписания = МаршрутОбъект.Ссылка;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	НастройкаОбменаОбъект.ПометкаУдаления = Ложь;
	НастройкаОбменаОбъект.ОбменДанными.Загрузка = Истина;
	
	ШаблонНаименования = "%1 - %2";
	НастройкаОбменаОбъект.Наименование = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ШаблонНаименования, СтруктураПараметров.Организация, СтруктураПараметров.Банк);
		
	Если НастройкаОбменаОбъект.ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен
		И Не ЗначениеЗаполнено(НастройкаОбменаОбъект.ВерсияФормата) Тогда
		НастройкаОбменаОбъект.ВерсияФормата = ОбменСБанкамиКлиентСервер.АктуальнаяВерсияФорматаАсинхронногоОбмена();
	КонецЕсли;

	Попытка
		НастройкаОбменаОбъект.Записать();
	Исключение
		ТекстСообщения = НСтр("ru = 'Ошибка создания настройки обмена: %1'");
		КраткоеПредставлениеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, КраткоеПредставлениеОшибки);
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Операция = НСтр("ru = 'Создание настройки обмена'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			Операция, ПодробноеПредставлениеОшибки, ТекстСообщения, "ОбменСБанками", НастройкаОбменаСсылка);
		Возврат;
	КонецПопытки;

	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("НастройкаОбмена", НастройкаОбменаОбъект.Ссылка);
	
	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресХранилища);
	
	СохранитьПараметрыОбмена(НастройкаОбменаОбъект.Ссылка);

КонецПроцедуры

// Создает новую настройку прямого обмена с банком.
//
// Параметры:
//    НастройкиЗаполнения - Строка - адрес во временном хранилище, содержащий файл настроек;
//    Организация - ОпределяемыйТип.Организация - ссылка на организацию, для которой загружаются настройки
//    Недействительна - Булево - позволяет отключить настройку в целях дальнейшего тестирования;
//    ЛокальныйФайл - Булево - признак, что пользователь выбрал файл с диска.
//    МассивСертификатов - Массив, Неопределено - если создана настройка обмена через ВК,
//        то в параметре возвращаются данные сертификатов подписи типа ДвоичныеДанные;
//    ЗагружатьВК - Булево - если Истина, что ВК будет загружена с сервера поставщика.
//    НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - настройка обмена с банком, если она уже существует.
//
Функция СоздатьНастройкуОбменаИзФайла(НастройкиЗаполнения, Организация, Недействительна, ЛокальныйФайл, МассивСертификатов = Неопределено, ЗагружатьВК = Истина, НастройкаОбмена = Неопределено) Экспорт
	
	ЭД = XDTOДанныеФайлаНастроек(НастройкиЗаполнения, ЛокальныйФайл);
	
	УстановитьПривилегированныйРежим(Истина);
	
	НаименованиеОрганизации = "";
	
	СтруктураПоискаОрганизации = Новый Структура;
	ИННОрганизации = ЭД.Recipient.inn;
	Если ЗначениеЗаполнено(ИННОрганизации) Тогда
		СтруктураПоискаОрганизации.Вставить("ИНН", ИННОрганизации);
	КонецЕсли;
	
	КППОрганизации = ЭД.Recipient.kpp;
	
	Если ЗначениеЗаполнено(КППОрганизации) Тогда
		СтруктураПоискаОрганизации.Вставить("КПП", КППОрганизации);
	КонецЕсли;
	НаименованиеОрганизации = ЭД.Recipient.name;
	Если ЗначениеЗаполнено(НаименованиеОрганизации) Тогда
		СтруктураПоискаОрганизации.Вставить("Наименование", НаименованиеОрганизации);
	КонецЕсли;
	
	Если СтруктураПоискаОрганизации.Количество() > 0 Тогда
		СсылкаНаОрганизацию = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.НайтиСсылкуНаОбъект(
			"Организации", , СтруктураПоискаОрганизации);
	ИначеЕсли НЕ ЗначениеЗаполнено(Организация) Тогда
		ТекстСообщения = НСтр("ru = 'В файле настроек нет информации об организации.
									|Обратитесь в свой банк.'");
		ВызватьИсключение ТекстСообщения;
	Иначе
		СсылкаНаОрганизацию = Организация;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(СсылкаНаОрганизацию) Тогда
		ТекстСообщения = НСтр("ru = 'Не найдена организация по реквизитам: %1%2%3'");
		Если СтруктураПоискаОрганизации.Свойство("ИНН") Тогда
			ТекстИНН = Символы.ПС + НСтр("ru = 'ИНН: %1'");
			ТекстИНН = СтрШаблон(ТекстИНН, СтруктураПоискаОрганизации.ИНН);
		Иначе
			ТекстИНН = "";
		КонецЕсли;
		Если СтруктураПоискаОрганизации.Свойство("КПП") Тогда
			ТекстКПП = Символы.ПС + НСтр("ru = 'КПП: %1'");
			ТекстКПП = СтрШаблон(ТекстКПП, СтруктураПоискаОрганизации.КПП);
		Иначе
			ТекстКПП = "";
		КонецЕсли;
		Если СтруктураПоискаОрганизации.Свойство("Наименование") Тогда
			ТекстНаименование = Символы.ПС + НСтр("ru = 'Наименование: %1'");
			ТекстНаименование = СтрШаблон(
				ТекстНаименование, СтруктураПоискаОрганизации.Наименование);
		Иначе
			ТекстНаименование = "";
		КонецЕсли;
		ТекстСообщения = СтрШаблон(ТекстСообщения, ТекстИНН, ТекстКПП, ТекстНаименование);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	НаименованиеБанка = "";
	СтруктураПоискаБанка = Новый Структура;
	БИК = ЭД.Sender.bic;
	СтруктураПоискаБанка.Вставить("Код", БИК);
	НаименованиеБанка = ЭД.Sender.name;
	СтруктураПоискаБанка.Вставить("Наименование", НаименованиеБанка);
	
	СсылкаНаБанк = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.НайтиСсылкуНаОбъект("Банки", БИК, СтруктураПоискаБанка);
	
	Если НЕ ЗначениеЗаполнено(СсылкаНаБанк) Тогда
		ТекстСообщения = НСтр("ru = 'Не найден банк по реквизитам: %1%2'");
		Если СтруктураПоискаБанка.Свойство("Код") Тогда
			ТекстБИК = Символы.ПС + НСтр("ru = 'БИК: %1'");
			ТекстБИК = СтрШаблон(ТекстБИК, СтруктураПоискаБанка.Код);
		Иначе
			ТекстБИК = "";
		КонецЕсли;
		Если СтруктураПоискаБанка.Свойство("Наименование") Тогда
			ТекстНаименование = Символы.ПС + НСтр("ru = 'Наименование: %1'");
			ТекстНаименование = СтрШаблон(
				ТекстНаименование, СтруктураПоискаБанка.Наименование);
		Иначе
			ТекстНаименование = "";
		КонецЕсли;
		ТекстСообщения = СтрШаблон(ТекстСообщения, ТекстБИК, ТекстНаименование);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	ЗаписыватьОбъект = Истина;
	Если ЗначениеЗаполнено(НастройкаОбмена) Тогда
		СуществующаяНастройкаОбмена = НастройкаОбмена;
	Иначе
		СуществующаяНастройкаОбмена = ОбменСБанками.НастройкаОбмена(СсылкаНаОрганизацию, СсылкаНаБанк, Ложь);
	КонецЕсли;
	Если ЗначениеЗаполнено(СуществующаяНастройкаОбмена) Тогда
		Объект = СуществующаяНастройкаОбмена.ПолучитьОбъект();
	Иначе
		Объект = Справочники.НастройкиОбменСБанками.СоздатьЭлемент();
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(НаименованиеОрганизации) Тогда
		НаименованиеОрганизации = СсылкаНаОрганизацию;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(НаименованиеБанка) Тогда
		НаименованиеБанка = СсылкаНаБанк;
	КонецЕсли;
	
	ЗаполненыНаименования = ЗначениеЗаполнено(НаименованиеОрганизации) И ЗначениеЗаполнено(НаименованиеБанка);
	
	Объект.Наименование = Строка(НаименованиеОрганизации) + ?(ЗаполненыНаименования, " - ", "")
		+ Строка(НаименованиеБанка);
	Объект.Организация = СсылкаНаОрганизацию;
	Объект.Банк = СсылкаНаБанк;
	
	Если НЕ ЭД.Data.Свойства().Получить("CryptoParameters") = Неопределено И ЭД.Data.CryptoParameters <> Неопределено
		И НЕ ЭД.Data.CryptoParameters.Свойства().Получить("URLAddinInfo") = Неопределено
		И ЗначениеЗаполнено(ЭД.Data.CryptoParameters.URLAddinInfo) Тогда
		
		Объект.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК;
		
		ВремФайл = ПолучитьИмяВременногоФайла("xml");
		ПараметрыПолучения = Новый Структура;
		ПараметрыПолучения.Вставить("ПутьДляСохранения", ВремФайл);
		
		Результат = ПолучениеФайловИзИнтернета.СкачатьФайлНаСервере(
			ЭД.Data.CryptoParameters.URLAddinInfo, ПараметрыПолучения);
		
		Если Результат.Статус Тогда
			ПараметрыВК = Справочники.ДополнительныеВнешниеКомпоненты.ПараметрыВК(ВремФайл);
			
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
			
			Если ПараметрыВК <> Неопределено Тогда
				
				ДанныеВКИБ = ДополнительныеВнешниеКомпонентыВызовСервера.ПараметрыВнешнейКомпоненты(ПараметрыВК.ИмяМодуля);
				
				Если ОбщегоНазначения.РазделениеВключено() Тогда
					Если ДанныеВКИБ <> Неопределено Тогда
						Объект.ИмяВнешнегоМодуля = ПараметрыВК.ИмяМодуля;
					Иначе
						ТекстСообщения = НСтр("ru = 'Запрещено использование неизвестных внешних компонент:
													|Наименование: %1.
													|Модуль: %2.
													|Версия: %3.'");
						ТекстСообщения = СтрШаблон(ТекстСообщения, ПараметрыВК.Название, ПараметрыВК.ИмяМодуля, ПараметрыВК.Версия);
						ВызватьИсключение ТекстСообщения;
					КонецЕсли;
				Иначе
					Объект.ИмяВнешнегоМодуля = ПараметрыВК.ИмяМодуля;
					
					Если ДанныеВКИБ <> Неопределено И ПараметрыВК.Версия = ДанныеВКИБ.Версия Тогда
						ЗагружатьВК = Ложь;
					КонецЕсли;
					
					Если ЗагружатьВК Тогда
						Результат = ПолучениеФайловИзИнтернета.СкачатьФайлВоВременноеХранилище(ПараметрыВК.URLВК);
						Если Результат.Статус Тогда
							Справочники.ДополнительныеВнешниеКомпоненты.СохранитьВнешнююКомпонентуВИнформационнойБазе(Результат.Путь);
						Иначе
							ВызватьИсключение Результат.СообщениеОбОшибке;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		Иначе
			ВызватьИсключение Результат.СообщениеОбОшибке;
		КонецЕсли;
	Иначе
		Объект.ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен;
	КонецЕсли;
	
	Объект.ИдентификаторОрганизации = ЭД.Data.CustomerID;
	
	Объект.АутентификацияПоСертификату = Ложь;
	Объект.ИмяПользователя = "";
		
	Объект.ВерсияФормата = ЭД.formatVersion;
	Объект.АдресСервера = ЭД.Data.BankServerAddress;
	Если ЭД.formatVersion <> "2.01" Тогда
		Объект.СжиматьДанныеПакетаЭД = ЭД.Data.Compress;
	КонецЕсли;
	Если ЭД.Data.Logon.Login <> Неопределено Тогда
		Объект.ИмяПользователя = ЭД.Data.Logon.Login.User;
	ИначеЕсли ЭД.Data.Logon.Certificate <> Неопределено Тогда
		Объект.АутентификацияПоСертификату = Истина;
	КонецЕсли;
	Объект.ИспользуетсяКриптография = Ложь;
	
	Объект.СертификатыПодписейОрганизации.Очистить();
	
	ГруппыСертификатов = Новый Массив;
	ВГруппеНесколькоСертификатов = Ложь;
	
	Если НЕ ЭД.Data.Свойства().Получить("CryptoParameters") = Неопределено
		И ЭД.Data.CryptoParameters <> Неопределено Тогда
		Объект.ИспользуетсяКриптография = Истина;
		Константы.ИспользоватьЭлектронныеПодписи.Установить(Истина);
		
		Если Объект.ПрограммаБанка = Перечисления.ПрограммыБанка.АсинхронныйОбмен Тогда
			
			Если ЭД.Data.CryptoParameters.Encrypted <> Неопределено Тогда
				ПрограммаКриптографии = НайтиСоздатьПрограммуКриптографии(ЭД.Data.CryptoParameters.CSPName,
					ЭД.Data.CryptoParameters.CSPType, ЭД.Data.CryptoParameters.SignAlgorithm, ЭД.Data.CryptoParameters.HashAlgorithm,
					ЭД.Data.CryptoParameters.Encrypted.EncryptAlgorithm);
			Иначе
				ПрограммаКриптографии = НайтиСоздатьПрограммуКриптографии(ЭД.Data.CryptoParameters.CSPName,
					ЭД.Data.CryptoParameters.CSPType, ЭД.Data.CryptoParameters.SignAlgorithm, ЭД.Data.CryptoParameters.HashAlgorithm);
			КонецЕсли;
				
			Для Каждого ГруппаПодписи Из ЭД.Data.CryptoParameters.CustomerSignature.GroupSignatures Цикл
				МассивСертификатовТекущейГруппы = Новый Массив;
				Для Каждого Сертификат Из ГруппаПодписи.Certificate Цикл
					ДанныеСертификата = ДанныеСертификатаВФорматеDER(Сертификат);
					Сертификат = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.НайтиСоздатьСертификатЭП(ДанныеСертификата,
						Объект.Организация, ЭД.Data.CryptoParameters.CSPName);
					НовСтрока = Объект.СертификатыПодписейОрганизации.Добавить();
					НовСтрока.СертификатЭП = Сертификат;
					МассивСертификатовТекущейГруппы.Добавить(Сертификат);
				КонецЦикла;
			
				Объект.СертификатыПодписейОрганизации.Свернуть("СертификатЭП");
				ГруппыСертификатов.Добавить(МассивСертификатовТекущейГруппы);
				Если МассивСертификатовТекущейГруппы.Количество() > 1 Тогда
					ВГруппеНесколькоСертификатов = Истина;
				КонецЕсли;
			КонецЦикла;
		Иначе
			
			СертификатБанка = ЭД.Data.CryptoParameters.BankCertificate;
	
			Если ЗначениеЗаполнено(СертификатБанка) Тогда
				Объект.СертификатБанка = Новый ХранилищеЗначения(СертификатБанка);
			КонецЕсли;
			
			МассивСертификатов = Новый Массив;
			Для Каждого ГруппаПодписи Из ЭД.Data.CryptoParameters.CustomerSignature.GroupSignatures Цикл
				Для Каждого Сертификат Из ГруппаПодписи.Certificate Цикл
					МассивСертификатов.Добавить(Сертификат);
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Объект.ИсходящиеДокументы.Очистить();

	ВидыДокументовСНесколькимиПодписями = ОбменСБанкамиСлужебныйПовтИсп.ВидыДокументовПодписываемыхПоМаршруту();
	Для Каждого Документ Из ЭД.Data.Document Цикл
		ТекущийВидЭД = ВидЭД(Документ.docKind);
		Если ЗначениеЗаполнено(ТекущийВидЭД) Тогда
			НовЗапись = Объект.ИсходящиеДокументы.Добавить();
			НовЗапись.ИсходящийДокумент = ТекущийВидЭД;
			НовЗапись.ИспользоватьЭП = Документ.Signed <> Неопределено;
			НовЗапись.Формировать = Истина;
			
			Если НовЗапись.ИспользоватьЭП Тогда
				Если ВидыДокументовСНесколькимиПодписями.Найти(ТекущийВидЭД) = Неопределено
					ИЛИ Объект.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК Тогда
					НовЗапись.МаршрутПодписания = Справочники.МаршрутыПодписания.ОднойДоступнойПодписью;
				ИначеЕсли Документ.Signed.RuleSignatures = "(0)" Тогда
					МаршрутОбъект = НайтиСоздатьМаршрутПодписания(Объект, ТекущийВидЭД);
					МаршрутОбъект.Наименование = СтрШаблон("%1 - %2 (%3)", Объект.Организация, Объект.Банк, ТекущийВидЭД);
					МаршрутОбъект.СхемаПодписания = Перечисления.СхемыПодписанияЭД.ПоПравилам;
					МаршрутОбъект.Организация = Объект.Организация;
					ДеревоТребований = ЭлектронноеВзаимодействиеСлужебный.ПустоеДеревоТребованийКПодписанию();
					КорневаяСтрока = ДеревоТребований.Строки.Добавить();
					КорневаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.И;
					Для Каждого СтрокаТЧ Из Объект.СертификатыПодписейОрганизации Цикл
						СтрокаПодписанта = КорневаяСтрока.Строки.Добавить();
						СтрокаПодписанта.Сертификат = СтрокаТЧ.СертификатЭП;
					КонецЦикла;
					ЭлектронноеВзаимодействиеСлужебный.ЗаполнитьТаблицуТребованийКПодписаниюПоДереву(
						МаршрутОбъект.ТаблицаТребований, ДеревоТребований);
					МаршрутОбъект.КлючАвтоматическойНастройки = Справочники.НастройкиОбменСБанками.КлючАвтоматическойНастройки(Объект,
						ТекущийВидЭД);
					МаршрутОбъект.Записать();
					НовЗапись.МаршрутПодписания = МаршрутОбъект.Ссылка;
				Иначе
					// Заполнение сложных правил подписания.
					ЧислоШифров = СтрЧислоВхождений(Документ.Signed.RuleSignatures, "(");
					Если ЧислоШифров = 0 Тогда // при ошибке в правиле применяем правило по-умолчанию
						НовЗапись.МаршрутПодписания = Справочники.МаршрутыПодписания.ОднойДоступнойПодписью;
					ИначеЕсли ЧислоШифров = 1 Тогда
						Шифр = СтрЗаменить(СтрЗаменить(Документ.Signed.RuleSignatures, "(", ""), ")", "");
						Если СтрДлина(Шифр) <> ГруппыСертификатов.Количество() Тогда
							ТекстСообщения = Нстр("ru = 'Некорректный файл настроек обмена.
														|Неправильно заданы правила подписания документов.
														|Обратитесь в техническую поддержку банка.'");
							ВызватьИсключение ТекстСообщения;
						КонецЕсли;
						МаршрутОбъект = НайтиСоздатьМаршрутПодписания(Объект, ТекущийВидЭД);
						МаршрутОбъект.Наименование = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							"%1 - %2 (%3)", Объект.Организация, Объект.Банк, ТекущийВидЭД);
						МаршрутОбъект.СхемаПодписания = Перечисления.СхемыПодписанияЭД.ПоПравилам;
						МаршрутОбъект.Организация = Объект.Организация;
		
						ДеревоТребований = ЭлектронноеВзаимодействиеСлужебный.ПустоеДеревоТребованийКПодписанию();
						КорневаяСтрока = ДеревоТребований.Строки.Добавить();
						КорневаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.И;
						Для Счетчик = 1 По СтрДлина(Шифр) Цикл
							ТекущееЗначение = Сред(Шифр, Счетчик, 1);
							Если ТекущееЗначение = "1" Тогда
								Если ВГруппеНесколькоСертификатов Тогда
									ТекущаяСтрока = КорневаяСтрока.Строки.Добавить();
									ТекущаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.ИЛИ;
								Иначе
									ТекущаяСтрока = КорневаяСтрока;
								КонецЕсли;
								
								Для Каждого Сертификат Из ГруппыСертификатов[Счетчик - 1] Цикл
									СтрокаПодписанта = ТекущаяСтрока.Строки.Добавить();
									СтрокаПодписанта.Сертификат = Сертификат;
								КонецЦикла;
							КонецЕсли;
						КонецЦикла;
		
						ЭлектронноеВзаимодействиеСлужебный.ЗаполнитьТаблицуТребованийКПодписаниюПоДереву(
							МаршрутОбъект.ТаблицаТребований, ДеревоТребований);
						МаршрутОбъект.КлючАвтоматическойНастройки = Справочники.НастройкиОбменСБанками.КлючАвтоматическойНастройки(Объект, 
							ТекущийВидЭД);
						МаршрутОбъект.Записать();
						НовЗапись.МаршрутПодписания = МаршрутОбъект.Ссылка;
					Иначе // Указано несколько шифров
						МассивШифров = СтрРазделить(Документ.Signed.RuleSignatures, "||");
						МаршрутОбъект = НайтиСоздатьМаршрутПодписания(Объект, ТекущийВидЭД);
						МаршрутОбъект.Наименование = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							"%1 - %2 (%3)", Объект.Организация, Объект.Банк, ТекущийВидЭД);
						МаршрутОбъект.СхемаПодписания = Перечисления.СхемыПодписанияЭД.ПоПравилам;
						МаршрутОбъект.Организация = Объект.Организация;

						ДеревоТребований = ЭлектронноеВзаимодействиеСлужебный.ПустоеДеревоТребованийКПодписанию();
						КорневаяСтрока = ДеревоТребований.Строки.Добавить();
						КорневаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.ИЛИ;
						
						Для Каждого Шифр Из МассивШифров Цикл
							СтрокаШифра = КорневаяСтрока.Строки.Добавить();
							СтрокаШифра.Требование = Перечисления.ТребованияКПодписаниюЭД.И;
							Шифр = СтрЗаменить(СтрЗаменить(Шифр, "(", ""), ")", "");
							Если СтрДлина(Шифр) <> ГруппыСертификатов.Количество() Тогда
								ТекстСообщения = Нстр("ru = 'Некорректный файл настроек обмена.
															|Неправильно заданы правила подписания документов.
															|Обратитесь в техническую поддержку банка.'");
								ВызватьИсключение ТекстСообщения;
							КонецЕсли;
							
							Для Счетчик = 1 По СтрДлина(Шифр) Цикл
								ТекущееЗначение = Сред(Шифр, Счетчик, 1);
								Если ТекущееЗначение = "1" Тогда
									Если ВГруппеНесколькоСертификатов Тогда
										ТекущаяСтрока = СтрокаШифра.Строки.Добавить();
										ТекущаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.ИЛИ;
									Иначе
										ТекущаяСтрока = СтрокаШифра;
									КонецЕсли;
									Для Каждого Сертификат Из ГруппыСертификатов[Счетчик - 1] Цикл
										СтрокаПодписанта = ТекущаяСтрока.Строки.Добавить();
										СтрокаПодписанта.Сертификат = Сертификат;
									КонецЦикла;
								КонецЕсли;
							КонецЦикла;
						КонецЦикла;
						ЭлектронноеВзаимодействиеСлужебный.ЗаполнитьТаблицуТребованийКПодписаниюПоДереву(
							МаршрутОбъект.ТаблицаТребований, ДеревоТребований);
						МаршрутОбъект.КлючАвтоматическойНастройки = Справочники.НастройкиОбменСБанками.КлючАвтоматическойНастройки(Объект,
							ТекущийВидЭД);
						МаршрутОбъект.Записать();
						НовЗапись.МаршрутПодписания = МаршрутОбъект.Ссылка;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Объект.ИсходящиеДокументы.Сортировать("ИсходящийДокумент");

	// Принудительное добавление документа Запрос-зонд
	Если Объект.ИсходящиеДокументы.Найти(Перечисления.ВидыЭДОбменСБанками.ЗапросЗонд, "ИсходящийДокумент") = Неопределено Тогда
		НовЗапись = Объект.ИсходящиеДокументы.Добавить();
		НовЗапись.ИсходящийДокумент = Перечисления.ВидыЭДОбменСБанками.ЗапросЗонд;
		НовЗапись.ИспользоватьЭП = Объект.ИспользуетсяКриптография;
		НовЗапись.Формировать = Истина;
		
		Если НовЗапись.ИспользоватьЭП Тогда
			НовЗапись.МаршрутПодписания = Справочники.МаршрутыПодписания.ОднойДоступнойПодписью;
		КонецЕсли;
	КонецЕсли;
		
	Объект.ПометкаУдаления = Ложь;
	Объект.Недействительна = Недействительна;
	
	Если ЗаписыватьОбъект Тогда
		Попытка
			Объект.Записать();
		Исключение
			ТекстСообщения = НСтр("ru = 'Возникла ошибка при создании настройки обмена с сервисом 1С:ДиректБанк.'");
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ВидОперации = НСтр("ru = 'Создание настройки обмена с сервисом 1С:ДиректБанк.'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробноеПредставлениеОшибки, , "ОбменСБанками");
			ВызватьИсключение ТекстСообщения;
		КонецПопытки
	КонецЕсли;
	
	СохранитьПараметрыОбмена(Объект.Ссылка);
	
	Возврат Объект.Ссылка;

КонецФункции

// Получает объект XDTO на основании xml файла.
//
// Параметры:
//  АдресФайла - Строка - адрес временного хранилища с двоичными данными файла.
//  ЛокальныйФайл - Булево - признак выбора файла с диска.
// 
// Возвращаемое значение:
// ОбъектXDTO - данные из файла.
//
Функция XDTOДанныеФайлаНастроек(АдресФайла, ЛокальныйФайл = Ложь) Экспорт
	
	ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(АдресФайла);
	
	ВремФайл = ПолучитьИмяВременногоФайла("xml");
	
	ДвоичныеДанныеФайла.Записать(ВремФайл);
	
	ОбъектXML = Новый ЧтениеXML;
	
	Попытка
		ОбъектXML.ОткрытьФайл(ВремФайл, , , "UTF-8");
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		ОбъектXML.Закрыть();
		ЕстьСвойствоData = ЭД.Свойства().Получить("Data") <> Неопределено;
		Если ЕстьСвойствоData Тогда
			Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ЭД.formatVersion);
	
			Если Фабрика = Неопределено Тогда
				ТекстСообщения = НСтр("ru = 'Возникла ошибка при чтении настроек.
											|Неизвестная версия формата файла.'");
				ВидОперации = НСтр("ru = 'Чтение настроек обмена с сервисом 1С:ДиректБанк из файла.'");
				Если ЛокальныйФайл Тогда
					ТекстОшибки = НСтр("ru = 'При загрузке настроек обмена с сервисом 1С:ДиректБанк произошла ошибка.
											|Информация об ошибке: Неизвестная версия формата файла.'",
									ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
					ТекстОшибки = СтрШаблон(ТекстОшибки, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
					ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
				Иначе
					ТекстОшибки = НСтр("ru = 'При загрузке настроек обмена с сервисом 1С:ДиректБанк произошла ошибка.
										|Путь к файлу: %1
										|Информация об ошибке: Неизвестная версия формата файла.'",
									ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
					ТекстОшибки = СтрШаблон(ТекстОшибки, ВремФайл, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				КонецЕсли;
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, , "ОбменСБанками");
				ВызватьИсключение ТекстСообщения;
			КонецЕсли;
		
			ОбъектXML.ОткрытьФайл(ВремФайл);
			ПространствоИменАсинхрОбмена = ПространствоИменАсинхронногоОбмена(ЭД.formatVersion);
			Settings = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "Settings");
			ЭД = Фабрика.ПрочитатьXML(ОбъектXML, Settings);
		Иначе
			УдалитьПространствоИмен(ВремФайл, "http://bssys.com/upg/settings");
			ОбъектXML.ОткрытьФайл(ВремФайл);
			ПостроительDOM = Новый ПостроительDOM();
			ДокументDOM = ПостроительDOM.Прочитать(ОбъектXML);
			ОбъектXML.Закрыть();
			СоответствиеПространствИмен = ДокументDOM.ЭлементДокумента.ПолучитьСоответствияПространствИмен();
			Если СоответствиеПространствИмен.Получить("xmlns") <> "http://1c-sbrf.ru/XMLSchema" Тогда
				ДокументDOM.ЭлементДокумента.УстановитьСоответствиеПространстваИмен("", "http://1c-sbrf.ru/XMLSchema");
				ЗаписьXML = Новый ЗаписьXML;
				ЗаписьXML.ОткрытьФайл(ВремФайл);
				ЗаписьDOM = Новый ЗаписьDOM;
				ЗаписьDOM.Записать(ДокументDOM, ЗаписьXML);
				ЗаписьXML.Закрыть();
			КонецЕсли;
			ОбъектXML.ОткрытьФайл(ВремФайл);
			SettingsSBRF = ТипЗначенияCML(ФабрикаXDTO, "http://1c-sbrf.ru/XMLSchema", "Settings");
			ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML, SettingsSBRF);
		КонецЕсли;
		ЭД.Проверить();
	Исключение
		ТекстСообщения = НСтр("ru = 'Возникла ошибка при чтении настроек.'");
		ВидОперации = НСтр("ru = 'Чтение настроек обмена с сервисом 1С:ДиректБанк из файла.'");
		Если ЛокальныйФайл Тогда
			ТекстОшибки = НСтр("ru = 'При загрузке настроек обмена с сервисом 1С:ДиректБанк произошла ошибка.
									|Информация об ошибке: %1'");
			ТекстОшибки = СтрШаблон(ТекстОшибки, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		Иначе
			ТекстОшибки = НСтр("ru = 'При загрузке настроек обмена с сервисом 1С:ДиректБанк произошла ошибка.
									|Путь к файлу: %1
									|Информация об ошибке: %2'");
			ТекстОшибки = СтрШаблон(ТекстОшибки, ВремФайл, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецЕсли;

		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, , "ОбменСБанками");
		ОбъектXML.Закрыть();
		ВызватьИсключение ТекстСообщения;
	КонецПопытки;
	
	ОбъектXML.Закрыть();
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
	
	Возврат ЭД;
	
КонецФункции

// Функция определяет настройки обмена ЭД по источнику - документу базы данных или по ЭД.
//
Функция ОпределитьНастройкиОбменаЭДПоИсточнику(Источник, ВыводитьСообщения, МассивОтпечатковСертификатов, СообщениеОбмена = Неопределено, ВидЭД = Неопределено, ФлагДействующиеНастройкиОбмена = Истина) Экспорт
	
	ДействующиеПараметрыОбмена = ДействующиеПараметрыОбмена(Источник, СообщениеОбмена);
	
	Если ВыводитьСообщения И ДействующиеПараметрыОбмена.НастройкаОбменаДействует
		И НЕ ДействующиеПараметрыОбмена.ВидЭДПоддерживаетсяБанком Тогда
		ТекстСообщения = НСтр("ru = 'Данный вид электронного документа банк не принимает.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	Если ВыводитьСообщения И НЕ ДействующиеПараметрыОбмена.НастройкаОбменаДействует
		И НЕ (ЗначениеЗаполнено(ДействующиеПараметрыОбмена.ПараметрыЭД.Банк)
				И ЗначениеЗаполнено(ДействующиеПараметрыОбмена.ПараметрыЭД.Организация)) Тогда
		ТекстСообщения = НСтр("ru = 'Не удалось определить параметры обмена с банком.
									|Проверьте реквизиты документа.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	// Заполним ВидЭД в случае непосредственного выбора пользователем.
	Если ЗначениеЗаполнено(ВидЭД) Тогда
		ДействующиеПараметрыОбмена.ПараметрыЭД.ВидЭД = ВидЭД;
	КонецЕсли;
	
	Результат = ОпределитьНастройкиОбменаЭД(
		ДействующиеПараметрыОбмена.ПараметрыЭД, МассивОтпечатковСертификатов, ФлагДействующиеНастройкиОбмена);
	
	Если Результат = Неопределено Тогда
		Если ВыводитьСообщения Тогда
			ДействующиеПараметрыОбмена.ПараметрыЭД.Удалить("ИмяРеквизитаОрганизации");
			СообщитьОбОтсутствииНастройкиОбмена(ДействующиеПараметрыОбмена.ПараметрыЭД, Источник);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Определяет настройки обмена с банком.
//
// СсылкаНаВладельца - ДокументСсылка - ссылка на документ информационной базы;
// СообщениеОбмена - ДокументСсылка.СообщенияОбменСБанками, Неопределено - ссылка на сообщение обмена;
//
// Возвращаемое значение:
// СтруктураНастроекОбмена - Структура:
//    * НастройкаОбменаДействует - Булево - найдена действующая настройка обмена;
//    * ВидЭДПоддерживаетсяБанком - Булево - данный вид документа на поддерживается банка;
//    * НастройкаОбмена - СправочникСсылка.НастройкаОбменаСБанком - найденная настройка обмена;
//    * ПараметрыЭД - Структура - дополнительные настройки.
//
Функция ДействующиеПараметрыОбмена(СсылкаНаВладельца, СообщениеОбмена = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("НастройкаОбменаДействует", Истина);
	СтруктураВозврата.Вставить("ВидЭДПоддерживаетсяБанком", Истина);
	СтруктураВозврата.Вставить("ПараметрыЭД");
	СтруктураВозврата.Вставить("НастройкаОбмена");
	
	Если ЗначениеЗаполнено(СообщениеОбмена) Тогда
		
		УстановитьПривилегированныйРежим(Истина);
		РеквизитыСообщения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СообщениеОбмена, "ВидЭД, НастройкаОбмена");
		СтруктураВозврата.ПараметрыЭД = ЗаполнитьПараметрыЭДПоИсточнику(СсылкаНаВладельца, РеквизитыСообщения.ВидЭД);
		
		ЗаполнитьЗначенияСвойств(СтруктураВозврата.ПараметрыЭД, РеквизитыСообщения);
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЭП.Отпечаток
		|ИЗ
		|	РегистрСведений.ЭлектронныеПодписи КАК ЭП
		|ГДЕ
		|	ЭП.ПодписанныйОбъект.ВладелецФайла = &ВладелецФайла";
		
		Запрос.УстановитьПараметр("ВладелецФайла", СообщениеОбмена);
		Отпечатки = Запрос.Выполнить().Выгрузить();
		
		СтруктураВозврата.ПараметрыЭД.Вставить("УстановленныеПодписи", Отпечатки.ВыгрузитьКолонку("Отпечаток"));
	Иначе
		СтруктураВозврата.ПараметрыЭД = ЗаполнитьПараметрыЭДПоИсточнику(СсылкаНаВладельца);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(СтруктураВозврата.ПараметрыЭД.ВидЭД) Тогда
		МассивСсылок = Новый Массив;
		МассивСсылок.Добавить(СсылкаНаВладельца);
		СоответствиеВладельцевИСообщенийОбмена = ОбменСБанкамиСлужебныйВызовСервера.СообщенияОбменаПоВладельцам(
			МассивСсылок);
		Для Каждого ТекЭл Из МассивСсылок Цикл
			СсылкаНаСообщениеОбмена = СоответствиеВладельцевИСообщенийОбмена.Получить(ТекЭл);
			Если ЗначениеЗаполнено(СсылкаНаСообщениеОбмена) Тогда
				СтруктураВозврата.ПараметрыЭД.ВидЭД = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
					СсылкаНаСообщениеОбмена, "ВидЭД");
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	НастройкиОбменСБанками.Ссылка
	|ИЗ
	|	Справочник.НастройкиОбменСБанками КАК НастройкиОбменСБанками
	|ГДЕ
	|	НастройкиОбменСБанками.Организация = &Организация
	|	И НастройкиОбменСБанками.Банк = &Банк
	|	И НЕ НастройкиОбменСБанками.ПометкаУдаления
	|	И НЕ НастройкиОбменСБанками.Недействительна";
	Запрос.УстановитьПараметр("Организация", СтруктураВозврата.ПараметрыЭД.Организация);
	Запрос.УстановитьПараметр("Банк", СтруктураВозврата.ПараметрыЭД.Банк);
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Не Результат.Следующий() Тогда
		СтруктураВозврата.НастройкаОбменаДействует = Ложь;
		Возврат СтруктураВозврата;
	КонецЕсли;
	
	СтруктураВозврата.НастройкаОбмена = Результат.Ссылка;
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	НастройкиОбменСБанкамиИсходящиеДокументы.ИсходящийДокумент
	|ИЗ
	|	Справочник.НастройкиОбменСБанками.ИсходящиеДокументы КАК НастройкиОбменСБанкамиИсходящиеДокументы
	|ГДЕ
	|	НастройкиОбменСБанкамиИсходящиеДокументы.Ссылка = &Ссылка
	|	И НастройкиОбменСБанкамиИсходящиеДокументы.ИсходящийДокумент = &ИсходящийДокумент";
	Запрос.УстановитьПараметр("Ссылка", СтруктураВозврата.НастройкаОбмена);
	Запрос.УстановитьПараметр("ИсходящийДокумент", СтруктураВозврата.ПараметрыЭД.ВидЭД);
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		СтруктураВозврата.ВидЭДПоддерживаетсяБанком = Ложь;
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ДеревоРазбора

Процедура ДобавитьЗначениеВДерево(ДеревоДанных, ИмяРеквизита, ЗначениеРеквизита)
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(ДеревоДанных, ИмяРеквизита, ЗначениеРеквизита);
	
КонецПроцедуры

Процедура ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Реквизит, Значение)
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Реквизит, Значение);
	
КонецПроцедуры

Функция ЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть, СообщатьОбОшибке = Истина)
	
	Возврат ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть, СообщатьОбОшибке);
	
КонецФункции

Функция НайтиСоздатьСтрокуВДеревеРазбора(СтрокаТипаВДереве, ИдОбъекта, ОписаниеОбъекта, СсылкаНаОбъект, ДопРеквизиты, ДеревоРазбора, Ошибка)
	
	Если ЗначениеЗаполнено(СсылкаНаОбъект) Тогда
		НайденнаяСтрока = СтрокаТипаВДереве.Строки.Найти(СсылкаНаОбъект, "СсылкаНаОбъект");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
			НайденнаяСтрока.СсылкаНаОбъект = СсылкаНаОбъект;
			НайденнаяСтрока.ИД = ИдОбъекта;
			НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			НайденнаяСтрока.ОписаниеТипа = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(СтрокаТипаВДереве.ТипОбъекта);
			НайденнаяСтрока.ИндексСтроки = СтрокаТипаВДереве.ИндексСтроки + "_"
				+ Строка(СтрокаТипаВДереве.Строки.Индекс(НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
			// Проверим, что Описания совпадают по одной ссылке
			Если НайденнаяСтрока.ОписаниеОбъекта <> ОписаниеОбъекта Тогда
				// Ошибка: по ссылке существуют в ЭД разные по Описанию объекты
				Ошибка = Истина;
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Ошибка в данных эл.документа: на один Объект <%1>, два Описания <%2> и <%3>.'"), СсылкаНаОбъект,
					НайденнаяСтрока.ОписаниеОбъекта, ОписаниеОбъекта);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(ИдОбъекта) Тогда
		
		НайденнаяСтрока = СтрокаТипаВДереве.Строки.Найти(ИдОбъекта, "ИД");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
			НайденнаяСтрока.ИД              = ИдОбъекта;
			НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			Если СтрокаТипаВДереве.ТипОбъекта <> "Штамп" И СтрокаТипаВДереве.ТипОбъекта <> "БанковскийСчет" Тогда
				НайденнаяСтрока.ОписаниеТипа = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(
					СтрокаТипаВДереве.ТипОбъекта);
			КонецЕсли;
			НайденнаяСтрока.ИндексСтроки = СтрокаТипаВДереве.ИндексСтроки + "_"
				+ Строка(СтрокаТипаВДереве.Строки.Индекс(НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
		Иначе
			Возврат НайденнаяСтрока;
		КонецЕсли;
	Иначе
		НайденнаяСтрока = СтрокаТипаВДереве.Строки.Найти(ОписаниеОбъекта, "ОписаниеОбъекта");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
			НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			НайденнаяСтрока.ОписаниеТипа    = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(
				СтрокаТипаВДереве.ТипОбъекта);
			НайденнаяСтрока.ИндексСтроки    = СтрокаТипаВДереве.ИндексСтроки + "_" + Строка(СтрокаТипаВДереве.Строки.Индекс(
				НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
		КонецЕсли;
	КонецЕсли;
	
	Возврат НайденнаяСтрока;
	
КонецФункции

#КонецОбласти

#Область РаботаСXDTO

// Удаляет пространство имен из файла.
//
// Параметры:
//   ИмяФайла - Строка - путь к файлу на диске;
//   ПространствоИмен - Строка - удаляемое пространство имен.
//
Процедура УдалитьПространствоИмен(ИмяФайла, ПространствоИмен)
	
	Текст = Новый ТекстовыйДокумент;
	Текст.Прочитать(ИмяФайла, КодировкаТекста.UTF8);
	СтрокаФайл = Текст.ПолучитьСтроку(2);
	СтрокаФайл = СтрЗаменить(СтрокаФайл, "xmlns=""" + ПространствоИмен + """", "");
	Текст.ЗаменитьСтроку(2, СтрокаФайл);
	ТекстДокумента = Текст.ПолучитьТекст();
	
	Текст = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8);
	Текст.Записать(ТекстДокумента);
	Текст.Закрыть();
	
КонецПроцедуры

Функция ТипОбъектаCML(Фабрика, URIПространстваИмен, Путь)
	
	МассивПути = ЭлектронноеВзаимодействиеСлужебный.МассивПодстрок(Путь, ".");
	
	ПервыйЭлемент = МассивПути[0];
	Если Лев(ПервыйЭлемент,1) = "{" И Прав(ПервыйЭлемент,1) = "}" Тогда
		ИмяПакета = Сред(ПервыйЭлемент, 2, СтрДлина(ПервыйЭлемент) - 2);
		Коллекция = Фабрика.Пакеты.Получить(ИмяПакета).КорневыеСвойства;
	Иначе
		ТипОбъекта = Фабрика.Тип(URIПространстваИмен, ПервыйЭлемент);
		Коллекция = ТипОбъекта.Свойства;
	КонецЕсли;
	
	МассивПути.Удалить(0);
	Пока МассивПути.Количество() > 0 Цикл
		
		Если Коллекция = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Свойство = Коллекция.Получить(МассивПути[0]);
		Если Свойство = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		ТипОбъекта = Свойство.Тип;
		МассивПути.Удалить(0);
		Попытка
			Коллекция = ТипОбъекта.Свойства;
		Исключение
			Коллекция = Неопределено;
		КонецПопытки;
		
	КонецЦикла;
	
	Возврат ТипОбъекта;
	
КонецФункции

Функция СформироватьXMLФайлыДокументов(МассивОбъектовДляВыгрузки, ПараметрыОбмена, ДопПараметры = "")
	
	МассивСтруктурВозврата = Новый Массив;
	СтруктураВидовЭД = Новый Соответствие;
	
	Для Каждого ТекЭлемент Из МассивОбъектовДляВыгрузки Цикл
		ВидЭД = "";
		Если НЕ ЗначениеЗаполнено(ДопПараметры) ИЛИ НЕ ДопПараметры.Свойство("ВидЭД", ВидЭД) Тогда
			ПараметрыЭД = ПараметрыОбмена.Получить(ТекЭлемент.Ссылка);
			ПараметрыЭД.Свойство("ВидЭД", ВидЭД);
		КонецЕсли;
	
		МассивОбъектовПоВидуЭД = СтруктураВидовЭД.Получить(ВидЭД);
		Если МассивОбъектовПоВидуЭД = Неопределено Тогда
			МассивОбъектовПоВидуЭД = Новый Массив;
		КонецЕсли;
		МассивОбъектовПоВидуЭД.Добавить(ТекЭлемент);
		СтруктураВидовЭД.Вставить(ВидЭД, МассивОбъектовПоВидуЭД);
	КонецЦикла;
	
	Для Каждого ТекЭлемент Из СтруктураВидовЭД Цикл
		
		Если ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПлатежноеПоручение");
			МетодЗаполненияДанных = "ЗаполнитьДанныеПлатежныхПоручений";
			МетодФормированияЭД = "СформироватьПлатежноеПоручение";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПлатежноеТребование");
			МетодЗаполненияДанных = "ЗаполнитьДанныеПлатежныхТребований";
			МетодФормированияЭД = "СформироватьПлатежноеТребование";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПереводВалюты");
			МетодЗаполненияДанных = "ЗаполнитьДанныеПорученийНаПереводВалюты";
			МетодФормированияЭД = "СформироватьПоручениеНаПереводВалюты";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПокупкуВалюты Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПокупкуВалюты");
			МетодЗаполненияДанных = "ЗаполнитьДанныеПорученийНаПокупкуВалюты";
			МетодФормированияЭД = "СформироватьПоручениеНаПокупкуВалюты";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПродажуВалюты Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПродажуВалюты");
			МетодЗаполненияДанных = "ЗаполнитьДанныеПорученийНаПродажуВалюты";
			МетодФормированияЭД = "СформироватьПоручениеНаПродажуВалюты";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.РаспоряжениеНаОбязательнуюПродажуВалюты Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("РаспоряжениеНаОбязательнуюПродажуВалюты");
			МетодЗаполненияДанных = "ЗаполнитьДанныеРаспоряженийНаОбязательнуюПродажуВалюты";
			МетодФормированияЭД = "СформироватьРаспоряжениеНаОбязательнуюПродажуВалюты";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.СправкаОПодтверждающихДокументах Тогда
			Макет = Обработки.ОбменСБанками.ПолучитьМакет("СправкаОПодтверждающихДокументах");
			МетодЗаполненияДанных = "ЗаполнитьДанныеСправокОПодтверждающихДокументах";
			МетодФормированияЭД = "СформироватьСправкуОПодтверждающихДокументах";
		ИначеЕсли ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.СписокНаОткрытиеСчетовПоЗарплатномуПроекту
			ИЛИ ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.СписокУволенныхСотрудников
			ИЛИ ТекЭлемент.Ключ = Перечисления.ВидыЭДОбменСБанками.СписокНаЗачислениеДенежныхСредствНаСчетаСотрудников Тогда
			Для Каждого ОбъектДляВыгрузки Из ТекЭлемент.Значение Цикл
				СтруктураВозврата = СформироватьЭДПоЗарплатномуПроекту(
					ОбъектДляВыгрузки, ПараметрыОбмена.Получить(ОбъектДляВыгрузки), ТекЭлемент.Ключ);
				Если ЗначениеЗаполнено(СтруктураВозврата) Тогда
					МассивСтруктурВозврата.Добавить(СтруктураВозврата);
				КонецЕсли;
			КонецЦикла;
			Продолжить;
		КонецЕсли;
		
		Данные = Новый Массив;
		Для Каждого ОбъектДляВыгрузки Из ТекЭлемент.Значение Цикл
			ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
			Данные.Добавить(ДеревоДокумента);
		КонецЦикла;
		
		ПараметрыПроцедуры = Новый Массив;
		ПараметрыПроцедуры.Добавить(ТекЭлемент.Значение);
		ПараметрыПроцедуры.Добавить(Данные);
		ОбщегоНазначения.ВыполнитьМетодКонфигурации("ОбменСБанкамиПереопределяемый." + МетодЗаполненияДанных,
			ПараметрыПроцедуры);
	
		Счетчик = 0;
		Для Каждого ДеревоДанных Из Данные Цикл
			ДокументИБ = ТекЭлемент.Значение.Получить(Счетчик);
			Если ТипЗнч(ДеревоДанных) = Тип("Строка") Тогда
				ТекстОшибки = НСтр("ru = 'Не сформирован электронный документ для документа: %1
									|Причина: %2'");
				ТекстОшибки = СтрШаблон(ТекстОшибки, ДокументИБ, ДеревоДанных);
				Операция = НСтр("ru = 'Получение данных для формирования электронного документа'");
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
					Операция, ТекстОшибки, ТекстОшибки, "ОбменСБанками", ДокументИБ);
				Продолжить;
			КонецЕсли;
			СтруктураВозврата = Новый Структура;
			ПараметрыПроцедуры = Новый Массив;
			ПараметрыПроцедуры.Добавить(ДокументИБ);
			ПараметрыПроцедуры.Добавить(ПараметрыОбмена.Получить(ДокументИБ));
			ПараметрыПроцедуры.Добавить(ДеревоДанных);
			ПараметрыПроцедуры.Добавить(СтруктураВозврата);
			Попытка
				ОбщегоНазначения.ВыполнитьМетодКонфигурации("ОбменСБанкамиСлужебный." + МетодФормированияЭД, ПараметрыПроцедуры);
				МассивСтруктурВозврата.Добавить(СтруктураВозврата);
			Исключение
				ТекстОшибки = НСтр("ru = 'Не сформирован электронный документ для документа: %1
									|Причина: %2'");
				ТекстОшибки = СтрШаблон(ТекстОшибки, ДокументИБ, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
				Операция = НСтр("ru = 'Формирование электронного документа'");
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
					Операция, ТекстОшибки, ТекстОшибки, "ОбменСБанками", ДокументИБ);
			КонецПопытки;
			Счетчик = Счетчик + 1;
		КонецЦикла
	КонецЦикла;
	
	Возврат МассивСтруктурВозврата;
	
КонецФункции

Процедура СформироватьПлатежноеТребованиеAsync(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
	
	ВерсияФормата = ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияФормата");
	
	Если НЕ ЗначениеЗаполнено(ВерсияФормата) Тогда
		ВерсияФормата = ОбменСБанкамиКлиентСервер.АктуальнаяВерсияФорматаАсинхронногоОбмена();
	КонецЕсли;
	
	ПространствоИмен = ПространствоИменАсинхронногоОбмена(ВерсияФормата);
	Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ВерсияФормата);
	
	ТекстОшибки = "";
		
	ЭД = ОбъектТипаCML(Фабрика, "PayRequest", ПространствоИмен);
	
	ИдДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
	ЗаполнитьСвойствоXDTO(ЭД, "id", ИдДокумента, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ЭД, "formatVersion", ВерсияФормата, Истина, ТекстОшибки);

	ЗаполнитьСвойствоXDTO(ЭД, "creationDate", ТекущаяДатаСеанса(), Истина, ТекстОшибки);
	userAgent = ОбменСБанкамиСлужебныйПовтИсп.ВерсияПрограммыКлиентаДляБанка();
	ЗаполнитьСвойствоXDTO(ЭД, "userAgent", userAgent, , ТекстОшибки);
	
	Отправитель = ОбъектТипаCML(Фабрика, "CustomerPartyType", ПространствоИмен);
	ИдКлиента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдКлиента");
	ЗаполнитьСвойствоXDTO(Отправитель, "id", ИдКлиента, Истина, ТекстОшибки);
	ПолучательНаименование = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Наименование");
	ЗаполнитьСвойствоXDTO(Отправитель, "name", ПолучательНаименование, Истина, ТекстОшибки);
	ПолучательИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.ИНН");
	ЗаполнитьСвойствоXDTO(Отправитель, "inn", ПолучательИНН, , ТекстОшибки);
	ПолучательКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.КПП");
	ЗаполнитьСвойствоXDTO(Отправитель, "kpp", ПолучательКПП, , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ЭД, "Sender", Отправитель, Истина, ТекстОшибки);
	
	Банк = ОбъектТипаCML(Фабрика, "BankPartyType", ПространствоИмен);
	ПолучательБИКБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Банк.БИК");
	ЗаполнитьСвойствоXDTO(Банк, "bic", ПолучательБИКБанка, Истина, ТекстОшибки);
	ПолучательНаименованиеБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(Банк, "name", ПолучательНаименованиеБанка, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ЭД, "Recipient", Банк, Истина, ТекстОшибки);
	
	ДанныеПлатежа = ОбъектТипаCML(Фабрика, "PayRequest.Data", ПространствоИмен);
	
	Номер = ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "DocNo", Номер, Истина, ТекстОшибки);
	Дата = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "DocDate", Дата, Истина, ТекстОшибки);
	Сумма = ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Sum", Сумма, Истина, ТекстОшибки);
	
	РеквизитыПлательщика = ОбъектТипаCML(Фабрика, "CustomerDetailsType", ПространствоИмен);
	ПлательщикНаименование = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Наименование");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Name", ПлательщикНаименование, Истина, ТекстОшибки);
	ПлательщикИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.ИНН");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "INN", ПлательщикИНН, , ТекстОшибки);
	ПлательщикКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.КПП");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "KPP", ПлательщикКПП, , ТекстОшибки);
	ПлательщикРасчСчет = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.РасчСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Account", ПлательщикРасчСчет, , ТекстОшибки);
	
	БанкПлательщика = ОбъектТипаCML(Фабрика, "BankType", ПространствоИмен);
	ПлательщикБИКБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Банк.БИК");
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "BIC", ПлательщикБИКБанка, Истина, ТекстОшибки);
	ПлательщикНаименованиеБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "Name", ПлательщикНаименованиеБанка, , ТекстОшибки);
	ПлательщикГородБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Банк.Город");
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "City", ПлательщикГородБанка, , ТекстОшибки);
	ПлательщикКоррСчетБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Банк.КоррСчет");
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "CorrespAcc", ПлательщикКоррСчетБанка, , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Bank", БанкПлательщика, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Payer", РеквизитыПлательщика, Истина, ТекстОшибки);
	
	РеквизитыПолучателя = ОбъектТипаCML(Фабрика, "CustomerDetailsType", ПространствоИмен);
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Name", ПолучательНаименование, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "INN", ПолучательИНН, , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "KPP", ПолучательКПП, , ТекстОшибки);
	ПолучательРасчСчет = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.РасчСчет");
		
	Если ЗначениеЗаполнено(ПолучательРасчСчет) И СтрДлина(СокрЛП(ПолучательРасчСчет)) <> 20 Тогда
		ТекстОшибки = НСтр("ru = 'Некорректный номер счета получателя %1
							|Длина номера счета должна состоять из 20 цифр.'");
		ТекстОшибки = СтрШаблон(ТекстОшибки, ПолучательРасчСчет);
	КонецЕсли;

	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Account", ПолучательРасчСчет, , ТекстОшибки);
	
	БанкПолучателя = ОбъектТипаCML(Фабрика, "BankType", ПространствоИмен);
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "BIC", ПолучательБИКБанка, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "Name", ПолучательНаименованиеБанка, , ТекстОшибки);
	ПолучательГородБанка = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Банк.Город");
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "City", ПолучательГородБанка, , ТекстОшибки);
	ПолучательКоррСчет = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Банк.КоррСчет");
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "CorrespAcc", ПолучательКоррСчет, , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Bank", БанкПолучателя, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Payee", РеквизитыПолучателя, Истина, ТекстОшибки);
	
	ВидПлатежа = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидПлатежа");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "PaymentKind", ВидПлатежа, , ТекстОшибки);
	ВидОплаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидОплаты");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "TransitionKind", ВидОплаты, , ТекстОшибки);
	Очередность = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Очередность");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Priority", Очередность, , ТекстОшибки);
	Код = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Код");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Code", Код, , ТекстОшибки);
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Purpose", НазначениеПлатежа, Истина, ТекстОшибки);
	
	УсловиеОплаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "УсловиеОплаты");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "PaymentCondition", УсловиеОплаты, Истина, ТекстОшибки);
	СрокАкцепта = ЗначениеРеквизитаВДереве(ДеревоДанных, "СрокАкцепта");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "AcceptTerm", СрокАкцепта, , ТекстОшибки);
	ДатаОтсылкиДокументов = ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаОтсылкиДокументов");
	Если ЗначениеЗаполнено(ДатаОтсылкиДокументов) Тогда
		ДатаСтрокой = Формат(ДатаОтсылкиДокументов, "ДФ=dd.MM.yyyy");
		ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "DocDispatchDate", ДатаСтрокой, , ТекстОшибки);
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(ЭД, "Data", ДанныеПлатежа, Истина, ТекстОшибки);
	
	ЭД.Проверить();
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	Иначе
		ДвоичныеДанные = ДвоичныеДанныеИзXDTO(Фабрика, ЭД, Ложь);
			АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьДанныеИзОтветаБанка(ОтветБанка)
	
	ВремФайл = ПолучитьИмяВременногоФайла("xml");
	ОтветБанка.Записать(ВремФайл);
	СодержимоеФайла = Новый Соответствие;
	Чтение = Новый ЧтениеXML;
	Чтение.ОткрытьФайл(ВремФайл);
		
	URI = "urn:x-obml:1.0";
	Попытка
		Message = ФабрикаXDTO.ПрочитатьXML(Чтение, ФабрикаXDTO.Тип(URI, "CMSDETACHED"));
		СодержимоеФайла.Вставить("Данные", Message.data.__content);
		Подписи = Новый Массив;
		Для Каждого Подпись Из Message.signature Цикл
			Подписи.Добавить(Подпись);
		КонецЦикла;
		СодержимоеФайла.Вставить("Подписи", Подписи);
	Исключение
		СодержимоеФайла.Вставить("Данные", ОтветБанка);
	КонецПопытки;
	Чтение.Закрыть();
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
	
	Возврат СодержимоеФайла;

КонецФункции

Функция ПрочитатьФайлПоСхеме(ВидЭД, ДанныеФайла, ДеревоРазбора, НовыйЭД, ПоказыватьОшибки = Ложь)
	
	ОбъектXML = Новый ЧтениеXML;
	Ошибка = Ложь;
	НеизвестныйЭД = Ложь;
	
	ЧтениеДанных = Новый ЧтениеДанных(ДанныеФайла);
	ПотокВПамяти = ЧтениеДанных.ИсходныйПоток();
	
	Попытка
		
		ОбъектXML.ОткрытьПоток(ПотокВПамяти);
		Если ОбъектXML.Прочитать() Тогда
			ИмяКорневогоЭлемента = ВРег(ОбъектXML.Имя);
		КонецЕсли;
		
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		
		Если ВРег(ЭД.Тип().Имя) = ВРег("anyType") Тогда // не указан тип элемента в явном виде
			ПотокВПамяти.Перейти(0, ПозицияВПотоке.Начало);
			ОбъектXML.ОткрытьПоток(ПотокВПамяти);
			Если ЭД.Свойства().Получить("СекцияРасчСчет") <> Неопределено Тогда
				ClientBankExchange = ТипЗначенияCML(ФабрикаXDTO, "urn:1C.ru:ClientBankExchange", "ClientBankExchange");
				ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML, ClientBankExchange);
				ПрочитатьВыпискуXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
			ИначеЕсли ЭД.Свойства().Получить("Info") <> Неопределено Тогда
				ПрочитатьКвитанциюСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
			ИначеЕсли ЭД.Свойства().Получить("stmtDateTime") <> Неопределено Тогда
				ПрочитатьВыпискуСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
			ИначеЕсли ЭД.Свойства().Получить("BkToCstmrStmt") <> Неопределено Тогда
				ПрочитатьВалютнуюВыпискуISO(ЭД, ДеревоРазбора, НовыйЭД);
			ИначеЕсли ЭД.Свойства().Получить("CstmrCdtTrfInitn") <> Неопределено Тогда
				ПрочитатьПлатежноеПоручениеISO(ЭД, ДеревоРазбора, НовыйЭД);
			Иначе // читаем файл по типу, имя которого совпадает с типом объекта XDTO
				
				Если ЭД.Свойства().Получить("formatVersion") = Неопределено Тогда
					НеизвестныйЭД = Истина;
				Иначе
					ПространствоИменАсинхрОбмена = ПространствоИменАсинхронногоОбмена(ЭД.formatVersion);
					Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ЭД.formatVersion);
					Если Фабрика = Неопределено Тогда
						НеизвестныйЭД = Истина;
					Иначе
						Если ИмяКорневогоЭлемента = ВРег("PayDocRu") Тогда // платежное поручение рублевое
							PayDocRu = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "PayDocRu");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, PayDocRu);
							ПрочитатьПлатежноеПоручениеAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("PayRequest") Тогда // платежное требование рублевое
							PayRequest = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "PayRequest");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, PayRequest);
							ПрочитатьПлатежноеТребованиеAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("Statement") Тогда // выписка
							Statement = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "Statement");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, Statement);
							ПрочитатьВыпискуAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("StatementRequest") Тогда // запрос на выписку
							StatementRequest = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "StatementRequest");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, StatementRequest);
							ПрочитатьЗапросВыпискиAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("StatusDocNotice") Тогда // извещение о состоянии ЭД
							StatusDocNotice = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "StatusDocNotice");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, StatusDocNotice);
							ПрочитатьИзвещениеОСостоянииAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("StatusRequest") Тогда // запрос о состоянии ЭД
							StatusRequest = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "StatusRequest");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, StatusRequest);
							ПрочитатьЗапросОСостоянииAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("Probe") Тогда // запрос - зонд
							Probe = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "Probe");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, Probe);
							ПрочитатьЗапросЗондAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						ИначеЕсли ИмяКорневогоЭлемента = ВРег("CancelationRequest") Тогда // запрос на отзыв ЭД
							ТипCancelationRequest = ТипЗначенияCML(Фабрика, ПространствоИменАсинхрОбмена, "CancelationRequest");
							ЭД = Фабрика.ПрочитатьXML(ОбъектXML, ТипCancelationRequest);
							ПрочитатьЗапросНаОтзывAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
						Иначе
							НеизвестныйЭД = Истина;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		Иначе // тип указан в явном виде
			Если ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO, "urn:1C.ru:ClientBankExchange", "ClientBankExchange") Тогда
				Если ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение Тогда
					ПрочитатьПлатежноеПоручениеXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
				ИначеЕсли ВидЭД = Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка Тогда
					ПрочитатьВыпискуXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
				Иначе
					ПрочитатьЗапросВыпискиXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
				КонецЕсли;
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"http://bssys.com/upg/request", "PayDocRu") Тогда
				ПрочитатьПлатежноеПоручениеСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"http://bssys.com/upg/request", "StmtReqType") Тогда
				ПрочитатьЗапросВыпискиСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"urn:iso:std:iso:20022:tech:xsd:pain.001.001.03", "Document") Тогда
				ПрочитатьПлатежноеПоручениеISO(ЭД, ДеревоРазбора, НовыйЭД);
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"http://bssys.com/upg/request", "PayDocCur") Тогда
				ПрочитатьПоручениеНаПереводВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД);
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"http://bssys.com/upg/request", "CurrBuy") Тогда
				ПрочитатьПоручениеНаПокупкуВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД);
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"http://bssys.com/upg/request", "CurrSell") Тогда
				ПрочитатьПоручениеНаПродажуВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД);
			ИначеЕсли ЭД.Тип() = ТипЗначенияCML(ФабрикаXDTO,"http://bssys.com/upg/request", "MandatorySale") Тогда
				ПрочитатьРаспоряжениеНаОбязательнуюПродажуВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД);
			Иначе
				НеизвестныйЭД = Истина;
			КонецЕсли;
		КонецЕсли;
		Если НеизвестныйЭД Тогда
			Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
				ИмяФайла = ПолучитьИмяВременногоФайла("xml");
				ДанныеФайла.Записать(ИмяФайла);
				ТекстСообщения = СтрШаблон(
					НСтр("ru = 'Электронный документ содержит неизвестный тип данных.
								|Путь к файлу: %1.'"), ИмяФайла);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			КонецЕсли;
			Ошибка = Истина;
		КонецЕсли;
	Исключение
		Ошибка = Истина;
		ТекстСообщения = Неопределено;
		Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) ИЛИ ПоказыватьОшибки Тогда
			ИмяФайла = ПолучитьИмяВременногоФайла("xml");
			ДанныеФайла.Записать(ИмяФайла);
			ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, ИмяФайла, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецЕсли;
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ВидОперации = НСтр("ru = 'Чтение ЭД.'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			ВидОперации, ПодробноеПредставлениеОшибки, ТекстСообщения, "ОбменСБанками");
	КонецПопытки;
	ОбъектXML.Закрыть();

	Возврат НЕ Ошибка;
	
КонецФункции

Процедура ПрочитатьВыпискуXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",   ЭД.Отправитель);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",    ЭД.Получатель);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСоздания",  ЭД.ДатаСоздания);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВремяСоздания", ЭД.ВремяСоздания);
	Если НЕ ЭД.СекцияРасчСчет = Неопределено Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачала", ЭД.СекцияРасчСчет.ДатаНачала);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонца",  ЭД.СекцияРасчСчет.ДатаКонца);
		Если ЭД.СекцияРасчСчет.РасчСчета.Количество()>0 Тогда
			
			Для Каждого РеквизитыРасчСчета Из ЭД.СекцияРасчСчет.РасчСчета Цикл
				СписокТЧ = Новый СписокЗначений;
				ПараметрыСчета = Новый Структура;
				ПараметрыСчета.Вставить("РасчСчет",         РеквизитыРасчСчета.РасчСчет);
				ПараметрыСчета.Вставить("НачальныйОстаток", РеквизитыРасчСчета.НачальныйОстаток);
				ПараметрыСчета.Вставить("ВсегоПоступило",   РеквизитыРасчСчета.ВсегоПоступило);
				ПараметрыСчета.Вставить("ВсегоСписано",     РеквизитыРасчСчета.ВсегоСписано);
				ПараметрыСчета.Вставить("КонечныйОстаток",  РеквизитыРасчСчета.КонечныйОстаток);
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
					ДеревоРазбора, "БанковскийСчет");
				РасчетныйСчет = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.НайтиСсылкуНаОбъект(
					"БанковскиеСчетаОрганизаций", РеквизитыРасчСчета.РасчСчет);
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(
					НайденныйТипВДереве, РеквизитыРасчСчета.РасчСчет, , РасчетныйСчет, ПараметрыСчета, ДеревоРазбора, Ошибка);
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "БанковскийСчет");
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "БанковскиеСчетаОрганизаций", СписокТЧ);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЭД.УсловияОтбора = Неопределено Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачала", ЭД.УсловияОтбора.ДатаНачала);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонца",  ЭД.УсловияОтбора.ДатаКонца);
	КонецЕсли;
	
	Для Каждого ЭлементПлатежа Из ЭД.СекцияПлатежногоДокумента Цикл
		РеквизитыПлатежа = Новый СписокЗначений;
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.СекцияДокумент, "СекцияДокумент");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.Номер, "Номер");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.Дата,  "Дата");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.Сумма, "Сумма");
		Если НЕ ЭлементПлатежа.Квитанция = Неопределено Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.Квитанция.КвитанцияДата,       "КвитанцияДата");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.Квитанция.КвитанцияВремя,      "КвитанцияВремя");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.Квитанция.КвитанцияСодержание, "КвитанцияСодержание");
		КонецЕсли;
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикСчет, "ПлательщикСчет");
		Если НЕ ЭлементПлатежа.РеквизитыПлательщика.ДатаСписано = Неопределено Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ДатаСписано.__content, "ДатаСписано");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ДатаСписано.ИдПлатежа, "ИдПлатежа");
		КонецЕсли;
		Если ЗначениеЗаполнено(ЭлементПлатежа.РеквизитыПлательщика.Плательщик1) Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.Плательщик1, "ПлательщикНаименование");
		Иначе
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.Плательщик, "ПлательщикНаименование");
		КонецЕсли;
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикРасчСчет, "ПлательщикРасчСчет");
		Если ЗначениеЗаполнено(ЭлементПлатежа.РеквизитыПлательщика.Плательщик1) Тогда
			РеквизитыПлатежа.Добавить(Истина, "НепрямыеРасчетыУПлательщика");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.Плательщик1, "ПлательщикНаименованиеНепрямыеРасчеты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.Плательщик2, "ПлательщикСчетНепрямыеРасчеты");
			РеквизитыПлатежа.Добавить(
				ЭлементПлатежа.РеквизитыПлательщика.Плательщик3, "ПлательщикНаименованиеБанкаНепрямыеРасчеты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.Плательщик4, "ПлательщикГородБанкаНепрямыеРасчеты");
		Иначе
			РеквизитыПлатежа.Добавить(Ложь, "НепрямыеРасчетыУПлательщика");
		КонецЕсли;
		
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикИНН, "ПлательщикИНН");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикКПП, "ПлательщикКПП");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикБанк1, "ПлательщикНаименованиеБанка");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикБанк2, "ПлательщикГородБанка");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикБИК, "ПлательщикБИКБанка");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлательщика.ПлательщикКорсчет, "ПлательщикКорСчетБанка");
		
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательСчет, "ПолучательСчет");
		
		
		Если НЕ ЭлементПлатежа.РеквизитыПолучателя.ДатаПоступило = Неопределено Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ДатаПоступило.__content, "ДатаПоступило");
		КонецЕсли;
		Если ЗначениеЗаполнено(ЭлементПлатежа.РеквизитыПолучателя.Получатель1) Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.Получатель1, "ПолучательНаименование");
		Иначе
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.Получатель, "ПолучательНаименование");
		КонецЕсли;

		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательРасчСчет, "ПолучательРасчСчет");
		Если ЗначениеЗаполнено(ЭлементПлатежа.РеквизитыПолучателя.Получатель1) Тогда
			РеквизитыПлатежа.Добавить(Истина, "НепрямыеРасчетыУПолучателя");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.Получатель1, "ПолучательНаименованиеНепрямыеРасчеты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.Получатель2, "ПолучательСчетНепрямыеРасчеты");
			РеквизитыПлатежа.Добавить(
				ЭлементПлатежа.РеквизитыПолучателя.Получатель3, "ПолучательНаименованиеБанкаНепрямыеРасчеты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.Получатель4, "ПолучательГородБанкаНепрямыеРасчеты");
		Иначе
			РеквизитыПлатежа.Добавить(Ложь, "НепрямыеРасчетыУПолучателя");
		КонецЕсли;
		
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательИНН, "ПолучательИНН");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательКПП, "ПолучательКПП");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательБанк1, "ПолучательНаименованиеБанка");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательБанк2, "ПолучательГородБанка");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательБИК, "ПолучательБИКБанка");
		РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПолучателя.ПолучательКорсчет, "ПолучательКорСчетБанка");
		
		Если НЕ ЭлементПлатежа.РеквизитыПлатежа = Неопределено Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.ВидПлатежа,         "ВидПлатежа");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.ВидОплаты,          "ВидОплаты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.Очередность,        "Очередность");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.Код,                "Код");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа,  "НазначениеПлатежа");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа1, "НазначениеПлатежа1");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа2, "НазначениеПлатежа2");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа3, "НазначениеПлатежа3");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа4, "НазначениеПлатежа4");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа5, "НазначениеПлатежа5");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.РеквизитыПлатежа.НазначениеПлатежа6, "НазначениеПлатежа6");
		КонецЕсли;
		
		Если НЕ ЭлементПлатежа.ПлатежиВБюджет = Неопределено Тогда
			РеквизитыПлатежа.Добавить(Истина, "ЭтоПлатежВБюджет");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.СтатусСоставителя,   "СтатусСоставителя");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ПоказательКБК,       "ПоказательКБК");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ОКАТО,               "ОКТМО");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ПоказательОснования, "ПоказательОснования");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ПоказательПериода,   "ПоказательПериода");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ПоказательНомера,    "ПоказательНомера");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ПоказательДаты,      "ПоказательДаты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ПлатежиВБюджет.ПоказательТипа,      "ПоказательТипа");
		Иначе
			РеквизитыПлатежа.Добавить(Ложь, "ЭтоПлатежВБюджет");
		КонецЕсли;
		
		Если НЕ ЭлементПлатежа.ДополнительныеРеквизиты = Неопределено Тогда
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.СрокАкцепта,          "СрокАкцепта");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.ВидАккредитива,       "ВидАккредитива");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.СрокПлатежа,          "СрокПлатежа");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.УсловиеОплаты,        "УсловиеОплаты");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.ПлатежПоПредст,       "ПлатежПоПредст");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.ДополнУсловия,        "ДополнУсловия");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.НомерСчетаПоставщика, "НомерСчетаПоставщика");
			РеквизитыПлатежа.Добавить(ЭлементПлатежа.ДополнительныеРеквизиты.ДатаОтсылкиДок,       "ДатаОтсылкиДок");
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", РеквизитыПлатежа);
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьЗапросВыпискиXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки;
	
	ЗапросВыписки = ЭД.УсловияОтбора;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаНачала", ЗапросВыписки.ДатаНачала);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаКонца", ЗапросВыписки.ДатаКонца);
	Для Каждого Элемент Из ЗапросВыписки.РасчСчет Цикл
		РеквизитыСчета = Новый СписокЗначений;
		РеквизитыСчета.Добавить(Элемент, "НомерСчета");
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", РеквизитыСчета);
	КонецЦикла;

КонецПроцедуры

Процедура ПрочитатьПлатежноеПоручениеXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение;
	
	ПлатежныйДокумент = ЭД.СекцияПлатежногоДокумента[0];
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ПлатежныйДокумент.Номер);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ПлатежныйДокумент.Дата);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "СекцияДокумент", ПлатежныйДокумент.СекцияДокумент);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ПлатежныйДокумент.Сумма);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", ПлатежныйДокумент.Сумма);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторДокумента", ПлатежныйДокумент.ИдДокумента);
	Если Не ПлатежныйДокумент.ПлатежиВБюджет = Неопределено Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЭтоПлатежВБюджет",  Истина);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "СтатусСоставителя", ПлатежныйДокумент.ПлатежиВБюджет.СтатусСоставителя);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательКБК", ПлатежныйДокумент.ПлатежиВБюджет.ПоказательКБК);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ОКТМО", ПлатежныйДокумент.ПлатежиВБюджет.ОКАТО);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательОснования", ПлатежныйДокумент.ПлатежиВБюджет.ПоказательОснования);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательПериода", ПлатежныйДокумент.ПлатежиВБюджет.ПоказательПериода);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательНомера", ПлатежныйДокумент.ПлатежиВБюджет.ПоказательНомера);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательДаты", ПлатежныйДокумент.ПлатежиВБюджет.ПоказательДаты);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательТипа", ПлатежныйДокумент.ПлатежиВБюджет.ПоказательТипа);
	Иначе
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЭтоПлатежВБюджет",  Ложь);
	КонецЕсли;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ВидОплаты", ПлатежныйДокумент.РеквизитыПлатежа.ВидОплаты);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ВидПлатежа", ПлатежныйДокумент.РеквизитыПлатежа.ВидПлатежа);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "Код", ПлатежныйДокумент.РеквизитыПлатежа.Код);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа1", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа1);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа2", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа2);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа3", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа3);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа4", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа4);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа5", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа5);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НазначениеПлатежа6", ПлатежныйДокумент.РеквизитыПлатежа.НазначениеПлатежа6);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "Очередность", ПлатежныйДокумент.РеквизитыПлатежа.Очередность);
	РеквизитыПлательщика = ПлатежныйДокумент.РеквизитыПлательщика;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаСписано", РеквизитыПлательщика.ДатаСписано);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикНаименование", РеквизитыПлательщика.Плательщик1);
	Если Не ЗначениеЗаполнено(ПлатежныйДокумент.РеквизитыПлательщика.Плательщик1) Тогда
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикНаименование", РеквизитыПлательщика.Плательщик);
	КонецЕсли;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикБИКБанка", РеквизитыПлательщика.ПлательщикБИК);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикНаименованиеБанка", РеквизитыПлательщика.ПлательщикБанк1);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикГородБанка", РеквизитыПлательщика.ПлательщикБанк2);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикГородБанкаДляРасчетов", РеквизитыПлательщика.Плательщик4);
	Если ЗначениеЗаполнено(ПлатежныйДокумент.РеквизитыПлательщика.Плательщик3) Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НепрямыеРасчетыУПлательщика", Истина);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикКоррСчетБанка", РеквизитыПлательщика.Плательщик2);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикКоррСчетБанкаДляРасчетов", РеквизитыПлательщика.ПлательщикКорсчет);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикНаименованиеБанкаДляРасчетов", РеквизитыПлательщика.Плательщик3);
	Иначе
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НепрямыеРасчетыУПлательщика", Ложь);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикКоррСчетБанка", РеквизитыПлательщика.ПлательщикРасчСчет);
	КонецЕсли;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикИНН", РеквизитыПлательщика.ПлательщикИНН);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикКПП", РеквизитыПлательщика.ПлательщикКПП);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикКорсчет", РеквизитыПлательщика.ПлательщикКорсчет);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикРасчСчет", РеквизитыПлательщика.ПлательщикСчет);
	
	РеквизитыПолучателя = ПлатежныйДокумент.РеквизитыПолучателя;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаПоступило", РеквизитыПолучателя.ДатаПоступило);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательНаименование", РеквизитыПолучателя.Получатель1);
	Если Не ЗначениеЗаполнено(ПлатежныйДокумент.РеквизитыПолучателя.Получатель1) Тогда
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательНаименование", РеквизитыПолучателя.Получатель);
	КонецЕсли;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательБИКБанка", РеквизитыПолучателя.ПолучательБИК);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательНаименованиеБанка", РеквизитыПолучателя.ПолучательБанк1);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательГородБанка", РеквизитыПолучателя.ПолучательБанк2);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательГородБанкаДляРасчетов", РеквизитыПолучателя.Получатель4);
	Если ЗначениеЗаполнено(ПлатежныйДокумент.РеквизитыПолучателя.Получатель3) Тогда
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "НепрямыеРасчетыУПолучателя", Истина);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательКоррСчетБанка", РеквизитыПолучателя.Получатель2);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательНаименованиеБанкаДляРасчетов", РеквизитыПолучателя.Получатель3);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательКоррСчетБанкаДляРасчетов", РеквизитыПолучателя.ПолучательКорсчет);
	Иначе
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НепрямыеРасчетыУПолучателя", Ложь);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательКоррСчетБанка", РеквизитыПолучателя.ПолучательРасчСчет);
	КонецЕсли;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательИНН", РеквизитыПолучателя.ПолучательИНН);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательКПП", РеквизитыПолучателя.ПолучательКПП);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательКорсчет", РеквизитыПолучателя.ПолучательКорсчет);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательРасчСчет", РеквизитыПолучателя.ПолучательСчет);

КонецПроцедуры

Процедура ПрочитатьВыпискуAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка;
	Stmt = ЭД;
	StmtData = Stmt.Data;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель", Stmt.Sender.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель", Stmt.Recipient.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования", Stmt.creationDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачала", StmtData.DateFrom);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонца", StmtData.DateTo);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТипВыписки", StmtData.StatementType);
	
	СписокТЧ = Новый СписокЗначений;
	ПараметрыСчета = Новый Структура;
	ПараметрыСчета.Вставить("РасчСчет", StmtData.Account);
	ПараметрыСчета.Вставить("НачальныйОстаток", StmtData.OpeningBalance);
	ПараметрыСчета.Вставить("ВсегоПоступило", StmtData.TotalCredits);
	ПараметрыСчета.Вставить("ВсегоСписано", StmtData.TotalDebits);
	ПараметрыСчета.Вставить("КонечныйОстаток", StmtData.ClosingBalance);
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
		ДеревоРазбора, "БанковскийСчет");
	РасчетныйСчет = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.НайтиСсылкуНаОбъект(
		"БанковскиеСчетаОрганизаций", ПараметрыСчета.РасчСчет);
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(
		НайденныйТипВДереве, ПараметрыСчета.РасчСчет, , РасчетныйСчет, ПараметрыСчета, ДеревоРазбора, Ошибка);
	СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "БанковскийСчет");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "БанковскиеСчетаОрганизаций", СписокТЧ);
	
	Если НЕ StmtData.Stamp = Неопределено Тогда
		ПараметрыШтампа = Новый Структура;
		ПараметрыШтампа.Вставить("БИК", StmtData.Stamp.BIC);
		ПараметрыШтампа.Вставить("НаименованиеБанка", StmtData.Stamp.Name);
		ПараметрыШтампа.Вставить("ГородБанка", StmtData.Stamp.City);
		ПараметрыШтампа.Вставить("КоррСчетБанка", StmtData.Stamp.CorrespAcc);
		ПараметрыШтампа.Вставить("ОтделениеБанка",  StmtData.Stamp.Branch);
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
			ДеревоРазбора, "Штамп");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(
			НайденныйТипВДереве, "Штамп", , , ПараметрыШтампа, ДеревоРазбора, Ошибка);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Штамп", НайденнаяСтрока.ИндексСтроки);
	КонецЕсли;
	
	Для Каждого Operation Из StmtData.OperationInfo Цикл
		
		РеквизитыПлатежа = Новый СписокЗначений;
		
		Если Operation.DC = "1" Тогда // списание с лиц.счета
			РеквизитыПлатежа.Добавить(Operation.ExtID, "ИдПлатежа");
			РеквизитыПлатежа.Добавить(Operation.Date, "ДатаСписано");
			РеквизитыПлатежа.Добавить(Истина, "ПлатежИсходящий");
		ИначеЕсли Operation.DC = "2" Тогда // поступление на лиц.счет
			РеквизитыПлатежа.Добавить(Operation.Date, "ДатаПоступило");
			РеквизитыПлатежа.Добавить(Ложь, "ПлатежИсходящий");
		Иначе
			Продолжить;
		КонецЕсли;
		
		ЭтоПлатежныйОрдер = Ложь;
		ЭтоМемориальныйОрдер = Ложь;
		ЭтоПлатежноеПоручение = Ложь;
		ЭтоИнкассовоеПоручение = Ложь;
		ЭтоПлатежноеТребование = Ложь;
		ЭтоБанковскийДокумент = Ложь;
		
		Если Operation.PayDoc.PayDocRu <> Неопределено Тогда
			PayData = Operation.PayDoc.PayDocRu;
			РеквизитыПлатежа.Добавить("Платежное поручение", "СекцияДокумент");
			ЭтоПлатежноеПоручение = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("PayRequest") <> Неопределено
			И Operation.PayDoc.PayRequest <> Неопределено Тогда
			PayData = Operation.PayDoc.PayRequest;
			РеквизитыПлатежа.Добавить("Платежное требование", "СекцияДокумент");
			ЭтоПлатежноеТребование = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("CollectionOrder") <> Неопределено
			И Operation.PayDoc.CollectionOrder <> Неопределено Тогда
			PayData = Operation.PayDoc.CollectionOrder;
			РеквизитыПлатежа.Добавить("Инкассовое поручение", "СекцияДокумент");
			ЭтоИнкассовоеПоручение = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("PaymentOrder") <> Неопределено
			И Operation.PayDoc.PaymentOrder <> Неопределено Тогда
			PayData = Operation.PayDoc.PaymentOrder;
			РеквизитыПлатежа.Добавить("Платежный ордер", "СекцияДокумент");
			ЭтоПлатежныйОрдер = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("BankOrder") <> Неопределено
			И Operation.PayDoc.BankOrder <> Неопределено Тогда
			PayData = Operation.PayDoc.BankOrder;
			РеквизитыПлатежа.Добавить("Банковский ордер", "СекцияДокумент");
		ИначеЕсли Operation.PayDoc.Свойства().Получить("MemOrder") <> Неопределено
			И Operation.PayDoc.MemOrder <> Неопределено Тогда
			PayData = Operation.PayDoc.MemOrder;
			РеквизитыПлатежа.Добавить("Мемориальный ордер", "СекцияДокумент");
			ЭтоМемориальныйОрдер = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("InnerDoc") <> Неопределено
			И Operation.PayDoc.InnerDoc <> Неопределено Тогда
			PayData = Operation.PayDoc.InnerDoc;
			РеквизитыПлатежа.Добавить(PayData.InnerDocKind, "СекцияДокумент");
			ЭтоБанковскийДокумент = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("CashContribution") <> Неопределено
			И Operation.PayDoc.CashContribution <> Неопределено Тогда
			PayData = Operation.PayDoc.CashContribution;
			РеквизитыПлатежа.Добавить("Объявление на взнос наличными", "СекцияДокумент");
			ЭтоБанковскийДокумент = Истина;
		ИначеЕсли Operation.PayDoc.Свойства().Получить("Check") <> Неопределено
			И Operation.PayDoc.Check <> Неопределено Тогда
			PayData = Operation.PayDoc.Check;
			РеквизитыПлатежа.Добавить("Чек", "СекцияДокумент");
			ЭтоБанковскийДокумент = Истина;
		КонецЕсли;
			
		РеквизитыПлатежа.Добавить(PayData.DocNo, "Номер");
		РеквизитыПлатежа.Добавить(PayData.DocDate, "Дата");
		РеквизитыПлатежа.Добавить(PayData.Sum, "Сумма");
		
		Если НЕ ЭтоМемориальныйОрдер Тогда
			Payer = PayData.Payer;
			РеквизитыПлатежа.Добавить(Payer.Name, "ПлательщикНаименование");
			РеквизитыПлатежа.Добавить(Payer.INN, "ПлательщикИНН");
			РеквизитыПлатежа.Добавить(Payer.KPP, "ПлательщикКПП");
			РеквизитыПлатежа.Добавить(Payer.Account, "ПлательщикСчет");
			РеквизитыПлатежа.Добавить(Payer.Bank.BIC, "ПлательщикБИКБанка");
			РеквизитыПлатежа.Добавить(Payer.Bank.Name, "ПлательщикНаименованиеБанка");
			РеквизитыПлатежа.Добавить(Payer.Bank.City, "ПлательщикГородБанка");
			РеквизитыПлатежа.Добавить(Payer.Bank.CorrespAcc, "ПлательщикКоррСчетБанка");
			
			Payee = PayData.Payee;
			РеквизитыПлатежа.Добавить(Payee.Name, "ПолучательНаименование");
			РеквизитыПлатежа.Добавить(Payee.INN, "ПолучательИНН");
			РеквизитыПлатежа.Добавить(Payee.KPP, "ПолучательКПП");
			РеквизитыПлатежа.Добавить(Payee.Account, "ПолучательСчет");
			РеквизитыПлатежа.Добавить(Payee.Bank.BIC, "ПолучательБИКБанка");
			РеквизитыПлатежа.Добавить(Payee.Bank.Name, "ПолучательНаименованиеБанка");
			РеквизитыПлатежа.Добавить(Payee.Bank.City, "ПолучательГородБанка");
			РеквизитыПлатежа.Добавить(Payee.Bank.CorrespAcc, "ПолучательКоррСчетБанка");
			
			Если Не ЭтоБанковскийДокумент Тогда
				РеквизитыПлатежа.Добавить(PayData.PaymentKind, "ВидПлатежа");
				РеквизитыПлатежа.Добавить(PayData.Priority, "Очередность");
			КонецЕсли;
			
			РеквизитыПлатежа.Добавить(PayData.TransitionKind, "ВидОплаты");
			РеквизитыПлатежа.Добавить(PayData.Code, "Код");
			РеквизитыПлатежа.Добавить(PayData.Purpose, "НазначениеПлатежа");
			КоличествоСтрокНП = Мин(СтрЧислоСтрок(PayData.Purpose), 6);
			Для Сч = 1 По КоличествоСтрокНП Цикл
				РеквизитыПлатежа.Добавить(СтрПолучитьСтроку(PayData.Purpose, Сч), "НазначениеПлатежа" + Сч);
			КонецЦикла;
			
		КонецЕсли;
		
		Если ЭтоПлатежноеПоручение ИЛИ ЭтоИнкассовоеПоручение ИЛИ ЭтоПлатежныйОрдер Тогда
			Если НЕ PayData.BudgetPaymentInfo = Неопределено Тогда
				PayDataBudget = PayData.BudgetPaymentInfo;
				РеквизитыПлатежа.Добавить(Истина, "ЭтоПлатежВБюджет");
				РеквизитыПлатежа.Добавить(PayDataBudget.DrawerStatus, "СтатусСоставителя");
				РеквизитыПлатежа.Добавить(PayDataBudget.CBC, "ПоказательКБК");
				РеквизитыПлатежа.Добавить(PayDataBudget.OKTMO, "ОКТМО");
				РеквизитыПлатежа.Добавить(PayDataBudget.Reason, "ПоказательОснования");
				РеквизитыПлатежа.Добавить(PayDataBudget.TaxPeriod, "ПоказательПериода");
				РеквизитыПлатежа.Добавить(PayDataBudget.DocNo, "ПоказательНомера");
				РеквизитыПлатежа.Добавить(PayDataBudget.DocDate, "ПоказательДаты");
				РеквизитыПлатежа.Добавить(PayDataBudget.PayType, "ПоказательТипа");
			Иначе
				РеквизитыПлатежа.Добавить(Ложь, "ЭтоПлатежВБюджет");
			КонецЕсли;
		КонецЕсли;
		
		Если ЭтоПлатежноеТребование Тогда
			РеквизитыПлатежа.Добавить(PayData.PaymentCondition, "УсловиеОплаты");
			КоличествоСтрок = Мин(СтрЧислоСтрок(PayData.PaymentCondition), 3);
			Для Сч = 1 По КоличествоСтрок Цикл
				РеквизитыПлатежа.Добавить(СтрПолучитьСтроку(PayData.PaymentCondition, Сч), "УсловиеОплаты" + Сч);
			КонецЦикла;
			РеквизитыПлатежа.Добавить(PayData.AcceptTerm, "СрокАкцепта");
			РеквизитыПлатежа.Добавить(PayData.DocDispatchDate, "ДатаОтсылкиДок");
		КонецЕсли;
		
		Если ЭтоПлатежныйОрдер Тогда
			РеквизитыПлатежа.Добавить(PayData.TransitionContent, "СодержаниеОперации");
			РеквизитыПлатежа.Добавить(PayData.PartialPaymentNo, "НомерЧастичногоПлатежа");
			РеквизитыПлатежа.Добавить(PayData.PartialTransitionKind, "ШифрПлатежногоДокумента");
			РеквизитыПлатежа.Добавить(PayData.SumResidualPayment, "СуммаОстаткаПлатежа");
			РеквизитыПлатежа.Добавить(PayData.PartialDocNo, "НомерПлатежногоДокумента");
			РеквизитыПлатежа.Добавить(PayData.PartialDocDate, "ДатаПлатежногоДокумента");
		КонецЕсли;
		
		Если ЭтоМемориальныйОрдер Тогда
			Если Operation.DC = "1" Тогда // списание с лиц.счета
				СторонаБанка = "Получатель";
				СторонаКлиента = "Плательщик";
			ИначеЕсли Operation.DC = "2" Тогда // поступление на лиц.счет
				СторонаБанка = "Плательщик";
				СторонаКлиента = "Получатель";
			Иначе
				Продолжить;
			КонецЕсли;
			Payee = PayData.Author;
			Если НЕ Payee = Неопределено Тогда
				РеквизитыПлатежа.Добавить(Payee.Name, СторонаБанка + "Наименование");
				РеквизитыПлатежа.Добавить(Payee.CorrespAcc, СторонаБанка + "Счет");
				РеквизитыПлатежа.Добавить(Payee.BIC, СторонаБанка + "БИКБанка");
				РеквизитыПлатежа.Добавить(Payee.Name, СторонаБанка + "НаименованиеБанка");
				РеквизитыПлатежа.Добавить(Payee.City, СторонаБанка + "ГородБанка");
				РеквизитыПлатежа.Добавить(Payee.CorrespAcc, СторонаБанка + "КоррСчетБанка");
			КонецЕсли;
			РеквизитыПлатежа.Добавить(PayData.PartialTransitionKind, "ШифрДокумента");
			РеквизитыПлатежа.Добавить(PayData.TransitionContent, "СодержаниеОперации");
			РеквизитыПлатежа.Добавить(PayData.TransitionContent, "НазначениеПлатежа");
			РеквизитыПлатежа.Добавить(PayData.PartialTransitionKind, "ВидОплаты");
			
			РеквизитыПлатежа.Добавить(ЭД.Recipient.name, СторонаКлиента + "Наименование");
			РеквизитыПлатежа.Добавить(ЭД.Recipient.inn, СторонаКлиента + "ИНН");
			РеквизитыПлатежа.Добавить(ЭД.Recipient.kpp, СторонаКлиента + "КПП");
			РеквизитыПлатежа.Добавить(ЭД.Data.Account, СторонаКлиента + "Счет");
			РеквизитыПлатежа.Добавить(ЭД.Data.Bank.Bic, СторонаКлиента + "БИКБанка");
			РеквизитыПлатежа.Добавить(ЭД.Data.Bank.Name, СторонаКлиента + "НаименованиеБанка");
			РеквизитыПлатежа.Добавить(ЭД.Data.Bank.City, СторонаКлиента + "ГородБанка");
			РеквизитыПлатежа.Добавить(ЭД.Data.Bank.CorrespAcc, СторонаКлиента + "КоррСчетБанка");
		КонецЕсли;
		
		Если НЕ Operation.Stamp = Неопределено Тогда
			РеквизитыПлатежа.Добавить(Operation.Stamp.BIC, "ШтампБанкаБИК");
			РеквизитыПлатежа.Добавить(Operation.Stamp.Name, "ШтампБанкаНаименование");
			РеквизитыПлатежа.Добавить(Operation.Stamp.City, "ШтампБанкаГород");
			РеквизитыПлатежа.Добавить(Operation.Stamp.CorrespAcc, "ШтампБанкаКоррСчетБанка");
			РеквизитыПлатежа.Добавить(Operation.Stamp.Branch, "ШтампБанкаОтделение");
			РеквизитыПлатежа.Добавить(Operation.Stamp.Status.Name, "ШтампБанкаСтатус");
		КонецЕсли;
	
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", РеквизитыПлатежа);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьЗапросВыпискиAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки;
	
	DataRequest = ЭД.Data;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачала", DataRequest.DateFrom);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонца",  DataRequest.DateTo);
	
	ТекстБанк = " " + НСтр("ru='в банке'") + " ";
	Если НЕ DataRequest.Bank.Name = Неопределено Тогда
		ТекстБанк = ТекстБанк + DataRequest.Bank.Name + ", ";
	КонецЕсли;
	ТекстБанк = ТекстБанк + НСтр("ru = 'БИК:'") + " " + DataRequest.Bank.BIC;
	
	НомерСчета = DataRequest.Account + ТекстБанк;
	РеквизитыСчета = Новый СписокЗначений;
	РеквизитыСчета.Добавить(НомерСчета, "НомерСчета");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", РеквизитыСчета);
	
КонецПроцедуры

Процедура ПрочитатьПлатежноеПоручениеAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение;
	PayData = ЭД.Data;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", PayData.DocNo);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", PayData.DocDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СекцияДокумент", "Платежное поручение");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", PayData.Sum);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", PayData.Sum);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.id);
	
	Payer = PayData.Payer;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикНаименование", Payer.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикИНН", Payer.INN);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикКПП", Payer.KPP);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикРасчСчет", Payer.Account);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикБИКБанка", Payer.Bank.BIC);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикНаименованиеБанка", Payer.Bank.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикГородБанка", Payer.Bank.City);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикКоррСчетБанка", Payer.Bank.CorrespAcc);
	
	Payee = PayData.Payee;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательНаименование", Payee.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательИНН", Payee.INN);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательКПП", Payee.KPP);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательРасчСчет", Payee.Account);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательБИКБанка", Payee.Bank.BIC);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательНаименованиеБанка", Payee.Bank.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательГородБанка", Payee.Bank.City);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательКоррСчетБанка", Payee.Bank.CorrespAcc);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВидПлатежа", PayData.PaymentKind);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВидОплаты", PayData.TransitionKind);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Очередность", PayData.Priority);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Код", PayData.Code);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НазначениеПлатежа", PayData.Purpose);
	
	Если НЕ PayData.BudgetPaymentInfo = Неопределено Тогда
		PayDataBudget = PayData.BudgetPaymentInfo;
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЭтоПлатежВБюджет", Истина);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "СтатусСоставителя", PayDataBudget.DrawerStatus);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПоказательКБК", PayDataBudget.CBC);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКТМО", PayDataBudget.OKTMO);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательОснования", PayDataBudget.Reason);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПоказательПериода", PayDataBudget.TaxPeriod);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПоказательНомера", PayDataBudget.DocNo);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПоказательДаты", PayDataBudget.DocDate);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПоказательТипа", PayDataBudget.PayType);
	Иначе
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЭтоПлатежВБюджет",  Ложь);
	КонецЕсли;

КонецПроцедуры

Процедура ПрочитатьПлатежноеТребованиеAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.id);
	
	PayData = ЭД.Data;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", PayData.DocNo);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", PayData.DocDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СекцияДокумент", "Платежное требование");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", PayData.Sum);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", PayData.Sum);
	
	Payer = PayData.Payer;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикНаименование", Payer.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикИНН", Payer.INN);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикКПП", Payer.KPP);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикРасчСчет", Payer.Account);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикБИКБанка", Payer.Bank.BIC);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикНаименованиеБанка", Payer.Bank.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикГородБанка", Payer.Bank.City);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлательщикКоррСчетБанка", Payer.Bank.CorrespAcc);
	
	Payee = PayData.Payee;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательНаименование", Payee.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательИНН", Payee.INN);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательКПП", Payee.KPP);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательРасчСчет", Payee.Account);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательБИКБанка", Payee.Bank.BIC);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательНаименованиеБанка", Payee.Bank.Name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательГородБанка", Payee.Bank.City);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПолучательКоррСчетБанка", Payee.Bank.CorrespAcc);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВидПлатежа", PayData.PaymentKind);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВидОплаты", PayData.TransitionKind);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Очередность", PayData.Priority);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НазначениеПлатежа", PayData.Purpose);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Код", PayData.Code);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "УсловиеОплаты", PayData.PaymentCondition);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СрокАкцепта", PayData.AcceptTerm);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаОтсылкиДокументов", PayData.DocDispatchDate);
	
КонецПроцедуры

Процедура ПрочитатьЗапросОСостоянииAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросОСостоянииЭД;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Идентификатор", ЭД.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВерсияФормата", ЭД.formatVersion);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСоздания", ЭД.creationDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Программа", ЭД.userAgent);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторКлиента", ЭД.Sender.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеКлиента", ЭД.Sender.name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИНН", ЭД.Sender.inn);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КПП", ЭД.Sender.kpp);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БИК", ЭД.Recipient.bic);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеБанка", ЭД.Recipient.name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторИсходногоДокумента", ЭД.ExtID);
	
КонецПроцедуры

Процедура ПрочитатьЗапросНаОтзывAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросНаОтзывЭД;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Идентификатор", ЭД.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВерсияФормата", ЭД.formatVersion);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСоздания", ЭД.creationDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Программа", ЭД.userAgent);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторКлиента", ЭД.Sender.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеКлиента", ЭД.Sender.name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИНН", ЭД.Sender.inn);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КПП", ЭД.Sender.kpp);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БИК", ЭД.Recipient.bic);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеБанка", ЭД.Recipient.name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторИсходногоДокумента", ЭД.ExtID);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Причина", ЭД.Reason);
	
КонецПроцедуры

Процедура ПрочитатьЗапросЗондAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросЗонд;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Идентификатор", ЭД.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВерсияФормата", ЭД.formatVersion);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСоздания", ЭД.creationDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Программа", ЭД.userAgent);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторКлиента", ЭД.Sender.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеКлиента", ЭД.Sender.name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИНН", ЭД.Sender.inn);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КПП", ЭД.Sender.kpp);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БИК", ЭД.Recipient.bic);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеБанка", ЭД.Recipient.name);
	
КонецПроцедуры

Процедура ПрочитатьИзвещениеОСостоянииAsyncXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ИзвещениеОСостоянииЭД;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.id);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВерсияФормата", ЭД.formatVersion);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСоздания", ЭД.creationDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Программа", ЭД.userAgent);
	
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторКлиента", ЭД.Recipient.Customer.id);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НаименованиеКлиента", ЭД.Recipient.Customer.name);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИНН", ЭД.Recipient.Customer.inn);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КПП", ЭД.Recipient.Customer.kpp);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БИК", ЭД.Sender.Bank.bic);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеБанка", ЭД.Sender.Bank.name);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторИсходногоДокумента", ЭД.ExtID);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторЗапроса", ЭД.ExtIDStatusRequest);
	
	Если ЭД.Result.Error = Неопределено Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЕстьОшибка", Ложь);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КодСтатуса", ЭД.Result.Status.Code);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТекстСтатуса", ЭД.Result.Status.Name);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ДополнительнаяИнформация", ЭД.Result.Status.MoreInfo);
	Иначе
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЕстьОшибка", Истина);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КодОшибки", ЭД.Result.Error.Code);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Описание", ЭД.Result.Error.Description);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ДополнительнаяИнформация", ЭД.Result.Error.MoreInfo);
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьПлатежноеПоручениеCML(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
	
	ПространствоИмен = "urn:1C.ru:ClientBankExchange";
	
	ТекстОшибки = "";
	
	ClientBankExchange = ОбъектТипаCML(ФабрикаXDTO, "ClientBankExchange", ПространствоИмен);
	ВерсияФормата = ОбменСБанкамиКлиентСервер.ВерсияФорматаСинхронногоОбмена();
	ЗаполнитьСвойствоXDTO(ClientBankExchange, "ВерсияФормата", ВерсияФормата, Истина, ТекстОшибки);
	ПлательщикНаименованиеБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(ClientBankExchange, "Получатель", ПлательщикНаименованиеБанка, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ClientBankExchange, "Отправитель", "1С: Предприятие", Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ClientBankExchange, "ДатаСоздания", ТекущаяДатаСеанса(), , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ClientBankExchange, "ВремяСоздания", ТекущаяДатаСеанса(), , ТекстОшибки);
	
	ПлатежноеПоручениеЭО = ОбъектТипаCML(ФабрикаXDTO, "ПлатежныйДокумент", ПространствоИмен);
	ИдДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "ИдДокумента", ИдДокумента, , ТекстОшибки);
	
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "СекцияДокумент", "Платежное поручение", Истина, ТекстОшибки);
	Номер = СокрЛП(ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер"));
	
	Если СтрДлина(Номер) > 6 Тогда
		ТекстОшибки = ТекстОшибки + ?(ПустаяСтрока(ТекстОшибки), "", Символы.ПС)
			+ НСтр("ru = 'Длина номера документа не может превышать 6 символов.'");
	КонецЕсли;
	
	Если Не СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(Номер) Тогда
		ТекстОшибки = ТекстОшибки + ?(ПустаяСтрока(ТекстОшибки), "", Символы.ПС)
			+ НСтр("ru = 'Номер документа должен содержать только цифры.'");
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "Номер", Номер, Истина, ТекстОшибки);
	Дата = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "Дата", Дата, Истина, ТекстОшибки);
	Сумма = ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "Сумма", Сумма, Истина, ТекстОшибки);
	
	РеквизитыПлательщика = ОбъектТипаCML(ФабрикаXDTO, "РеквизитыПлательщика", ПространствоИмен);
	ПлательщикРасчСчет = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.РасчСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикСчет", ПлательщикРасчСчет, Истина, ТекстОшибки);
	
	ПлательщикКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.КПП");
	ПеречислениеВБюджет = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет") = Истина;
	
	Если НЕ ЗначениеЗаполнено(ПлательщикКПП) И ПеречислениеВБюджет Тогда
		ПлательщикКПП = "0";
	КонецЕсли;
	
	Если ПеречислениеВБюджет ИЛИ (ЗначениеЗаполнено(ПлательщикКПП) И НЕ ПлательщикКПП = "0") Тогда
		ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикКПП", ПлательщикКПП, ПеречислениеВБюджет, ТекстОшибки);
	КонецЕсли;
	
	ПлательщикИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.ИНН");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикИНН", ПлательщикИНН, , ТекстОшибки);
	
	ПлательщикБанк = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикБанк1", ПлательщикБанк, , ТекстОшибки);
	ПлательщикГородБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Город");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикБанк2", ПлательщикГородБанка, , ТекстОшибки);
	ПлательщикБИКБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.БИК");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикБИК", ПлательщикБИКБанка, , ТекстОшибки);
	ПлательщикКоррСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.КоррСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "ПлательщикРасчСчет", ПлательщикКоррСчет, , ТекстОшибки);
	
	ПлательщикНаим = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Наименование");
	
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Плательщик1", ПлательщикНаим, , ТекстОшибки);
	
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Плательщик", ПлательщикНаим, , ТекстОшибки);
		
	РеквизитыПолучателя = ОбъектТипаCML(ФабрикаXDTO, "РеквизитыПолучателя", ПространствоИмен);
	ПолучательРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.РасчСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательСчет", ПолучательРасчСчет, Истина, ТекстОшибки);
	
	ПолучательКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.КПП");
	
	Если НЕ ЗначениеЗаполнено(ПолучательКПП) И ПеречислениеВБюджет Тогда
		ПолучательКПП = "0";
	КонецЕсли;
	
	Если ПеречислениеВБюджет ИЛИ (ЗначениеЗаполнено(ПолучательКПП) И НЕ ПолучательКПП = "0") Тогда
		ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательКПП", ПолучательКПП, ПеречислениеВБюджет, ТекстОшибки);
	КонецЕсли;
	
	ПолучательИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.ИНН");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательИНН", ПолучательИНН, , ТекстОшибки);
	
	ПолучательБанк = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательБанк1", ПолучательБанк, , ТекстОшибки);
	ПолучательГородБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Город");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательБанк2", ПолучательГородБанка, , ТекстОшибки);
	ПолучательБИКБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.БИК");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательБИК", ПолучательБИКБанка, , ТекстОшибки);
	ПолучательКоррСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.КоррСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "ПолучательРасчСчет", ПолучательКоррСчет, , ТекстОшибки);
	
	ПолучательНаим = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Наименование");
		
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Получатель1", ПолучательНаим, , ТекстОшибки);
	
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Получатель", ПолучательНаим, , ТекстОшибки);
	Если ПеречислениеВБюджет Тогда
		
		ПлатежиВБюджетCML = ОбъектТипаCML(ФабрикаXDTO, "ПлатежиВБюджет", ПространствоИмен);
		
		СтатусСоставителя = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.СтатусСоставителя");
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "СтатусСоставителя", СтатусСоставителя, Истина, ТекстОшибки);
		
		ПоказательКБК = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательКБК");
		ПоказательКБК = ?(Не ПустаяСтрока(ПоказательКБК), СокрЛП(ПоказательКБК), "0");
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ПоказательКБК", ПоказательКБК, Истина, ТекстОшибки);
		
		ОКТМО = СокрЛП(ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ОКТМО"));
		Если НЕ ЗначениеЗаполнено(ОКТМО) ИЛИ ПустаяСтрока(ОКТМО) Тогда
			ОКТМО = "0";
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ОКАТО", ОКТМО, Истина, ТекстОшибки);
		
		ПоказательОснования = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательОснования");
		Если НЕ ЗначениеЗаполнено(ПоказательОснования) ИЛИ ПустаяСтрока(ПоказательОснования) Тогда
			ПоказательОснования = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ПоказательОснования", ПоказательОснования, Истина, ТекстОшибки);
		
		ПоказательПериода = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательПериода");
		Если НЕ ЗначениеЗаполнено(ПоказательПериода) ИЛИ ПустаяСтрока(ПоказательПериода)
			ИЛИ ПоказательПериода = "  .  .    " Тогда
			ПоказательПериода = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ПоказательПериода", ПоказательПериода, Истина, ТекстОшибки);
		
		ПоказательНомера = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательНомера");
		Если НЕ ЗначениеЗаполнено(ПоказательНомера) ИЛИ ПустаяСтрока(ПоказательНомера) Тогда
			ПоказательНомера = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ПоказательНомера", ПоказательНомера, Истина, ТекстОшибки);
		
		ПоказательДаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательДаты");
		Если НЕ ЗначениеЗаполнено(ПоказательДаты) Тогда
			ПоказательДаты = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ПоказательДаты", ПоказательДаты, Истина, ТекстОшибки);
		
		Если Дата < Дата(2016, 3, 28) Тогда
			ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "ПоказательТипа", "0", Истина, ТекстОшибки);
		КонецЕсли;
		
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "РеквизитыПлательщика", РеквизитыПлательщика, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "РеквизитыПолучателя", РеквизитыПолучателя, Истина, ТекстОшибки);
	
	РеквизитыПлатежа = ОбъектТипаCML(ФабрикаXDTO, "РеквизитыПлатежа", ПространствоИмен);
	ВидПлатежа = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидПлатежа");
	ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "ВидПлатежа", ВидПлатежа, , ТекстОшибки);
	ВидОплаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидОплаты");
	ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "ВидОплаты", ВидОплаты, , ТекстОшибки);
	Очередность = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Очередность");
	ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "Очередность", Очередность, , ТекстОшибки);
	Код = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Код");
	ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "Код", Код, , ТекстОшибки);
	Если ПеречислениеВБюджет И Не ЗначениеЗаполнено(Код) Тогда
		ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "Код", "0", , ТекстОшибки);
	КонецЕсли;
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа");
	ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "НазначениеПлатежа", НазначениеПлатежа, , ТекстОшибки);
	
	НазначениеПлатежаОтформатированное = НазначениеПлатежаОтформатированное(НазначениеПлатежа);
	
	КоличествоСтрокНП = Мин(СтрЧислоСтрок(НазначениеПлатежаОтформатированное), 6);
	
	Для Сч = 1 По КоличествоСтрокНП Цикл
		ТекСтрока = СтрПолучитьСтроку(НазначениеПлатежаОтформатированное, Сч);
		ЗаполнитьСвойствоXDTO(РеквизитыПлатежа, "НазначениеПлатежа" + Сч, ТекСтрока, , ТекстОшибки);
	КонецЦикла;
		
	ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "РеквизитыПлатежа", РеквизитыПлатежа, Истина, ТекстОшибки);
	
	Если ПеречислениеВБюджет Тогда
		ЗаполнитьСвойствоXDTO(ПлатежноеПоручениеЭО, "ПлатежиВБюджет", ПлатежиВБюджетCML, Истина, ТекстОшибки);
	КонецЕсли;
	
	ClientBankExchange.СекцияПлатежногоДокумента.Добавить(ПлатежноеПоручениеЭО);
	
	ClientBankExchange.Проверить();
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	Иначе
		ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, ClientBankExchange);
		АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	КонецЕсли;
	
КонецПроцедуры

Функция НазначениеПлатежаОтформатированное(НазначениеПлатежа)
	
	НазначениеПлатежаОтформатированное = "";
	Для Счетчик = 1 По СтрЧислоСтрок(НазначениеПлатежа) Цикл
		ТекСтрока = СтрПолучитьСтроку(НазначениеПлатежа, Счетчик);
		Пока СтрДлина(ТекСтрока) > 35 Цикл
			НазначениеПлатежаОтформатированное = НазначениеПлатежаОтформатированное + Сред(ТекСтрока, 1, 35) + Символы.ПС;
			ТекСтрока = Сред(ТекСтрока, 36);
		КонецЦикла;
		НазначениеПлатежаОтформатированное = НазначениеПлатежаОтформатированное + ТекСтрока + Символы.ПС;
	КонецЦикла;
	
	Возврат НазначениеПлатежаОтформатированное;
	
КонецФункции

Процедура СформироватьПлатежноеПоручениеAsync(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
	
	ВерсияФормата = ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияФормата");
	
	Если НЕ ЗначениеЗаполнено(ВерсияФормата) Тогда
		ВерсияФормата = ОбменСБанкамиКлиентСервер.АктуальнаяВерсияФорматаАсинхронногоОбмена();
	КонецЕсли;
	
	Фабрика = ОбменСБанкамиСлужебныйПовтИсп.ФабрикаAsyncXDTO(ВерсияФормата);
	
	ПространствоИмен = ПространствоИменАсинхронногоОбмена(ВерсияФормата);
	
	ТекстОшибки = "";

	ЭД = ОбъектТипаCML(Фабрика, "PayDocRu", ПространствоИмен);
	
	ИдДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
	ЗаполнитьСвойствоXDTO(ЭД, "id", ИдДокумента, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ЭД, "formatVersion", ВерсияФормата, Истина, ТекстОшибки);

	ЗаполнитьСвойствоXDTO(ЭД, "creationDate", ТекущаяДатаСеанса(), Истина, ТекстОшибки);
	userAgent = ОбменСБанкамиСлужебныйПовтИсп.ВерсияПрограммыКлиентаДляБанка();
	ЗаполнитьСвойствоXDTO(ЭД, "userAgent", userAgent, , ТекстОшибки);
	
	Отправитель = ОбъектТипаCML(Фабрика, "CustomerPartyType", ПространствоИмен);
	ИдКлиента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдКлиента");
	ЗаполнитьСвойствоXDTO(Отправитель, "id", ИдКлиента, Истина, ТекстОшибки);
	ПлательщикНаименование = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Наименование");
	ЗаполнитьСвойствоXDTO(Отправитель, "name", ПлательщикНаименование, Истина, ТекстОшибки);
	ПлательщикИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.ИНН");
	ЗаполнитьСвойствоXDTO(Отправитель, "inn", ПлательщикИНН, , ТекстОшибки);
	ПлательщикКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.КПП");
	Если ПлательщикКПП <> "0" Тогда
		ЗаполнитьСвойствоXDTO(Отправитель, "kpp", ПлательщикКПП, , ТекстОшибки);
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(ЭД, "Sender", Отправитель, Истина, ТекстОшибки);
	
	Получатель = ОбъектТипаCML(Фабрика, "BankPartyType", ПространствоИмен);
	ПлательщикБИКБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.БИК");
	ЗаполнитьСвойствоXDTO(Получатель, "bic", ПлательщикБИКБанка, Истина, ТекстОшибки);
	ПлательщикНаименованиеБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(Получатель, "name", ПлательщикНаименованиеБанка, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ЭД, "Recipient", Получатель, Истина, ТекстОшибки);
	
	ДанныеПлатежа = ОбъектТипаCML(Фабрика, "PayDocRu.Data", ПространствоИмен);
	
	Номер = СокрЛП(ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер"));
	Если Не СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(Номер) Тогда
		ТекстОшибки = ТекстОшибки + ?(ПустаяСтрока(ТекстОшибки), "", Символы.ПС)
			+ НСтр("ru = 'Номер документа должен содержать только цифры.'");
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "DocNo", Номер, Истина, ТекстОшибки);
	Дата = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "DocDate", Дата, Истина, ТекстОшибки);
	Сумма = ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Sum", Сумма, Истина, ТекстОшибки);
	
	РеквизитыПлательщика = ОбъектТипаCML(Фабрика, "CustomerDetailsType", ПространствоИмен);
	ПлательщикРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.РасчСчет");
		
	Если ЗначениеЗаполнено(ПлательщикРасчСчет) И СтрДлина(СокрЛП(ПлательщикРасчСчет)) <> 20 Тогда
		ТекстОшибки = НСтр("ru = 'Некорректный номер счета плательщика %1
							|Длина номера счета должна состоять из 20 цифр.'");
		ТекстОшибки = СтрШаблон(ТекстОшибки, ПлательщикРасчСчет);
	КонецЕсли;

	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Name", ПлательщикНаименование, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "INN", ПлательщикИНН, , ТекстОшибки);
	ЭтоПеречислениеВБюджет = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет") = Истина;
	Если Не ЗначениеЗаполнено(ПлательщикКПП) И ЭтоПеречислениеВБюджет Тогда
		ПлательщикКПП = "0";
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "KPP", ПлательщикКПП, ЭтоПеречислениеВБюджет, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Account", ПлательщикРасчСчет, , ТекстОшибки);
	
	БанкПлательщика = ОбъектТипаCML(Фабрика, "BankType", ПространствоИмен);
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "BIC", ПлательщикБИКБанка, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "Name", ПлательщикНаименованиеБанка, , ТекстОшибки);
	ПлательщикГородБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Город");
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "City", ПлательщикГородБанка, , ТекстОшибки);
	ПлательщикКоррСчетБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.КоррСчет");
	ЗаполнитьСвойствоXDTO(БанкПлательщика, "CorrespAcc", ПлательщикКоррСчетБанка, , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "Bank", БанкПлательщика, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Payer", РеквизитыПлательщика, Истина, ТекстОшибки);
	
	РеквизитыПолучателя = ОбъектТипаCML(Фабрика, "CustomerDetailsType", ПространствоИмен);
	ПолучательНаименование = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Наименование");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Name", ПолучательНаименование, Истина, ТекстОшибки);
	ПолучательИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.ИНН");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "INN", ПолучательИНН, , ТекстОшибки);
	ПолучательКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.КПП");
	Если Не ЗначениеЗаполнено(ПолучательКПП) И ЭтоПеречислениеВБюджет Тогда
		ПолучательКПП = "0";
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "KPP", ПолучательКПП, ЭтоПеречислениеВБюджет, ТекстОшибки);
	ПолучательРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.РасчСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Account", ПолучательРасчСчет, , ТекстОшибки);
	
	БанкПолучателя = ОбъектТипаCML(Фабрика, "BankType", ПространствоИмен);
	ПолучательБИКБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.БИК");
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "BIC", ПолучательБИКБанка, Истина, ТекстОшибки);
	ПолучательНаименованиеБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Наименование");
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "Name", ПолучательНаименованиеБанка, , ТекстОшибки);
	ПолучательГородБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Город");
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "City", ПолучательГородБанка, , ТекстОшибки);
	ПолучательКоррСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.КоррСчет");
	ЗаполнитьСвойствоXDTO(БанкПолучателя, "CorrespAcc", ПолучательКоррСчет, , ТекстОшибки);
	ЗаполнитьСвойствоXDTO(РеквизитыПолучателя, "Bank", БанкПолучателя, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Payee", РеквизитыПолучателя, Истина, ТекстОшибки);
	
	ВидПлатежа = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидПлатежа");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "PaymentKind", ВидПлатежа, , ТекстОшибки);
	ВидОплаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидОплаты");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "TransitionKind", ВидОплаты, , ТекстОшибки);
	Очередность = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Очередность");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Priority", Очередность, , ТекстОшибки);
	Код = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Код");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Code", Код, , ТекстОшибки);
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа");
	ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Purpose", НазначениеПлатежа, Истина, ТекстОшибки);
	
	Если ЭтоПеречислениеВБюджет Тогда
		Если НЕ ЗначениеЗаполнено(Код) Тогда
			ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "Code", "0", , ТекстОшибки);
		КонецЕсли;
		Если ВерсияФормата = "2.01" Тогда
			ПлатежиВБюджетCML = ОбъектТипаCML(Фабрика, "PayDocRu.Data.BudgetPaymentInfo", ПространствоИмен);
		Иначе
			ПлатежиВБюджетCML = ОбъектТипаCML(Фабрика, "BudgetPaymentInfoType", ПространствоИмен);
		КонецЕсли;
		СтатусСоставителя = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.СтатусСоставителя");
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "DrawerStatus", СтатусСоставителя, Истина, ТекстОшибки);
		ПоказательКБК = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательКБК");
		ПоказательКБК = ?(Не ПустаяСтрока(ПоказательКБК), СокрЛП(ПоказательКБК), "0");
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "CBC", ПоказательКБК, Истина, ТекстОшибки);
		ОКТМО = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ОКТМО");
		Если НЕ ЗначениеЗаполнено(ОКТМО) ИЛИ ПустаяСтрока(ОКТМО) Тогда
			ОКТМО = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "OKTMO", ОКТМО, Истина, ТекстОшибки);
		ПоказательОснования = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательОснования");
		Если НЕ ЗначениеЗаполнено(ПоказательОснования) ИЛИ ПустаяСтрока(ПоказательОснования) Тогда
			ПоказательОснования = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "Reason", ПоказательОснования, Истина, ТекстОшибки);
		
		ПоказательПериода = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательПериода");
		Если НЕ ЗначениеЗаполнено(ПоказательПериода) ИЛИ ПустаяСтрока(ПоказательПериода)
			ИЛИ ПоказательПериода = "  .  .    " Тогда
			ПоказательПериода = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "TaxPeriod", ПоказательПериода, Истина, ТекстОшибки);
		
		ПоказательНомера = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательНомера");
		Если НЕ ЗначениеЗаполнено(ПоказательНомера) ИЛИ ПустаяСтрока(ПоказательНомера) Тогда
			ПоказательНомера = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "DocNo", ПоказательНомера, Истина, ТекстОшибки);
		
		ПоказательДаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательДаты");
		Если НЕ ЗначениеЗаполнено(ПоказательДаты) Тогда
			ПоказательДаты = "0";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "DocDate", ПоказательДаты, Истина, ТекстОшибки);
		
		Если Дата < Дата(2016, 3, 28) ИЛИ ВерсияФормата = "2.02" ИЛИ ВерсияФормата = "2.01" Тогда
			ЗаполнитьСвойствоXDTO(ПлатежиВБюджетCML, "PayType", "0", Истина, ТекстОшибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(ДанныеПлатежа, "BudgetPaymentInfo", ПлатежиВБюджетCML, , ТекстОшибки);
	КонецЕсли;

	ЗаполнитьСвойствоXDTO(ЭД, "Data", ДанныеПлатежа, Истина, ТекстОшибки);
	
	ЭД.Проверить();
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	Иначе
		ДвоичныеДанные = ДвоичныеДанныеИзXDTO(Фабрика, ЭД, Ложь);
		АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	КонецЕсли;

КонецПроцедуры

Функция ИнформацияОРасположенииБанка(СтрокаРазбора)

	СтруктураВозврата = Новый Структура("ТипНаселенногоПункта, НазваниеНаселенногоПункта");
	ПозПробела = СтрНайти(СтрокаРазбора, " ");
	Если ПозПробела > 0 Тогда
		СтруктураВозврата.ТипНаселенногоПункта = СтрЗаменить(Сред(СтрокаРазбора, 1, ПозПробела - 1), ".", "");
		Если ПозПробела < СтрДлина(СтрокаРазбора) Тогда
			СтруктураВозврата.НазваниеНаселенногоПункта = Сред(СтрокаРазбора, ПозПробела + 1);
		КонецЕсли
	КонецЕсли;
	Возврат СтруктураВозврата;
	
КонецФункции

Процедура УстановитьЗначениеXDTO(ОбъектXDTO, ИмяСвойства, Значение, ТекстОшибки)
	
	Попытка
		ОбъектXDTO.Установить(ИмяСвойства, Значение);
	Исключение
		ШаблонСообщения = НСтр("ru = 'Выполнение операции: Заполнение XDTO.
			|Ошибка установки значения свойства ""%1"".'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, ИмяСвойства);
		ТекстОшибки = ?(ЗначениеЗаполнено(ТекстОшибки), ТекстОшибки + Символы.ПС + ТекстСообщения, ТекстСообщения);
		
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ТекстСообщения + Символы.ПС
			+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "ОбменСБанками");
	КонецПопытки
	
КонецПроцедуры

Процедура ДобавитьРеквизитШапкиОбъекта(СтрокаЭлементов, ИмяРеквизита, ЗначениеРеквизита, СсылкаНаОбъект = Неопределено)
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(
		СтрокаЭлементов, ИмяРеквизита, ЗначениеРеквизита, СсылкаНаОбъект);
	
КонецПроцедуры

Функция ЗначениеСвойстваXDTO(ОбъектXDTO, Путь)
	
	Возврат ЭлектронноеВзаимодействиеСлужебный.ЗначениеСвойстваXDTO(ОбъектXDTO, Путь);
	
КонецФункции

#КонецОбласти

#Область Транспорт

Процедура ОбработатьОтветИзБанка(ОтветБанка, ОтправленноеСообщениеОбмена, ПолученноеСообщениеОбмена = Неопределено, ЕстьОшибка = Неопределено)
	
	ДанныеОтвета = ПолучитьДанныеИзОтветаБанка(ОтветБанка);
	ЕстьОшибка = Ложь;
	Сообщение = ДанныеОтвета.Получить("Данные");
	РеквизитыОтправленногоСообщения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		ОтправленноеСообщениеОбмена, "НастройкаОбмена, ВидЭД");
	ВидЭД = РеквизитыОтправленногоСообщения.ВидЭД;
	ЧтениеДанных = Новый ЧтениеДанных(Сообщение);
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
	Если ЧтениеXML.Прочитать() И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента
		И (ЧтениеXML.ЛокальноеИмя = "success" ИЛИ ЧтениеXML.ЛокальноеИмя = "error") Тогда
		ЧтениеДанных = Новый ЧтениеДанных(Сообщение);
		ЧтениеXML.ОткрытьПоток(ЧтениеДанных.ИсходныйПоток());
		Пока ЧтениеXML.Прочитать() Цикл
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "success" Тогда
				ЧтениеXML.Прочитать();
				ЧтениеXML.Прочитать();
				СтруктураПараметров = Новый Структура;
				СтруктураПараметров.Вставить("ВнешнийИдентификатор", ЧтениеXML.Значение);
				СтруктураПараметров.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Доставлен);
				ДополнительныеДанные = Новый Структура("ДатаПоступленияВБанк", ТекущаяДатаСеанса());
				СтруктураПараметров.Вставить("ДополнительныеДанные", ДополнительныеДанные);
				ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(ОтправленноеСообщениеОбмена, СтруктураПараметров)
			ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "error" Тогда
				ЧтениеXML.Прочитать();
				ЧтениеXML.Прочитать();
				КодОшибки = ЧтениеXML.Значение;
				ЧтениеXML.Прочитать();
				ЧтениеXML.Прочитать();
				ЧтениеXML.Прочитать();
				ТекстОшибки = ЧтениеXML.Значение;
				СтруктураПараметров = Новый Структура;
				СтруктураПараметров.Вставить("ПричинаОтклонения", ТекстОшибки);
				СтруктураПараметров.Вставить("Статус", Перечисления.СтатусыОбменСБанками.ОтклоненБанком);
				ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(ОтправленноеСообщениеОбмена, СтруктураПараметров);
				Если ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки Тогда
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
				КонецЕсли;
				ЕстьОшибка = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	Иначе
		АдресФайла = ПоместитьВоВременноеХранилище(Сообщение);
		НаименованиеЗапроса = Строка(ОтправленноеСообщениеОбмена);
		НаименованиеВыписки = СтрЗаменить(НаименованиеЗапроса, НСтр("ru = 'Запрос выписки'"), НСтр("ru = 'Выписка банка за период'"));
		
		ПараметрыСообщения = Новый Структура;
		ПараметрыСообщения.Вставить("ПредставлениеДокумента", НаименованиеВыписки);
		ПараметрыСообщения.Вставить("Расширение", "xml");
		ПараметрыСообщения.Вставить("АдресФайлаВоВременномХранилище", АдресФайла);
		ПараметрыСообщения.Вставить("НастройкаОбмена", РеквизитыОтправленногоСообщения.НастройкаОбмена);
		ПараметрыСообщения.Вставить("ВидЭД", Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка);
		ПараметрыСообщения.Вставить("Направление", Перечисления.НаправленияЭД.Входящий);
		ПараметрыСообщения.Вставить("СообщениеРодитель", ОтправленноеСообщениеОбмена);
		ПараметрыСообщения.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Получен);
		
		НовоеСообщение = Неопределено;
		СохранитьСообщениеОбмена(ПараметрыСообщения, НовоеСообщение);
		
		ОбменСБанкамиСлужебныйВызовСервера.ОпределитьИсполненныеПлатежныеПоручения(НовоеСообщение);
		ПолученноеСообщениеОбмена = НовоеСообщение;
	КонецЕсли;
	ЧтениеXML.Закрыть();
	
КонецПроцедуры

Процедура ОтправитьВБанк(Настройки, Данные, Результат, ТекстОшибки)
	
	Заголовки = Новый Соответствие;
	
	Заголовки.Вставить("Content-Type", "application/xml; charset=utf-8");
	
	Если Настройки.Свойство("Хэш") Тогда
		Заголовки.Вставить("Authorization", "Basic " + Настройки.Хэш);
	КонецЕсли;
	
	Если Настройки.Свойство("ИдентификаторСессии") Тогда
		Заголовки.Вставить("SID", Настройки.ИдентификаторСессии);
	КонецЕсли;
	
	Если Настройки.Свойство("ИдентификаторОрганизации") Тогда
		Заголовки.Вставить("CustomerID", Настройки.ИдентификаторОрганизации);
	КонецЕсли;
	
	Если Настройки.Свойство("ВерсияФормата") Тогда
		Заголовки.Вставить("APIVersion", Настройки.ВерсияФормата);
	КонецЕсли;
	
	РезультатВыполнения = ЭлектронноеВзаимодействиеСлужебный.ОтправитьЗапросНаСервер(
		Настройки.Адрес, Настройки.Ресурс, Заголовки, Данные);
	
	Если РезультатВыполнения.Статус Тогда
		Результат = РезультатВыполнения.Тело;
	Иначе
		Если ЗначениеЗаполнено(РезультатВыполнения.КодСостояния) Тогда
			Шаблон = НСтр("ru = 'При отправке документа в банк произошла ошибка (%1). %2'");
			ТекстОшибки = СтрШаблон(Шаблон, РезультатВыполнения.КодСостояния, РезультатВыполнения.СообщениеОбОшибке);
		Иначе
			ТекстОшибки = РезультатВыполнения.СообщениеОбОшибке;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработкаПакетов

Процедура ОбработатьОшибкуПередачиПакета(СообщенияОбмена, ВидОперации, ТекстОшибки, ТекстСообщения, ПакетОбмена = Неопределено)
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Статус", Перечисления.СтатусыОбменСБанками.ОшибкаПередачи);
	СтруктураПараметров.Вставить("ПричинаОтклонения", ТекстОшибки);
	
	Для Каждого СообщениеОбмена Из СообщенияОбмена Цикл
		ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(СообщениеОбмена, СтруктураПараметров);
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
		ВидОперации, ТекстОшибки, ТекстСообщения, "ОбменСБанками", ПакетОбмена);
	
КонецПроцедуры

Функция СообщенияОбменаВПакетеЭДО(ПакетОбменСБанками)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПакетОбменСБанкамиСообщения.Сообщение
	               |ИЗ
	               |	Документ.ПакетОбменСБанками.Сообщения КАК ПакетОбменСБанкамиСообщения
	               |ГДЕ
	               |	ПакетОбменСБанкамиСообщения.Ссылка = &ПакетОбменСБанками";
	Запрос.УстановитьПараметр("ПакетОбменСБанками", ПакетОбменСБанками);
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	Возврат ТаблицаРезультата.ВыгрузитьКолонку("Сообщение");;
	
КонецФункции

Функция НайтиПакетОбменСБанками(НастройкаОбмена, ВнешнийИдентификатор)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	ПакетОбменСБанками.Ссылка
	               |ИЗ
	               |	Документ.ПакетОбменСБанками КАК ПакетОбменСБанками
	               |ГДЕ
	               |	ПакетОбменСБанками.НастройкаОбмена = &НастройкаОбмена
	               |	И ПакетОбменСБанками.ВнешнийИдентификатор = &ВнешнийИдентификатор
	               |	И ПакетОбменСБанками.Направление = ЗНАЧЕНИЕ(Перечисление.НаправленияЭД.Исходящий)";
	Запрос.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
	Запрос.УстановитьПараметр("ВнешнийИдентификатор", ВнешнийИдентификатор);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли
	
КонецФункции

Процедура ДобавитьСообщениеОбменаВПакет(Пакет, СообщениеОбмена)
	
	ПакетОбъект = Пакет.ПолучитьОбъект();
	
	НоваяСтрокаСообщениеОбмена = ПакетОбъект.Сообщения.Добавить();
	НоваяСтрокаСообщениеОбмена.Сообщение = СообщениеОбмена;
	ПакетОбъект.Записать();
	
КонецПроцедуры

Функция СформироватьНовыйПакетОбменСБанками(СтруктураПараметров)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Попытка
		ПакетОбменСБанками = Документы.ПакетОбменСБанками.СоздатьДокумент();
		ПакетОбменСБанками.Дата = ТекущаяДатаСеанса();
		ЗаполнитьЗначенияСвойств(ПакетОбменСБанками, СтруктураПараметров);
		ПакетОбменСБанками.Записать();
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			Операция = НСтр("ru = 'Создание пакета обмена'");
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			Операция, ПодробноеПредставлениеОшибки, ТекстСообщения, "ОбменСБанками");
	КонецПопытки;
	
	Возврат ПакетОбменСБанками.Ссылка;
	
КонецФункции

#КонецОбласти

#Область ЗарплатныйПроект

Функция СформироватьЭДПоЗарплатномуПроекту(СсылкаНаОбъект, НастройкиОбменаЭД, ВидЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", ВидЭД);
	СтруктураЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Идентификатор", Строка(Новый УникальныйИдентификатор));
	СтруктураЭД.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	
	ПечатныйНомерДокумента = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, ПечатныйНомерДокумента);
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя", ПечатныйНомерДокумента);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	СтруктураЭД.Вставить("НастройкаОбмена", НастройкиОбменаЭД.НастройкаОбмена);
	СтруктураЭД.Вставить("ПрограммаБанка", НастройкиОбменаЭД.ПрограммаБанка);
	
	ИмяФайла = Неопределено; АдресФайла = Неопределено;
	ОбменСБанкамиПереопределяемый.ПриФормированииXMLФайла(СсылкаНаОбъект, ИмяФайла, АдресФайла);
		
	Если НЕ ЗначениеЗаполнено(ИмяФайла) Тогда
		Возврат ВозвращаемоеЗначение;
	КонецЕсли;
		
	УникальныйИдентификатор = Новый УникальныйИдентификатор;
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Организация", НастройкиОбменаЭД.Организация);
	СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
	СтруктураПараметров.Вставить("Номер", СтруктураЭД.НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("Основной", Истина);
	СтруктураЭД.Вставить("ПредставлениеДокумента", ИмяФайла);
	СтруктураЭД.Вставить("Статус", Перечисления.СтатусыОбменСБанками.Сформирован);
	СтруктураЭД.Вставить("АдресФайлаВоВременномХранилище", АдресФайла);
	
	СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
	ВозвращаемоеЗначение = СтруктураПараметров;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

#КонецОбласти

#Область МаршрутыПодписания

// Формирует маршрут подписания по умолчанию для настройки обмена с банком.
//
// Параметры:
//  НастройкаОбмена						 - СправочникСсылка.НастройкиОбменСБанками - ссылка на настройку обмена.
//  ВидДокумента						 - ПеречислениеСсылка.ВидыЭДОбменСБанками  - вид электронного документа.
//  ЗаполнитьКлючАвтоматическойНастройки - Булево                                  - если Истина, то у настройки будет
//      заполнен ключ, по которому она будет найдена при попытке обновления настроек из банка.
// 
// Возвращаемое значение:
//  СправочникСсылка.МаршрутыПодписания - ссылка на маршрут подписания.
//
Функция НовыйМаршрутПоСертификатамНастройки(НастройкаОбмена, ВидДокумента, 
	ЗаполнитьКлючАвтоматическойНастройки = Истина) Экспорт

	Маршрут = Справочники.МаршрутыПодписания.ПустаяСсылка();
	НастройкаСодержитСертификаты = Ложь;
	Для каждого СтрокаСертификата Из НастройкаОбмена.СертификатыПодписейОрганизации Цикл
		Если ЗначениеЗаполнено(СтрокаСертификата.СертификатЭП) Тогда
			НастройкаСодержитСертификаты = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если НастройкаСодержитСертификаты Тогда
		МаршрутОбъект = Справочники.МаршрутыПодписания.СоздатьЭлемент();
		МаршрутОбъект.Наименование = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("%1 - %2 (%3)", 
			НастройкаОбмена.Организация, НастройкаОбмена.Банк, ВидДокумента);
		МаршрутОбъект.СхемаПодписания = Перечисления.СхемыПодписанияЭД.ПоПравилам;
		МаршрутОбъект.Организация = НастройкаОбмена.Организация;
		
		// Добавим ключ автоматической настройки по аналогии с загрузкой настроек из банка
		Если ЗаполнитьКлючАвтоматическойНастройки Тогда
			МаршрутОбъект.КлючАвтоматическойНастройки = Справочники.НастройкиОбменСБанками.КлючАвтоматическойНастройки(
				НастройкаОбмена, ВидДокумента);
		КонецЕсли;
		
		ДеревоТребований = ЭлектронноеВзаимодействиеСлужебный.ПустоеДеревоТребованийКПодписанию();
		КорневаяСтрока = ДеревоТребований.Строки.Добавить();
		КорневаяСтрока.Требование = Перечисления.ТребованияКПодписаниюЭД.И;
		Для Каждого СтрокаСертификата Из НастройкаОбмена.СертификатыПодписейОрганизации Цикл
			СтрокаПодписанта = КорневаяСтрока.Строки.Добавить();
			СтрокаПодписанта.Сертификат = СтрокаСертификата.СертификатЭП;
		КонецЦикла;
		
		ЭлектронноеВзаимодействиеСлужебный.ЗаполнитьТаблицуТребованийКПодписаниюПоДереву(МаршрутОбъект.ТаблицаТребований,
			ДеревоТребований);
		МаршрутОбъект.Записать();
		
		Маршрут = МаршрутОбъект.Ссылка;
	КонецЕсли;
	
	Возврат Маршрут;

КонецФункции 

// Формирует для сообщения обмена с банком текстовое представление прогресса подписания.
//
// Параметры:
//  СообщениеОбмена	 - ДокументСсылка.СообщениеОбменСБанками - ссылка на электронный документ.
//  ВесМаршрута		 - Число - максимально возможное количество подписей по маршруту.
// 
// Возвращаемое значение:
//  Строка - текстовое представление прогресса подписания.
//
Функция ПредставлениеПрогрессаПодписания(СообщениеОбмена, ВесМаршрута) Экспорт

	// Определим количество уже установленных подписей
	Если ЗначениеЗаполнено(СообщениеОбмена.Ссылка) Тогда
		ПрисоединенныйФайл = ОбменСБанкамиСлужебныйВызовСервера.ПрисоединенныйФайл(СообщениеОбмена.Ссылка);
		Если ЗначениеЗаполнено(ПрисоединенныйФайл) Тогда
			УстановленоПодписей = ЭлектроннаяПодпись.УстановленныеПодписи(ПрисоединенныйФайл).Количество();
		Иначе
			УстановленоПодписей = 0;
		КонецЕсли;
	Иначе
		УстановленоПодписей = 0;
	КонецЕсли;
	
	// Сформируем представление прогресса подписания
	Если ВесМаршрута = 0 Тогда
		ВсегоПодписей = Макс(1, УстановленоПодписей);
	Иначе
		ВсегоПодписей = ВесМаршрута + УстановленоПодписей;
	КонецЕсли;
	ЯзыкКонфигурации = ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка();
	Разделитель = ?(ЭлектронноеВзаимодействиеСлужебный.КонфигурацияИспользуетНесколькоЯзыков(), "/", НСтр("ru = 'из'", ЯзыкКонфигурации));
	Результат = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = '(%1 %2 %3)'", ЯзыкКонфигурации), 
		УстановленоПодписей, Разделитель, ВсегоПодписей);
		
	Возврат Результат;

КонецФункции

// Возвращает имя поля формы настроек обмена с банком, на котором нужно спозиционироваться при возникновении ошибки
//   проверки настроек.
//
// Параметры:
//  НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - ссылка на настройку обмена.
//  НомерСтроки		- Число - номер строки таблицы исходящих документов, на которой нужно спозиционироваться.
// 
// Возвращаемое значение:
//  Строка - имя поля для передачи в функцию ОбщегоНазначенияКлиентСервер.СообщитьПользователю.
//
Функция ИмяПоляДляОтображенияОшибкиПоМаршруту(НастройкаОбмена, НомерСтроки) Экспорт

	ИмяПоляОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ИсходящиеДокументы[%1].МаршрутПодписания", 
		НомерСтроки - 1);
	
	Возврат ИмяПоляОшибки;

КонецФункции

Функция НайтиСоздатьМаршрутПодписания(НастройкаОбмена, ВидЭД)
	
	УстановитьПривилегированныйРежим(Истина);
	КлючПоиска = Справочники.НастройкиОбменСБанками.КлючАвтоматическойНастройки(НастройкаОбмена, ВидЭД);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	МаршрутыПодписания.Ссылка
	               |ИЗ
	               |	Справочник.МаршрутыПодписания КАК МаршрутыПодписания
	               |ГДЕ
	               |	МаршрутыПодписания.Организация = &Организация
	               |	И МаршрутыПодписания.КлючАвтоматическойНастройки = &КлючАвтоматическойНастройки";
	Запрос.УстановитьПараметр("Организация", НастройкаОбмена.Организация);
	Запрос.УстановитьПараметр("КлючАвтоматическойНастройки", КлючПоиска);
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Следующий() Тогда
		Объект = Результат.Ссылка.ПолучитьОбъект();
		Объект.ТаблицаТребований.Очистить();
		Возврат Объект;
	КонецЕсли;
	
	Возврат Справочники.МаршрутыПодписания.СоздатьЭлемент();
	
КонецФункции

#КонецОбласти

#Область ОбработкаЭлектронногоДокумента

Процедура ЗаполнитьМассивСОтборомПоСтатусу(ТаблицаДанных, МассивОтбора, МассивЗаполнения)
	
	Для Каждого Элемент Из ТаблицаДанных Цикл
		Если МассивОтбора.Найти(Элемент.Статус) <> Неопределено Тогда
			Если МассивЗаполнения.Найти(Элемент.СсылкаНаСообщениеОбмена) = Неопределено Тогда
				МассивЗаполнения.Добавить(Элемент.СсылкаНаСообщениеОбмена);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла
	
КонецПроцедуры

// Определяет имя файла электронного документа.
//
// Параметры:
//  ВидЭД - ПеречислениеСсылка.ВидыЭДОбменСБанками - вид электронного документа;
//  СсылкаНаОбъект - ДокументаСсылка - ссылка на объект информационной базы;
//  НомерДокумента - Строка - номер документа;
//
// Возвращаемое значение:
//  Строка - строковое представление электронного документа.
//
Функция ПредставлениеЭД(ВидЭД, СсылкаНаОбъект, НомерДокумента)
	
	Если ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение
		ИЛИ ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование
		ИЛИ ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПродажуВалюты
		ИЛИ ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПокупкуВалюты
		ИЛИ ВидЭД = Перечисления.ВидыЭДОбменСБанками.РаспоряжениеНаОбязательнуюПродажуВалюты
		ИЛИ ВидЭД = Перечисления.ВидыЭДОбменСБанками.СправкаОПодтверждающихДокументах
		ИЛИ ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты Тогда
		ШаблонПредставленияЭД = НСтр("ru = '%1 № %2 от %3'");
	Иначе
		ШаблонПредставленияЭД = НСтр("ru = '%1 %2 %3'");
	КонецЕсли;
	
	ДатаСтрокой = Формат(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОбъект, "Дата"), "ДЛФ=D");
	
	СтрокаИмениФайла = СтрШаблон(ШаблонПредставленияЭД, ВидЭД, НомерДокумента, ДатаСтрокой);
	
	Возврат СтрокаИмениФайла;
	
КонецФункции

Функция СтруктураПараметровЭД()
	
	ПараметрыЭД = Новый Структура;
	
	ПараметрыЭД.Вставить("ВидЭД", Неопределено);
	ПараметрыЭД.Вставить("Направление", Перечисления.НаправленияЭД.Исходящий);
	ПараметрыЭД.Вставить("Банк", Неопределено);
	ПараметрыЭД.Вставить("Организация", Неопределено);
	ПараметрыЭД.Вставить("НастройкаОбмена", Неопределено);
	ПараметрыЭД.Вставить("УстановленныеПодписи", Новый Массив);
	
	Возврат ПараметрыЭД;
	
КонецФункции

Процедура ПроверитьНаличиеИУдалитьСостояниеДокумента(СсылкаНаОбъект)
	
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерЗаписи = РегистрыСведений.СостоянияОбменСБанками.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.СсылкаНаОбъект = СсылкаНаОбъект;
	МенеджерЗаписи.Прочитать();
	Если МенеджерЗаписи.Выбран() Тогда
		МенеджерЗаписи.Удалить();
	КонецЕсли;
	
КонецПроцедуры

Процедура СоздатьПрисоединенныйФайл(ПакетОбменСБанками, ДвоичныеДанныеФайла)
	
	АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
	Представление = СтроковыеФункцииКлиентСервер.СтрокаЛатиницей(Строка(ПакетОбменСБанками));
	Представление = ОбщегоНазначенияКлиентСервер.ЗаменитьНедопустимыеСимволыВИмениФайла(Представление, "");
	
	ПараметрыФайла = Новый Структура();
	ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
	ПараметрыФайла.Вставить("ВладелецФайлов", ПакетОбменСБанками);
	ПараметрыФайла.Вставить("ИмяБезРасширения", Представление);
	ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
	ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
	
	РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, АдресВоВременномХранилище);
	
КонецПроцедуры

// Производит удаление из массива объектов для которых запрещено формирование новых ЭД.
//
// Параметры:
//  МассивСсылок - Массив - массив ссылок.
//
Процедура УдалитьНедоступныеДляФормированияЭДОбъекты(МассивСсылок)

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СостоянияЭД.СсылкаНаОбъект
	|ИЗ
	|	РегистрСведений.СостоянияОбменСБанками КАК СостоянияЭД
	|ГДЕ
	|	СостоянияЭД.СсылкаНаОбъект В(&МассивСсылок)
	|	И СостоянияЭД.СообщениеОбмена.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыОбменСБанками.Отклонен)
	|	И СостоянияЭД.СообщениеОбмена.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыОбменСБанками.НеСформирован)";
	Запрос.УстановитьПараметр("МассивСсылок", МассивСсылок);
	
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
		Индекс = МассивСсылок.Найти(Результат.СсылкаНаОбъект);
		МассивСсылок.Удалить(Индекс);
		ШаблонСообщения = НСтр("ru='Для документа %1 уже есть актуальный электронный документ.'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, Результат.СсылкаНаОбъект);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЦикла;

КонецПроцедуры

// Процедура определяет, по каким объектам ИБ не надо выполнять действия (подписание, подготовка к отправке).
//
// Параметры:
//  НастройкиОбъектов - соответствие, содержит ссылки на документы ИБ, 
//                     по которым предполагается выполнение каких-либо действий с ЭД.
//  МассивНеобрабатываемыхОбъектов - массив, возвращает в вызывающую процедуру ссылки на объекты ИБ,
//                                  по которым не надо выполнять никаких действий.
//
Процедура ОпределитьНеобрабатываемыеОбъекты(НастройкиОбъектов, МассивНеобрабатываемыхОбъектов)
	
	МассивОтбора = Новый Массив;
	Для Каждого Элемент Из НастройкиОбъектов Цикл
		Если ЗначениеЗаполнено(Элемент.Значение) Тогда
			МассивОтбора.Добавить(Элемент.Ключ);
		КонецЕсли;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СостоянияЭД.СсылкаНаОбъект КАК СсылкаНаОбъект,
	|	СостоянияЭД.СообщениеОбмена КАК СообщениеОбмена,
	|	СостоянияЭД.Состояние КАК Состояние
	|ИЗ
	|	РегистрСведений.СостоянияОбменСБанками КАК СостоянияЭД
	|ГДЕ
	|	СостоянияЭД.СсылкаНаОбъект В(&МассивСсылок)
	|	И СостоянияЭД.Состояние В (ЗНАЧЕНИЕ(Перечисление.СостоянияОбменСБанками.ПлатежИсполнен), ЗНАЧЕНИЕ(Перечисление.СостоянияОбменСБанками.ОжидаетсяИзвещениеОПолучении), ЗНАЧЕНИЕ(Перечисление.СостоянияОбменСБанками.ОжидаетсяИсполнение))";
	
	Запрос.УстановитьПараметр("МассивСсылок", МассивОтбора);
	
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
		МассивНеобрабатываемыхОбъектов.Добавить(Результат.СообщениеОбмена);
		
		ТекстСообщения = НСтр("ru = 'Обработка %1.
				|Не требуется выполнения действий с электронным документом.'");
		ТекстСообщения = СтрШаблон(ТекстСообщения, Результат.СсылкаНаОбъект);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Результат.СсылкаНаОбъект);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область НастройкиОбмена

// Получает текст запроса по настройкам обмена.
//
// Возвращаемое значение:
//  ТекстЗапроса - текст запроса.
//
Процедура ПолучитьТекстЗапросаПараметровОбменаПоНастройкеОбмена(ТекстЗапроса)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ТЧ_НастройкиОбмена.Ссылка.Организация КАК Организация,
	|	ТЧ_НастройкиОбмена.Ссылка.Банк КАК Банк,
	|	ТЧ_НастройкиОбмена.ИсходящийДокумент КАК ВидЭД,
	|	ТЧ_НастройкиОбмена.ИспользоватьЭП КАК Подписывать,
	|	ТЧ_НастройкиОбмена.Ссылка.СертификатБанка КАК СертификатБанка,
	|	ТЧ_НастройкиОбмена.Ссылка.РесурсВходящихДокументов КАК РесурсВходящихДокументов,
	|	ТЧ_НастройкиОбмена.Ссылка.РесурсИсходящихДокументов КАК РесурсИсходящихДокументов,
	|	ТЧ_НастройкиОбмена.Ссылка.ИдентификаторОрганизации КАК ИдентификаторОрганизации,
	|	ТЧ_НастройкиОбмена.Ссылка КАК НастройкаОбмена,
	|	ТЧ_НастройкиОбмена.Ссылка.ПрограммаБанка КАК ПрограммаБанка,
	|	ВЫБОР
	|		КОГДА ТЧ_НастройкиОбмена.Ссылка.Недействительна
	|				ИЛИ ТЧ_НастройкиОбмена.Ссылка.ПометкаУдаления
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК НастройкаОбменаДействует,
	|	ТЧ_НастройкиОбмена.Ссылка.АутентификацияПоСертификату
	|ПОМЕСТИТЬ ВТ_ТЧ_НастройкиОбмена
	|ИЗ
	|	Справочник.НастройкиОбменСБанками.ИсходящиеДокументы КАК ТЧ_НастройкиОбмена
	|ГДЕ
	|	ТЧ_НастройкиОбмена.Ссылка = &НастройкаОбмена
	|	И ТЧ_НастройкиОбмена.ИсходящийДокумент = &ВидЭД
	|	И ВЫБОР
	|			КОГДА &ТолькоДействующиеНастройкиОбмена
	|				ТОГДА НЕ ТЧ_НастройкиОбмена.Ссылка.ПометкаУдаления
	|						И НЕ ТЧ_НастройкиОбмена.Ссылка.Недействительна
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СертификатыНастройкиОбмена.СертификатЭП КАК Ссылка,
	|	ВидыЭД.ВидЭД КАК ВидДокумента,
	|	ЛОЖЬ КАК ЗапомнитьПарольКСертификату,
	|	ЛОЖЬ КАК ПарольПолучен,
	|	НЕОПРЕДЕЛЕНО КАК ПарольПользователя
	|ПОМЕСТИТЬ ВТ_Сертификаты
	|ИЗ
	|	Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК СертификатыНастройкиОбмена
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПодписываемыеВидыЭД КАК ВидыЭД
	|		ПО (ВидыЭД.СертификатЭП = СертификатыНастройкиОбмена.СертификатЭП)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
	|		ПО СертификатыНастройкиОбмена.СертификатЭП = Сертификаты.Ссылка
	|ГДЕ
	|	НЕ СертификатыНастройкиОбмена.СертификатЭП.ПометкаУдаления
	|	И НЕ СертификатыНастройкиОбмена.СертификатЭП.Отозван
	|	И ВидыЭД.ВидЭД = &ВидЭД
	|	И &ПроверкаПользователя
	|	И ВидыЭД.Использовать
	|	И СертификатыНастройкиОбмена.Ссылка = &НастройкаОбмена
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТЧ_НастройкиОбмена.Организация,
	|	ВТ_ТЧ_НастройкиОбмена.Банк,
	|	ВТ_ТЧ_НастройкиОбмена.ВидЭД,
	|	ВТ_ТЧ_НастройкиОбмена.Подписывать КАК Подписывать,
	|	ВТ_ТЧ_НастройкиОбмена.СертификатБанка,
	|	ВТ_ТЧ_НастройкиОбмена.РесурсВходящихДокументов КАК РесурсВходящихДокументов,
	|	ВТ_ТЧ_НастройкиОбмена.РесурсИсходящихДокументов КАК РесурсИсходящихДокументов,
	|	ВТ_ТЧ_НастройкиОбмена.ИдентификаторОрганизации КАК ИдентификаторОрганизации,
	|	ВТ_ТЧ_НастройкиОбмена.НастройкаОбмена КАК НастройкаОбмена,
	|	ВЫБОР
	|		КОГДА ВТ_Сертификаты.Ссылка ЕСТЬ NULL 
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования.ПустаяСсылка)
	|		ИНАЧЕ ВТ_Сертификаты.Ссылка
	|	КОНЕЦ КАК СертификатОрганизацииДляПодписи,
	|	ЕСТЬNULL(ВТ_Сертификаты.ЗапомнитьПарольКСертификату, ЛОЖЬ) КАК ЗапомнитьПарольКСертификату,
	|	ЕСТЬNULL(ВТ_Сертификаты.ЗапомнитьПарольКСертификату, ЛОЖЬ) КАК ПарольПолучен,
	|	ВТ_Сертификаты.ПарольПользователя,
	|	ВТ_ТЧ_НастройкиОбмена.ПрограммаБанка,
	|	ВТ_ТЧ_НастройкиОбмена.НастройкаОбменаДействует,
	|	ВТ_ТЧ_НастройкиОбмена.АутентификацияПоСертификату
	|ИЗ
	|	ВТ_ТЧ_НастройкиОбмена КАК ВТ_ТЧ_НастройкиОбмена
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Сертификаты КАК ВТ_Сертификаты
	|		ПО ВТ_ТЧ_НастройкиОбмена.ВидЭД = ВТ_Сертификаты.ВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НастройкиОбменаСертификатыПодписейОрганизации.СертификатЭП.Отпечаток КАК Отпечаток,
	|	НастройкиОбменаСертификатыПодписейОрганизации.Ссылка КАК НастройкаОбмена
	|ИЗ
	|	Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификатыПодписейОрганизации
	|ГДЕ
	|	НЕ НастройкиОбменаСертификатыПодписейОрганизации.Ссылка.ПометкаУдаления
	|	И НастройкиОбменаСертификатыПодписейОрганизации.Ссылка = &НастройкаОбмена";
	
КонецПроцедуры

Процедура СообщитьОбОтсутствииНастройкиОбмена(ПараметрыЭД, Источник)
	
	ШаблонСообщения = НСтр("ru = 'Обработка %1.
							|Операция не выполнена.
							|Необходимо создать ""Настройку обмена с сервисом 1С:ДиректБанк"" с реквизитами:'");
	
	Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Источник);
	
	ТаблицаПараметров = Новый ТаблицаЗначений();
	ТаблицаПараметров.Колонки.Добавить("Ключ");
	ТаблицаПараметров.Колонки.Добавить("Значение");
	ТаблицаПараметров.Колонки.Добавить("Порядок");
	
	Для Каждого ТекПараметр Из ПараметрыЭД Цикл
		
		Порядок = 0;
		Если НРег(ТекПараметр.Ключ) = НРег("Организация") Тогда
			Представление = ТекПараметр.Ключ;
			Порядок = 1;
		ИначеЕсли НРег(ТекПараметр.Ключ) = НРег("Банк") Тогда
			Представление = ТекПараметр.Ключ;
			Порядок = 2;
		ИначеЕсли НРег(ТекПараметр.Ключ) = НРег("ВидЭД") Тогда
			Представление = НСтр("ru = 'Вид электронного документа'");;
			Порядок = 3;
		КонецЕсли;
		
		Если Порядок > 0 Тогда
			СтрокаПараметров = ТаблицаПараметров.Добавить();
			СтрокаПараметров.Ключ = Представление;
			СтрокаПараметров.Значение = ТекПараметр.Значение;
			СтрокаПараметров.Порядок = Порядок;
		КонецЕсли;
	КонецЦикла;
	
	ТаблицаПараметров.Сортировать("Порядок");
	Для Каждого СтрокаПараметров Из ТаблицаПараметров Цикл
		Если ЗначениеЗаполнено(СтрокаПараметров.Значение) Тогда
			Текст = Текст + Символы.ПС + НСтр("ru = '<%1>: %2'");
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Текст, СтрокаПараметров.Ключ, СтрокаПараметров.Значение);
		КонецЕсли;
	КонецЦикла;
	
	ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
	
КонецПроцедуры

// Обновляет дату получения документа текущим числом.
//
// Параметры:
//    НастройкаОбмена - СправочникСсылка.НастройкиОбменСБанками - ссылка на текущую настройку обмена с банками.
//
Процедура СохранитьПараметрыОбмена(НастройкаОбмена)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ПрограммаБанка = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ПрограммаБанка");
	
	Менеджер = РегистрыСведений.ПараметрыОбменСБанками.СоздатьМенеджерЗаписи();
	Менеджер.НастройкаОбмена = НастройкаОбмена;
	Менеджер.Прочитать();
	Менеджер.НастройкаОбмена = НастройкаОбмена;
	Если ПрограммаБанка <> Перечисления.ПрограммыБанка.СбербанкОнлайн Тогда
		Менеджер.ПоследняяДатаПолученияЭД = НачалоДня(ТекущаяДатаСеанса());
	КонецЕсли;
	Менеджер.Записать();
	
КонецПроцедуры

// Функция возвращает соответствие настройке обмена - структуры данных сертификата,
// содержащую ссылку на сертификат и его доп.реквизиты (запомнить пароль, пароль пользователя, маркер расшифрованный/зашифрованный).
// 
// Параметры:
//  МассивНастроекОбмена               - Массив    - содержит ссылки на настройки, по которым требуется определить сертификаты;
//  СтМассивовСтруктурСертификатов - Структура - содержит структуру со свойствами:
//    * МассивСтруктурСертификатовСервер - Массив - массив структур сертификатов личного хранилища с сервера.
//    * МассивСтруктурСертификатовКлиент - Массив - массив структур сертификатов личного хранилища с клиента.
//  СоотвСертификатовИПаролей      - Фиксированное соответствие:
//    * Ключ     - СправочникСсылка.СертификатыЭП - сертификат авторизации.
//    * Значение - Строка - пароль к сертификату.
//
// Возвращаемое значение:
//  Соответствие: ключ - настройка обмена, значение - структура параметров сертификата ЭП
//    ("СертификатДляАвторизации, ПарольСертификата, ИдентификаторСессии, МаркерЗашифрованный").
//
Функция СоотвНастроекОбменаИСоответствийСертификатовИПараметровДляАвторизацииСервер(Знач МассивНастроекОбмена = Неопределено, Знач СтМассивовСтруктурСертификатов = Неопределено, Знач СоотвСертификатовИПаролей = Неопределено)
	
	Результат = ПараметрыАвторизацииНаСервереБанка(
		МассивНастроекОбмена, СтМассивовСтруктурСертификатов, СоотвСертификатовИПаролей);
	
	СоотвНастроекОбмена = Новый Соответствие;
	СоотвНастроекОбменаИМассиваСертификатовАвторизации = Неопределено;
	СоотвСертификатовИИхСтруктур = Неопределено;
	Если Результат.Свойство("СоотвНастроекОбменаИМассиваСертификатовАвторизации", СоотвНастроекОбменаИМассиваСертификатовАвторизации)
		И Результат.Свойство("СоотвСертификатовИИхСтруктур", СоотвСертификатовИИхСтруктур)
		И ТипЗнч(СоотвНастроекОбменаИМассиваСертификатовАвторизации) = Тип("Соответствие")
		И ТипЗнч(СоотвСертификатовИИхСтруктур) = Тип("Соответствие") Тогда
		// В СоотвНастроекОбменаИМассиваСертификатовАвторизации - Ключ - Настройка обмена, Значение - Массив сертификатов
		// по данной настройке. Функция должна вернуть Соответствие, в котором Ключ - настройка обмена,
		// Значение - Соответствие сертификатов и их параметров.
		Для Каждого Элемент Из СоотвНастроекОбменаИМассиваСертификатовАвторизации Цикл
			
			Соответствие = Новый Соответствие;
			МассивСертификатов = Элемент.Значение;
			Для Каждого Сертификат Из МассивСертификатов Цикл
				
				Структура = СоотвСертификатовИИхСтруктур.Получить(Сертификат);
				Если ЗначениеЗаполнено(Структура) И Структура.ПарольПолучен Тогда
					// Авторизоваться на сервере можно любым указанным в настройке обмена сертификатом,
					// поэтому, если есть несколько доступных для авторизации сертификатов и среди них есть хотя бы
					// один с сохраненным (в сертификате или сеансе) паролем, то вернем именно его, чтобы не открывать
					// диалог выбора сертификата.
					Соответствие = Новый Соответствие;
					Соответствие.Вставить(Сертификат, Структура);
					Прервать;
				КонецЕсли;
				Соответствие.Вставить(Сертификат, Структура);
			КонецЦикла;
			СоотвНастроекОбмена.Вставить(Элемент.Ключ, Соответствие);
		КонецЦикла;
	КонецЕсли;
	
	Возврат СоотвНастроекОбмена;
	
КонецФункции

// Получает текст запроса по настройкам обмена
//
// Параметры:
//  ТекстЗапроса - текст запроса.
//
Процедура ПолучитьТекстЗапросаПараметровОбмена(ТекстЗапроса)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ТЧ_НастройкиОбмена.Ссылка.Организация КАК Организация,
		|	ТЧ_НастройкиОбмена.Ссылка.Банк КАК Банк,
		|	ТЧ_НастройкиОбмена.ИсходящийДокумент КАК ВидЭД,
		|	ТЧ_НастройкиОбмена.ИспользоватьЭП КАК Подписывать,
		|	ТЧ_НастройкиОбмена.Ссылка.СертификатБанка КАК СертификатБанка,
		|	ТЧ_НастройкиОбмена.Ссылка.РесурсВходящихДокументов КАК РесурсВходящихДокументов,
		|	ТЧ_НастройкиОбмена.Ссылка.РесурсИсходящихДокументов КАК РесурсИсходящихДокументов,
		|	ТЧ_НастройкиОбмена.Ссылка.ИдентификаторОрганизации КАК ИдентификаторОрганизации,
		|	ТЧ_НастройкиОбмена.Ссылка КАК НастройкаОбмена,
		|	ТЧ_НастройкиОбмена.Ссылка.ПрограммаБанка КАК ПрограммаБанка,
		|	ВЫБОР
		|		КОГДА ТЧ_НастройкиОбмена.Ссылка.Недействительна
		|				ИЛИ ТЧ_НастройкиОбмена.Ссылка.ПометкаУдаления
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК НастройкаОбменаДействует,
		|	ТЧ_НастройкиОбмена.Ссылка.АутентификацияПоСертификату
		|ПОМЕСТИТЬ ВТ_ТЧ_НастройкиОбмена
		|ИЗ
		|	Справочник.НастройкиОбменСБанками.ИсходящиеДокументы КАК ТЧ_НастройкиОбмена
		|ГДЕ
		|	ВЫБОР
		|			КОГДА &ТолькоДействующиеНастройкиОбмена
		|				ТОГДА НЕ ТЧ_НастройкиОбмена.Ссылка.ПометкаУдаления
		|						И НЕ ТЧ_НастройкиОбмена.Ссылка.Недействительна
		|			ИНАЧЕ ИСТИНА
		|		КОНЕЦ
		|	И ВЫБОР
		|			КОГДА &ВидЭД = НЕОПРЕДЕЛЕНО
		|				ТОГДА ТЧ_НастройкиОбмена.Ссылка.Организация = &Организация
		|						И ТЧ_НастройкиОбмена.Ссылка.Банк = &Банк
		|			КОГДА ТЧ_НастройкиОбмена.Ссылка.Организация = &Организация
		|					И ТЧ_НастройкиОбмена.Ссылка.Банк = &Банк
		|					И ТЧ_НастройкиОбмена.ИсходящийДокумент = &ВидЭД
		|				ТОГДА ТЧ_НастройкиОбмена.Формировать
		|		КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НастройкиОбменаСертификаты.СертификатЭП КАК СертификатЭП
		|ПОМЕСТИТЬ ВТ_СертификатыИзНастроекОбмена
		|ИЗ
		|	ВТ_ТЧ_НастройкиОбмена КАК ВТ_ТЧ_НастройкиОбмена
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификаты
		|		ПО ВТ_ТЧ_НастройкиОбмена.НастройкаОбмена = НастройкиОбменаСертификаты.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Сертификаты.Ссылка КАК Ссылка,
		|	ВидыЭДЭП.ВидЭД КАК ВидДокумента,
		|	Сертификаты.Организация КАК Организация,
		|	ЛОЖЬ КАК ПарольПолучен,
		|	НЕОПРЕДЕЛЕНО КАК ПарольСертификата
		|ПОМЕСТИТЬ ВТ_Сертификаты
		|ИЗ
		|	Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПодписываемыеВидыЭД КАК ВидыЭДЭП
		|		ПО (ВидыЭДЭП.СертификатЭП = Сертификаты.Ссылка)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_СертификатыИзНастроекОбмена КАК СертификатыИзНастроекОбмена
		|		ПО Сертификаты.Ссылка = СертификатыИзНастроекОбмена.СертификатЭП
		|ГДЕ
		|	НЕ Сертификаты.ПометкаУдаления
		|	И НЕ Сертификаты.Отозван
		|	И ВЫБОР
		|			КОГДА &ВидЭД = НЕОПРЕДЕЛЕНО
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВидыЭДЭП.ВидЭД = &ВидЭД
		|		КОНЕЦ
		|	И &ПроверкаПользователя
		|	И ВидыЭДЭП.Использовать
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ТЧ_НастройкиОбмена.Организация,
		|	ВТ_ТЧ_НастройкиОбмена.Банк,
		|	ВТ_ТЧ_НастройкиОбмена.ВидЭД,
		|	ВТ_ТЧ_НастройкиОбмена.Подписывать КАК Подписывать,
		|	ВТ_ТЧ_НастройкиОбмена.СертификатБанка,
		|	ВТ_ТЧ_НастройкиОбмена.РесурсВходящихДокументов,
		|	ВТ_ТЧ_НастройкиОбмена.РесурсИсходящихДокументов,
		|	ВТ_ТЧ_НастройкиОбмена.ИдентификаторОрганизации,
		|	ВТ_ТЧ_НастройкиОбмена.НастройкаОбмена,
		|	ВЫБОР
		|		КОГДА ВТ_Сертификаты.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования.ПустаяСсылка)
		|		ИНАЧЕ ВТ_Сертификаты.Ссылка
		|	КОНЕЦ КАК СертификатОрганизацииДляПодписи,
		|	ЛОЖЬ КАК ПарольПолучен,
		|	ВТ_Сертификаты.ПарольСертификата,
		|	ВТ_ТЧ_НастройкиОбмена.ПрограммаБанка,
		|	ВТ_ТЧ_НастройкиОбмена.НастройкаОбменаДействует,
		|	ВТ_ТЧ_НастройкиОбмена.АутентификацияПоСертификату
		|ИЗ
		|	ВТ_ТЧ_НастройкиОбмена КАК ВТ_ТЧ_НастройкиОбмена
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Сертификаты КАК ВТ_Сертификаты
		|		ПО ВТ_ТЧ_НастройкиОбмена.ВидЭД = ВТ_Сертификаты.ВидДокумента
		|			И ВТ_ТЧ_НастройкиОбмена.Организация = ВТ_Сертификаты.Организация
		|ГДЕ
		|	ВЫБОР
		|			КОГДА &ВидЭД = НЕОПРЕДЕЛЕНО
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВТ_ТЧ_НастройкиОбмена.ВидЭД = &ВидЭД
		|		КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	НастройкиОбменСБанкамиСертификатыПодписейОрганизации.Ссылка КАК НастройкаОбмена,
		|	НастройкиОбменСБанкамиСертификатыПодписейОрганизации.СертификатЭП.Отпечаток КАК Отпечаток
		|ИЗ
		|	Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменСБанкамиСертификатыПодписейОрганизации
		|ГДЕ
		|	НЕ НастройкиОбменСБанкамиСертификатыПодписейОрганизации.Ссылка.ПометкаУдаления
		|	И НЕ НастройкиОбменСБанкамиСертификатыПодписейОрганизации.Ссылка.Недействительна";
	
КонецПроцедуры

Функция ОпределитьНастройкиОбменаЭД(СтруктураПараметров, МассивОтпечатковСертификатов = Неопределено, ФлагДействующиеНастройкиОбмена = Истина)
	
	УстановитьПривилегированныйРежим(Истина);
	
	НастройкиОбменаЭД = Неопределено;
	
	ВидЭД = "";
	Банк = "";
	Если СтруктураПараметров.Свойство("ВидЭД", ВидЭД) И СтруктураПараметров.Свойство("Банк", Банк)
		И ЗначениеЗаполнено(ВидЭД) И ЗначениеЗаполнено(Банк) Тогда
		
		Запрос  = Новый Запрос;
		Запрос.УстановитьПараметр("ВидЭД", ВидЭД);
		Запрос.УстановитьПараметр("Банк", Банк);
		Запрос.УстановитьПараметр("ТолькоДействующиеНастройкиОбмена",  ФлагДействующиеНастройкиОбмена);
		
		НастройкаОбмена = "";
		Организация = "";
		Если СтруктураПараметров.Свойство("НастройкаОбмена", НастройкаОбмена) И ЗначениеЗаполнено(НастройкаОбмена) Тогда
			Запрос.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
			ПолучитьТекстЗапросаПараметровОбменаПоНастройкеОбмена(Запрос.Текст);
			Индекс = 2;
		ИначеЕсли СтруктураПараметров.Свойство("Организация", Организация) И ЗначениеЗаполнено(Организация) Тогда
			Запрос.УстановитьПараметр("Организация", Организация);
			ПолучитьТекстЗапросаПараметровОбмена(Запрос.Текст);
			Индекс = 3;
		КонецЕсли;
		
		Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПроверкаПользователя", "ИСТИНА");
		Иначе
			Запрос.Текст = СтрЗаменить(	Запрос.Текст, "&ПроверкаПользователя",
				"Сертификаты.Пользователь В (&Пользователь, ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка), &ПользовательНеУказан)");
			Запрос.УстановитьПараметр("ПользовательНеУказан", Пользователи.СсылкаНеуказанногоПользователя());
			Запрос.УстановитьПараметр("Пользователь",  Пользователи.АвторизованныйПользователь());
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Запрос.Текст) Тогда
			
			РезультатЗапроса = Запрос.ВыполнитьПакет();
			ТЗ = РезультатЗапроса[Индекс].Выгрузить();
			ТЗСертификатовНеобходимыхПодписей = РезультатЗапроса[Индекс + 1].Выгрузить();
			
			Если Не ТЗ.Количество() = 0 Тогда
				ТекущаяНастройка = ТЗ[0];
				
				НастройкиОбменаЭД = Новый Структура;
				НастройкиОбменаЭД.Вставить("СертификатДоступен", Ложь);
				// Если с клиента были переданы установленные сертификаты криптографии,
				// то надо выбрать настройку с этими сертификатами.
				ДоступныеСертификаты = Новый Массив;
				НайденПодходящийСертификат = Ложь;
				
				Если МассивОтпечатковСертификатов = Неопределено Тогда
					МассивОтпечатковСертификатов = Новый Массив;
				КонецЕсли;
				Для Каждого СтрокаТЗ Из ТЗ Цикл
					Если СтрокаТЗ.Подписывать Тогда
						ПараметрыОтбора = Новый Структура(
							"НастройкаОбмена, Отпечаток", СтрокаТЗ.НастройкаОбмена, СтрокаТЗ.СертификатОрганизацииДляПодписи.Отпечаток);
						МассивСтрок = ТЗСертификатовНеобходимыхПодписей.НайтиСтроки(ПараметрыОтбора);
						Для Каждого Элемент Из МассивСтрок Цикл
							Если (МассивОтпечатковСертификатов.Найти(Элемент.Отпечаток) <> Неопределено
								ИЛИ ТекущаяНастройка.ПрограммаБанка = Перечисления.ПрограммыБанка.СбербанкОнлайн
								ИЛИ ТекущаяНастройка.ПрограммаБанка = Перечисления.ПрограммыБанка.ОбменЧерезВК)
								И СтруктураПараметров.УстановленныеПодписи.Найти(СтрокаТЗ.СертификатОрганизацииДляПодписи.Отпечаток) = Неопределено Тогда
								
								Если Не НайденПодходящийСертификат Тогда
									ТекущаяНастройка = СтрокаТЗ;
									НастройкиОбменаЭД.Вставить("СертификатДоступен", Истина);
									НайденПодходящийСертификат = Истина;
								КонецЕсли;
								ДоступныеСертификаты.Добавить(СтрокаТЗ.СертификатОрганизацииДляПодписи);
								
							КонецЕсли
						КонецЦикла;
					КонецЕсли;
				КонецЦикла;
			
				Для Каждого ТекКолонка Из ТЗ.Колонки Цикл
					НастройкиОбменаЭД.Вставить(ТекКолонка.Имя, ТекущаяНастройка[ТекКолонка.Имя]);
				КонецЦикла;
				
				НастройкиОбменаЭД.Вставить("ДоступныеСертификаты", ДоступныеСертификаты);
				
				Если НастройкиОбменаЭД.Свойство("Подписывать") Тогда
					ФлагПодписи = НастройкиОбменаЭД.Подписывать;
				Иначе
					ФлагПодписи = Ложь;
				КонецЕсли;
				НастройкиОбменаЭД.Вставить("Подписывать", ФлагПодписи);
			КонецЕсли;
		КонецЕсли;
	Иначе
		// Если заполнены не все обязательные реквизиты, то нельзя утверждать, что нет настройки обмена.
		НастройкиОбменаЭД = "";
	КонецЕсли;
	
	Возврат НастройкиОбменаЭД;
	
КонецФункции

// Функция получает данные по сертификатам, разрешенным для использования при подписании ЭД и авторизации
// на сервере банка. Поиск сертификатов выполняется как пересечение массивов сертификатов установленных в
// личном хранилище (клиента либо сервера, в зависимости от настроек в 1с), с сертификатами импортированными в 1с.
// При необходимости, выборка может быть ограничена массивом настроек обмена, по которым
// требуется определить параметры сертификатов.
//
// Параметры:
//  СтМассивовСтруктурСертификатов - структура массивов - может содержать 2 элемента: МассивСтруктурСертификатовСервер
//    и МассивСтруктурСертификатовКлиент, соответственно массив структур сертификатов личного хранилища с сервера и
//    то же самое с клиента;
//
// Возвращаемое значение:
//  Структура соответствий - пустая, либо содержит 3 элемента:
//    СоотвНастроекОбменаИСертификатовПодписи;
//    СоотвНастроекОбменаИСертификатовАвторизации;
//    СоотвСертификатовИИхСтруктур.
//
Функция ПараметрыАвторизацииНаСервереБанка(МассивНастроекОбмена, СтМассивовСтруктурСертификатов, СоотвСертификатовИПаролей)
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураСоответствий = Новый Структура;
	
	ВыполнятьКриптооперацииНаСервере = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ВыполнятьКриптооперацииНаСервере();
	// Если используется отложенная отправка, то искать сертификаты авторизации не надо.
	МассивОтпечатковКлиент = Новый Массив;
	МассивОтпечатковСервер = Новый Массив;
	
	ИспользоватьЭП = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ЗначениеФункциональнойОпции(
		"ИспользоватьЭлектронныеПодписиЭД");
	Если ТипЗнч(СтМассивовСтруктурСертификатов) = Тип("Структура") Тогда
		СтМассивовСтруктурСертификатов.Свойство("МассивОтпечатковСервер", МассивОтпечатковСервер);
		СтМассивовСтруктурСертификатов.Свойство("МассивОтпечатковКлиент", МассивОтпечатковКлиент);
		Если ВыполнятьКриптооперацииНаСервере И НЕ ЗначениеЗаполнено(МассивОтпечатковСервер) И ИспользоватьЭП Тогда
			МассивОтпечатковСервер = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.МассивОтпечатковСертификатов(Ложь);
		КонецЕсли;
	КонецЕсли;
	
	МассивОтпечатковСервер = ?(ЗначениеЗаполнено(МассивОтпечатковСервер), МассивОтпечатковСервер, Новый Массив);
	МассивОтпечатковКлиент = ?(ЗначениеЗаполнено(МассивОтпечатковКлиент), МассивОтпечатковКлиент, Новый Массив);
	
	МассивОтпечатковДляАвторизации = Новый Массив;
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивОтпечатковДляАвторизации, МассивОтпечатковКлиент);
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивОтпечатковДляАвторизации, МассивОтпечатковСервер);
	
	Если (МассивОтпечатковСервер <> Неопределено И МассивОтпечатковСервер.Количество())
		ИЛИ (МассивОтпечатковКлиент <> Неопределено И МассивОтпечатковКлиент.Количество()) Тогда
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	ТаблицаСертификатов.ПарольСертификата КАК ПарольСертификата,
		|	ТаблицаСертификатов.Сертификат КАК Сертификат
		|ПОМЕСТИТЬ ВТ_ПолученныеПароли
		|ИЗ
		|	&ТаблицаСертификатов КАК ТаблицаСертификатов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Сертификаты.Ссылка КАК СертификатПодписи,
		|	Сертификаты.Отпечаток КАК Отпечаток,
		|	Сертификаты.Отозван КАК Отозван,
		|	Сертификаты.ДанныеСертификата КАК ДанныеСертификата,
		|	Сертификаты.ПользовательОповещенОСрокеДействия КАК ОповещенОСрокеДействия,
		|	Сертификаты.ДействителенДо КАК ДатаОкончания,
		|	ТаблицаСертификатов.ПарольСертификата КАК ПарольСертификата,
		|	ТаблицаСертификатов.Сертификат КАК Сертификат,
		|	ВЫБОР
		|		КОГДА ТаблицаСертификатов.Сертификат ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ПарольПолучен
		|ПОМЕСТИТЬ ТаблицаСертификатов
		|ИЗ
		|	Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК Сертификаты
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ПолученныеПароли КАК ТаблицаСертификатов
		|		ПО (ТаблицаСертификатов.Сертификат = Сертификаты.Ссылка)
		|ГДЕ
		|	НЕ Сертификаты.ПометкаУдаления
		|	И НЕ Сертификаты.Отозван
		|	И &ПроверкаПользователя
		|	И Сертификаты.Отпечаток В(&МассивОтпечатковДляАвторизации)
		|	И ВЫБОР
		|			КОГДА Сертификаты.ДействителенДо = ДАТАВРЕМЯ(1, 1, 1)
		|				ТОГДА ИСТИНА
		|			КОГДА РАЗНОСТЬДАТ(&ТекущаяДата, Сертификаты.ДействителенДо, ДЕНЬ) > 0
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ЛОЖЬ
		|		КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НастройкиОбмена.Ссылка КАК НастройкаОбмена,
		|	НастройкиОбмена.ИдентификаторОрганизации КАК ИдентификаторОрганизации,
		|	НастройкиОбмена.ПрограммаБанка КАК ПрограммаБанка,
		|	Сертификаты.СертификатПодписи КАК СертификатПодписи,
		|	Сертификаты.ПарольСертификата КАК ПарольСертификата,
		|	ЕСТЬNULL(Сертификаты.ПарольПолучен, ЛОЖЬ) КАК ПарольПолучен,
		|	Сертификаты.Отпечаток КАК Отпечаток,
		|	Сертификаты.Отозван КАК Отозван,
		|	Сертификаты.ДанныеСертификата КАК ДанныеСертификата,
		|	Сертификаты.ОповещенОСрокеДействия КАК ОповещенОСрокеДействия,
		|	Сертификаты.ДатаОкончания КАК ДатаОкончания
		|ИЗ
		|	Справочник.НастройкиОбменСБанками КАК НастройкиОбмена
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НастройкиОбменСБанками.СертификатыПодписейОрганизации КАК НастройкиОбменаСертификаты
		|		ПО (НастройкиОбменаСертификаты.Ссылка = НастройкиОбмена.Ссылка)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаСертификатов КАК Сертификаты
		|		ПО (НастройкиОбменаСертификаты.СертификатЭП = Сертификаты.СертификатПодписи)
		|ГДЕ
		|	НЕ НастройкиОбмена.ПометкаУдаления
		|	И НастройкиОбмена.Ссылка В(&МассивНастроекОбмена)
		|
		|УПОРЯДОЧИТЬ ПО
		|	Сертификаты.ПарольПолучен УБЫВ";
		
		Запрос.УстановитьПараметр("МассивОтпечатковДляАвторизации", МассивОтпечатковДляАвторизации);
		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
		
		Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПроверкаПользователя", "ИСТИНА");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПроверкаПользователя",
				"Сертификаты.Пользователь В (&ПустойПользователь, &ТекущийПользователь, &ПользовательНеУказан)");
			Запрос.УстановитьПараметр("ПустойПользователь",  Справочники.Пользователи.ПустаяСсылка());
			Запрос.УстановитьПараметр("ПользовательНеУказан", Пользователи.СсылкаНеуказанногоПользователя());
			Запрос.УстановитьПараметр("ТекущийПользователь", Пользователи.АвторизованныйПользователь());
		КонецЕсли;

		
		СертификатыСПаролями = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ПарольКСертификату(,МассивОтпечатковДляАвторизации);
		ТЗ_Сертификатов = Новый ТаблицаЗначений;
		ТЗ_Сертификатов.Колонки.Добавить("Сертификат",
			Новый ОписаниеТипов("СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования"));
		ТЗ_Сертификатов.Колонки.Добавить("ПарольСертификата", Новый ОписаниеТипов("Строка"));
		Для Каждого Элемент Из СертификатыСПаролями Цикл
			НоваяСтрока = ТЗ_Сертификатов.Добавить();
			НоваяСтрока.Сертификат = Элемент.Ключ;
			НоваяСтрока.ПарольСертификата = Элемент.Значение;
		КонецЦикла;
		Запрос.УстановитьПараметр("ТаблицаСертификатов", ТЗ_Сертификатов);
		Если НЕ ЗначениеЗаполнено(МассивНастроекОбмена) Тогда
			МассивНастроекОбмена = Новый Массив;
		КонецЕсли;
		Если МассивНастроекОбмена.Количество() > 0 Тогда
			Запрос.УстановитьПараметр("МассивНастроекОбмена", МассивНастроекОбмена);
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "И НастройкиОбмена.Ссылка В(&МассивНастроекОбмена)", "");
		КонецЕсли;
		Запрос.Текст = ТекстЗапроса;
		Выборка = Запрос.Выполнить().Выбрать();
		
		СоотвНастроекОбменаИМассиваСертификатовАвторизации = Новый Соответствие;
		СоотвСертификатовИИхСтруктур = Новый Соответствие;
		
		ТекущаяНастройкаОбмена = Неопределено;
		Пока Выборка.Следующий() Цикл
			Если ТекущаяНастройкаОбмена <> Выборка.НастройкаОбмена Тогда
				МассивСертификатов = Новый Массив;
				ТекущаяНастройкаОбмена = Выборка.НастройкаОбмена;
			КонецЕсли;
			МассивСертификатов.Добавить(Выборка.СертификатПодписи);
			
			Если СоотвНастроекОбменаИМассиваСертификатовАвторизации.Получить(ТекущаяНастройкаОбмена) = Неопределено Тогда
				СоотвНастроекОбменаИМассиваСертификатовАвторизации.Вставить(ТекущаяНастройкаОбмена, МассивСертификатов);
			КонецЕсли;
			СтруктураСертификата = Новый Структура("СертификатПодписи, ПарольПолучен, ПарольСертификата, Отпечаток, Отозван,
													|ДанныеСертификата, ОповещенОСрокеДействия, ДатаОкончания, ПрограммаБанка");
			ЗаполнитьЗначенияСвойств(СтруктураСертификата, Выборка);
		
			ПарольПолучен = Выборка.ПарольПолучен;
			СтруктураСертификата.Вставить("ПарольСертификата", Выборка.ПарольСертификата);
			СтруктураСертификата.Вставить("ПарольПолучен", ПарольПолучен);
		
			СоотвСертификатовИИхСтруктур.Вставить(Выборка.СертификатПодписи, СтруктураСертификата);
			
		КонецЦикла;
		
		СтруктураСоответствий.Вставить("СоотвНастроекОбменаИМассиваСертификатовАвторизации", СоотвНастроекОбменаИМассиваСертификатовАвторизации);
		СтруктураСоответствий.Вставить("СоотвСертификатовИИхСтруктур", СоотвСертификатовИИхСтруктур);
	КонецЕсли;
	
	Возврат СтруктураСоответствий;
	
КонецФункции

#КонецОбласти

#Область АсинхронныйОбмен

Процедура ЗапроситьВыпискуБанкаАсинхронно(СтруктураПараметров, АдресХранилища)
	
	МассивСообщенийОбмена = СтруктураПараметров.МассивСообщенийОбмена;
	ТекстСообщения = "";
	
	НовыйПакет = Неопределено;
	СоздатьПакетОбменСБанками(СтруктураПараметров.НастройкаОбмена, МассивСообщенийОбмена, НовыйПакет);
	
	Если НЕ ЗначениеЗаполнено(НовыйПакет) Тогда
		СтруктураВозврата = Новый Структура;
		СтруктураВозврата.Вставить("ЗапросОтправлен", Ложь);
		СтруктураВозврата.Вставить("ЕстьОшибка", Истина);
		Возврат;
	КонецЕсли;
	
	ЕстьОшибка = Ложь;
	СоздатьЭДПакетаAsync(НовыйПакет, ЕстьОшибка);
	
	Если ЕстьОшибка Тогда
		СтруктураВозврата = Новый Структура;
		СтруктураВозврата.Вставить("ЗапросОтправлен", Ложь);
		СтруктураВозврата.Вставить("ЕстьОшибка", Истина);
		Возврат;
	КонецЕсли;
	
	МассивПакетов = Новый Массив;
	МассивПакетов.Добавить(НовыйПакет);
	СоотвНастроекОбменаИПараметровСертификатов = Новый Соответствие;
	СоотвНастроекОбменаИПараметровСертификатов.Вставить(СтруктураПараметров.НастройкаОбмена, СтруктураПараметров);
	Результат = ОтправкаПакетовЭДО(МассивПакетов, СоотвНастроекОбменаИПараметровСертификатов, ТекстСообщения);
							
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ЗапросОтправлен", Результат.КоличествоОтправлено > 0);
	СтруктураВозврата.Вставить("ЕстьОшибка", ЗначениеЗаполнено(ТекстСообщения));
	СтруктураВозврата.Вставить("ВыпискаБанка", Неопределено);
	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресХранилища);
	
КонецПроцедуры

Функция ВидЭД(КодЭД)
	
	Если КодЭД = "10" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение;
	ИначеЕсли КодЭД = "11" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ПлатежноеТребование;
	ИначеЕсли КодЭД = "14" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки;
	ИначеЕсли КодЭД = "05" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ЗапросЗонд;
	ИначеЕсли КодЭД = "04" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ЗапросНаОтзывЭД;
	ИначеЕсли КодЭД = "03" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ЗапросОСостоянииЭД;
	ИначеЕсли КодЭД = "19" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.СписокНаОткрытиеСчетовПоЗарплатномуПроекту;
	ИначеЕсли КодЭД = "21" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.СписокНаЗачислениеДенежныхСредствНаСчетаСотрудников;
	ИначеЕсли КодЭД = "23" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.СписокУволенныхСотрудников;
	ИначеЕсли КодЭД = "30" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты;
	ИначеЕсли КодЭД = "31" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПродажуВалюты;
	ИначеЕсли КодЭД = "32" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПокупкуВалюты;
	ИначеЕсли КодЭД = "33" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.РаспоряжениеНаОбязательнуюПродажуВалюты;
	ИначеЕсли КодЭД = "34" Тогда
		Возврат Перечисления.ВидыЭДОбменСБанками.СправкаОПодтверждающихДокументах;
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область Сбербанк

Функция СформироватьПоручениеНаПродажуВалютыСбербанк(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
		
	ПространствоИмен = "http://bssys.com/upg/request";
	ТекстОшибки = "";
	
	CurrSell = ОбъектТипаCML(ФабрикаXDTO, "CurrSell", ПространствоИмен);
		ИДДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
		ЗаполнитьСвойствоXDTO(CurrSell, "docExtId", ИДДокумента, Истина, ТекстОшибки);
		ОбщиеРеквизиты = ОбъектТипаCML(ФабрикаXDTO, "CurrComDocData", ПространствоИмен);
			ДатаДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docDate", ДатаДокумента, Истина, ТекстОшибки);
			НомерДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docNum", НомерДокумента, Истина, ТекстОшибки);
			РеквизитыОрганизации = ОбъектТипаCML(ФабрикаXDTO, "OrgData", ПространствоИмен);
				НаименованиеОрганизации = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОрганизации.Наименование");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "orgName", НаименованиеОрганизации, Истина, ТекстОшибки);
				ИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "inn", ИНН, Истина, ТекстОшибки);
				КПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.КПП");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "kpp", КПП, , ТекстОшибки);
				ОКПО = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ОКПО");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "okpo", ОКПО, , ТекстОшибки);
				НаименованиеМеждународное = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОрганизации.НаименованиеМеждународное");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "internationalName", НаименованиеМеждународное, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "OrgData", РеквизитыОрганизации, Истина, ТекстОшибки);
			Если ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник") = Истина Тогда
				УполномоченныйСотрудник = УполномоченныйСотрудникСбербанк(ДеревоДанных, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "AuthPers", УполномоченныйСотрудник, , ТекстОшибки);
			КонецЕсли;
		ЗаполнитьСвойствоXDTO(CurrSell, "DocData", ОбщиеРеквизиты, Истина, ТекстОшибки);
		Сделка = ОбъектТипаCML(ФабрикаXDTO, "CurrSellTrans", ПространствоИмен);
			Сумма = СуммаСбербанк(ДеревоДанных, "СуммаПродажи", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "SumSell", Сумма, Истина, ТекстОшибки);
			УсловияПродажи = ОбъектТипаCML(ФабрикаXDTO, "TermDeal", ПространствоИмен);
				УсловияСделки = ЗначениеРеквизитаВДереве(ДеревоДанных, "УсловияСделки");
				ЗаполнитьСвойствоXDTO(УсловияПродажи, "DealType", УсловияСделки, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "TermSell", УсловияПродажи, Истина, ТекстОшибки);
			РеквизитыСчетаСписания = ОбъектТипаCML(ФабрикаXDTO, "AccountRubType", ПространствоИмен);
				НомерСчетаСписания = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыСписания.НомерСчета");
				ЗаполнитьСвойствоXDTO(РеквизитыСчетаСписания, "accNum", НомерСчетаСписания, Истина, ТекстОшибки);
				РеквизитыБанкаСписания = БанкСбербанк(ДеревоДанных, "РеквизитыСписания.Банк", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(РеквизитыСчетаСписания, "Bank", РеквизитыБанкаСписания, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "AccountSell", РеквизитыСчетаСписания, Истина, ТекстОшибки);
			РеквизитыСчетаЗачисления = ОбъектТипаCML(ФабрикаXDTO, "OurRubAccountType", ПространствоИмен);
				НомерСчетаЗачисления = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыЗачисления.НомерСчета");
				ЗаполнитьСвойствоXDTO(РеквизитыСчетаЗачисления, "accNum", НомерСчетаЗачисления, Истина, ТекстОшибки);
				ТипЗачисления = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыЗачисления.ТипЗачисления");
				ЗаполнитьСвойствоXDTO(РеквизитыСчетаЗачисления, "type", ТипЗачисления, Истина, ТекстОшибки);
				РеквизитыБанкаЗачисления = БанкСбербанк(ДеревоДанных, "РеквизитыЗачисления.Банк", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(РеквизитыСчетаЗачисления, "Bank", РеквизитыБанкаЗачисления, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "AccountCredit", РеквизитыСчетаЗачисления, Истина, ТекстОшибки);
			КомиссионноеВознаграждение = КомиссионноеВознаграждениеСбербанк(ДеревоДанных, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "Commis", КомиссионноеВознаграждение, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(CurrSell, "Trans", Сделка, Истина, ТекстОшибки);
		СоглашениеСБанком = ЗначениеРеквизитаВДереве(ДеревоДанных, "СоглашениеСБанком");
		ЗаполнитьСвойствоXDTO(CurrSell, "BankAgreement", СоглашениеСБанком, , ТекстОшибки);
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки
	КонецЕсли;
	
	CurrSell.Проверить();
		
	ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, CurrSell);
	АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	
КонецФункции

Функция ПриложенныеДокументыСбербанк(ДеревоДанных, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	СекцияПрисоединенныеФайлы = ОбъектТипаCML(ФабрикаXDTO, "AttachmentsType", ПространствоИмен);
	Для Каждого ТекущийПрисоединенныйФайл Из ДеревоДанных.Строки Цикл
		ПрисоединенныйФайлСсылка = ЗначениеРеквизитаВДереве(
			ТекущийПрисоединенныйФайл, "ПрисоединенныеФайлы.НомерСтроки.ПрисоединенныйФайл");
		РеквизитыФайла = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
			ПрисоединенныйФайлСсылка, "Расширение, Наименование, Описание, ДатаСоздания, Размер");
		ДвоичныеДанныеФайла = РаботаСФайлами.ДвоичныеДанныеФайла(ПрисоединенныйФайлСсылка);
		ПрисоединенныйФайл = ОбъектТипаCML(ФабрикаXDTO, "AttachmentsType.Attachment", ПространствоИмен);
			ЗаполнитьСвойствоXDTO(ПрисоединенныйФайл, "Type", РеквизитыФайла.Расширение, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ПрисоединенныйФайл, "AttachmentName", РеквизитыФайла.Наименование, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ПрисоединенныйФайл, "Description", РеквизитыФайла.Описание, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ПрисоединенныйФайл, "Date", РеквизитыФайла.ДатаСоздания, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ПрисоединенныйФайл, "Size", РеквизитыФайла.Размер, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ПрисоединенныйФайл, "Body", ДвоичныеДанныеФайла, Истина, ТекстОшибки);
		СекцияПрисоединенныеФайлы.Attachment.Добавить(ПрисоединенныйФайл);
	КонецЦикла;
	
	Возврат СекцияПрисоединенныеФайлы;
	
КонецФункции

Функция КодыВидовВалютныхОперацийСбербанк(ДеревоДанных, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	КодыВидовВалютныхОпераций = ОбъектТипаCML(ФабрикаXDTO, "VoInfos", ПространствоИмен);
	Для Каждого ТекущийКодОперации Из ДеревоДанных.Строки Цикл
		СекцияКодВидаОперации = ОбъектТипаCML(ФабрикаXDTO, "VoInfo", ПространствоИмен);
			КодВидаОперации = ЗначениеРеквизитаВДереве(
				ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.КодВидаВалютнойОперации");
			ЗаполнитьСвойствоXDTO(СекцияКодВидаОперации, "Vo", КодВидаОперации, Истина, ТекстОшибки);
			Сумма = ЗначениеРеквизитаВДереве(ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.Сумма");
			СекцияСумма = СуммаСбербанк(ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияКодВидаОперации, "Sum", СекцияСумма, Истина, ТекстОшибки);
			НомерПаспортаСделки = ЗначениеРеквизитаВДереве(
				ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.НомерПаспортаСделки");
			ЗаполнитьСвойствоXDTO(СекцияКодВидаОперации, "PsNum", НомерПаспортаСделки, , ТекстОшибки);
			ЕстьКонтракт = ЗначениеРеквизитаВДереве(ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.Контракт") = Истина;
			Если ЕстьКонтракт Тогда
				Контракт = ОбъектТипаCML(ФабрикаXDTO, "Contract", ПространствоИмен);
					НомерКонтракта = ЗначениеРеквизитаВДереве(
						ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.Контракт.Номер");
					Если ЗначениеЗаполнено(НомерКонтракта) Тогда
						ЗаполнитьСвойствоXDTO(Контракт, "numCheck", "1", Истина, ТекстОшибки);
					Иначе
						ЗаполнитьСвойствоXDTO(Контракт, "numCheck", "0", Истина, ТекстОшибки);
					КонецЕсли;
					ЗаполнитьСвойствоXDTO(Контракт, "num", НомерКонтракта, , ТекстОшибки);
					ДатаКонтракта = ЗначениеРеквизитаВДереве(
						ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.Контракт.Дата");
					ЗаполнитьСвойствоXDTO(Контракт, "date", ДатаКонтракта, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияКодВидаОперации, "Contract", Контракт, , ТекстОшибки);
				ВалютаИСумма = СуммаСбербанк(ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.Контракт", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияКодВидаОперации, "ContractSum", ВалютаИСумма, , ТекстОшибки);
			КонецЕсли;
			ОжидаемыйСрок = ЗначениеРеквизитаВДереве(
				ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.ОжидаемыйСрок");
			ЗаполнитьСвойствоXDTO(СекцияКодВидаОперации, "ExpectedDate", ОжидаемыйСрок, , ТекстОшибки);
		КодыВидовВалютныхОпераций.VoInfo.Добавить(СекцияКодВидаОперации);
	КонецЦикла;
	
	Возврат КодыВидовВалютныхОпераций;
		
КонецФункции

Функция БанкСбербанк(ДеревоДанных, Путь, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	РеквизитыБанка = ОбъектТипаCML(ФабрикаXDTO, "Bank", ПространствоИмен);
	БИКБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".БИК");
	ЗаполнитьСвойствоXDTO(РеквизитыБанка, "bic", БИКБанка, Истина, ТекстОшибки);
	КоррСчетБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".КоррСчет");
	ЗаполнитьСвойствоXDTO(РеквизитыБанка, "correspAcc", КоррСчетБанка, , ТекстОшибки);
	НаименованиеБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".Наименование");
	ЗаполнитьСвойствоXDTO(РеквизитыБанка, "Name", НаименованиеБанка, Истина, ТекстОшибки);
	ГородБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".Город");
	ЗаполнитьСвойствоXDTO(РеквизитыБанка, "BankCity", ГородБанка, , ТекстОшибки);
	ИнформацияОРасположенииБанка = ИнформацияОРасположенииБанка(ГородБанка);
		
	Если ЗначениеЗаполнено(ИнформацияОРасположенииБанка.НазваниеНаселенногоПункта) Тогда
		ЗаполнитьСвойствоXDTO(
			РеквизитыБанка, "BankCity", ИнформацияОРасположенииБанка.НазваниеНаселенногоПункта, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(
			РеквизитыБанка, "SettlementType", ИнформацияОРасположенииБанка.ТипНаселенногоПункта, Истина, ТекстОшибки);
	Иначе
		ТекстОшибки = ТекстОшибки + ?(ПустаяСтрока(ТекстОшибки), "", Символы.ПС)
			+ НСтр("ru = 'Некорректные данные в поле ""Город"" банка'" + " " + НаименованиеБанка);
	КонецЕсли;

	Возврат РеквизитыБанка;
	
КонецФункции

Функция КомиссионноеВознаграждениеСбербанк(ДеревоДанных, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";

	КомиссионноеВознаграждение = ОбъектТипаCML(ФабрикаXDTO, "Commision", ПространствоИмен);
	Если ЗначениеРеквизитаВДереве(ДеревоДанных, "КомиссионноеВознаграждение") = "Счет" Тогда
		СчетСписания = ОбъектТипаCML(ФабрикаXDTO, "ComAcc", ПространствоИмен);
			НомерСчетаСписания = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "КомиссионноеВознаграждение.Счет.НомерСчета");
			ЗаполнитьСвойствоXDTO(СчетСписания, "accNum", НомерСчетаСписания, Истина, ТекстОшибки);
			БИКБанкаСписания = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "КомиссионноеВознаграждение.Счет.БИК");
			ЗаполнитьСвойствоXDTO(СчетСписания, "bic", БИКБанкаСписания, Истина, ТекстОшибки);
			НаименованиеБанкаСписания = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "КомиссионноеВознаграждение.Счет.НаименованиеБанка");
			ЗаполнитьСвойствоXDTO(СчетСписания, "BankName", НаименованиеБанкаСписания, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(КомиссионноеВознаграждение, "ComAcc", СчетСписания, Истина, ТекстОшибки);
	Иначе
		ПлатежноеПоручение = ОбъектТипаCML(ФабрикаXDTO, "ComOrder", ПространствоИмен);
			НомерПлатежногоПоручения = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "КомиссионноеВознаграждение.ПлатежноеПоручение.Номер");
			ЗаполнитьСвойствоXDTO(ПлатежноеПоручение, "numPayDoc", НомерПлатежногоПоручения, Истина, ТекстОшибки);
			ДатаПлатежногоПоручения = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "КомиссионноеВознаграждение.ПлатежноеПоручение.Дата");
			ЗаполнитьСвойствоXDTO(ПлатежноеПоручение, "datePayDoc", ДатаПлатежногоПоручения, Истина, ТекстОшибки);
			НазначениеПлатежа = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "КомиссионноеВознаграждение.ПлатежноеПоручение.НазначениеПлатежа");
			ЗаполнитьСвойствоXDTO(ПлатежноеПоручение, "purposePayDoc", НазначениеПлатежа, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(КомиссионноеВознаграждение, "ComOrder", ПлатежноеПоручение, Истина, ТекстОшибки);
	КонецЕсли;
	Возврат КомиссионноеВознаграждение;

КонецФункции

Функция ОбосновывающиеДокументыСбербанк(ДеревоДанных, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	ОбосновывающиеДокументы = ОбъектТипаCML(ФабрикаXDTO, "VoDocs", ПространствоИмен);
	Для Каждого ТекущийОбосновывающийДокумент Из ДеревоДанных.Строки Цикл
		СекцияОбосновывающийДокумент = ОбъектТипаCML(ФабрикаXDTO, "VoDoc", ПространствоИмен);
			ТипДокумента = ЗначениеРеквизитаВДереве(
				ТекущийОбосновывающийДокумент, "ОбосновывающиеДокументы.НомерСтроки.ТипДокумента");
			ЗаполнитьСвойствоXDTO(СекцияОбосновывающийДокумент, "DocType", ТипДокумента, Истина, ТекстОшибки);
			НаименованиеДокумента = ЗначениеРеквизитаВДереве(
				ТекущийОбосновывающийДокумент, "ОбосновывающиеДокументы.НомерСтроки.НаименованиеДокумента");
			ЗаполнитьСвойствоXDTO(СекцияОбосновывающийДокумент, "DocName", НаименованиеДокумента, , ТекстОшибки);
			ОсновныеДанныеДокумента = РеквизитыДокументаСбербанк(
				ТекущийОбосновывающийДокумент, "ОбосновывающиеДокументы.НомерСтроки", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияОбосновывающийДокумент, "Request", ОсновныеДанныеДокумента, Истина, ТекстОшибки);
		ОбосновывающиеДокументы.VoDoc.Добавить(СекцияОбосновывающийДокумент);
	КонецЦикла;

	Возврат ОбосновывающиеДокументы;
	
КонецФункции

Функция РеквизитыДокументаСбербанк(ДеревоДанных, Путь, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	DocData = ОбъектТипаCML(ФабрикаXDTO, "DocData", ПространствоИмен);
	НаименованиеБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".НаименованиеБанка");
	ЗаполнитьСвойствоXDTO(DocData, "bankName", НаименованиеБанка, , ТекстОшибки);
	НомерДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".НомерДокумента");
	Если Не ЗначениеЗаполнено(НомерДокумента) Тогда
		НомерДокумента = "null";
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(DocData, "docNum", НомерДокумента, Истина, ТекстОшибки);
	ДатаДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".ДатаДокумента");
	ЗаполнитьСвойствоXDTO(DocData, "docDate", ДатаДокумента, Истина, ТекстОшибки);
	
	Возврат DocData;

КонецФункции

Функция СтранаСбербанк(ДеревоДанных, Путь, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	Страна = ОбъектТипаCML(ФабрикаXDTO, "CountryName", ПространствоИмен);
	КодСтраныНерезидента = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".КодСтраны");
	ЗаполнитьСвойствоXDTO(Страна, "code", КодСтраныНерезидента, Истина, ТекстОшибки);
	НаименованиеСтраныНерезидента = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".НаименованиеСтраны");
	ЗаполнитьСвойствоXDTO(Страна, "name", НаименованиеСтраныНерезидента, Истина, ТекстОшибки);
	Возврат Страна;
	
КонецФункции

Функция СуммаСбербанк(ДеревоДанных, Путь, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	CurrAmountType = ОбъектТипаCML(ФабрикаXDTO, "CurrAmountType", ПространствоИмен);
	Сумма = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".Сумма");
	ЗаполнитьСвойствоXDTO(CurrAmountType, "docSum", Сумма, Истина, ТекстОшибки);
	КодВалюты = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".КодВалюты");
	ЗаполнитьСвойствоXDTO(CurrAmountType, "currCode", КодВалюты, Истина, ТекстОшибки);
	ISOКодВалюты = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".ISOКодВалюты");
	ЗаполнитьСвойствоXDTO(CurrAmountType, "currIsoCode", ISOКодВалюты, , ТекстОшибки);
	Возврат CurrAmountType;
	
КонецФункции

Процедура ПолучитьСтатусыПлатежныхДокументовСбербанк(НастройкаОбмена, ИдентификаторСессии, КоличествоПолучено, МассивСообщенийОбмена = Неопределено)
	
	Пока Истина Цикл
	
		КоличествоПолучено = 0;
		ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ИдентификаторОрганизации");

		МассивТикетов = ОбменСБанкамиСлужебныйВызовСервера.МассивИдентификаторовЗапроса(
			НастройкаОбмена, Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение);

		Если МассивТикетов.Количество() = 0 Тогда
			Прервать;
		КонецЕсли;
			
		ПолучитьИзвещенияПоТикетамСбербанк(
			НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, МассивТикетов, КоличествоПолучено);

		ТекстЗапроса = ОбменСБанкамиСлужебныйВызовСервера.ТекстЗапросаСостоянияОбработкиПлатежныхДокументовСбербанк(
			НастройкаОбмена, МассивТикетов);

		Если ЗначениеЗаполнено(ТекстЗапроса) Тогда
			
			Данные = Новый Массив;
			Данные.Добавить(ТекстЗапроса);
			ОтправитьДанныеВСбербанк(НастройкаОбмена, ИдентификаторСессии, Данные, МассивТикетов);
				
			Если МассивТикетов.Количество() Тогда
				ОбменСБанкамиСлужебныйВызовСервера.СохранитьИдентификаторы(
					МассивТикетов, НастройкаОбмена, Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение);
			КонецЕсли;
			
			ПолучитьИзвещенияПоТикетамСбербанк(
				НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, МассивТикетов, КоличествоПолучено);
			
		КонецЕсли;
		
		Если МассивСообщенийОбмена = Неопределено
			ИЛИ ИзвещенияПодтвержденияПоSMSПолученыСбербанк(МассивСообщенийОбмена) Тогда
			МассивСообщенийОбмена = СообщенияОбменаТребующиеSMSПодтверждения(МассивСообщенийОбмена);
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ИзвещенияПодтвержденияПоSMSПолученыСбербанк(МассивСообщенийОбмена)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СообщениеОбменСБанками.Ссылка
	|ИЗ
	|	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	|ГДЕ
	|	СообщениеОбменСБанками.Статус В (ЗНАЧЕНИЕ(Перечисление.СтатусыОбменСБанками.Отправлен), ЗНАЧЕНИЕ(Перечисление.СтатусыОбменСБанками.Доставлен))
	|	И СообщениеОбменСБанками.Ссылка В(&МассивСообщенийОбмена)";
	Запрос.УстановитьПараметр("МассивСообщенийОбмена", МассивСообщенийОбмена);
	
	Возврат Запрос.Выполнить().Пустой();
	
КонецФункции

Процедура ПолучитьИзвещенияПоТикетамСбербанк(НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, МассивТикетов, КоличествоПолучено)
	
	МассивОтветов = Неопределено;
	ПолучитьДанныеИзСбербанка(НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, МассивТикетов, МассивОтветов);

	Индекс = 0;
	Для Каждого Ответ Из МассивОтветов Цикл
	
		Если Ответ = "<!--NOT PROCESSED YET-->" ИЛИ Ответ = "<!--NOT_PROCESSED_YET-->" Тогда
			// тикет еще не обработан, пропускаем
		ИначеЕсли Ответ = "<!--REQUEST NOT FOUND-->" ИЛИ Ответ = "<!--REQUEST_NOT_FOUND-->" Тогда
			ТекстСообщения = НСтр("ru = 'На сервере банка произошла ошибка. Повторите операцию позже.'");
			ТекстОшибки = НСтр("ru = 'Ошибка отправки запроса статуса документа.
									|Тикет: %1
									|Ответ: %2'");
			ТекстОшибки = СтрШаблон(ТекстОшибки, МассивТикетов.Получить(Индекс), Ответ);
			ВидОперации = НСтр("ru = 'Получение статуса документа'");
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ТекстОшибки, , "ОбменСБанками", НастройкаОбмена);
			ВызватьИсключение ТекстСообщения;
		Иначе
			КоличествоТомов = 0;
			МассивНовыхСообщенийОбмена = Новый Массив;
			ИдентификаторЗапроса = МассивТикетов.Получить(Индекс);
			ОбменСБанкамиСлужебныйВызовСервера.ОбработатьОтветСбербанка(
				Ответ, НастройкаОбмена, МассивНовыхСообщенийОбмена, ИдентификаторЗапроса, КоличествоТомов);
			Если КоличествоТомов > 0 Тогда
				ПолучитьБольшойПакетСбербанк(НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, ИдентификаторЗапроса,
					КоличествоТомов, МассивНовыхСообщенийОбмена);
			КонецЕсли;
			КоличествоПолучено = КоличествоПолучено + МассивНовыхСообщенийОбмена.Количество();
		КонецЕсли;
		Индекс = Индекс + 1;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПолучитьБольшойПакетСбербанк(НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, ИдентификаторЗапроса, КоличествоТомов, МассивНовыхСообщенийОбмена)

	ВидОперации = НСтр("ru = 'Получение большого документа с сервера Сбербанка'");
	
	ТекстОшибки = "";
	
	WSПрокси = ОбменСБанкамиСлужебныйПовтИсп.WSПроксиСбербанк();
	МассивОтветов = Новый Массив;
	
	Для Индекс = 1 По КоличествоТомов Цикл
	
		ПолучениеТомаТип = WSПрокси.ФабрикаXDTO.Тип("http://upg.sbns.bssys.com/", "getResponsePartSRP");
		ВыбранныйЭлемент = WSПрокси.ФабрикаXDTO.Создать(ПолучениеТомаТип);
		
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "request", ИдентификаторЗапроса, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "part", Индекс, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "sessionId", ИдентификаторСессии, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "orgId", ИдентификаторОрганизации, Истина, ТекстОшибки);
		
		Если ЗначениеЗаполнено(ТекстОшибки) Тогда
			ШаблонСообщения = НСтр("ru = 'Ошибка формирования запроса большого документа из Сбербанка:
									|%1'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, ТекстОшибки);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
	
		ВыбранныйЭлемент.Проверить();
	
		Попытка
			XDTOРезультат = WSПрокси.getResponsePartSRP(
				ИдентификаторЗапроса, Индекс, ИдентификаторСессии, ИдентификаторОрганизации);
		Исключение
			ДобавитьЗаписьВЖурнал(НастройкаОбмена, "getResponsePartSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
			ВызватьИсключение;
		КонецПопытки;
	
		ДобавитьЗаписьВЖурнал(НастройкаОбмена, "getResponsePartSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
	
		МассивОтветов.Добавить(XDTOРезультат);
	
	КонецЦикла;
	
	ОбменСБанкамиСлужебныйВызовСервера.СохранитьБольшойПакетСбербанк(
		НастройкаОбмена, ИдентификаторЗапроса, МассивОтветов, МассивНовыхСообщенийОбмена);
	
КонецПроцедуры

Функция ТекстЗапросаГенерацииSMSСбербанк(НастройкаОбмена, ИдентификаторДокумента)
	
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ИдентификаторОрганизации");
	
	Request = ОбъектТипаCML(ФабрикаXDTO, "Request", "http://bssys.com/upg/request");
	ИдентификаторЗапроса = Новый УникальныйИдентификатор;
	ТекстОшибки = "";
	ЗаполнитьСвойствоXDTO(Request, "requestId", Строка(ИдентификаторЗапроса), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "orgId", ИдентификаторОрганизации, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "version", ВерсияФорматаСбербанк(), Истина, ТекстОшибки);
	Отправитель = ПредставлениеОтправителяСбербанк();
	ЗаполнитьСвойствоXDTO(Request, "sender", Отправитель, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "receiver", "SBBOL_DBO", Истина, ТекстОшибки);
	
	GenSMSSign = ОбъектТипаCML(ФабрикаXDTO, "Request.GenSMSSign", "http://bssys.com/upg/request");
	ЗаполнитьСвойствоXDTO(GenSMSSign, "objId", ИдентификаторДокумента, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(GenSMSSign, "docType", "PayDocRu", Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "GenSMSSign", GenSMSSign, Истина, ТекстОшибки);
	
	Request.Проверить();
	
	Запись = Новый ЗаписьXML;
	Запись.УстановитьСтроку();
	ФабрикаXDTO.ЗаписатьXML(Запись, Request);
	ТекстЗапроса = Запись.Закрыть();
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПроверкиSMSСбербанк(НастройкаОбмена, ИдентификаторДокумента, ИдентификаторКриптопрофиля, SMSКод, ТекущаяСессия)
	
	ИдентификаторОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НастройкаОбмена, "ИдентификаторОрганизации");
	
	ПространствоИмен = "http://bssys.com/upg/request";
	Request = ОбъектТипаCML(ФабрикаXDTO, "Request", ПространствоИмен);
	ИдентификаторЗапроса = Новый УникальныйИдентификатор;
	ТекстОшибки = "";
	ЗаполнитьСвойствоXDTO(Request, "requestId", Строка(ИдентификаторЗапроса), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "orgId", ИдентификаторОрганизации, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "version", ВерсияФорматаСбербанк(), Истина, ТекстОшибки);
	Отправитель = ПредставлениеОтправителяСбербанк();
	ЗаполнитьСвойствоXDTO(Request, "sender", Отправитель, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "receiver", "SBBOL_DBO", Истина, ТекстОшибки);
	
	VerifySMSSign = ОбъектТипаCML(ФабрикаXDTO, "VerifySMSSign", "http://bssys.com/upg/request");
	ЗаполнитьСвойствоXDTO(VerifySMSSign, "smsCode", SMSКод, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(VerifySMSSign, "cryptoProfileID", ИдентификаторКриптопрофиля, Истина, ТекстОшибки);
	
	SMSSignReqParams = ОбъектТипаCML(ФабрикаXDTO, "VerifySMSSign.SMSSignReqParams", "http://bssys.com/upg/request");
	ЗаполнитьСвойствоXDTO(SMSSignReqParams, "objId", ИдентификаторДокумента, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(SMSSignReqParams, "docType", "PayDocRu", Истина, ТекстОшибки);
	
	ЗаполнитьСвойствоXDTO(VerifySMSSign, "SMSSignReqParams", SMSSignReqParams, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Request, "VerifySMSSign", VerifySMSSign, Истина, ТекстОшибки);
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Fraud = ОбъектТипаCML(ФабрикаXDTO, "Fraud", ПространствоИмен);
	
	ЗаполнитьФродПараметрыВXDTO(Fraud, ТекущаяСессия.ФродПараметры, ТекущаяСессия.Логин);
	
	ЗаполнитьСвойствоXDTO(Request, "Fraud", Fraud);
	
	Request.Проверить();
	
	Запись = Новый ЗаписьXML;
	Запись.УстановитьСтроку();
	ФабрикаXDTO.ЗаписатьXML(Запись, Request);
	ТекстЗапроса = Запись.Закрыть();
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция СтрокаИзОбъектаXDTO(Фабрика, ОбъектXDTO)

	НоваяЗаписьXML = Новый ЗаписьXML;
	ПотокВПамяти = Новый ПотокВПамяти();
	НоваяЗаписьXML.ОткрытьПоток(ПотокВПамяти, "UTF-8");
	Фабрика.ЗаписатьXML(НоваяЗаписьXML, ОбъектXDTO, , , , НазначениеТипаXML.Явное);
	НоваяЗаписьXML.Закрыть();
	ПотокВПамяти.Перейти(0, ПозицияВПотоке.Начало);
	ЧтениеДанных = Новый ЧтениеДанных(ПотокВПамяти, "UTF-8");
	СтрокаВозврата = ЧтениеДанных.ПрочитатьСимволы();
	ПотокВПамяти.Закрыть();
	Возврат СтрокаВозврата;
	
КонецФункции

Процедура СформироватьПлатежноеПоручениеСбербанк(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище, ИспользуетсяПодпись)
		
	ПространствоИмен = "http://bssys.com/upg/request";
	ТекстОшибки = "";
	
	PayDocRu = ОбъектТипаCML(ФабрикаXDTO, "PayDocRu", ПространствоИмен);
	ИДДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
	ЗаполнитьСвойствоXDTO(PayDocRu, "docExtId", ИДДокумента, Истина, ТекстОшибки);
	Если Не ИспользуетсяПодпись Тогда
		ЗаполнитьСвойствоXDTO(PayDocRu, "sentForSign", "1", , ТекстОшибки);
	КонецЕсли;
	AccDoc = ОбъектТипаCML(ФабрикаXDTO, "PayDocRu.AccDoc", ПространствоИмен);
	
	ПеречислениеВБюджет = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет") = Истина;
	Код = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Код");
	Если ПеречислениеВБюджет И Не ЗначениеЗаполнено(Код) Тогда
		ЗаполнитьСвойствоXDTO(AccDoc, "uip", "0", , ТекстОшибки);
	Иначе
		ЗаполнитьСвойствоXDTO(AccDoc, "uip", Код, , ТекстОшибки);
	КонецЕсли;
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа");
	// Сервер Сбербанка не умеет работать с символом возврата каретки.
	НазначениеПлатежа = СтрЗаменить(НазначениеПлатежа, Символы.ВК, "");
	ЗаполнитьСвойствоXDTO(AccDoc, "purpose", НазначениеПлатежа, Истина, ТекстОшибки);
	Номер = СокрЛП(ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер"));
	Если Не СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(Номер) Тогда
		ТекстОшибки = ТекстОшибки + ?(ПустаяСтрока(ТекстОшибки), "", Символы.ПС)
			+ НСтр("ru = 'Номер документа должен содержать только цифры.'");
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(AccDoc, "accDocNo", Номер, Истина, ТекстОшибки);
	Дата = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
	ЗаполнитьСвойствоXDTO(AccDoc, "docDate", Дата, Истина, ТекстОшибки);
	Сумма = ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
	ЗаполнитьСвойствоXDTO(AccDoc, "docSum", Сумма, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(AccDoc, "transKind", "01", Истина, ТекстОшибки);
	ВидПлатежа = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ВидПлатежа");
	ВидПлатежа = ?(ЗначениеЗаполнено(ВидПлатежа), НРег(ВидПлатежа), "0");
	ЗаполнитьСвойствоXDTO(AccDoc, "paytKind", ВидПлатежа, Истина, ТекстОшибки);
	Очередность = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Очередность");
	ЗаполнитьСвойствоXDTO(AccDoc, "priority", Очередность, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(PayDocRu, "AccDoc", AccDoc, Истина, ТекстОшибки);
	
	Payer = ОбъектТипаCML(ФабрикаXDTO, "PayDocRuClient", ПространствоИмен);
	ПлательщикНаименование = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Наименование");
	// Сервер Сбербанка не умеет работать с символом возврата каретки.
	ПлательщикНаименование = СтрЗаменить(ПлательщикНаименование, Символы.ВК, "");
	ЗаполнитьСвойствоXDTO(Payer, "Name", ПлательщикНаименование, Истина, ТекстОшибки);
	ПлательщикИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.ИНН");
	ЗаполнитьСвойствоXDTO(Payer, "inn", ПлательщикИНН, Истина, ТекстОшибки);
	ПлательщикКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.КПП");
	Если Не ЗначениеЗаполнено(ПлательщикКПП) И ПеречислениеВБюджет Тогда
		ПлательщикКПП = "0";
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(Payer, "kpp", ПлательщикКПП, , ТекстОшибки);
	ПлательщикРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.РасчСчет");
	ЗаполнитьСвойствоXDTO(Payer, "personalAcc", ПлательщикРасчСчет, Истина, ТекстОшибки);
	Bank = БанкСбербанк(ДеревоДанных, "РеквизитыПлательщика.Банк", ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Payer, "Bank", Bank, Истина, ТекстОшибки);
	
	ЗаполнитьСвойствоXDTO(PayDocRu, "Payer", Payer, Истина, ТекстОшибки);
	
	Payee = ОбъектТипаCML(ФабрикаXDTO, "Contragent",ПространствоИмен);
	ПолучательНаименование = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Наименование");
	// Сервер Сбербанка не умеет работать с символом возврата каретки.
	ПолучательНаименование = СтрЗаменить(ПолучательНаименование, Символы.ВК, "");
	ЗаполнитьСвойствоXDTO(Payee, "Name", ПолучательНаименование, Истина, ТекстОшибки);
	ПолучательИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.ИНН");
	ЗаполнитьСвойствоXDTO(Payee, "inn", ПолучательИНН, , ТекстОшибки);
	ПолучательКПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.КПП");
	Если Не ЗначениеЗаполнено(ПолучательКПП) И ПеречислениеВБюджет Тогда
		ПолучательКПП = "0";
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(Payee, "kpp", ПолучательКПП, , ТекстОшибки);
	ПолучательРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.РасчСчет");
	ЗаполнитьСвойствоXDTO(Payee, "personalAcc", ПолучательРасчСчет, , ТекстОшибки);
	
	Bank = БанкСбербанк(ДеревоДанных, "РеквизитыПолучателя.Банк", ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Payee, "Bank", Bank, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(PayDocRu, "Payee", Payee, Истина, ТекстОшибки);
	Если ПеречислениеВБюджет Тогда
		DepartmentalInfo = ОбъектТипаCML(ФабрикаXDTO, "PayDocRu.DepartmentalInfo", ПространствоИмен);
		СтатусСоставителя = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.СтатусСоставителя");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "drawerStatus", СтатусСоставителя, Истина, ТекстОшибки);
		КодБК = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательКБК");
		КодБК = ?(Не ПустаяСтрока(КодБК), СокрЛП(КодБК), "0");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "cbc", КодБК, Истина, ТекстОшибки);
		КодОКАТО = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ОКТМО");
		КодОКАТО = ?(ЗначениеЗаполнено(КодОКАТО), КодОКАТО, "0");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "okato", СокрЛП(КодОКАТО), Истина, ТекстОшибки);
		ПоказательОснования = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательОснования");
		ПоказательОснования = ?(ЗначениеЗаполнено(ПоказательОснования), ПоказательОснования, "0");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "paytReason", ПоказательОснования, Истина, ТекстОшибки);
		ПоказательПериода = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательПериода");
		ПоказательПериода = ?(ЗначениеЗаполнено(ПоказательПериода), ПоказательПериода, "0");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "taxPeriod", ПоказательПериода, Истина, ТекстОшибки);
		ПоказательНомера = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательНомера");
		ПоказательНомера = ?(ЗначениеЗаполнено(ПоказательНомера), ПоказательНомера, "0");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "docNo", ПоказательНомера, Истина, ТекстОшибки);
		ПоказательДаты = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПлатежиВБюджет.ПоказательДаты");
		ПоказательДаты = ?(ЗначениеЗаполнено(ПоказательДаты), ПоказательДаты, "0");
		ЗаполнитьСвойствоXDTO(DepartmentalInfo, "docDate", ПоказательДаты, Истина, ТекстОшибки);
		Если Дата < Дата(2016, 3, 28) Тогда
			ЗаполнитьСвойствоXDTO(DepartmentalInfo, "taxPaytKind", "0", Истина, ТекстОшибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(PayDocRu, "DepartmentalInfo", DepartmentalInfo, , ТекстОшибки);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки
	Иначе
		ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, PayDocRu);
		АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	КонецЕсли;
	
	PayDocRu.Проверить();
	
КонецПроцедуры

Процедура ПрочитатьКвитанциюСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.Квитанция;
	НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий;
	
	ТикетСББОЛ = ЗначениеСвойстваXDTO(ЭД, "docId");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТикетСББОЛ", ТикетСББОЛ);
	ДатаСозданияКвитка = ЗначениеСвойстваXDTO(ЭД, "createTime");
	Если ЗначениеЗаполнено(ДатаСозданияКвитка) Тогда
		ДатаБезПриведения = XMLЗначение(Тип("Дата"), Сред(ДатаСозданияКвитка, 1, 19));
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСозданияКвитка", ДатаБезПриведения);
	КонецЕсли;
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КодСостоянияДокумента", ЭД.Info.statusStateCode);
	ИдентификаторОрганизации = ЗначениеСвойстваXDTO(ЭД, "Info.orgId");
	Если НЕ ИдентификаторОрганизации = Неопределено Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторОрганизации", ИдентификаторОрганизации);
	КонецЕсли;
		
	ИдентификаторДокумента = ЗначениеСвойстваXDTO(ЭД, "Info.docExtId");
	Если НЕ ИдентификаторДокумента = Неопределено Тогда
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ИдентификаторДокумента);
	КонецЕсли;
	Если НЕ ЗначениеСвойстваXDTO(ЭД, "Info.BankDate") = Неопределено Тогда
		ДатаСписанияСоСчетаПлательщика = ЗначениеСвойстваXDTO(ЭД, "Info.BankDate.chargeOffDate");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСписанияСоСчетаПлательщика", ДатаСписанияСоСчетаПлательщика);
		ДатаПостановкиВКартотеку = ЗначениеСвойстваXDTO(ЭД, "Info.BankDate.fileDate");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПостановкиВКартотеку", ДатаПостановкиВКартотеку);
		ДатаОтметкиБанкомПлательщика = ЗначениеСвойстваXDTO(ЭД, "Info.BankDate.signDate");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтметкиБанкомПлательщика", ДатаОтметкиБанкомПлательщика);
		ДатаПоступленияВБанкПлательщика = ЗначениеСвойстваXDTO(ЭД, "Info.BankDate.receiptDate");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПоступленияВБанкПлательщика", ДатаПоступленияВБанкПлательщика);
		ДатаПеречисленияПлатежа = ЗначениеСвойстваXDTO(ЭД, "Info.BankDate.dpp");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПеречисленияПлатежа", ДатаПеречисленияПлатежа);
		ДатаОтметкиБанкомПолучателя = ЗначениеСвойстваXDTO(ЭД, "Info.BankDate.recDate");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтметкиБанкомПолучателя", ДатаОтметкиБанкомПолучателя);
	КонецЕсли;
	Если НЕ ЗначениеСвойстваXDTO(ЭД, "Info.MsgFromBank") = Неопределено Тогда
		АвторСообщения = ЗначениеСвойстваXDTO(ЭД, "Info.MsgFromBank.author");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "АвторСообщения", АвторСообщения);
		СообщениеИзБанка = ЗначениеСвойстваXDTO(ЭД, "Info.MsgFromBank.Message");
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СообщениеИзБанка", СообщениеИзБанка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьЗапросВыпискиСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ЗапросВыписки;
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docExtId);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСозданияЗапроса", ЭД.createTime);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачала", ЭД.beginDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонца", ЭД.endDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТипЗапроса", ЭД.stmtType);
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлатежноеНаименованиеОрганизации", ЭД.orgName);
	Для Каждого Элемент Из ЭД.Accounts.Account Цикл
		РеквизитыСчета = Новый СписокЗначений;
		РеквизитыСчета.Добавить(Элемент.bic, "БИК");
		РеквизитыСчета.Добавить(Элемент.__content, "НомерСчета");
		РеквизитыСчета.Добавить(Элемент.docNum, "НомерЗапроса");
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", РеквизитыСчета);
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьПлатежноеПоручениеСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
		НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПлатежноеПоручение;
		НовыйЭД.ОписаниеТипа = "Сбербанк";
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Код", ЭД.AccDoc.uip);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.AccDoc.AccDocNo);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.AccDoc.docDate);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВидПлатежа", ЭД.AccDoc.paytKind);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСозданияДокумента", ЭД.AccDoc.docDate);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВидОперации", ЭД.AccDoc.TransKind);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ДополнительнаяУслуга", ЭД.AccDoc.urgentSBRF);
		
		Если НЕ ЭД.Credit = Неопределено Тогда
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ЦелевоеПоручение", ЭД.Credit.flagTargetAssignment);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ИспользоватьСобственныеСредства", ЭД.Credit.flagUseOwnMeans);
			Если НЕ ЭД.Credit.Свойства().Получить("CredConNum") = Неопределено Тогда
				ДобавитьРеквизитШапкиОбъекта(
					НовыйЭД, "НомерКредитногоДоговора", ЭД.Credit.CredConNum);
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЭД.AccDoc.Свойства().Получить("CodeVO") = Неопределено Тогда
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "КодВидаВалютнойОперации", ЭД.AccDoc.CodeVO);
		КонецЕсли;
		
		Если НЕ ЭД.DepartmentalInfo = Неопределено Тогда
			ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлатежиВБюджет", Истина);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "СтатусСоставителя", ЭД.DepartmentalInfo.drawerStatus);
			ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПоказательКБК", ЭД.DepartmentalInfo.cbc);
			ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКТМО", ЭД.DepartmentalInfo.okato);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ПоказательОснования", ЭД.DepartmentalInfo.paytReason);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ПоказательПериода", ЭД.DepartmentalInfo.taxPeriod);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ПоказательНомера", ЭД.DepartmentalInfo.docNo);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ПоказательДаты", ЭД.DepartmentalInfo.docDate);
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ПоказательТипа", ЭД.DepartmentalInfo.taxPaytKind);
		КонецЕсли;
		
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикИНН", ЭД.Payer.inn);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикКПП", ЭД.Payer.kpp);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЭД.AccDoc.docSum);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикНаименование", ЭД.Payer.Name);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикРасчСчет", ЭД.Payer.PersonalAcc);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикНаименованиеБанка", ЭД.Payer.Bank.Name);
		НаселенныйПунктБанкаПлательщика = "";
		Если НЕ ЭД.Payer.Bank.Свойства().Получить("BankCity")=Неопределено Тогда
			НаселенныйПунктБанкаПлательщика = ЭД.Payer.Bank.BankCity;
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "НаселенныйПунктБанкаПлательщика", НаселенныйПунктБанкаПлательщика);
		КонецЕсли;
		ТипНаселенногоПунктаБанкаПлательщика = "";
		Если НЕ ЭД.Payer.Bank.Свойства().Получить("SettlementType")=Неопределено Тогда
			ТипНаселенногоПунктаБанкаПлательщика = ЭД.Payer.Bank.SettlementType;
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ТипНаселенногоПунктаБанкаПлательщика", ТипНаселенногоПунктаБанкаПлательщика);
		КонецЕсли;
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикГородБанка", ТипНаселенногоПунктаБанкаПлательщика + " " + НаселенныйПунктБанкаПлательщика);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлательщикБИКБанка", ЭД.Payer.Bank.bic);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПлательщикКоррСчетБанка", ЭД.Payer.Bank.correspAcc);
		Если НЕ ЭД.Payer.Свойства().Получить("Filial") = Неопределено Тогда
			ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ФилиалБанкаПлательщика", ЭД.Payer.Filial);
		КонецЕсли;
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательНаименованиеБанка", ЭД.Payee.Bank.Name);
		НаселенныйПунктБанкаПолучателя = "";
		Если НЕ ЭД.Payee.Bank.Свойства().Получить("BankCity") = Неопределено Тогда
			НаселенныйПунктБанкаПолучателя = ЭД.Payee.Bank.BankCity;
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "НаселенныйПунктБанкаПолучателя", НаселенныйПунктБанкаПолучателя);
		КонецЕсли;
		ТипНаселенногоПунктаБанкаПолучателя = "";
		Если НЕ ЭД.Payee.Bank.Свойства().Получить("SettlementType") = Неопределено Тогда
			ТипНаселенногоПунктаБанкаПолучателя = ЭД.Payee.Bank.SettlementType;
			ДобавитьРеквизитШапкиОбъекта(
				НовыйЭД, "ТипНаселенногоПунктаБанкаПолучателя", ТипНаселенногоПунктаБанкаПолучателя);
		КонецЕсли;
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательГородБанка", ТипНаселенногоПунктаБанкаПолучателя + " " + НаселенныйПунктБанкаПолучателя);
			
		Если НЕ ЭД.Payee.Свойства().Получить("Filial") = Неопределено Тогда
			ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ФилиалБанкаПолучателя", ЭД.Payee.Filial);
		КонецЕсли;
		
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательБИКБанка", ЭД.Payee.Bank.bic);
		ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД, "ПолучательКоррСчетБанка", ЭД.Payee.Bank.correspAcc);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательИНН", ЭД.Payee.inn);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательКПП", ЭД.Payee.kpp);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательРасчСчет", ЭД.Payee.PersonalAcc);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолучательНаименование", ЭД.Payee.Name);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Очередность", ЭД.AccDoc.priority);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НазначениеПлатежа", ЭД.AccDoc.purpose);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docExtId);
		
КонецПроцедуры

Процедура ПрочитатьВыпискуСбербанкXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка;
	
	НаименованиеОрганизации = ЗначениеСвойстваXDTO(ЭД, "orgName");
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "НаименованиеОрганизации", НаименованиеОрганизации);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель", НаименованиеОрганизации);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСоставленияВыписки", ЭД.stmtDateTime);
	ДатаФормирования = XMLЗначение(Тип("Дата"), ЭД.stmtDateTime);

	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования", ДатаФормирования);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БИК", ЭД.bic);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель", ЭД.bic);
	ДатаПоследнейОперации = ЗначениеСвойстваXDTO(ЭД, "lastMovetDate");
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаПоследнейОперации", ДатаПоследнейОперации);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "РасчСчет", ЭД.Acc);
	НачальныйОстаток = ЗначениеСвойстваXDTO(ЭД, "enterBal");
	НачальныйОстаток = ?(НачальныйОстаток = Неопределено, НачальныйОстаток, Число(НачальныйОстаток));
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НачальныйОстаток", НачальныйОстаток);
	КонечныйОстаток = ЗначениеСвойстваXDTO(ЭД, "outBal");
	КонечныйОстаток = ?(КонечныйОстаток = Неопределено, КонечныйОстаток, Число(КонечныйОстаток));
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КонечныйОстаток", КонечныйОстаток);
	ДатаНачала = XMLЗначение(Тип("Дата"), ЭД.beginDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачала", ДатаНачала);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаНачалаСтрокой", ЭД.beginDate);
	ДатаКонца = XMLЗначение(Тип("Дата"), ЭД.endDate);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонца", ДатаКонца);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаКонцаСтрокой", ЭД.endDate);
	ВсегоСписано = ?(ЭД.debetSum = Неопределено, ЭД.debetSum, Число(ЭД.debetSum));
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВсегоСписано", ВсегоСписано);
	ВсегоПоступило = ?(ЭД.debetSum = Неопределено, ЭД.creditSum, Число(ЭД.creditSum));
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВсегоПоступило", ВсегоПоступило);
	ДатаПредыдущейОперации = ЗначениеСвойстваXDTO(ЭД, "DatePLast");
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаПредыдущейОперации", ДатаПредыдущейОперации);
	КурсНаНачалоПериода = ЗначениеСвойстваXDTO(ЭД, "rateIn");
	КурсНаНачалоПериода = ?(КурсНаНачалоПериода = Неопределено, КурсНаНачалоПериода, Число(КурсНаНачалоПериода));
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КурсНаНачалоПериода", КурсНаНачалоПериода);
	КурсНаКонецПериода = ЗначениеСвойстваXDTO(ЭД, "rateOut");
	КурсНаКонецПериода = ?(КурсНаКонецПериода = Неопределено, КурсНаКонецПериода, Число(КурсНаКонецПериода));
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КурсНаКонецПериода", КурсНаКонецПериода);
	ВходящийОстатокВНациональнойВалюте = ЗначениеСвойстваXDTO(ЭД, "enterBalNat");
	ВходящийОстатокВНациональнойВалюте = ?(ВходящийОстатокВНациональнойВалюте = Неопределено,
		ВходящийОстатокВНациональнойВалюте, Число(ВходящийОстатокВНациональнойВалюте));
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ВходящийОстатокВНациональнойВалюте", ВходящийОстатокВНациональнойВалюте);
	ИсходящийОстатокВНациональнойВалюте = ЗначениеСвойстваXDTO(ЭД, "outBalNat");
	ИсходящийОстатокВНациональнойВалюте = ?(ИсходящийОстатокВНациональнойВалюте = Неопределено,
		ИсходящийОстатокВНациональнойВалюте, Число(ИсходящийОстатокВНациональнойВалюте));
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИсходящийОстатокВНациональнойВалюте", ИсходящийОстатокВНациональнойВалюте);
	ПлановыйИсходящийОстаток = ЗначениеСвойстваXDTO(ЭД, "planOutBal");
	ПлановыйИсходящийОстаток = ?(ПлановыйИсходящийОстаток = Неопределено, ПлановыйИсходящийОстаток,
		Число(ПлановыйИсходящийОстаток));
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлановыйИсходящийОстаток", ПлановыйИсходящийОстаток);
	ПлановыйИсходящийОстатокВНациональнойВалюте = ЗначениеСвойстваXDTO(ЭД, "planOutBalNat");
	ПлановыйИсходящийОстатокВНациональнойВалюте = ?(ПлановыйИсходящийОстатокВНациональнойВалюте = Неопределено,
		ПлановыйИсходящийОстатокВНациональнойВалюте, Число(ПлановыйИсходящийОстатокВНациональнойВалюте));
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ПлановыйИсходящийОстатокВНациональнойВалюте", ПлановыйИсходящийОстатокВНациональнойВалюте);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТипЗапросаВыписки", ЭД.stmtType);
	Номер = ЗначениеСвойстваXDTO(ЭД, "docNum");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", Номер);
	УчетнаяЗапись = ЗначениеСвойстваXDTO(ЭД, "accountName");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "УчетнаяЗапись", УчетнаяЗапись);
	ДебетВНациональнойВалюте = ЗначениеСвойстваXDTO(ЭД, "debetSumNat");
	ДебетВНациональнойВалюте = ?(ДебетВНациональнойВалюте = Неопределено, Неопределено, Число(ДебетВНациональнойВалюте));
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДебетВНациональнойВалюте", ДебетВНациональнойВалюте);
	КредитВНациональнойВалюте = ЗначениеСвойстваXDTO(ЭД, "creditSumNat");
	КредитВНациональнойВалюте = ?(КредитВНациональнойВалюте = Неопределено, Неопределено, Число(КредитВНациональнойВалюте));
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "КредитВНациональнойВалюте", КредитВНациональнойВалюте);
	Исполнитель = ЗначениеСвойстваXDTO(ЭД, "author");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Исполнитель", Исполнитель);
	ДопИнформация = ЗначениеСвойстваXDTO(ЭД, "docComment");
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДопИнформация", ДопИнформация);
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docId);
	
	СписокТЧ = Новый СписокЗначений;
	ПараметрыСчета = Новый Структура;
	ПараметрыСчета.Вставить("РасчСчет", ЭД.Acc);
	НачальныйОстаток = ?(ЭД.enterBal = Неопределено, ЭД.enterBal, Число(ЭД.enterBal));
	ПараметрыСчета.Вставить("НачальныйОстаток", НачальныйОстаток);
	ВсегоПоступило = ?(ЭД.creditSum = Неопределено, ЭД.creditSum, Число(ЭД.creditSum));
	ПараметрыСчета.Вставить("ВсегоПоступило", ВсегоПоступило);
	ВсегоСписано = ?(ЭД.debetSum = Неопределено, ЭД.debetSum, Число(ЭД.debetSum));
	ПараметрыСчета.Вставить("ВсегоСписано", ВсегоСписано);
	КонечныйОстаток = ЗначениеСвойстваXDTO(ЭД, "outBal");
	КонечныйОстаток = ?(КонечныйОстаток = Неопределено, КонечныйОстаток, Число(КонечныйОстаток));
	ПараметрыСчета.Вставить("КонечныйОстаток", КонечныйОстаток);
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
		ДеревоРазбора, "БанковскийСчет");
	РасчетныйСчет = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.НайтиСсылкуНаОбъект(
		"БанковскиеСчетаОрганизаций", ЭД.Acc);
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(
		НайденныйТипВДереве, ЭД.Acc, , РасчетныйСчет, ПараметрыСчета, ДеревоРазбора, Ошибка);
	СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "БанковскийСчет");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "БанковскиеСчетаОрганизаций", СписокТЧ);
	
	Если НЕ ЗначениеСвойстваXDTO(ЭД, "Docs") = Неопределено Тогда
		Операции = ЗначениеСвойстваXDTO(ЭД, "Docs.TransInfo");
		Если ТипЗнч(Операции) = Тип("ОбъектXDTO") Тогда
			ПрочитатьОперациюВыпискиСбербанк(Операции, НовыйЭД);
		Иначе
			Для Каждого Операция Из Операции Цикл
				ПрочитатьОперациюВыпискиСбербанк(Операция, НовыйЭД);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗначениеСвойстваXDTO(ЭД, "InfoForStamp") = Неопределено Тогда
		
		ПараметрыШтампа = Новый Структура;
		ПараметрыШтампа.Вставить("БИК", ЭД.bic);
		НаименованиеБанка = ЗначениеСвойстваXDTO(ЭД, "InfoForStamp.BankName");
		ПараметрыШтампа.Вставить("НаименованиеБанка", НаименованиеБанка);
		ГородБанка = ЗначениеСвойстваXDTO(ЭД, "InfoForStamp.BranchName");
		ПараметрыШтампа.Вставить("ГородБанка", ГородБанка);
		Офис = ЗначениеСвойстваXDTO(ЭД, "InfoForStamp.SubBranchName");
		ПараметрыШтампа.Вставить("Офис", Офис);
		Филиал = ЗначениеСвойстваXDTO(ЭД, "InfoForStamp.SubBranchNum");
		ПараметрыШтампа.Вставить("ОтделениеБанка", Филиал);
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
			ДеревоРазбора, "Штамп");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(
			НайденныйТипВДереве, "Штамп", , , ПараметрыШтампа, ДеревоРазбора, Ошибка);
		ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Штамп", НайденнаяСтрока.ИндексСтроки);
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ПрочитатьОперациюВыпискиСбербанк(Документ, НовыйЭД)
	
	РеквизитыДокумента = Новый СписокЗначений;
	ДатаСписания = ЗначениеСвойстваXDTO(Документ, "chargeOffDate");
	РеквизитыДокумента.Добавить(ДатаСписания, "ДатаСписания");
	ДатаПеречисления = ЗначениеСвойстваXDTO(Документ, "dpp");
	РеквизитыДокумента.Добавить(ДатаПеречисления, "ДатаПеречисления");
	ДатаПостановкиВКартотеку = ЗначениеСвойстваXDTO(Документ, "fileDate");
	РеквизитыДокумента.Добавить(ДатаПостановкиВКартотеку, "ДатаПостановкиВКартотеку");
	ДатаОтметкиБанкаПолучателя = ЗначениеСвойстваXDTO(Документ, "recDate");
	РеквизитыДокумента.Добавить(ДатаОтметкиБанкаПолучателя, "ДатаОтметкиБанкаПолучателя");
	ДатаПоступленияВБанкПлательщика = ЗначениеСвойстваXDTO(Документ, "receiptDate");
	РеквизитыДокумента.Добавить(ДатаПоступленияВБанкПлательщика, "ДатаПоступленияВБанкПлательщика");
	ДатаОтметкиБанкомПлательщика = ЗначениеСвойстваXDTO(Документ, "signDate");
	РеквизитыДокумента.Добавить(ДатаОтметкиБанкомПлательщика, "ДатаОтметкиБанкомПлательщика");
	НомерДокументаБанка = ЗначениеСвойстваXDTO(Документ, "bankNumDoc");
	РеквизитыДокумента.Добавить(НомерДокументаБанка, "НомерДокументаБанка");
	КодПодразделения = ЗначениеСвойстваXDTO(Документ, "branchCode");
	РеквизитыДокумента.Добавить(КодПодразделения, "КодПодразделения");
	ДатаСписано = XMLЗначение(Тип("Дата"), Документ.carryDate);
	РеквизитыДокумента.Добавить(ДатаСписано, "ДатаСписано");
	ДатаПроводки = XMLЗначение(Тип("Дата"), Документ.carryDate);
	ПлатежИсходящий = XMLЗначение(Тип("Булево"), Документ.dc);
	Если ПлатежИсходящий Тогда
		РеквизитыДокумента.Добавить(ДатаПроводки, "ДатаСписано");
	Иначе
		РеквизитыДокумента.Добавить(ДатаПроводки, "ДатаПоступило");
	КонецЕсли;
	РеквизитыДокумента.Добавить(Документ.carryDate, "ДатаПроводки");
	РеквизитыДокумента.Добавить(ПлатежИсходящий, "ПризнакПриложения");
	РеквизитыДокумента.Добавить(ПлатежИсходящий, "ПлатежИсходящий");
	Код = ЗначениеСвойстваXDTO(Документ, "uip");
	РеквизитыДокумента.Добавить(Код, "Код");
	ВалютаПлатежа = ЗначениеСвойстваXDTO(Документ, "docCurr");
	РеквизитыДокумента.Добавить(ВалютаПлатежа, "ВалютаПлатежа");
	ДатаДокумента = XMLЗначение(Тип("Дата"), Сред(Документ.docDate, 1, 19)); // без часового пояса
	РеквизитыДокумента.Добавить(ДатаДокумента, "Дата");
	РеквизитыДокумента.Добавить(Документ.docNum, "Номер");
	Сумма = ?(Документ.docSum = Неопределено, Документ.docSum, Число(Документ.docSum));
	РеквизитыДокумента.Добавить(Сумма, "Сумма");
	СуммаДокументаВНациональнойВалюте = ЗначениеСвойстваXDTO(Документ, "docSumNat");
	СуммаДокументаВНациональнойВалюте = ?(СуммаДокументаВНациональнойВалюте = Неопределено,
		СуммаДокументаВНациональнойВалюте, Число(СуммаДокументаВНациональнойВалюте));
	РеквизитыДокумента.Добавить(СуммаДокументаВНациональнойВалюте, "СуммаДокументаВНациональнойВалюте");
	Очередность = ЗначениеСвойстваXDTO(Документ, "paymentOrder");
	РеквизитыДокумента.Добавить(Очередность, "Очередность");
	ВидПлатежа = ЗначениеСвойстваXDTO(Документ, "paytKind");
	РеквизитыДокумента.Добавить(ВидПлатежа, "ВидПлатежа");
	НазначениеПлатежа = ЗначениеСвойстваXDTO(Документ, "purpose");
	РеквизитыДокумента.Добавить(НазначениеПлатежа, "НазначениеПлатежа");
	РеквизитыДокумента.Добавить(Документ.transKind, "ВидОплаты");
	ДопУслуга = ЗначениеСвойстваXDTO(Документ, "urgentSBRF");
	РеквизитыДокумента.Добавить(ДопУслуга, "ДопУслуга");
	ИдентификаторДокумента = ЗначениеСвойстваXDTO(Документ, "docId");
	РеквизитыДокумента.Добавить(ИдентификаторДокумента, "ИдентификаторДокумента");
	РеквизитыДокумента.Добавить(ИдентификаторДокумента, "ИдПлатежа");
	ПолучательНаименование = ЗначениеСвойстваXDTO(Документ, "payeeName");
	РеквизитыДокумента.Добавить(ПолучательНаименование, "ПолучательНаименование");
	РеквизитыДокумента.Добавить(Документ.payeeAcc, "ПолучательСчет");
	ПолучательИНН = ЗначениеСвойстваXDTO(Документ, "payeeINN");
	РеквизитыДокумента.Добавить(ПолучательИНН, "ПолучательИНН");
	ПолучательБИКБанка = ЗначениеСвойстваXDTO(Документ, "payeeBankBic");
	РеквизитыДокумента.Добавить(ПолучательБИКБанка, "ПолучательБИКБанка");
	СчетБанкаПолучателя = ЗначениеСвойстваXDTO(Документ, "payeeBankCorrAcc");
	РеквизитыДокумента.Добавить(СчетБанкаПолучателя, "СчетБанкаПолучателя");
	ПолучательНаименованиеБанка = ЗначениеСвойстваXDTO(Документ, "payeeBankName");
	РеквизитыДокумента.Добавить(ПолучательНаименованиеБанка, "ПолучательНаименованиеБанка");
	ПлательщикНаименование = ЗначениеСвойстваXDTO(Документ, "payerName");
	РеквизитыДокумента.Добавить(ПлательщикНаименование, "ПлательщикНаименование");
	РеквизитыДокумента.Добавить(Документ.payerAcc, "ПлательщикСчет");
	ПлательщикИНН = ЗначениеСвойстваXDTO(Документ, "payerINN");
	РеквизитыДокумента.Добавить(ПлательщикИНН, "ПлательщикИНН");
	ПлательщикБИКБанка = ЗначениеСвойстваXDTO(Документ, "payerBankBic");
	РеквизитыДокумента.Добавить(ПлательщикБИКБанка, "ПлательщикБИКБанка");
	СчетБанкаПлательщика = ЗначениеСвойстваXDTO(Документ, "payerBankCorrAcc");
	РеквизитыДокумента.Добавить(СчетБанкаПлательщика, "СчетБанкаПлательщика");
	ПлательщикНаименованиеБанка = ЗначениеСвойстваXDTO(Документ, "payerBankName");
	РеквизитыДокумента.Добавить(ПлательщикНаименованиеБанка, "ПлательщикНаименованиеБанка");
	Переоценка = ЗначениеСвойстваXDTO(Документ, "s_TI");
	РеквизитыДокумента.Добавить(Переоценка, "Переоценка");
	ДополнительнаяИнформация = ЗначениеСвойстваXDTO(Документ, "Info");
	РеквизитыДокумента.Добавить(ДополнительнаяИнформация, "ДополнительнаяИнформация");

	Если Не ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo") = Неопределено Тогда
		РеквизитыДокумента.Добавить(Истина, "ЭтоПлатежВБюджет");
		ПоказательКБК = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.cbc");
		РеквизитыДокумента.Добавить(ПоказательКБК, "ПоказательКБК");
		ПоказательДаты = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.docDate");
		РеквизитыДокумента.Добавить(ПоказательДаты, "ПоказательДаты");
		ПоказательНомера = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.docNo");
		РеквизитыДокумента.Добавить(ПоказательНомера, "ПоказательНомера");
		СтатусСоставителя = ЗначениеСвойстваXDTO(
			Документ, "DepartmentalInfo.drawerStatus");
		РеквизитыДокумента.Добавить(СтатусСоставителя, "СтатусСоставителя");
		ПлательщикКПП = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.kpp102");
		РеквизитыДокумента.Добавить(ПлательщикКПП, "ПлательщикКПП");
		ПолучательКПП = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.kpp103");
		РеквизитыДокумента.Добавить(ПолучательКПП, "ПолучательКПП");
		КодОКАТО = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.okato");
		РеквизитыДокумента.Добавить(КодОКАТО, "КодОКАТО");
		ПоказательОснования = ЗначениеСвойстваXDTO(
			Документ, "DepartmentalInfo.paytReason");
		РеквизитыДокумента.Добавить(ПоказательОснования, "ПоказательОснования");
		ПоказательТип = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.taxPaytKind");
		РеквизитыДокумента.Добавить(ПоказательТип, "ПоказательТип");
		ПоказательПериода = ЗначениеСвойстваXDTO(Документ, "DepartmentalInfo.taxPeriod");
		РеквизитыДокумента.Добавить(ПоказательПериода, "ПоказательПериода");
	Иначе
		РеквизитыДокумента.Добавить(Ложь, "ЭтоПлатежВБюджет");
	КонецЕсли;
	
	Если Не ЗначениеСвойстваXDTO(Документ, "DiffDoc") = Неопределено Тогда
		РеквизитыДокумента.Добавить(Истина, "ЭтоКартотека");
		
		ДатаДокументаКартотека = ЗначениеСвойстваXDTO(Документ, "DiffDoc.docDateCard");
		Если НЕ ДатаДокументаКартотека = Неопределено Тогда
			РеквизитыДокумента.Добавить(XMLЗначение(Тип("Дата"), ДатаДокументаКартотека), "ДатаОтсылкиДок");
		КонецЕсли;
		НомерДокументаКартотека = ЗначениеСвойстваXDTO(Документ, "DiffDoc.docNumberCard");
		РеквизитыДокумента.Добавить(НомерДокументаКартотека, "НомерДокументаКартотека");
		ШифрДокументаКартотека = ЗначениеСвойстваXDTO(Документ, "DiffDoc.docShifr");
		РеквизитыДокумента.Добавить(ШифрДокументаКартотека, "ШифрДокументаКартотека");
		СрокАкцепта = ЗначениеСвойстваXDTO(Документ, "DiffDoc.letterOfCreditAcceptDate");
		РеквизитыДокумента.Добавить(СрокАкцепта, "СрокАкцепта");
		ДополнУсловия = ЗначениеСвойстваXDTO(Документ, "DiffDoc.letterOfCreditAddCond");
		РеквизитыДокумента.Добавить(ДополнУсловия, "ДополнУсловия");
		ПлатежПоПредст = ЗначениеСвойстваXDTO(
			Документ, "DiffDoc.letterOfCreditDemandDocs");
		РеквизитыДокумента.Добавить(ПлатежПоПредст, "ПлатежПоПредст");
		НомерСчетаПоставщика = ЗначениеСвойстваXDTO(
			Документ, "DiffDoc.letterOfCreditPayAcc");
		РеквизитыДокумента.Добавить(НомерСчетаПоставщика, "НомерСчетаПоставщика");
		Условие1 = ЗначениеСвойстваXDTO(Документ, "DiffDoc.letterOfCreditPaymCond");
		РеквизитыДокумента.Добавить(Условие1, "Условие1");
		СрокПлатежа = ЗначениеСвойстваXDTO(Документ, "DiffDoc.letterOfCreditPeriodVal");
		РеквизитыДокумента.Добавить(СрокПлатежа, "СрокПлатежа");
		ВидАккредитива = ЗначениеСвойстваXDTO(Документ, "DiffDoc.docDateCard");
		РеквизитыДокумента.Добавить(ВидАккредитива, "ВидАккредитива");
		НомерПлатежа = ЗначениеСвойстваXDTO(Документ, "DiffDoc.NumPaymentCard");
		РеквизитыДокумента.Добавить(Документ.DiffDoc.NumPaymentCard, "НомерПлатежа");
		СодержаниеОперации = ЗначениеСвойстваXDTO(Документ, "DiffDoc.OperContent");
		РеквизитыДокумента.Добавить(СодержаниеОперации, "СодержаниеОперации");
		УсловиеОплаты = ЗначениеСвойстваXDTO(Документ, "DiffDoc.PayingCondition");
		РеквизитыДокумента.Добавить(УсловиеОплаты, "УсловиеОплаты");
		СуммаОстаткаПлатежа = ЗначениеСвойстваXDTO(Документ, "DiffDoc.SumRestCard");
		СуммаОстаткаПлатежа = ?(СуммаОстаткаПлатежа = Неопределено, СуммаОстаткаПлатежа, Число(СуммаОстаткаПлатежа));
		РеквизитыДокумента.Добавить(СуммаОстаткаПлатежа, "СуммаОстаткаПлатежа");
	Иначе
		РеквизитыДокумента.Добавить(Ложь, "ЭтоКартотека");
	КонецЕсли;
	
	Если Не ЗначениеСвойстваXDTO(Документ, "Cur") = Неопределено Тогда
		
		МассивРеквизитов = СлужебныеРеквизитыВыпискиСбербанк();
		Для Каждого Реквизит Из МассивРеквизитов Цикл
			Значение = ЗначениеСвойстваXDTO(Документ, "Cur." + Реквизит);
			РеквизитыДокумента.Добавить(Значение, Реквизит);
		КонецЦикла;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", РеквизитыДокумента);
	
КонецПроцедуры

Процедура СохранитьШтампыБанка(ВыпискаБанка)

	ДвоичныеДанныеЭД = ОбменСБанкамиСлужебныйВызовСервера.ДвоичныеДанныеПрисоединенногоФайла(ВыпискаБанка);
	
	СтруктураРазбораФайла = СформироватьДеревоРазбора(Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка, ДвоичныеДанныеЭД);
	
	ДеревоРазбора = СтруктураРазбораФайла.ДеревоРазбора;
	СтрокаОбъекта = СтруктураРазбораФайла.СтрокаОбъекта;
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		ДатаСписано = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
			ДеревоРазбора, СтрокаТЧ, "ДатаСписано");
		ШтампБанкаСтатус = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
			ДеревоРазбора, СтрокаТЧ, "ШтампБанкаСтатус");
		ИдПлатежа = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
			ДеревоРазбора, СтрокаТЧ, "ИдПлатежа");
		Если ЗначениеЗаполнено(ДатаСписано) И ЗначениеЗаполнено(ШтампБанкаСтатус) И ЗначениеЗаполнено(ИдПлатежа) Тогда
			ПлатежныйДокумент = Документы.СообщениеОбменСБанками.НайтиПоРеквизиту("Идентификатор", ИдПлатежа);
			Если ЗначениеЗаполнено(ПлатежныйДокумент) Тогда
				ШтампБанкаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
					ДеревоРазбора, СтрокаТЧ, "ШтампБанкаНаименование");
				ШтампБанкаОтделение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
					ДеревоРазбора, СтрокаТЧ, "ШтампБанкаОтделение");
				ШтампБанкаБИК = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
					ДеревоРазбора, СтрокаТЧ, "ШтампБанкаБИК");
				ДанныеШтампа = Новый Структура();
				ДанныеШтампа.Вставить("НаименованиеБанка", ШтампБанкаНаименование);
				ДанныеШтампа.Вставить("Отделение", ШтампБанкаОтделение);
				ДанныеШтампа.Вставить("БИК", ШтампБанкаБИК);
				ДанныеШтампа.Вставить("Статус", ШтампБанкаСтатус);
				ДанныеШтампа.Вставить("ДатаОперации", ДатаСписано);
				Штамп = Новый Структура("ДанныеШтампа", ДанныеШтампа);
				СтруктураИзменения = Новый Структура("ДополнительныеДанные", Штамп);
				ОбменСБанкамиСлужебныйВызовСервера.ИзменитьСообщениеОбмена(ПлатежныйДокумент, СтруктураИзменения);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла
	
КонецПроцедуры

Процедура ДобавитьОтпечаткиСертификатовСбербанка(МассивОтпечатков)
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СведенияОСертификатахОбменСБанками.СертификатЭП.Отпечаток КАК Отпечаток
	|ИЗ
	|	РегистрСведений.СведенияОСертификатахОбменСБанками КАК СведенияОСертификатахОбменСБанками
	|ГДЕ
	|	СведенияОСертификатахОбменСБанками.ПрограммаБанка = ЗНАЧЕНИЕ(Перечисление.ПрограммыБанка.СбербанкОнлайн)";
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		МассивОтпечатков.Добавить(Выборка.Отпечаток);
	КонецЦикла
	
КонецПроцедуры

Функция СообщенияОбменаТребующиеSMSПодтверждения(МассивСообщений)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СообщениеОбменСБанками.Ссылка
	               |ИЗ
	               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	               |ГДЕ
	               |	СообщениеОбменСБанками.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОбменСБанками.НеПодтвержден)
	               |	И СообщениеОбменСБанками.Ссылка В(&МассивСообщений)";
	Запрос.УстановитьПараметр("МассивСообщений", МассивСообщений);
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

// Возвращает выписки банка за период из информационной базы.
// Если не найдена выписка хоть за один из дней в периоде, то возвращается пустой массив.
//
// Параметры:
//   НастройкаОбмена - СправочникСсылка.НастройкаОбменСБанками - настройка обмена с банком;
//   МассивСчетов - Массив - в элементах - строки, содержащие номера счетов;
//   ДатаНачала - Дата - дата начала периода;
//   ДатаОкончания - Дата - дата окончания периода;
//
// Возвращаемое значение:
//   Массив - в элементах ДокументСсылка.СообщениеОбменСБанком - ссылки на банковские выписки.
//
Функция ГотовыеВыпискиСбербанка(Знач НастройкаОбмена, Знач МассивСчетов, Знач ДатаНачала, Знач ДатаОкончания, Знач ДатаЗапроса = Неопределено)
	
	МассивВозврата = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	СообщениеОбменСБанками.Ссылка КАК Ссылка,
	               |	СообщениеОбменСБанками.ДатаСообщения КАК ДатаВыпискиБанка,
	               |	СообщениеОбменСБанками.НомерСчета КАК НомерСчета
	               |ИЗ
	               |	Документ.СообщениеОбменСБанками КАК СообщениеОбменСБанками
	               |ГДЕ
	               |	СообщениеОбменСБанками.НастройкаОбмена = &НастройкаОбмена
	               |	И СообщениеОбменСБанками.ВидЭД = ЗНАЧЕНИЕ(Перечисление.ВидыЭДОбменСБанками.ВыпискаБанка)
	               |	И СообщениеОбменСБанками.НомерСчета В(&НомераБанковскихСчетов)
	               |	И СообщениеОбменСБанками.ДатаСообщения <= &ДатаОкончания
	               |	И СообщениеОбменСБанками.ДатаСообщения >= &ДатаНачала
	               |	И &УсловиеДатаЗапроса
	               |	И НЕ СообщениеОбменСБанками.ПометкаУдаления
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ДатаВыпискиБанка,
	               |	СообщениеОбменСБанками.НомерСчета УБЫВ,
	               |	СообщениеОбменСБанками.Дата УБЫВ";
	Запрос.УстановитьПараметр("НастройкаОбмена", НастройкаОбмена);
	Запрос.УстановитьПараметр("НомераБанковскихСчетов", МассивСчетов);
	Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
	Если ЗначениеЗаполнено(ДатаЗапроса) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеДатаЗапроса", "СообщениеОбменСБанками.Дата > &ДатаЗапроса");
		Запрос.УстановитьПараметр("ДатаЗапроса", ДатаЗапроса);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеДатаЗапроса", "ИСТИНА");
	КонецЕсли;

	Выборка = Запрос.Выполнить().Выбрать();
	
	ПредыдущаяДата = Неопределено;
	ПредыдущийНомерСчета = Неопределено;
	Пока Выборка.Следующий() Цикл
		Если ПредыдущаяДата = Выборка.ДатаВыпискиБанка И ПредыдущийНомерСчета = Выборка.НомерСчета Тогда
			Продолжить;
		КонецЕсли;
		ПредыдущаяДата = Выборка.ДатаВыпискиБанка;
		ПредыдущийНомерСчета = Выборка.НомерСчета;
		МассивВозврата.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	КоличествоСчетов = МассивСчетов.Количество();
	
	ТребуемоеКоличествоДней = (НачалоДня(ДатаОкончания) - ДатаНачала) / 60 / 60 / 24 * КоличествоСчетов
								+ 1 * КоличествоСчетов;
	
	Если ТребуемоеКоличествоДней <> МассивВозврата.Количество() Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	Возврат МассивВозврата;
	
КонецФункции

Функция ДанныеЗапросаВыпискиСбербанк(НастройкаОбмена, ДатаЗапроса, НомерСчета, ИдентификаторЗапроса)

	ПространствоИмен = "http://bssys.com/upg/request";
	
	ТекстОшибки = "";
	ЕстьОшибка  = Ложь;
	
	ИдентификаторЗапроса = Строка(Новый УникальныйИдентификатор);
	Операция = НСтр("ru = 'Формирование запроса выписки'");
	
	РеквизитыНастройкиОбмена = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(НастройкаОбмена, "Организация, Банк");
	
	Организация = РеквизитыНастройкиОбмена.Организация;
	Банк = РеквизитыНастройкиОбмена.Банк;
	
	StmtReqType = ОбъектТипаCML(ФабрикаXDTO, "StmtReqType", ПространствоИмен);
	ЗаполнитьСвойствоXDTO(StmtReqType, "docExtId", Строка(ИдентификаторЗапроса), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(StmtReqType, "createTime", ТекущаяДатаСеанса(), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(StmtReqType, "beginDate", НачалоДня(ДатаЗапроса), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(StmtReqType, "endDate", КонецДня(ДатаЗапроса), Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(StmtReqType, "stmtType", 101, Истина, ТекстОшибки);
	
	МенеджерЗаписи = РегистрыСведений.ПараметрыОбменСБанками.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.НастройкаОбмена = НастройкаОбмена;
	МенеджерЗаписи.Прочитать();
	МенеджерЗаписи.НомерЗапроса = МенеджерЗаписи.НомерЗапроса + 1;
	МенеджерЗаписи.НастройкаОбмена = НастройкаОбмена;
	МенеджерЗаписи.Записать();
	
	РеквизитСокращенноеНаименованиеОрганизации = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении(
		"СокращенноеНаименованиеОрганизации");
	Если НЕ ЗначениеЗаполнено(РеквизитСокращенноеНаименованиеОрганизации) Тогда
		РеквизитСокращенноеНаименованиеОрганизации = "Наименование";
	КонецЕсли;
	Наименование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Организация, РеквизитСокращенноеНаименованиеОрганизации);
	ЗаполнитьСвойствоXDTO(StmtReqType, "orgName", Наименование, , ТекстОшибки);
	
	Accounts = ОбъектТипаCML(ФабрикаXDTO, "StmtReqType.Accounts", ПространствоИмен);
	
	БИК = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Банк, "Код");
	
	Acc = ОбъектТипаCML(ФабрикаXDTO, "Acc", ПространствоИмен);
	ЗаполнитьСвойствоXDTO(Acc, "__content", НомерСчета, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Acc, "bic", БИК,  Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(Acc, "docNum", МенеджерЗаписи.НомерЗапроса, , ТекстОшибки);
	Accounts.Account.Добавить(Acc);
	
	ЗаполнитьСвойствоXDTO(StmtReqType, "Accounts", Accounts, Истина, ТекстОшибки);
	
	StmtReqType.Проверить();
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстСообщения = НСтр("ru = 'При формировании электронного документа произошла ошибка.
									|%1.'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			Операция, ТекстСообщения, , "ОбменСБанками", НастройкаОбмена);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	ДвоичныеДанныеЗапросаВыписки = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, StmtReqType);
	
	Возврат ДвоичныеДанныеЗапросаВыписки;

КонецФункции

Процедура ПолучитьДанныеИзСбербанка(НастройкаОбмена, ИдентификаторСессии, ИдентификаторОрганизации, МассивТикетов, МассивОтветов)
	
	ВидОперации = НСтр("ru = 'Получение документа из Сбербанка'");
	
	ТекстОшибки = "";
	
	WSПрокси = ОбменСБанкамиСлужебныйПовтИсп.WSПроксиСбербанк();
	
	ПолучениеСтатусаТип = WSПрокси.ФабрикаXDTO.Тип("http://upg.sbns.bssys.com/", "getRequestStatusSRP");
	ВыбранныйЭлемент = WSПрокси.ФабрикаXDTO.Создать(ПолучениеСтатусаТип);
	
	ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "sessionId", ИдентификаторСессии, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(ВыбранныйЭлемент, "orgId", ИдентификаторОрганизации, Истина, ТекстОшибки);
	
	Для Каждого Тикет Из МассивТикетов Цикл
		ВыбранныйЭлемент.requests.Добавить(Тикет);
	КонецЦикла;
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ШаблонСообщения = НСтр("ru = 'Ошибка формирования запроса статуса документа из Сбербанка:
									|%1'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, ТекстОшибки);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	ВыбранныйЭлемент.Проверить();
	
	Попытка
		XDTOРезультат = WSПрокси.getRequestStatusSRP(ВыбранныйЭлемент);
	Исключение
		ДобавитьЗаписьВЖурнал(НастройкаОбмена, "getRequestStatusSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
		ВызватьИсключение;
	КонецПопытки;
	
	ДобавитьЗаписьВЖурнал(НастройкаОбмена, "getRequestStatusSRP", WSПрокси.ФабрикаXDTO, ВыбранныйЭлемент, XDTOРезультат);
	
	МассивОтветов = Новый Массив;
	
	Для Каждого Ответ Из XDTOРезультат.return Цикл
		МассивОтветов.Добавить(Ответ);
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьПоручениеНаПереводВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docExtId);
	
	Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПереводВалюты");
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата", ЭД.DocData.docDate);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер", ЭД.DocData.docNum);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.НаименованиеМеждународное", ЭД.Payer_50.Name);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.РасчСчет", ЭД.Payer_50.AccDoc.accNum);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Страна.ISOКод", ЭД.Payer_50.Country.iso2);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Город", ЭД.Payer_50.Place);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Адрес", ЭД.Payer_50.Address);
		
	Если ЭД.BankPayer_52 <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлательщика.Банк.НаименованиеМеждународное", ЭД.BankPayer_52.Name);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.SWIFT", ЭД.BankPayer_52.BIC);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Адрес", ЭД.BankPayer_52.Address);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.НаименованиеМеждународное", ЭД.Beneficiar_59.Name);
	Если ЭД.Beneficiar_59.Country <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Страна.ISOКод", ЭД.Beneficiar_59.Country.iso2);
	КонецЕсли;
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Город", ЭД.Beneficiar_59.Place);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Адрес", ЭД.Beneficiar_59.Address);
	Если ЭД.Beneficiar_59.State <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Индекс", ЭД.Beneficiar_59.State.code);
	КонецЕсли;
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.РасчСчет", ЭД.Beneficiar_59.AccBeneficiar);
	
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПолучателя.Банк.НаименованиеМеждународное", ЭД.BankBeneficiar_57.Name);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.SWIFT", ЭД.BankBeneficiar_57.BIC);
	Если ЭД.BankBeneficiar_57.Country <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.ISOКод", ЭД.BankBeneficiar_57.Country.iso2);
	КонецЕсли;
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Адрес", ЭД.BankBeneficiar_57.Address);
	Если ЭД.BankBeneficiar_57.CliringCode <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.Банк.БИК", ЭД.BankBeneficiar_57.CliringCode.code);
	КонецЕсли;
	
	Если ЭД.ImediaBank_56 <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.SWIFT", ЭД.ImediaBank_56.BIC);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.НаименованиеМеждународное", ЭД.ImediaBank_56.Name);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаПеревода.ISOКодВалюты", ЭД.DocSum_33B.DocSumTransfer.currIsoCode);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаПеревода.Сумма", ЭД.DocSum_33B.DocSumTransfer.docSum);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа", ЭД.PaymentDetails_70);

	Если ЭД.VoSumInfo <> Неопределено И ЭД.VoSumInfo.VoInfo.Количество() Тогда
		ТаблицаКодовВидовОпераций = Новый ТаблицаЗначений;
		ТаблицаКодовВидовОпераций.Колонки.Добавить("КодВидаВалютнойОперации");
		ТаблицаКодовВидовОпераций.Колонки.Добавить("Сумма");
		ТаблицаКодовВидовОпераций.Колонки.Добавить("ISOКодВалюты");
		ТаблицаКодовВидовОпераций.Колонки.Добавить("НомерПаспортаСделки");
		Для Каждого КодВидаОперации Из ЭД.VoSumInfo.VoInfo Цикл
			СтрокаТаблицы = ТаблицаКодовВидовОпераций.Добавить();
			СтрокаТаблицы.КодВидаВалютнойОперации = КодВидаОперации.Vo;
			СтрокаТаблицы.Сумма = КодВидаОперации.Sum.docSum;
			СтрокаТаблицы.ISOКодВалюты = КодВидаОперации.Sum.currIsoCode;
			СтрокаТаблицы.НомерПаспортаСделки = КодВидаОперации.PsNum;
		КонецЦикла;
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(
			ДеревоДанных, ТаблицаКодовВидовОпераций, "КодыВидовВалютныхОпераций");
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ТипКомиссии", ЭД.Charge_71A.chargesParty);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДанных", ДеревоДанных);
	
КонецПроцедуры

Процедура ПрочитатьПоручениеНаПокупкуВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПокупкуВалюты;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docExtId);
	
	Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПокупкуВалюты");
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата", ЭД.DocData.docDate);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер", ЭД.DocData.docNum);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.Наименование", ЭД.DocData.OrgData.orgName);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН", ЭД.DocData.OrgData.inn);
	
	Если ЭД.DocData.AuthPers <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.ФИО", ЭД.DocData.AuthPers.Name);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Телефон", ЭД.DocData.AuthPers.Telfax);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СуммаПокупки.Сумма", ЭД.Trans.AmountTransf.SumBuy.docSum);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СуммаПокупки.ISOКодВалюты", ЭД.Trans.AmountTransf.SumBuy.currIsoCode);
	
	Если ЭД.Trans.TermBuy <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УсловияСделки", ЭД.Trans.TermBuy.DealType);
	КонецЕсли;
		
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.НомерСчета", ЭД.Trans.AccountNumTransf.accNum);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыЗачисления.Банк.Наименование", ЭД.Trans.AccountNumTransf.Bank.Name);
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДанных", ДеревоДанных);
	
КонецПроцедуры

Процедура ПрочитатьПоручениеНаПродажуВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПродажуВалюты;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docExtId);
	
	Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПродажуВалюты");
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата", ЭД.DocData.docDate);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер", ЭД.DocData.docNum);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.Наименование", ЭД.DocData.OrgData.orgName);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН", ЭД.DocData.OrgData.inn);
	
	Если ЭД.DocData.AuthPers <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.ФИО", ЭД.DocData.AuthPers.Name);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Телефон", ЭД.DocData.AuthPers.Telfax);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СуммаПродажи.Сумма", ЭД.Trans.SumSell.docSum);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СуммаПродажи.ISOКодВалюты", ЭД.Trans.SumSell.currIsoCode);
	
	Если ЭД.Trans.TermSell <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УсловияСделки", ЭД.Trans.TermSell.DealType);
	КонецЕсли;
		
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыСписания.НомерСчета", ЭД.Trans.AccountSell.accNum);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыСписания.Банк.Наименование", ЭД.Trans.AccountSell.Bank.Name);
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДанных", ДеревоДанных);
	
КонецПроцедуры

Процедура ПрочитатьРаспоряжениеНаОбязательнуюПродажуВалютыСбербанк(ЭД, ДеревоРазбора, НовыйЭД)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.РаспоряжениеНаОбязательнуюПродажуВалюты;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.docExtId);
	
	Макет = Обработки.ОбменСБанками.ПолучитьМакет("РаспоряжениеНаОбязательнуюПродажуВалюты");
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата", ЭД.DocData.docDate);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер", ЭД.DocData.docNum);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.Наименование", ЭД.DocData.OrgData.orgName);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН", ЭД.DocData.OrgData.inn);
	
	Если ЭД.DocData.AuthPers <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.ФИО", ЭД.DocData.AuthPers.Name);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Телефон", ЭД.DocData.AuthPers.Telfax);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.Сумма", ЭД.Advice.Doc.DocSum.docSum);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.ISOКодВалюты", ЭД.Advice.Doc.DocSum.currIsoCode);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.НомерДокумента", ЭД.Advice.Doc.DocData.docNum);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.ДатаДокумента", ЭД.Advice.Doc.DocData.docDate);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.НаименованиеБанка", ЭД.Advice.Doc.DocData.bankName);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТранзитныйСчет.НомерСчета", ЭД.AccDoc.AccNum);
	
	Если ЭД.Trans <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.НомерСчета", ЭД.Trans.AccTrans.accNum);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.НаименованиеБанка", ЭД.Trans.AccTrans.Bank.Name);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.SWIFT", ЭД.Trans.AccTrans.Bank.BankSWIFT);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.СуммаЗачисления.Сумма", ЭД.Trans.Sum.docSum);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.СуммаЗачисления.ISOКодВалюты", ЭД.Trans.Sum.currIsoCode);
	КонецЕсли;
	
	Если ЭД.Sell <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НеобязательнаяПродажа.Сумма", ЭД.Sell.Sum.docSum);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НеобязательнаяПродажа.ISOКодВалюты", ЭД.Sell.Sum.currIsoCode);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НеобязательнаяПродажа.УсловиеСделки", ЭД.Sell.DealType.DealType);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.НомерСчета", ЭД.Sell.Acc.accNum);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.Банк.Наименование", ЭД.Sell.Acc.Bank.Name);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.Банк.БИК", ЭД.Sell.Acc.Bank.bic);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.Банк.КоррСчет", ЭД.Sell.Acc.Bank.correspAcc);
	КонецЕсли;
		
	Если ЭД.Commis <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "КомиссионноеВознаграждение.Счет.НомерСчета", ЭД.Commis.ComAcc.accNum);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДанных", ДеревоДанных);
	
КонецПроцедуры

Процедура СформироватьПоручениеНаПереводВалютыСбербанк(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
		
	ПространствоИмен = "http://bssys.com/upg/request";
	ТекстОшибки = "";
	
	PayDocCur = ОбъектТипаCML(ФабрикаXDTO, "PayDocCur", ПространствоИмен);
		ИДДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
		ЗаполнитьСвойствоXDTO(PayDocCur, "docExtId", ИДДокумента, Истина, ТекстОшибки);
		ОбщиеРеквизитыПлатежногоДокумента = ОбъектТипаCML(ФабрикаXDTO, "PayDocCurDocData", ПространствоИмен);
			ДатаДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизитыПлатежногоДокумента, "docDate", ДатаДокумента, Истина, ТекстОшибки);
			НаименованиеБанкаПлательщика = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.Банк.НаименованиеМеждународное");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизитыПлатежногоДокумента, "bankName", НаименованиеБанкаПлательщика, , ТекстОшибки);
			БИКБанкаПлательщика = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.Банк.БИК");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизитыПлатежногоДокумента, "bankNum", БИКБанкаПлательщика, , ТекстОшибки);
			НомерДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизитыПлатежногоДокумента, "docNum", НомерДокумента, , ТекстОшибки);
			РеквизитыПлательщика = ОбъектТипаCML(ФабрикаXDTO, "OrgData", ПространствоИмен);
				КПППлательщика = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.КПП");
				ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "kpp", КПППлательщика, , ТекстОшибки);
				ИННПлательщика = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.ИНН");
				ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "inn", ИННПлательщика, , ТекстОшибки);
				НаименованиеПлательщика = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.Наименование");
				ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "orgName", НаименованиеПлательщика, , ТекстОшибки);
				НаименованиеПлательщикаМеждународное = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.НаименованиеМеждународное");
				ЗаполнитьСвойствоXDTO(
					РеквизитыПлательщика, "internationalName", НаименованиеПлательщикаМеждународное, , ТекстОшибки);
				ЗаполнитьСвойствоXDTO(РеквизитыПлательщика, "opf", НаименованиеПлательщикаМеждународное, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизитыПлатежногоДокумента, "OrgData", РеквизитыПлательщика, Истина, ТекстОшибки);
			Если ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник") = Истина Тогда
				УполномоченныйСотрудник = УполномоченныйСотрудникСбербанк(ДеревоДанных, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ОбщиеРеквизитыПлатежногоДокумента, "AuthPers", УполномоченныйСотрудник, , ТекстОшибки);
			КонецЕсли;
		ЗаполнитьСвойствоXDTO(PayDocCur, "DocData", ОбщиеРеквизитыПлатежногоДокумента, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "Urgent", "0", Истина, ТекстОшибки);
		Плательщик = ОбъектТипаCML(ФабрикаXDTO, "Payer_50", ПространствоИмен);
			СекцияСчетПлательщика = СчетСбербанк(ДеревоДанных, "РеквизитыПлательщика", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Плательщик, "AccDoc", СекцияСчетПлательщика, Истина, ТекстОшибки);
			МеждународноеНаименованиеПлательщика = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.НаименованиеМеждународное");
			ЗаполнитьСвойствоXDTO(Плательщик, "Name", МеждународноеНаименованиеПлательщика, Истина, ТекстОшибки);
			АдресПроизвольный = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.АдресПроизвольный");
			ЗаполнитьСвойствоXDTO(Плательщик, "Address", АдресПроизвольный, , ТекстОшибки);
			Город = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Город");
			ЗаполнитьСвойствоXDTO(Плательщик, "Place", Город, Истина, ТекстОшибки);
			СекцияСтрана = ОбъектТипаCML(ФабрикаXDTO, "Country", ПространствоИмен);
				КодСтраны = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Страна.КодСтраны");
				ЗаполнитьСвойствоXDTO(СекцияСтрана, "digital", КодСтраны, Истина, ТекстОшибки);
				ISOКодСтраны = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Страна.ISOКод");
				ЗаполнитьСвойствоXDTO(СекцияСтрана, "iso2", ISOКодСтраны, Истина, ТекстОшибки);
				НаименованиеСтраны = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Страна.Наименование");
				ЗаполнитьСвойствоXDTO(СекцияСтрана, "name", НаименованиеСтраны, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Плательщик, "Country", СекцияСтрана, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "Payer_50", Плательщик, Истина, ТекстОшибки);
		СекцияПоручение = ОбъектТипаCML(ФабрикаXDTO, "DocSum_33B", ПространствоИмен);
			СекцияВалютаИСуммаПеревода = СуммаСбербанк(ДеревоДанных, "ВалютаПеревода", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияПоручение, "DocSumTransfer", СекцияВалютаИСуммаПеревода, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияПоручение, "RateAgree", "0", Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "DocSum_33B", СекцияПоручение, Истина, ТекстОшибки);
		СекцияБенефициар = ОбъектТипаCML(ФабрикаXDTO, "Beneficiar_59", ПространствоИмен);
			СчетБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.РасчСчет");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "AccBeneficiar", СчетБенефициара, , ТекстОшибки);
			НаименованиеБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Наименование");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "Name", НаименованиеБенефициара, , ТекстОшибки);
			АдресПроизвольный = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресПроизвольный");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "Address", АдресПроизвольный, , ТекстОшибки);
			ГородБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Город");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "Place", ГородБенефициара, Истина, ТекстОшибки);
			СекцияСтранаБенефициара = ОбъектТипаCML(ФабрикаXDTO, "Country", ПространствоИмен);
				КодСтраныБенифициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Страна.КодСтраны");
				ЗаполнитьСвойствоXDTO(СекцияСтранаБенефициара, "digital", КодСтраныБенифициара, Истина, ТекстОшибки);
				ISOКодСтраныБенифициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Страна.ISOКод");
				ЗаполнитьСвойствоXDTO(СекцияСтранаБенефициара, "iso2", ISOКодСтраныБенифициара, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "Country", СекцияСтранаБенефициара, Истина, ТекстОшибки);
			НаименованиеСтраныБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Страна.Наименование");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "name", НаименованиеСтраныБенефициара, , ТекстОшибки);
			ИННБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.ИНН");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "Inn", ИННБенефициара, , ТекстОшибки);
			СВИФТКодБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.SWIFT");
			ЗаполнитьСвойствоXDTO(СекцияБенефициар, "BeiCode", СВИФТКодБанкаБенефициара, , ТекстОшибки);
			МеждународноеНаименованиеБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.НаименованиеМеждународное");
			ЗаполнитьСвойствоXDTO(
				СекцияБенефициар, "BankName", МеждународноеНаименованиеБанкаБенефициара, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "Beneficiar_59", СекцияБенефициар, Истина, ТекстОшибки);
		СекцияБанкПлательщика = ОбъектТипаCML(ФабрикаXDTO, "BankPayer_52", ПространствоИмен);
			СВИФТКодБанкаПлательщика = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.Банк.SWIFT");
			ЗаполнитьСвойствоXDTO(СекцияБанкПлательщика, "BIC", СВИФТКодБанкаПлательщика, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияБанкПлательщика, "NCode", БИКБанкаПлательщика, , ТекстОшибки);
			МеждународноеНаименованиеБанкаПлательщика = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.Банк.НаименованиеМеждународное");
			ЗаполнитьСвойствоXDTO(СекцияБанкПлательщика, "Name", МеждународноеНаименованиеБанкаПлательщика, , ТекстОшибки);
			АдресБанкаПлательщика = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.Банк.Адрес");
			ЗаполнитьСвойствоXDTO(СекцияБанкПлательщика, "Address", АдресБанкаПлательщика, , ТекстОшибки);
			ГородБанкаПлательщика = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлательщика.Банк.Город");
			ЗаполнитьСвойствоXDTO(СекцияБанкПлательщика, "Place", ГородБанкаПлательщика, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "BankPayer_52", СекцияБанкПлательщика, , ТекстОшибки);
		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.БанкПосредник") = Истина Тогда
			БанкПосредник = ОбъектТипаCML(ФабрикаXDTO, "ImediaBank_56", ПространствоИмен);
				SWIFTБанкаПосредника = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.SWIFT");
				ЗаполнитьСвойствоXDTO(БанкПосредник, "BIC", SWIFTБанкаПосредника, , ТекстОшибки);
				КлиринговыйКод = ОбъектТипаCML(ФабрикаXDTO, "CliringCode", ПространствоИмен);
					ISOКодСтраныБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Страна.ISOКод");
					ЗаполнитьСвойствоXDTO(БанкПосредник, "countryCode", ISOКодСтраныБанкаПосредника, , ТекстОшибки);
					НаименованиеБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Наименование");
					ЗаполнитьСвойствоXDTO(БанкПосредник, "name", НаименованиеБанкаПосредника, , ТекстОшибки);
					БИКБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.БИК");
					ЗаполнитьСвойствоXDTO(БанкПосредник, "code", БИКБанкаПосредника, , ТекстОшибки);
				ЗаполнитьСвойствоXDTO(БанкПосредник, "CliringCode", КлиринговыйКод, , ТекстОшибки);
				МеждународноеНаименованиеБанкаПосредника = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.НаименованиеМеждународное");
				ЗаполнитьСвойствоXDTO(БанкПосредник, "Name", МеждународноеНаименованиеБанкаПосредника, , ТекстОшибки);
				АдресБанкаПосредника = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Адрес");
				ЗаполнитьСвойствоXDTO(БанкПосредник, "Address", АдресБанкаПосредника, , ТекстОшибки);
				ГородБанкаПосредника = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Город");
				ЗаполнитьСвойствоXDTO(БанкПосредник, "Place", ГородБанкаПосредника, , ТекстОшибки);
				СтранаБанкаПосредника = ОбъектТипаCML(ФабрикаXDTO, "Country", ПространствоИмен);
					КодСтраныБанкаПосредника =  ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Страна.КодСтраны");
					ЗаполнитьСвойствоXDTO(БанкПосредник, "digital", КодСтраныБанкаПосредника, Истина, ТекстОшибки);
					ISOКодСтраныБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Страна.ISOКод");
					ЗаполнитьСвойствоXDTO(БанкПосредник, "iso2", ISOКодСтраныБанкаПосредника, Истина, ТекстОшибки);
					НаименованиеСтраныБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Страна.Наименование");
					ЗаполнитьСвойствоXDTO(БанкПосредник, "name", НаименованиеСтраныБанкаПосредника, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(БанкПосредник, "Country", СтранаБанкаПосредника, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(PayDocCur, "ImediaBank_56", БанкПосредник, , ТекстОшибки);
		КонецЕсли;
		БанкБенефициара = ОбъектТипаCML(ФабрикаXDTO, "BankBeneficiar_57", ПространствоИмен);
			SWIFTБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.SWIFT");
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "BIC", SWIFTБанкаБенефициара, , ТекстОшибки);
			КлиринговыйКод = ОбъектТипаCML(ФабрикаXDTO, "CliringCode", ПространствоИмен);
				ISOКодСтраныБанкаБенефициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.ISOКод");
				ЗаполнитьСвойствоXDTO(КлиринговыйКод, "countryCode", ISOКодСтраныБанкаБенефициара, , ТекстОшибки);
				НаименованиеСтраныБанкаБенефициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.Наименование");
				ЗаполнитьСвойствоXDTO(КлиринговыйКод, "name", НаименованиеСтраныБанкаБенефициара, , ТекстОшибки);
				БИКБанкаБенефициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.БИК");
				ЗаполнитьСвойствоXDTO(КлиринговыйКод, "code", БИКБанкаБенефициара, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "CliringCode", КлиринговыйКод, , ТекстОшибки);
			КоррСчетБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.КоррСчет");
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "CorrAcc", КоррСчетБанкаБенефициара, , ТекстОшибки);
			МеждународноеНаименованиеБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.НаименованиеМеждународное");
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "Name", МеждународноеНаименованиеБанкаБенефициара, , ТекстОшибки);
			АдресБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.Адрес");
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "Address", АдресБанкаБенефициара, , ТекстОшибки);
			ГородБанкаБенефициара = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.Город");
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "Place", ГородБанкаБенефициара, , ТекстОшибки);
			СтранаБанкаБенефициара = ОбъектТипаCML(ФабрикаXDTO, "Country", ПространствоИмен);
				КодСтраныБанкаБенефициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.КодСтраны");
				ЗаполнитьСвойствоXDTO(СтранаБанкаБенефициара, "digital", КодСтраныБанкаБенефициара, Истина, ТекстОшибки);
				ISOКодСтраныБанкаБенефициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.ISOКод");
				ЗаполнитьСвойствоXDTO(СтранаБанкаБенефициара, "iso2", ISOКодСтраныБанкаБенефициара, Истина, ТекстОшибки);
				НаименованиеСтраныБанкаБенефициара = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.ISOКод");
				ЗаполнитьСвойствоXDTO(СтранаБанкаБенефициара, "name", НаименованиеСтраныБанкаБенефициара, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(БанкБенефициара, "Country", СтранаБанкаБенефициара, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "BankBeneficiar_57", БанкБенефициара, Истина, ТекстОшибки);
		НазначениеПлатежа = ЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа");
		ЗаполнитьСвойствоXDTO(PayDocCur, "PaymentDetails_70", НазначениеПлатежа, Истина, ТекстОшибки);
		Комиссия = ОбъектТипаCML(ФабрикаXDTO, "Charge_71A", ПространствоИмен);
			ТипКомиссии = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПлатежа.ТипКомиссии");
			ЗаполнитьСвойствоXDTO(Комиссия, "chargesParty", ТипКомиссии, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(PayDocCur, "Charge_71A", Комиссия, Истина, ТекстОшибки);
		Опции = ОбъектТипаCML(ФабрикаXDTO, "PayDocCur.Options", ПространствоИмен);
		ЗаполнитьСвойствоXDTO(PayDocCur, "Options", Опции, Истина, ТекстОшибки);
	
		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "СправкаОВалютныхОперациях") = Истина Тогда
			СправкаОВалютныхОперациях = РеквизитыДокументаСбербанк(ДеревоДанных, "СправкаОВалютныхОперациях", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(PayDocCur, "CurrDealInquiry", СправкаОВалютныхОперациях, , ТекстОшибки);
		КонецЕсли;
	
		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "КодыВидовВалютныхОпераций") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыКодыВидовОпераций = ДеревоДанных.Строки.Найти("КодыВидовВалютныхОпераций", "ПолныйПуть");
			КодыВидовВалютныхОпераций = КодыВидовВалютныхОперацийСбербанк(СтрокаТаблицыКодыВидовОпераций, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(PayDocCur, "VoSumInfo", КодыВидовВалютныхОпераций, , ТекстОшибки);
		КонецЕсли;

		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "ОбосновывающиеДокументы") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыОбосновывающихДокументов = ДеревоДанных.Строки.Найти("ОбосновывающиеДокументы", "ПолныйПуть");
			ОбосновывающиеДокументы = ОбосновывающиеДокументыСбербанк(СтрокаТаблицыОбосновывающихДокументов, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(PayDocCur, "VoDocs", ОбосновывающиеДокументы, , ТекстОшибки);
		КонецЕсли;

		ПлатежВнутриСБРФ = (МеждународноеНаименованиеБанкаБенефициара = "SBERBANK") И (КодСтраныБанкаБенефициара = "643");
		Если ПлатежВнутриСБРФ Тогда
			ЗаполнитьСвойствоXDTO(PayDocCur, "PaymentDirection", "0", , ТекстОшибки);
		Иначе
			ЗаполнитьСвойствоXDTO(PayDocCur, "PaymentDirection", "1", , ТекстОшибки);
		КонецЕсли;
		
		ИнформацияДляРегулирующихОрганов = ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ИнформацияДляРегулирующихОрганов");
		ЗаполнитьСвойствоXDTO(PayDocCur, "B77Info", ИнформацияДляРегулирующихОрганов, , ТекстОшибки);
		
		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "КредитныйДоговор") = Истина Тогда
			КредитныйДоговор = ОбъектТипаCML(ФабрикаXDTO, "Credit", ПространствоИмен);
				ЦелевоеПоручение = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "КредитныйДоговор.ЦелевоеПоручение");
				ЗаполнитьСвойствоXDTO(
					КредитныйДоговор, "flagTargetAssignment", ?(ЦелевоеПоручение, "1", "0"), Истина, ТекстОшибки);
				ИспользоватьСобственныеСредства = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "КредитныйДоговор.ИспользоватьСобственныеСредства");
				ЗаполнитьСвойствоXDTO(
					КредитныйДоговор, "flagTargetAssignment", ?(ИспользоватьСобственныеСредства, "1", "0"), Истина, ТекстОшибки);
				НомерДоговора = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "КредитныйДоговор.НомерДоговора");
				ЗаполнитьСвойствоXDTO(КредитныйДоговор, "CredConNum", НомерДоговора, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(PayDocCur, "Credit", КредитныйДоговор, , ТекстОшибки);
		КонецЕсли;
		
		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "КодыИнструкций") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыКодыИнструкций = ДеревоДанных.Строки.Найти("КодыИнструкций", "ПолныйПуть");
			КодыИнструкций = ОбъектТипаCML(ФабрикаXDTO, "PayDocCur.Codes23e", ПространствоИмен);
			Для Каждого ТекущийКодИнструкции Из СтрокаТаблицыКодыИнструкций.Строки Цикл
				КодИнструкции = ОбъектТипаCML(ФабрикаXDTO, "PayDocCur.Codes23e.Code23e", ПространствоИмен);
					ОписаниеИнструкции = ЗначениеРеквизитаВДереве(
						ТекущийКодИнструкции, "КодыИнструкций.НомерСтроки.Описание");
					ЗаполнитьСвойствоXDTO(КодИнструкции, "Instr23EInfo", ОписаниеИнструкции, , ТекстОшибки);
					КодИнструкции = ЗначениеРеквизитаВДереве(
						ТекущийКодИнструкции, "КодыИнструкций.НомерСтроки.КодИнструкции");
					ЗаполнитьСвойствоXDTO(КодИнструкции, "Code", КодИнструкции, Истина, ТекстОшибки);
				КодыИнструкций.Code23e.Добавить(КодИнструкции);
			КонецЦикла;
			ЗаполнитьСвойствоXDTO(PayDocCur, "Codes23e", КодыИнструкций, , ТекстОшибки);
		КонецЕсли;

		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПрисоединенныеФайлы") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыПрисоединенныеФайлы = ДеревоДанных.Строки.Найти("ПрисоединенныеФайлы", "ПолныйПуть");
			СекцияПрисоединенныеФайлы = ПриложенныеДокументыСбербанк(СтрокаТаблицыПрисоединенныеФайлы, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(PayDocCur, "Attachments", СекцияПрисоединенныеФайлы, , ТекстОшибки);
		КонецЕсли;
		
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки
	Иначе
		ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, PayDocCur);
		АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	КонецЕсли;
	
	PayDocCur.Проверить();
	
КонецПроцедуры

Процедура СформироватьПоручениеНаПокупкуВалютыСбербанк(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
		
	ПространствоИмен = "http://bssys.com/upg/request";
	ТекстОшибки = "";
	
	CurrBuy = ОбъектТипаCML(ФабрикаXDTO, "CurrBuy", ПространствоИмен);
		ИДДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
		ЗаполнитьСвойствоXDTO(CurrBuy, "docExtId", ИДДокумента, Истина, ТекстОшибки);
		ОбщиеРеквизиты = ОбъектТипаCML(ФабрикаXDTO, "CurrComDocData", ПространствоИмен);
			ДатаДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docDate", ДатаДокумента, Истина, ТекстОшибки);
			НомерДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docNum", НомерДокумента, Истина, ТекстОшибки);
			РеквизитыОрганизации = ОбъектТипаCML(ФабрикаXDTO, "OrgData", ПространствоИмен);
				НаименованиеОрганизации = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.Наименование");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "orgName", НаименованиеОрганизации, Истина, ТекстОшибки);
				ИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "inn", ИНН, Истина, ТекстОшибки);
				КПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.КПП");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "kpp", КПП, , ТекстОшибки);
				ОКПО = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ОКПО");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "okpo", ОКПО, , ТекстОшибки);
				НаименованиеМеждународное = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОрганизации.НаименованиеМеждународное");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "internationalName", НаименованиеМеждународное, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "OrgData", РеквизитыОрганизации, Истина, ТекстОшибки);
			Если ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник") = Истина Тогда
				УполномоченныйСотрудник = УполномоченныйСотрудникСбербанк(ДеревоДанных, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "AuthPers", УполномоченныйСотрудник, , ТекстОшибки);
			КонецЕсли;
		ЗаполнитьСвойствоXDTO(CurrBuy, "DocData", ОбщиеРеквизиты, Истина, ТекстОшибки);
		Сделка = ОбъектТипаCML(ФабрикаXDTO, "CurrBuyTrans", ПространствоИмен);
			РасчетныйСчетСписанияСредств = ОбъектТипаCML(ФабрикаXDTO, "CurrBuyTrans.Acc", ПространствоИмен);
				НомерСчетаСписанияСредств = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыСписания.НомерСчета");
				ЗаполнитьСвойствоXDTO(РасчетныйСчетСписанияСредств, "account", НомерСчетаСписанияСредств, Истина, ТекстОшибки);
				БИКБанкаСписанияСредств = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыСписания.Банк.БИК");
				ЗаполнитьСвойствоXDTO(РасчетныйСчетСписанияСредств, "bic", БИКБанкаСписанияСредств, Истина, ТекстОшибки);
				НаименованиеБанкаСписанияСредств = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыСписания.Банк.Наименование");
				ЗаполнитьСвойствоXDTO(
					РасчетныйСчетСписанияСредств, "BankName", НаименованиеБанкаСписанияСредств, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "Acc", РасчетныйСчетСписанияСредств, Истина, ТекстОшибки);
			СекцияСуммаПокупки = ОбъектТипаCML(ФабрикаXDTO, "CurrBuyTrans.AmountTransf", ПространствоИмен);
				СуммаПокупки = СуммаСбербанк(ДеревоДанных, "СуммаПокупки", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияСуммаПокупки, "SumBuy", СуммаПокупки, , ТекстОшибки);
				Если ЗначениеРеквизитаВДереве(ДеревоДанных, "СредстваПокупки") = Истина Тогда
					СуммаСредств = СуммаСбербанк(ДеревоДанных, "СредстваПокупки", ТекстОшибки);
					ЗаполнитьСвойствоXDTO(СекцияСуммаПокупки, "SumThrough", СуммаСредств, , ТекстОшибки);
				КонецЕсли;
			ЗаполнитьСвойствоXDTO(Сделка, "AmountTransf", СекцияСуммаПокупки, Истина, ТекстОшибки);
			УсловияПокупки = ОбъектТипаCML(ФабрикаXDTO, "TermDeal", ПространствоИмен);
				УсловияСделки = ЗначениеРеквизитаВДереве(ДеревоДанных, "УсловияСделки");
				ЗаполнитьСвойствоXDTO(УсловияПокупки, "DealType", УсловияСделки, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "TermBuy", УсловияПокупки, , ТекстОшибки);
			РеквизитыЗачисленияВалюты = ОбъектТипаCML(ФабрикаXDTO, "CurrBuyTrans.AccountNumTransf", ПространствоИмен);
				СчетЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.НомерСчета");
				ЗаполнитьСвойствоXDTO(РеквизитыЗачисленияВалюты, "accNum", СчетЗачисления, Истина, ТекстОшибки);
				БанкЗачисления = ОбъектТипаCML(ФабрикаXDTO, "AccCurrBank", ПространствоИмен);
					БИКБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.Банк.БИК");
					ЗаполнитьСвойствоXDTO(БанкЗачисления, "bic", БИКБанкаЗачисления, , ТекстОшибки);
					КоррСчетБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.Банк.КоррСчет");
					ЗаполнитьСвойствоXDTO(БанкЗачисления, "correspAcc", КоррСчетБанкаЗачисления, , ТекстОшибки);
					НаименованиеБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.Банк.Наименование");
					ЗаполнитьСвойствоXDTO(БанкЗачисления, "Name", НаименованиеБанкаЗачисления, Истина, ТекстОшибки);
					SWIFTБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.Банк.SWIFT");
					ЗаполнитьСвойствоXDTO(БанкЗачисления, "BankSWIFT", SWIFTБанкаЗачисления, , ТекстОшибки);
				ЗаполнитьСвойствоXDTO(РеквизитыЗачисленияВалюты, "Bank", БанкЗачисления, Истина, ТекстОшибки);
				ТипЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыЗачисления.ТипЗачисления");
				ЗаполнитьСвойствоXDTO(РеквизитыЗачисленияВалюты, "type", ТипЗачисления, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "AccountNumTransf", РеквизитыЗачисленияВалюты, Истина, ТекстОшибки);
			СекцияСредстваПокупки = ОбъектТипаCML(ФабрикаXDTO, "CurrBuyTrans.PayDocBuy", ПространствоИмен);
				ИсточникСредствНаПокупку = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИсточникСредствНаПокупку.Счет");
					Если ИсточникСредствНаПокупку = "СчетСписания" Тогда
						СчетСписания = ОбъектТипаCML(ФабрикаXDTO, "DocAccount", ПространствоИмен);
							НомерСчетаСписания = ЗначениеРеквизитаВДереве(
								ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетСписания.НомерСчета");
							ЗаполнитьСвойствоXDTO(СчетСписания, "accNum", НомерСчетаСписания, Истина, ТекстОшибки);
							БИКБанкаСписания = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетСписания.БИК");
							ЗаполнитьСвойствоXDTO(СчетСписания, "bic", БИКБанкаСписания, Истина, ТекстОшибки);
							НаименованиеБанкаСписания = ЗначениеРеквизитаВДереве(
								ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетСписания.НаименованиеБанка");
							ЗаполнитьСвойствоXDTO(СчетСписания, "BankName", НаименованиеБанкаСписания, Истина, ТекстОшибки);
						ЗаполнитьСвойствоXDTO(СекцияСредстваПокупки, "DocAccount", СчетСписания, Истина, ТекстОшибки);
					Иначе
						СчетПеречисления = ОбъектТипаCML(ФабрикаXDTO, "AccountRub", ПространствоИмен);
							СчетПеречисленияНаПокупку = ЗначениеРеквизитаВДереве(
								ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку");
							Если СчетПеречисленияНаПокупку = "Счет" Тогда
								РеквизитыСчетаПеречисления = ОбъектТипаCML(ФабрикаXDTO, "AccountRub.Account", ПространствоИмен);
									НомерСчетаПеречисления = ЗначениеРеквизитаВДереве(
										ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку.Счет.НомерСчета");
									ЗаполнитьСвойствоXDTO(РеквизитыСчетаПеречисления, "accNum", НомерСчетаПеречисления, Истина, ТекстОшибки);
									БИКБанкаПеречисления = ЗначениеРеквизитаВДереве(
										ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку.Счет.БИК");
									ЗаполнитьСвойствоXDTO(РеквизитыСчетаПеречисления, "bic", БИКБанкаПеречисления, Истина, ТекстОшибки);
									НаименованиеБанкаПеречисления = ЗначениеРеквизитаВДереве(
										ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку.Счет.НаименованиеБанка");
									ЗаполнитьСвойствоXDTO(
										РеквизитыСчетаПеречисления, "BankName", НаименованиеБанкаПеречисления, Истина, ТекстОшибки);
								ЗаполнитьСвойствоXDTO(СчетПеречисления, "Account", РеквизитыСчетаПеречисления, Истина, ТекстОшибки);
							Иначе
								РеквизитыДокументаПеречисления = ОбъектТипаCML(ФабрикаXDTO, "AccountRub.Doc", ПространствоИмен);
									ТипДокумента = ЗначениеРеквизитаВДереве(
										ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку.ПлатежноеПоручение.ТипДокумента");
									ЗаполнитьСвойствоXDTO(РеквизитыДокументаПеречисления, "docType", ТипДокумента, Истина, ТекстОшибки);
									НомерДокумента = ЗначениеРеквизитаВДереве(
										ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку.ПлатежноеПоручение.Номер");
									ЗаполнитьСвойствоXDTO(РеквизитыДокументаПеречисления, "docNum", НомерДокумента, Истина, ТекстОшибки);
									ДатаДокумента = ЗначениеРеквизитаВДереве(
										ДеревоДанных, "ИсточникСредствНаПокупку.Счет.СчетПеречисленияНаПокупку.ПлатежноеПоручение.Дата");
									ЗаполнитьСвойствоXDTO(РеквизитыДокументаПеречисления, "docDate", ДатаДокумента, Истина, ТекстОшибки);
								ЗаполнитьСвойствоXDTO(СчетПеречисления, "Doc", РеквизитыДокументаПеречисления, Истина, ТекстОшибки);
							КонецЕсли;
							ЗаполнитьСвойствоXDTO(СчетПеречисления, "Doc", РеквизитыДокументаПеречисления, Истина, ТекстОшибки);
						ЗаполнитьСвойствоXDTO(СекцияСредстваПокупки, "RecAccount", СчетПеречисления, , ТекстОшибки);
					КонецЕсли;
				ТипСписания = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыСписания.ТипСписания");
				ЗаполнитьСвойствоXDTO(СекцияСредстваПокупки, "type", ТипСписания, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "PayDocBuy", СекцияСредстваПокупки, Истина, ТекстОшибки);
			КомиссионноеВознаграждение = КомиссионноеВознаграждениеСбербанк(ДеревоДанных, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Сделка, "Commis", КомиссионноеВознаграждение, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(CurrBuy, "Trans", Сделка, Истина, ТекстОшибки);
		СоглашениеСБанком = ЗначениеРеквизитаВДереве(ДеревоДанных, "СоглашениеСБанком");
		ЗаполнитьСвойствоXDTO(CurrBuy, "BankAgreement", СоглашениеСБанком, , ТекстОшибки);
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки
	КонецЕсли;
	
	CurrBuy.Проверить();
		
	ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, CurrBuy);
	АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	
КонецПроцедуры

Процедура СформироватьРаспоряжениеНаОбязательнуюПродажуВалютыСбербанк(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	ТекстОшибки = "";
	
	MandatorySale = ОбъектТипаCML(ФабрикаXDTO, "MandatorySale", ПространствоИмен);
		ИДДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
		ЗаполнитьСвойствоXDTO(MandatorySale, "docExtId", ИДДокумента, Истина, ТекстОшибки);
			ОбщиеРеквизиты = ОбъектТипаCML(ФабрикаXDTO, "ComDocData", ПространствоИмен);
			ДатаДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docDate", ДатаДокумента, Истина, ТекстОшибки);
			НомерДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docNum", НомерДокумента, Истина, ТекстОшибки);
			РеквизитыОрганизации = ОбъектТипаCML(ФабрикаXDTO, "OrgData", ПространствоИмен);
				НаименованиеОрганизации = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОрганизации.Наименование");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "orgName", НаименованиеОрганизации, Истина, ТекстОшибки);
				ИНН = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "inn", ИНН, Истина, ТекстОшибки);
				КПП = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.КПП");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "kpp", КПП, , ТекстОшибки);
				ОКПО = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ОКПО");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "okpo", ОКПО, , ТекстОшибки);
				НаименованиеМеждународное = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОрганизации.НаименованиеМеждународное");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "internationalName", НаименованиеМеждународное, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "OrgData", РеквизитыОрганизации, Истина, ТекстОшибки);
			Если ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник") = Истина Тогда
				УполномоченныйСотрудник = УполномоченныйСотрудникСбербанк(ДеревоДанных, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "AuthPers", УполномоченныйСотрудник, , ТекстОшибки);
			КонецЕсли;
		ЗаполнитьСвойствоXDTO(MandatorySale, "DocData", ОбщиеРеквизиты, Истина, ТекстОшибки);
		РеквизитыТранзитногоСчета = ОбъектТипаCML(ФабрикаXDTO, "AccountRU", ПространствоИмен);
			НомерТранзитногоСчета = ЗначениеРеквизитаВДереве(ДеревоДанных, "ТранзитныйСчет.НомерСчета");
			ЗаполнитьСвойствоXDTO(РеквизитыТранзитногоСчета, "AccNum", НомерТранзитногоСчета, , ТекстОшибки);
			РеквизитыТранзитногоБанка = БанкСбербанк(ДеревоДанных, "ТранзитныйСчет.Банк", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(РеквизитыТранзитногоСчета, "Bank", РеквизитыТранзитногоБанка, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(MandatorySale, "AccDoc", РеквизитыТранзитногоСчета, Истина, ТекстОшибки);
		Уведомление = ОбъектТипаCML(ФабрикаXDTO, "MandatorySale.Advice", ПространствоИмен);
			ДокументУведомления = ОбъектТипаCML(ФабрикаXDTO, "MandatorySale.Advice.Doc", ПространствоИмен);
				ОсновныеДанныеУведомления = ОбъектТипаCML(ФабрикаXDTO, "DocData", ПространствоИмен);
					НаименованиеБанкаВУведомлении = ЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.НаименованиеБанка");
					ЗаполнитьСвойствоXDTO(ОсновныеДанныеУведомления, "bankName", НаименованиеБанкаВУведомлении, , ТекстОшибки);
					НомерДокументаУведомления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.НомерДокумента");
					ЗаполнитьСвойствоXDTO(ОсновныеДанныеУведомления, "docNum", НомерДокументаУведомления, Истина, ТекстОшибки);
					ДатаДокументаУведомления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.ДатаДокумента");
					ЗаполнитьСвойствоXDTO(ОсновныеДанныеУведомления, "docDate", ДатаДокументаУведомления, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ДокументУведомления, "DocData", ОсновныеДанныеУведомления, Истина, ТекстОшибки);
				СекцияСуммаУведомления = СуммаСбербанк(ДеревоДанных, "Уведомление", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ДокументУведомления, "DocSum", СекцияСуммаУведомления, Истина, ТекстОшибки);
				КодОперации = ЗначениеРеквизитаВДереве(ДеревоДанных, "Уведомление.КодОперации");
				ЗаполнитьСвойствоXDTO(ДокументУведомления, "OperCode", КодОперации, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Уведомление, "Doc", ДокументУведомления, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(MandatorySale, "Advice", Уведомление, Истина, ТекстОшибки);
		ОбщаяСуммаПоступившихСредств = СуммаСбербанк(ДеревоДанных, "ОбщаяСуммаПоступившихСредств", ТекстОшибки);
		ЗаполнитьСвойствоXDTO(MandatorySale, "TotalSum", ОбщаяСуммаПоступившихСредств, Истина, ТекстОшибки);
		Вычет = ОбъектТипаCML(ФабрикаXDTO, "MandatorySale.Subtract", ПространствоИмен);
			СекцияСуммаВычета = СуммаСбербанк(ДеревоДанных, "Вычет", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Вычет, "Sum", СекцияСуммаВычета, Истина, ТекстОшибки);
			Обоснование = ЗначениеРеквизитаВДереве(ДеревоДанных, "Вычет.Обоснование");
			ЗаполнитьСвойствоXDTO(Вычет, "Substantiation", Обоснование, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(MandatorySale, "Subtract", Вычет, Истина, ТекстОшибки);
		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "НеобязательнаяПродажа") = Истина Тогда
			НеОбязательнаяПродажа = ОбъектТипаCML(ФабрикаXDTO, "MandatorySale.Sell", ПространствоИмен);
				ТипСделки = ОбъектТипаCML(ФабрикаXDTO, "TermDealTypeRequired", ПространствоИмен);
					УсловияПродажи = ЗначениеРеквизитаВДереве(ДеревоДанных, "НеобязательнаяПродажа.УсловиеСделки");
					ЗаполнитьСвойствоXDTO(ТипСделки, "DealType", УсловияПродажи, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(НеОбязательнаяПродажа, "DealType", УсловияПродажи, Истина, ТекстОшибки);
				СекцияСумма = СуммаСбербанк(ДеревоДанных, "НеобязательнаяПродажа", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(НеОбязательнаяПродажа, "Sum", СекцияСумма, Истина, ТекстОшибки);
				РеквизитыЗачисления = ОбъектТипаCML(ФабрикаXDTO, "OurRubAccountTypeRequired", ПространствоИмен);
					БанкЗачисления = БанкСбербанк(ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.Банк", ТекстОшибки);
					ЗаполнитьСвойствоXDTO(РеквизитыЗачисления, "Bank", СекцияСумма, Истина, ТекстОшибки);
					НомерСчетаЗачисления = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.НомерСчета");
					ЗаполнитьСвойствоXDTO(РеквизитыЗачисления, "accNum", НомерСчетаЗачисления, Истина, ТекстОшибки);
					ТипЗачисления = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "НеобязательнаяПродажа.СчетЗачисленияОтПродажи.Тип");
					ЗаполнитьСвойствоXDTO(РеквизитыЗачисления, "type", ТипЗачисления, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(НеОбязательнаяПродажа, "Acc", РеквизитыЗачисления, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "Sell", НеОбязательнаяПродажа, , ТекстОшибки);
		КонецЕсли;
		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление") = Истина Тогда
			Зачисление = ОбъектТипаCML(ФабрикаXDTO, "MandatorySale.Trans", ПространствоИмен);
				ЗаполнитьСвойствоXDTO(Зачисление, "flagNSPut", "1", , ТекстОшибки);
				ЗачислитьНа = ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.ЗачислитьНа");
				ЗаполнитьСвойствоXDTO(Зачисление, "transTo", ЗачислитьНа, , ТекстОшибки);
				РеквизитыСчета = ОбъектТипаCML(ФабрикаXDTO, "AccountCurrType", ПространствоИмен);
					НомерСчетаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.НомерСчета");
					ЗаполнитьСвойствоXDTO(РеквизитыСчета, "accNum", НомерСчетаЗачисления, Истина, ТекстОшибки);
					РеквизитыБанка = ОбъектТипаCML(ФабрикаXDTO, "AccountCurrType.Bank", ПространствоИмен);
						БИКБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.БИКБанка");
						ЗаполнитьСвойствоXDTO(РеквизитыБанка, "bic", БИКБанкаЗачисления, , ТекстОшибки);
						КоррСчетБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.КоррСчетБанка");
						ЗаполнитьСвойствоXDTO(РеквизитыБанка, "correspAcc", КоррСчетБанкаЗачисления, , ТекстОшибки);
						НаименованиеБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.НаименованиеБанка");
						ЗаполнитьСвойствоXDTO(РеквизитыБанка, "Name", НаименованиеБанкаЗачисления, Истина, ТекстОшибки);
						SWIFTБанкаЗачисления = ЗначениеРеквизитаВДереве(ДеревоДанных, "Зачисление.SWIFT");
						ЗаполнитьСвойствоXDTO(РеквизитыБанка, "BankSWIFT", SWIFTБанкаЗачисления, , ТекстОшибки);
					ЗаполнитьСвойствоXDTO(РеквизитыСчета, "Bank", РеквизитыБанка, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(Зачисление, "AccTrans", РеквизитыСчета, Истина, ТекстОшибки);
				СуммаЗачисления = СуммаСбербанк(ДеревоДанных, "Зачисление.СуммаЗачисления", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(Зачисление, "Sum", СуммаЗачисления, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "Trans", Зачисление, , ТекстОшибки);
		КонецЕсли;
		Если ЗначениеЗаполнено(ЗначениеРеквизитаВДереве(ДеревоДанных, "КомиссионноеВознаграждение")) Тогда
			КомиссионноеВознаграждение = КомиссионноеВознаграждениеСбербанк(ДеревоДанных, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "Commis", КомиссионноеВознаграждение, , ТекстОшибки);
		КонецЕсли;
		Если ЗначениеЗаполнено(ЗначениеРеквизитаВДереве(ДеревоДанных, "СправкаОВалютнойОперации")) Тогда
			СправкаОВалютнойОперации = РеквизитыДокументаСбербанк(ДеревоДанных, "СправкаОВалютнойОперации", ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "CurrDealInquiry", СправкаОВалютнойОперации, Истина, ТекстОшибки);
		КонецЕсли;
		
		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "КодыВидовВалютныхОпераций") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыКодыВидовОпераций = ДеревоДанных.Строки.Найти("КодыВидовВалютныхОпераций", "ПолныйПуть");
			КодыВидовВалютныхОпераций = КодыВидовВалютныхОперацийСбербанк(СтрокаТаблицыКодыВидовОпераций, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "VoSumInfo", КодыВидовВалютныхОпераций, , ТекстОшибки);
		КонецЕсли;

		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "ОбосновывающиеДокументы") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыОбосновывающихДокументов = ДеревоДанных.Строки.Найти("ОбосновывающиеДокументы", "ПолныйПуть");
			ОбосновывающиеДокументы = ОбосновывающиеДокументыСбербанк(СтрокаТаблицыОбосновывающихДокументов, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "VoDocs", ОбосновывающиеДокументы, , ТекстОшибки);
		КонецЕсли;
		
		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПрисоединенныеФайлы") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыПрисоединенныеФайлы = ДеревоДанных.Строки.Найти("ПрисоединенныеФайлы", "ПолныйПуть");
			СекцияПрисоединенныеФайлы = ПриложенныеДокументыСбербанк(СтрокаТаблицыПрисоединенныеФайлы, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(MandatorySale, "Attachments", СекцияПрисоединенныеФайлы, , ТекстОшибки);
		КонецЕсли;
		
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки
	КонецЕсли;
	
	MandatorySale.Проверить();
	
	ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, MandatorySale);
	АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	
КонецПроцедуры

Процедура СформироватьСправкуОПодтверждающихДокументахСбербанк(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	ТекстОшибки = "";
	
	ConfDocCertificate138I = ОбъектТипаCML(ФабрикаXDTO, "ConfDocCertificate138I", ПространствоИмен);
		ИДДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
		ЗаполнитьСвойствоXDTO(ConfDocCertificate138I, "docExtId", ИДДокумента, Истина, ТекстОшибки);
		ОбщиеРеквизиты = ОбъектТипаCML(ФабрикаXDTO, "DocDataConf181I", ПространствоИмен);
			ДатаДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docDate", ДатаДокумента, Истина, ТекстОшибки);
			НомерДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "docNum", НомерДокумента, Истина, ТекстОшибки);
			ДатаСправки = ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаСправки");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "statementFrom", ДатаСправки, Истина, ТекстОшибки);
			НаименованиеПодразделенияБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "НаименованиеПодразделенияБанка");
			ЗаполнитьСвойствоXDTO(
				ОбщиеРеквизиты, "branchSystemName", НаименованиеПодразделенияБанка, Истина, ТекстОшибки);
			НаименованиеБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "НаименованиеБанка");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "authBankName", НаименованиеБанка, , ТекстОшибки);
			БИКУполномоченногоБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "БИКУполномоченногоБанка");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "authBankBIC", БИКУполномоченногоБанка, , ТекстОшибки);
			РеквизитыОрганизации = ОбъектТипаCML(ФабрикаXDTO, "OrgDataCC", ПространствоИмен);
				ИННОрганизации = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ИНН");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "inn", ИННОрганизации, Истина, ТекстОшибки);
				НаименованиеОрганизации = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.Наименование");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "orgName", НаименованиеОрганизации, Истина, ТекстОшибки);
				ОКПО = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОрганизации.ОКПО");
				ЗаполнитьСвойствоXDTO(РеквизитыОрганизации, "okpo", ОКПО, , ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "OrgData", РеквизитыОрганизации, Истина, ТекстОшибки);
			НомерПаспортаСделки = ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерПаспортаСделки");
			ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "ContractNum", НомерПаспортаСделки, Истина, ТекстОшибки);
			Если ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник") = Истина Тогда
				УполномоченныйСотрудник = УполномоченныйСотрудникСбербанк(ДеревоДанных, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(ОбщиеРеквизиты, "AuthPers", УполномоченныйСотрудник, , ТекстОшибки);
			КонецЕсли;
		ЗаполнитьСвойствоXDTO(ConfDocCertificate138I, "DocData", ОбщиеРеквизиты, Истина, ТекстОшибки);
		
		СтрокиПодтверждающиеДокументы = ДеревоДанных.Строки.Найти("ПодтверждающиеДокументы", "ПолныйПуть");
		ПодтверждающийДокумент = ОбъектТипаCML(ФабрикаXDTO, "ConfDocCertificateDoc181I", ПространствоИмен);
		Для Каждого ТекущийДокумент Из СтрокиПодтверждающиеДокументы.Строки Цикл
			СекцияПодтверждающегоДокумента = ОбъектТипаCML(ФабрикаXDTO, "ConfDocCertificateDoc138I", ПространствоИмен);
				НомерСтроки = ЗначениеРеквизитаВДереве(ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки");
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "lineNumber", НомерСтроки, , ТекстОшибки);
				АтрибутыПодтверждающегоДокумента = ОбъектТипаCML(ФабрикаXDTO, "ConfDoc", ПространствоИмен);
					НомерДокумента = ЗначениеРеквизитаВДереве(ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.НомерДокумента");
					ЗаполнитьСвойствоXDTO(АтрибутыПодтверждающегоДокумента, "num", НомерДокумента, , ТекстОшибки);
					ЗаполнитьСвойствоXDTO(
						АтрибутыПодтверждающегоДокумента, "numCheck", ?(ЗначениеЗаполнено(НомерДокумента),"0", "1"), , ТекстОшибки);
					ДатаДокумента = ЗначениеРеквизитаВДереве(ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.ДатаДокумента");
					ЗаполнитьСвойствоXDTO(АтрибутыПодтверждающегоДокумента, "date", ДатаДокумента, , ТекстОшибки);
				ЗаполнитьСвойствоXDTO(
					СекцияПодтверждающегоДокумента, "ConfDoc", АтрибутыПодтверждающегоДокумента, , ТекстОшибки);
				КодВидаПодтверждающегоДокумента = ЗначениеРеквизитаВДереве(
					ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.КодВидаПодтверждающегоДокумента");
				ЗаполнитьСвойствоXDTO(
					СекцияПодтверждающегоДокумента, "DocCode", КодВидаПодтверждающегоДокумента, Истина, ТекстОшибки);
				НаименованиеВидаПодтверждающегоДокумента = ЗначениеРеквизитаВДереве(
					ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.НаименованиеВидаПодтверждающегоДокумента");
				ЗаполнитьСвойствоXDTO(
					СекцияПодтверждающегоДокумента, "DocName", НаименованиеВидаПодтверждающегоДокумента, , ТекстОшибки);
				СуммаВВалютеДокумента = СуммаСбербанк(
					СекцияПодтверждающегоДокумента, "ПодтверждающиеДокументы.НомерСтроки.СуммаВВалютеДокумента", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "DocSum", СуммаВВалютеДокумента, Истина, ТекстОшибки);
				СуммаВВалютеКонтракта = СуммаСбербанк(
					СекцияПодтверждающегоДокумента, "ПодтверждающиеДокументы.НомерСтроки.СуммаВВалютеКонтракта", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "ContractSum", СуммаВВалютеКонтракта, , ТекстОшибки);
				ПризнакПоставки = ЗначениеРеквизитаВДереве(ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.ПризнакПоставки");
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "DelDir", ПризнакПоставки, , ТекстОшибки);
				ОжидаемыйСрок = ЗначениеРеквизитаВДереве(ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.ОжидаемыйСрок");
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "ExpectedTerm", ОжидаемыйСрок, , ТекстОшибки);
				СтранаГрузоотправителя = СтранаСбербанк(
					ДеревоДанных, "ПодтверждающиеДокументы.НомерСтроки.СтранаГрузоотправителя", ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "Country", СтранаГрузоотправителя, , ТекстОшибки);
				СуммаПоставкиВВалютеДокумента = ЗначениеРеквизитаВДереве(
					ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.СуммаПоставкиВВалютеДокумента");
				ЗаполнитьСвойствоXDTO(СекцияПодтверждающегоДокумента, "DocSumDel", СуммаПоставкиВВалютеДокумента, , ТекстОшибки);
				СуммаПоставкиВВалютеКонтракта = ЗначениеРеквизитаВДереве(
					ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.СуммаПоставкиВВалютеКонтракта");
				ЗаполнитьСвойствоXDTO(
					СекцияПодтверждающегоДокумента, "ContractSumDel", СуммаПоставкиВВалютеКонтракта, , ТекстОшибки);
				ДатаКорректируемойСПД = ЗначениеРеквизитаВДереве(
					ТекущийДокумент, "ПодтверждающиеДокументы.НомерСтроки.ДатаКорректируемойСПД");
				ЗаполнитьСвойствоXDTO(
					СекцияПодтверждающегоДокумента, "AdjustmentDate", ДатаКорректируемойСПД, , ТекстОшибки);
			ПодтверждающийДокумент.ConfDocCertificateDoc138I.Добавить(СекцияПодтверждающегоДокумента);
		КонецЦикла;
		ЗаполнитьСвойствоXDTO(ConfDocCertificate138I, "ConfDocCertificateDocs138I", ПодтверждающийДокумент, Истина, ТекстОшибки);
		
		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "ПрисоединенныеФайлы") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыПрисоединенныеФайлы = ДеревоДанных.Строки.Найти("ПрисоединенныеФайлы", "ПолныйПуть");
			СекцияПрисоединенныеФайлы = ПриложенныеДокументыСбербанк(СтрокаТаблицыПрисоединенныеФайлы, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(ConfDocCertificate138I, "Attachments", СекцияПрисоединенныеФайлы, , ТекстОшибки);
		КонецЕсли;
		
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки
	КонецЕсли;
	
	ConfDocCertificate138I.Проверить();
	
	ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, ConfDocCertificate138I);
	АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);

КонецПроцедуры

Функция СчетСбербанк(ДеревоДанных, Путь, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";

	СекцияСчет = ОбъектТипаCML(ФабрикаXDTO, "AccNumBicType", ПространствоИмен);
	Счет = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".РасчСчет");
	ЗаполнитьСвойствоXDTO(СекцияСчет, "accNum", Счет, Истина, ТекстОшибки);
	БИКБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, Путь + ".Банк.БИК");
	ЗаполнитьСвойствоXDTO(СекцияСчет, "bic", БИКБанка, Истина, ТекстОшибки);
	Возврат СекцияСчет;
	
КонецФункции

Функция УполномоченныйСотрудникСбербанк(ДеревоДанных, ТекстОшибки)
	
	ПространствоИмен = "http://bssys.com/upg/request";
	УполномоченныйСотрудник = ОбъектТипаCML(ФабрикаXDTO, "AuthPers", ПространствоИмен);
	ФИО = ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.ФИО");
	ЗаполнитьСвойствоXDTO(УполномоченныйСотрудник, "Name", ФИО, , ТекстОшибки);
	Телефон = ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Телефон");
	ЗаполнитьСвойствоXDTO(УполномоченныйСотрудник, "Telfax", Телефон, , ТекстОшибки);
	Должность = ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Должность");
	ЗаполнитьСвойствоXDTO(УполномоченныйСотрудник, "Position", Должность, , ТекстОшибки);
	Возврат УполномоченныйСотрудник;
	
КонецФункции

#КонецОбласти

#Область Криптография

Процедура ОбновитьЗначение(СтароеЗначение, НовоеЗначение, ПропускатьНеопределенныеЗначения = Ложь)
	
	Если НовоеЗначение = Неопределено И ПропускатьНеопределенныеЗначения Тогда
		Возврат;
	КонецЕсли;
	
	Если СтароеЗначение <> НовоеЗначение Тогда
		СтароеЗначение = НовоеЗначение;
	КонецЕсли;
	
КонецПроцедуры

Функция НайтиСоздатьПрограммуКриптографии(НазваниеПрограммы, ТипПрограммы, АлгоритмПодписи, АлгоритмХеширования, АлгоритмШифрования = Неопределено)
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ПрограммыЭлектроннойПодписиИШифрования.Ссылка КАК Ссылка,
	|	ПрограммыЭлектроннойПодписиИШифрования.АлгоритмПодписи КАК АлгоритмПодписи,
	|	ПрограммыЭлектроннойПодписиИШифрования.АлгоритмХеширования КАК АлгоритмХеширования,
	|	ПрограммыЭлектроннойПодписиИШифрования.АлгоритмШифрования КАК АлгоритмШифрования
	|ИЗ
	|	Справочник.ПрограммыЭлектроннойПодписиИШифрования КАК ПрограммыЭлектроннойПодписиИШифрования
	|ГДЕ
	|	ПрограммыЭлектроннойПодписиИШифрования.ИмяПрограммы = &ИмяПрограммы
	|	И ПрограммыЭлектроннойПодписиИШифрования.ТипПрограммы = &ТипПрограммы
	|	И НЕ ПрограммыЭлектроннойПодписиИШифрования.ПометкаУдаления";
	Запрос.УстановитьПараметр("ИмяПрограммы", НазваниеПрограммы);
	Запрос.УстановитьПараметр("ТипПрограммы", ТипПрограммы);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Если Выборка.АлгоритмПодписи = АлгоритмПодписи И Выборка.АлгоритмХеширования = АлгоритмХеширования
			И ?(ЗначениеЗаполнено(АлгоритмШифрования), Выборка.АлгоритмШифрования = АлгоритмШифрования, Истина) Тогда
			Возврат Выборка.Ссылка;
		КонецЕсли;
		Программа = Выборка.Ссылка.ПолучитьОбъект();
	Иначе
		Программа = Справочники.ПрограммыЭлектроннойПодписиИШифрования.СоздатьЭлемент();
	КонецЕсли;
	
	Программа.АлгоритмПодписи = АлгоритмПодписи;
	Программа.АлгоритмХеширования = АлгоритмХеширования;
	Если ЗначениеЗаполнено(АлгоритмШифрования) Тогда
		Программа.АлгоритмШифрования = АлгоритмШифрования;
	КонецЕсли;
	Программа.ИмяПрограммы = НазваниеПрограммы;
	Программа.Наименование = НазваниеПрограммы;
	Программа.ТипПрограммы = ТипПрограммы;
	
	Программа.Записать();
	
	Возврат Программа.Ссылка;
	
КонецФункции

// Получает все подписи файла.
//
// Параметры
//  СсылкаНаОбъект  - СправочникСсылка - ссылка объект, в табличной части которого содержатся подписи;
//
// Возвращаемое значение:
//  МассивВозврата - Массив  - массив структур с возвращаемыми значениями.
//
Функция ПолучитьВсеПодписи(СсылкаНаОбъект)
	
	УстановитьПривилегированныйРежим(Истина);
	МассивВозврата = Новый Массив;
	
	ТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	ЭлектронныеПодписи.КомуВыданСертификат КАК КомуВыданСертификат,
	               |	ЭлектронныеПодписи.Подпись КАК Подпись,
	               |	ЭлектронныеПодписи.Отпечаток КАК Отпечаток,
	               |	ЭлектронныеПодписи.ИмяФайлаПодписи КАК ИмяФайлаПодписи,
	               |	ЭлектронныеПодписи.Сертификат КАК Сертификат
	               |ИЗ
	               |	РегистрСведений.ЭлектронныеПодписи КАК ЭлектронныеПодписи
	               |ГДЕ
	               |	ЭлектронныеПодписи.ПодписанныйОбъект = &СсылкаНаОбъект";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.Параметры.Вставить("СсылкаНаОбъект", СсылкаНаОбъект);
	
	ВыборкаЗапроса = Запрос.Выполнить().Выбрать();
	
	Пока ВыборкаЗапроса.Следующий() Цикл
		СтруктураВозврата = Новый Структура("Подпись, КомуВыданСертификат, ИмяФайлаПодписи, Сертификат, Отпечаток");
		ЗаполнитьЗначенияСвойств(СтруктураВозврата, ВыборкаЗапроса);
		МассивВозврата.Добавить(СтруктураВозврата);
	КонецЦикла;
	
	Возврат МассивВозврата;
	
КонецФункции

#КонецОбласти

#Область ISO

Процедура СформироватьПлатежноеПоручениеISO(СсылкаНаДокумент, ДеревоДанных, АдресФайлаВоВременномХранилище)
	
	ПространствоИмен = "urn:iso:std:iso:20022:tech:xsd:pain.001.001.03";
	ТекстОшибки = "";
	
	СообщениеPain001 = ОбъектТипаCML(ФабрикаXDTO, "Document", ПространствоИмен);
		СообщениеЗаголовок = ОбъектТипаCML(ФабрикаXDTO, "CustomerCreditTransferInitiationV03", ПространствоИмен);
			СекцияЗаголовокГруппы = ОбъектТипаCML(ФабрикаXDTO, "GroupHeader32", ПространствоИмен);
				ИдДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокГруппы, "MsgId", ИдДокумента, Истина, ТекстОшибки);
				Дата = ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокГруппы, "CreDtTm", ТекущаяДатаСеанса(), Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокГруппы, "NbOfTxs", "1", Истина, ТекстОшибки); // число документов
				ИдентификацияИнициатора = ОбъектТипаCML(ФабрикаXDTO, "PartyIdentification32", ПространствоИмен);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокГруппы, "InitgPty", ИдентификацияИнициатора, Истина, ТекстОшибки); // фиксированное
			ЗаполнитьСвойствоXDTO(СообщениеЗаголовок, "GrpHdr", СекцияЗаголовокГруппы, Истина, ТекстОшибки);
			СекцияЗаголовокПлатежа = ОбъектТипаCML(ФабрикаXDTO, "PaymentInstructionInformation3", ПространствоИмен);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "PmtInfId", ИдДокумента, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "PmtMtd", "TRF", Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "ReqdExctnDt", Дата, Истина, ТекстОшибки);
				СекцияЗаголовокДебитор = ОбъектТипаCML(ФабрикаXDTO, "PartyIdentification32", ПространствоИмен);
					ПлательщикНаименованиеМеждународное = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.НаименованиеМеждународное");
					ЗаполнитьСвойствоXDTO(СекцияЗаголовокДебитор, "Nm", ПлательщикНаименованиеМеждународное, Истина, ТекстОшибки);
					Если ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный") = Истина
						ИЛИ ЗначениеЗаполнено(ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.АдресПроизвольный")) Тогда
						ПочтовыйАдресПлательщика = АдресISO("РеквизитыПлательщика", ДеревоДанных, ТекстОшибки);
						ЗаполнитьСвойствоXDTO(СекцияЗаголовокДебитор, "PstlAdr", ПочтовыйАдресПлательщика, , ТекстОшибки);
					КонецЕсли;
					ИННПлательщика = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.ИНН");
					ИдентификаторУчастникаISO = ИдентификаторУчастникаISO(ДеревоДанных, ИННПлательщика, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(СекцияЗаголовокДебитор, "Id", ИдентификаторУчастникаISO, , ТекстОшибки);
					КодСтраныПлательщика = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Страна.ISOКод");
					ЗаполнитьСвойствоXDTO(СекцияЗаголовокДебитор, "CtryOfRes", КодСтраныПлательщика, , ТекстОшибки);
					Если ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник") = Истина Тогда
						КонтактноеЛицо = ОбъектТипаCML(ФабрикаXDTO, "ContactDetails2", ПространствоИмен);
							ФИО = ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.ФИО");
							ЗаполнитьСвойствоXDTO(КонтактноеЛицо, "Nm", ФИО, , ТекстОшибки);
							Телефон = ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Телефон");
							ЗаполнитьСвойствоXDTO(КонтактноеЛицо, "PhneNb", Телефон, , ТекстОшибки);
							Email = ЗначениеРеквизитаВДереве(ДеревоДанных, "УполномоченныйСотрудник.Email");
							ЗаполнитьСвойствоXDTO(КонтактноеЛицо, "EmailAdr", Email, , ТекстОшибки);
						ЗаполнитьСвойствоXDTO(СекцияЗаголовокДебитор, "CtctDtls", КонтактноеЛицо, , ТекстОшибки);
					КонецЕсли;
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "Dbtr", СекцияЗаголовокДебитор, Истина, ТекстОшибки);
				ПлательщикРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.РасчСчет");
				СекцияСчетПлательщика = СчетISO(ПлательщикРасчСчет, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "DbtrAcct", СекцияСчетПлательщика, Истина, ТекстОшибки);
				БанкПлательщик = ОбъектТипаCML(ФабрикаXDTO, "BranchAndFinancialInstitutionIdentification4", ПространствоИмен);
					БанкПлательщикИД = ОбъектТипаCML(ФабрикаXDTO, "FinancialInstitutionIdentification7", ПространствоИмен);
						ПлательщикСВИФТБИКБанка = ЗначениеРеквизитаВДереве(
							ДеревоДанных, "РеквизитыПлательщика.Банк.SWIFT");
						ЗаполнитьСвойствоXDTO(БанкПлательщикИД, "BIC", ПлательщикСВИФТБИКБанка, Истина, ТекстОшибки);
						ПлательщикМеждународноеНаименованиеБанка = ЗначениеРеквизитаВДереве(
							ДеревоДанных, "РеквизитыПлательщика.Банк.НаименованиеМеждународное");
						ЗаполнитьСвойствоXDTO(БанкПлательщикИД, "Nm", ПлательщикМеждународноеНаименованиеБанка, Истина, ТекстОшибки);
						ГородБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Город");
						АдресБанка = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Адрес");
						ТипАдресБанка = ОбъектТипаCML(ФабрикаXDTO, "PostalAddress6", ПространствоИмен);
							ЗаполнитьСвойствоXDTO(ТипАдресБанка, "TwnNm", ГородБанка, , ТекстОшибки);
							Если ЗначениеЗаполнено(АдресБанка) Тогда
								ТипАдресБанка.AdrLine.Добавить(АдресБанка);
							КонецЕсли;
						ЗаполнитьСвойствоXDTO(БанкПлательщикИД, "PstlAdr", ТипАдресБанка, , ТекстОшибки);
					ЗаполнитьСвойствоXDTO(БанкПлательщик, "FinInstnId", БанкПлательщикИД, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "DbtrAgt", БанкПлательщик, Истина, ТекстОшибки);
				ТипКомиссии = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ТипКомиссии");
				Если ТипКомиссии = "BEN" Тогда
					ТипКомиссии = "CRED";
				ИначеЕсли ТипКомиссии = "OUR" Тогда
					ТипКомиссии = "DEBT";
				ИначеЕсли ТипКомиссии = "SNA" Тогда
					ТипКомиссии = "SHAR";
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "ChrgBr", ТипКомиссии, Истина, ТекстОшибки);
				СчетКомиссии = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.СчетКомиссии");
				Если ЗначениеЗаполнено(СчетКомиссии) Тогда
					СекцияСчетКомиссии = СчетISO(СчетКомиссии, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(СекцияЗаголовокПлатежа, "ChrgsAcct", СекцияСчетКомиссии, Истина, ТекстОшибки);
				КонецЕсли;
				Сумма = ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
				СекцияТранзакция = ТранзакцияISO(ДеревоДанных, Сумма, "", ТекстОшибки);
				СекцияЗаголовокПлатежа.CdtTrfTxInf.Добавить(СекцияТранзакция);
		
			СообщениеЗаголовок.PmtInf.Добавить(СекцияЗаголовокПлатежа);

		ЗаполнитьСвойствоXDTO(СообщениеPain001, "CstmrCdtTrfInitn", СообщениеЗаголовок, Истина, ТекстОшибки);

	СообщениеPain001.Проверить();

	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ВызватьИсключение ТекстОшибки;
	Иначе
		ДвоичныеДанные = ДвоичныеДанныеИзXDTO(ФабрикаXDTO, СообщениеPain001, Ложь);
		АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные);
	КонецЕсли;
	
КонецПроцедуры

Функция МассивСтрокНазначенияПлатежаДляISO(НазначениеПлатежа)
	
	МассивВозврата = Новый Массив;
	ОграничениеСтрокиФорматаISO = 140;
	
	Для Счетчик = 1 По СтрЧислоСтрок(НазначениеПлатежа) Цикл
		ТекСтрока = СтрПолучитьСтроку(НазначениеПлатежа, Счетчик);
		Если СтрДлина(ТекСтрока) > ОграничениеСтрокиФорматаISO Тогда
			Пока СтрДлина(ТекСтрока) > 0 Цикл
				КоличествоКСрезу = Мин(ОграничениеСтрокиФорматаISO, СтрДлина(ТекСтрока));
				КусокСтроки = Сред(ТекСтрока, 1, КоличествоКСрезу);
				МассивВозврата.Добавить(КусокСтроки);
				Если СтрДлина(ТекСтрока) <= ОграничениеСтрокиФорматаISO Тогда
					Прервать;
				КонецЕсли;
				ТекСтрока = Сред(ТекСтрока, КоличествоКСрезу + 1);
			КонецЦикла;
		Иначе
			МассивВозврата.Добавить(ТекСтрока);
		КонецЕсли;
	КонецЦикла;

	Возврат МассивВозврата;
	
КонецФункции

Функция ИдентификаторУчастникаISO(ДеревоДанных, ИНН, ТекстОшибки)
	
	ПространствоИмен = "urn:iso:std:iso:20022:tech:xsd:pain.001.001.03";
	СекцияЗаголовокИд = ОбъектТипаCML(ФабрикаXDTO, "Party6Choice", ПространствоИмен);
		СекцияЗаголовокОрг = ОбъектТипаCML(ФабрикаXDTO, "OrganisationIdentification4", ПространствоИмен);
			СекцияЗаголовокОргИд = ОбъектТипаCML(ФабрикаXDTO, "GenericOrganisationIdentification1", ПространствоИмен);
				Если Не ЗначениеЗаполнено(ИНН) Тогда
					ИНН = "0";
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокОргИд, "Id", ИНН, Истина, ТекстОшибки);
				СекцияЗаголовокИмяКода = ОбъектТипаCML(ФабрикаXDTO, "OrganisationIdentificationSchemeName1Choice", ПространствоИмен);
					ЗаполнитьСвойствоXDTO(СекцияЗаголовокИмяКода, "Cd", "TXID", Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокОргИд, "SchmeNm", СекцияЗаголовокИмяКода, Ложь, ТекстОшибки);
			СекцияЗаголовокОрг.Othr.Добавить(СекцияЗаголовокОргИд);
		ЗаполнитьСвойствоXDTO(СекцияЗаголовокИд, "OrgId", СекцияЗаголовокОрг, Ложь, ТекстОшибки);
	Возврат СекцияЗаголовокИд;
	
КонецФункции

Функция АдресISO(Корень, ДеревоДанных, ТекстОшибки)
	
	ПространствоИмен = "urn:iso:std:iso:20022:tech:xsd:pain.001.001.03";
	СекцияПочтовыйАдрес = ОбъектТипаCML(ФабрикаXDTO, "PostalAddress6", ПространствоИмен);
	Если ЗначениеРеквизитаВДереве(ДеревоДанных, Корень + ".АдресСтруктурированный") = Истина Тогда
		КодСтраны = ЗначениеРеквизитаВДереве(ДеревоДанных, Корень + ".АдресСтруктурированный.Страна.ISOКод");
		ЗаполнитьСвойствоXDTO(СекцияПочтовыйАдрес, "Ctry", КодСтраны, Ложь, ТекстОшибки);
		Город = ЗначениеРеквизитаВДереве(ДеревоДанных, Корень + ".АдресСтруктурированный.Город");
		ЗаполнитьСвойствоXDTO(СекцияПочтовыйАдрес, "TwnNm", Город, Ложь, ТекстОшибки);
		Адрес = ЗначениеРеквизитаВДереве(ДеревоДанных, Корень + ".АдресСтруктурированный.Адрес");
		Если Не ПустаяСтрока(Адрес) Тогда
			СекцияПочтовыйАдрес.AdrLine.Добавить(Адрес);
		КонецЕсли;
		Индекс = ЗначениеРеквизитаВДереве(ДеревоДанных, Корень + ".АдресСтруктурированный.Индекс");
		ЗаполнитьСвойствоXDTO(СекцияПочтовыйАдрес, "PstCd", Индекс, Ложь, ТекстОшибки);
	КонецЕсли;
	АдресПроизвольный = ЗначениеРеквизитаВДереве(ДеревоДанных, Корень + ".АдресПроизвольный");
	Если ЗначениеЗаполнено(АдресПроизвольный) Тогда
		СекцияПочтовыйАдрес.AdrLine.Добавить(АдресПроизвольный);
	КонецЕсли;

	Возврат СекцияПочтовыйАдрес;
	
КонецФункции

Функция СчетISO(НомерСчета, ТекстОшибки)
	
	ПространствоИмен = "urn:iso:std:iso:20022:tech:xsd:pain.001.001.03";
	СекцияЗаголовокСчет = ОбъектТипаCML(ФабрикаXDTO, "CashAccount16", ПространствоИмен);
		СекцияЗаголовокСчетИд = ОбъектТипаCML(ФабрикаXDTO, "AccountIdentification4Choice", ПространствоИмен);
			СекцияЗаголовокСчетТип = ОбъектТипаCML(ФабрикаXDTO, "GenericAccountIdentification1", ПространствоИмен);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокСчетТип, "Id", НомерСчета, Истина, ТекстОшибки);
				СекцияЗаголовокСчетТипИмя = ОбъектТипаCML(ФабрикаXDTO, "AccountSchemeName1Choice", ПространствоИмен);
					ЗаполнитьСвойствоXDTO(СекцияЗаголовокСчетТипИмя, "Cd", "BBAN", Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияЗаголовокСчетТип, "SchmeNm", СекцияЗаголовокСчетТипИмя, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(СекцияЗаголовокСчетИд, "Othr", СекцияЗаголовокСчетТип, Истина, ТекстОшибки);
	ЗаполнитьСвойствоXDTO(СекцияЗаголовокСчет, "Id", СекцияЗаголовокСчетИд, Истина, ТекстОшибки);
	Возврат СекцияЗаголовокСчет;
	
КонецФункции

Функция ТранзакцияISO(ДеревоДанных, Сумма, ЛокальныйИнструмент, ТекстОшибки)
	
	ПространствоИмен = "urn:iso:std:iso:20022:tech:xsd:pain.001.001.03";

	СекцияТранзакция = ОбъектТипаCML(ФабрикаXDTO, "CreditTransferTransactionInformation10", ПространствоИмен);
		ИдДокумента = ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдДокумента");
		СекцияИДПлатежа = ОбъектТипаCML(ФабрикаXDTO, "PaymentIdentification1", ПространствоИмен);
			ЗаполнитьСвойствоXDTO(СекцияИДПлатежа, "InstrId", ИдДокумента, Истина, ТекстОшибки);
			Номер = СокрЛП(ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер"));
			ЗаполнитьСвойствоXDTO(СекцияИДПлатежа, "EndToEndId", Номер, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(СекцияТранзакция, "PmtId", СекцияИДПлатежа, Истина, ТекстОшибки);
		СекцияЗаголовокТипПлатежа = ОбъектТипаCML(ФабрикаXDTO, "PaymentTypeInformation19", ПространствоИмен);
			СекцияЗаголовокЛокальныйИнструмент = ОбъектТипаCML(ФабрикаXDTO, "LocalInstrument2Choice", ПространствоИмен);
			Если Не ПустаяСтрока(ЛокальныйИнструмент) Тогда
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокЛокальныйИнструмент, "Prtry", ЛокальныйИнструмент, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияЗаголовокТипПлатежа, "LclInstrm", СекцияЗаголовокЛокальныйИнструмент, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияТранзакция, "PmtTpInf", СекцияЗаголовокТипПлатежа, Истина, ТекстОшибки);
			КонецЕсли;
		СекцияСумма = ОбъектТипаCML(ФабрикаXDTO, "AmountType3Choice", ПространствоИмен);
			СекцияСуммаЗначение = ОбъектТипаCML(ФабрикаXDTO, "ActiveOrHistoricCurrencyAndAmount", ПространствоИмен);
				ЗаполнитьСвойствоXDTO(СекцияСуммаЗначение, "__content", Сумма, Истина, ТекстОшибки);
				КодВалютыПеревода = ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаПеревода.ISOКодВалюты");
				ЗаполнитьСвойствоXDTO(СекцияСуммаЗначение, "Ccy", КодВалютыПеревода, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияСумма, "InstdAmt", СекцияСуммаЗначение, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(СекцияТранзакция, "Amt", СекцияСумма, Истина, ТекстОшибки);
		// Курс
		КурсКонвертации = СокрЛП(ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.Курс"));
			Если ЗначениеЗаполнено(КурсКонвертации) Тогда
				СекцияКурс = ОбъектТипаCML(ФабрикаXDTO, "ExchangeRateInformation1", ПространствоИмен);
					ЗаполнитьСвойствоXDTO(СекцияКурс, "XchgRate", КурсКонвертации, Истина, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(СекцияКурс, "RateTp", "SPOT", Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(СекцияТранзакция, "XchgRateInf", СекцияКурс, Истина, ТекстОшибки);
			КонецЕсли;
		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.БанкПосредник") = Истина Тогда
			БанкПосредник = ОбъектТипаCML(ФабрикаXDTO, "BranchAndFinancialInstitutionIdentification4", ПространствоИмен);
				SWIFTБанкаПосредника = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.SWIFT");
				БанкПосредникИД = ОбъектТипаCML(ФабрикаXDTO, "FinancialInstitutionIdentification7", ПространствоИмен);
					ЗаполнитьСвойствоXDTO(БанкПосредникИД, "BIC", SWIFTБанкаПосредника, , ТекстОшибки);
					НаименованиеБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.НаименованиеМеждународное");
					ЗаполнитьСвойствоXDTO(БанкПосредникИД, "Nm", НаименованиеБанкаПосредника, , ТекстОшибки);
				СекцияАдресБанкаПосредника = ОбъектТипаCML(ФабрикаXDTO, "PostalAddress6", ПространствоИмен);
					ISOКодБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Страна.ISOКод");
					ЗаполнитьСвойствоXDTO(СекцияАдресБанкаПосредника, "Ctry", ISOКодБанкаПосредника, , ТекстОшибки);
					АдресБанкаПосредника = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.Адрес");
				СекцияАдресБанкаПосредника.AdrLine.Добавить(АдресБанкаПосредника);
				ЗаполнитьСвойствоXDTO(БанкПосредник, "FinInstnId", БанкПосредникИД, Истина, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияТранзакция, "IntrmyAgt1", БанкПосредник, Истина, ТекстОшибки);
		КонецЕсли;
		
		БанкПолучатель = ОбъектТипаCML(ФабрикаXDTO, "BranchAndFinancialInstitutionIdentification4", ПространствоИмен);
			БанкПолучательИД = ОбъектТипаCML(ФабрикаXDTO, "FinancialInstitutionIdentification7", ПространствоИмен);
				ПолучательБанкSWIFT = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.SWIFT");
				ЗаполнитьСвойствоXDTO(БанкПолучательИД, "BIC", ПолучательБанкSWIFT, , ТекстОшибки);
				БанкПолучателяНаименованиеМеждународное = ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыПолучателя.Банк.НаименованиеМеждународное");
				ЗаполнитьСвойствоXDTO(БанкПолучательИД, "Nm", БанкПолучателяНаименованиеМеждународное, , ТекстОшибки);
				АдресБанкаПолучателя = ОбъектТипаCML(ФабрикаXDTO, "PostalAddress6", ПространствоИмен);
					ПолучательБанкСтранаISOКод = ЗначениеРеквизитаВДереве(
						ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.ISOКод");
					ЗаполнитьСвойствоXDTO(АдресБанкаПолучателя, "Ctry", ПолучательБанкСтранаISOКод, , ТекстОшибки);
					ПолучательБанкАдрес = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Адрес");
					АдресБанкаПолучателя.AdrLine.Добавить(ПолучательБанкАдрес);
				ЗаполнитьСвойствоXDTO(БанкПолучательИД, "PstlAdr", АдресБанкаПолучателя, Истина, ТекстОшибки);
				БИКБанкПолучателя = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.БИК");
				Если ЗначениеЗаполнено(БИКБанкПолучателя) Тогда
					ClrSysMmbId = ОбъектТипаCML(ФабрикаXDTO, "ClearingSystemMemberIdentification2", ПространствоИмен);
					ЗаполнитьСвойствоXDTO(ClrSysMmbId, "MmbId", БИКБанкПолучателя, Истина, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(БанкПолучательИД, "ClrSysMmbId", ClrSysMmbId, , ТекстОшибки);
				КонецЕсли;
			ЗаполнитьСвойствоXDTO(БанкПолучатель, "FinInstnId", БанкПолучательИД, Истина, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(СекцияТранзакция, "CdtrAgt", БанкПолучатель, Истина, ТекстОшибки);

		Если ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.БанкПосредник") = Истина Тогда
			КорСчетБанкаПосредника = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.БанкПосредник.КорСчет");
			СчетБанкаПосредника = СчетISO(КорСчетБанкаПосредника, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(СекцияТранзакция, "CdtrAgtAcct", СчетБанкаПосредника, Истина, ТекстОшибки);
		КонецЕсли;
		
		Получатель = ОбъектТипаCML(ФабрикаXDTO, "PartyIdentification32", ПространствоИмен);
			ПолучательМеждународноеНаименование = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.НаименованиеМеждународное");
			ЗаполнитьСвойствоXDTO(Получатель, "Nm", ПолучательМеждународноеНаименование, , ТекстОшибки);
			Если ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный") = Истина
				ИЛИ ЗначениеЗаполнено(ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.АдресПроизвольный")) Тогда
				СекцияАдресПолучателя = АдресISO("РеквизитыПолучателя", ДеревоДанных, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(Получатель, "PstlAdr", СекцияАдресПолучателя, , ТекстОшибки);
			КонецЕсли;
			ИННПолучателя = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.ИНН");
			СекцияИдентификаторПолучателя = ИдентификаторУчастникаISO(ДеревоДанных, ИННПолучателя, ТекстОшибки);
			ЗаполнитьСвойствоXDTO(Получатель, "Id", СекцияИдентификаторПолучателя, , ТекстОшибки);
			КодСтраныПолучателя = ЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Страна.ISOКод");
			ЗаполнитьСвойствоXDTO(Получатель, "CtryOfRes", КодСтраныПолучателя, , ТекстОшибки);
		ЗаполнитьСвойствоXDTO(СекцияТранзакция, "Cdtr", Получатель, , ТекстОшибки);
		ПолучательРасчСчет = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.РасчСчет");
		СчетПолучатель = СчетISO(ПолучательРасчСчет, ТекстОшибки);
		ЗаполнитьСвойствоXDTO(СекцияТранзакция, "CdtrAcct", СчетПолучатель, , ТекстОшибки);
		
		ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "КодыВидовВалютныхОпераций") <> "";
		Если ТаблицаЗаполнена Тогда
			СтрокаТаблицыКодыВидовОпераций = ДеревоДанных.Строки.Найти("КодыВидовВалютныхОпераций", "ПолныйПуть");
			RegulatoryReporting3 = ОбъектТипаCML(ФабрикаXDTO, "RegulatoryReporting3", ПространствоИмен);
			Для Каждого ТекущийКодОперации Из СтрокаТаблицыКодыВидовОпераций.Строки Цикл
				StructuredRegulatoryReporting3 = ОбъектТипаCML(ФабрикаXDTO, "StructuredRegulatoryReporting3", ПространствоИмен);
				КодВидаОперации = ЗначениеРеквизитаВДереве(
					ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.КодВидаВалютнойОперации");
				ЗаполнитьСвойствоXDTO(StructuredRegulatoryReporting3, "Tp", "VO", , ТекстОшибки);
				ActiveOrHistoricCurrencyAndAmount = ОбъектТипаCML(
					ФабрикаXDTO, "ActiveOrHistoricCurrencyAndAmount", ПространствоИмен);
					Сумма = ЗначениеРеквизитаВДереве(ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.Сумма");
					ЗаполнитьСвойствоXDTO(ActiveOrHistoricCurrencyAndAmount, "__content", Сумма, , ТекстОшибки);
					ISOКодВалюты = ЗначениеРеквизитаВДереве(ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.ISOКодВалюты");
					ЗаполнитьСвойствоXDTO(ActiveOrHistoricCurrencyAndAmount, "Ccy", ISOКодВалюты, Истина, ТекстОшибки);
				ЗаполнитьСвойствоXDTO(StructuredRegulatoryReporting3, "Amt", ActiveOrHistoricCurrencyAndAmount, , ТекстОшибки);
				ЗаполнитьСвойствоXDTO(StructuredRegulatoryReporting3, "Cd", КодВидаОперации, , ТекстОшибки);
				НомерПаспортаСделки = ЗначениеРеквизитаВДереве(
					ТекущийКодОперации, "КодыВидовВалютныхОпераций.НомерСтроки.НомерПаспортаСделки");
				Если ЗначениеЗаполнено(НомерПаспортаСделки) Тогда
					StructuredRegulatoryReporting3.Inf.Добавить(НомерПаспортаСделки);
				КонецЕсли;
				RegulatoryReporting3.Dtls.Добавить(StructuredRegulatoryReporting3);
			КонецЦикла;
			СекцияТранзакция.RgltryRptg.Добавить(RegulatoryReporting3);
		КонецЕсли;

		СекцияИнформацияОПлатеже = ОбъектТипаCML(ФабрикаXDTO, "RemittanceInformation5", ПространствоИмен);
			НазначениеПлатежа = ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа");
			МассивСтрокНазначенияПлатежа = МассивСтрокНазначенияПлатежаДляISO(НазначениеПлатежа);
			Для Каждого Строка Из МассивСтрокНазначенияПлатежа Цикл
				Если НЕ ПустаяСтрока(Строка) Тогда
					СекцияИнформацияОПлатеже.Ustrd.Добавить(Строка);
				КонецЕсли;
			КонецЦикла;
			
			ТаблицаЗаполнена = ЗначениеРеквизитаВДереве(ДеревоДанных, "ОбосновывающиеДокументы") <> "";
			Если ТаблицаЗаполнена Тогда
				ИнформацияОПлатежеСтруктурная = ОбъектТипаCML(ФабрикаXDTO, "StructuredRemittanceInformation7", ПространствоИмен);
				СтрокаТаблицыОбосновывающихДокументов = ДеревоДанных.Строки.Найти("ОбосновывающиеДокументы", "ПолныйПуть");
				Для Каждого ТекущийОбосновывающийДокумент Из СтрокаТаблицыОбосновывающихДокументов.Строки Цикл
					СвязныеДокументы = ОбъектТипаCML(ФабрикаXDTO, "ReferredDocumentInformation3", ПространствоИмен);
					ТипДокумента = ОбъектТипаCML(ФабрикаXDTO, "ReferredDocumentType2", ПространствоИмен);
						ТипДокументаВыбор = ОбъектТипаCML(ФабрикаXDTO, "ReferredDocumentType1Choice", ПространствоИмен);
							ТипДокументаЗначение = ЗначениеРеквизитаВДереве(
								ТекущийОбосновывающийДокумент, "ОбосновывающиеДокументы.НомерСтроки.ТипДокумента");
							ЗаполнитьСвойствоXDTO(ТипДокументаВыбор, "Prtry", "POD", Истина, ТекстОшибки);
						ЗаполнитьСвойствоXDTO(ТипДокумента, "CdOrPrtry", ТипДокументаВыбор, Истина, ТекстОшибки);
					ЗаполнитьСвойствоXDTO(СвязныеДокументы, "Tp", ТипДокумента, , ТекстОшибки);
					НомерОбосновывающегоДокумента = ЗначениеРеквизитаВДереве(
						ТекущийОбосновывающийДокумент, "ОбосновывающиеДокументы.НомерСтроки.НомерДокумента");
					ЗаполнитьСвойствоXDTO(СвязныеДокументы, "Nb", НомерОбосновывающегоДокумента, , ТекстОшибки);
					ДатаДокумента = ЗначениеРеквизитаВДереве(
						ТекущийОбосновывающийДокумент, "ОбосновывающиеДокументы.НомерСтроки.ДатаДокумента");
					ЗаполнитьСвойствоXDTO(СвязныеДокументы, "RltdDt", ДатаДокумента, , ТекстОшибки);
					ИнформацияОПлатежеСтруктурная.RfrdDocInf.Добавить(СвязныеДокументы);
				КонецЦикла;
				СекцияИнформацияОПлатеже.Strd.Добавить(ИнформацияОПлатежеСтруктурная);
			КонецЕсли;
		ЗаполнитьСвойствоXDTO(СекцияТранзакция, "RmtInf", СекцияИнформацияОПлатеже, , ТекстОшибки);
		
	Возврат СекцияТранзакция;
	
КонецФункции

Процедура ПрочитатьВалютнуюВыпискуISO(ЭД, ДеревоРазбора, НовыйЭД)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ВыпискаБанка;
	
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторДокумента", ЭД.BkToCstmrStmt.GrpHdr.MsgId);

	МассивВыписок = Новый Массив;
	Макет = Обработки.ОбменСБанками.ПолучитьМакет("ВыпискаБанка");
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
	
	Если ТипЗнч(ЭД.BkToCstmrStmt.Stmt) = Тип("ОбъектXDTO") Тогда
		Выписки = Новый Массив;
		Выписки.Добавить(ЭД.BkToCstmrStmt.Stmt);
	Иначе
		Выписки = ЭД.BkToCstmrStmt.Stmt;
	КонецЕсли;
	
	ТаблицаВыписок = Новый ТаблицаЗначений;
	ТаблицаВыписок.Колонки.Добавить("НачалоПериода");
	ТаблицаВыписок.Колонки.Добавить("КонецПериода");
	ТаблицаВыписок.Колонки.Добавить("НомерСчета");
	ТаблицаВыписок.Колонки.Добавить("Организация");
	ТаблицаВыписок.Колонки.Добавить("Банк");
	ТаблицаВыписок.Колонки.Добавить("НачальныйОстаток");
	ТаблицаВыписок.Колонки.Добавить("ОборотВходящихПлатежей");
	ТаблицаВыписок.Колонки.Добавить("ОборотИсходящихПлатежей");
	ТаблицаВыписок.Колонки.Добавить("КонечныйОстаток");
	ТаблицаВыписок.Колонки.Добавить("Операции");
	
	Для Каждого Выписка Из Выписки Цикл
		СтрокаВыписки = ТаблицаВыписок.Добавить();
		
		Если Выписка.Свойства().Получить("FrToDt") <> Неопределено Тогда
			СтрокаВыписки.НачалоПериода = XMLЗначение(Тип("Дата"), Выписка.FrToDt.FrDtTm);
			СтрокаВыписки.КонецПериода = XMLЗначение(Тип("Дата"), Выписка.FrToDt.ToDtTm);
		КонецЕсли;
		
		Если Выписка.Acct.Id.Свойства().Получить("IBAN") <> Неопределено Тогда
			СтрокаВыписки.НомерСчета = Выписка.Acct.Id.IBAN;
		Иначе
			СтрокаВыписки.НомерСчета = Выписка.Acct.Id.Othr.Id;
		КонецЕсли;
		
		Организация = Новый Структура;
		
		Если Выписка.Acct.Свойства().Получить("Nm") <> Неопределено Тогда
			Организация.Вставить("Наименование", Выписка.Acct.Nm);
		КонецЕсли;
		
		Если Выписка.Acct.Свойства().Получить("Ownr") <> Неопределено Тогда // владелец счета
			Если Выписка.Acct.Ownr.Свойства().Получить("Nm") <> Неопределено Тогда
				Организация.Вставить("НаименованиеМеждународное", Выписка.Acct.Ownr.Nm);
			КонецЕсли;
			
			Если Выписка.Acct.Ownr.Свойства().Получить("Id") <> Неопределено
				И Выписка.Acct.Ownr.Id.Свойства().Получить("OrgId") <> Неопределено
				И Выписка.Acct.Ownr.Id.OrgId.Свойства().Получить("Othr") <> Неопределено Тогда
					Организация.Вставить("ИНН", Выписка.Acct.Ownr.Id.OrgId.Othr.Id);
			КонецЕсли;
		КонецЕсли;
		
		Если Организация.Количество() Тогда
			СтрокаВыписки.Организация = Организация;
		КонецЕсли;
		
		Если Выписка.Acct.Свойства().Получить("Svcr") <> Неопределено Тогда // обслуживающий банк
			Банк = Новый Структура;
			Если Выписка.Acct.Svcr.FinInstnId.Свойства().Получить("BIC") <> Неопределено Тогда
				Банк.Вставить("SWIFT", Выписка.Acct.Svcr.FinInstnId.BIC);
			КонецЕсли;
			
			Если Выписка.Acct.Svcr.FinInstnId.Свойства().Получить("Nm") <> Неопределено Тогда
				Банк.Вставить("НаименованиеМеждународное", Выписка.Acct.Svcr.FinInstnId.Nm);
			КонецЕсли;
			
			Если Выписка.Acct.Svcr.FinInstnId.Свойства().Получить("ClrSysMmbId") <> Неопределено Тогда
				Банк.Вставить("БИК", Выписка.Acct.Svcr.FinInstnId.ClrSysMmbId.MmbId);
			КонецЕсли;
			
			Если Банк.Количество() Тогда
				СтрокаВыписки.Банк = Банк;
			КонецЕсли;
			
		КонецЕсли;

		// Остатки
		Если ТипЗнч(Выписка.Bal) = Тип("ОбъектXDTO") Тогда
			Балансы = Новый Массив;
			Балансы.Добавить(Выписка.Bal);
		Иначе
			Балансы = Выписка.Bal;
		КонецЕсли;
		
		Для Каждого Баланс Из Балансы Цикл
			
			Если Баланс.Tp.CdOrPrtry.Свойства().Получить("Cd") <> Неопределено Тогда
				СуммаСтрокой = Баланс.Amt.Последовательность().ПолучитьТекст(0);
				Если Баланс.Tp.CdOrPrtry.Cd = "OPBD" Тогда
					СтрокаВыписки.НачальныйОстаток = XMLЗначение(Тип("Число"), СуммаСтрокой);
				ИначеЕсли Баланс.Tp.CdOrPrtry.Cd = "CLBD" Тогда
					СтрокаВыписки.КонечныйОстаток = XMLЗначение(Тип("Число"), СуммаСтрокой);
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
		// Обороты
		Если Выписка.Свойства().Получить("TxsSummry") <> Неопределено Тогда
			Если Выписка.TxsSummry.Свойства().Получить("TtlCdtNtries") <> Неопределено
				И Выписка.TxsSummry.TtlCdtNtries.Свойства().Получить("Sum") <> Неопределено Тогда
					СтрокаВыписки.ОборотВходящихПлатежей = XMLЗначение(Тип("Число"), Выписка.TxsSummry.TtlCdtNtries.Sum);
			КонецЕсли;
			Если Выписка.TxsSummry.Свойства().Получить("TtlDbtNtries") <> Неопределено
				И Выписка.TxsSummry.TtlDbtNtries.Свойства().Получить("Sum") <> Неопределено Тогда
					СтрокаВыписки.ОборотИсходящихПлатежей = XMLЗначение(Тип("Число"), Выписка.TxsSummry.TtlDbtNtries.Sum);
			КонецЕсли;
		КонецЕсли;

		
		Если Выписка.Свойства().Получить("Ntry") <> Неопределено Тогда
			Если ТипЗнч(Выписка.Ntry) = Тип("ОбъектXDTO") Тогда
				Операции = Новый Массив;
				Операции.Добавить(Выписка.Ntry);
			Иначе
				Операции = Выписка.Ntry;
			КонецЕсли;
			
			ТаблицаОпераций = Новый ТаблицаЗначений;
			ТаблицаОпераций.Колонки.Добавить("Статус");
			ТаблицаОпераций.Колонки.Добавить("НаправлениеПлатежа");
			ТаблицаОпераций.Колонки.Добавить("ДатаОперации");
			ТаблицаОпераций.Колонки.Добавить("ДатаВалютирования");
			ТаблицаОпераций.Колонки.Добавить("НомерДокумента");
			ТаблицаОпераций.Колонки.Добавить("СуммаДокумента");
			ТаблицаОпераций.Колонки.Добавить("ИдентификаторДокумента");
			ТаблицаОпераций.Колонки.Добавить("Плательщик");
			ТаблицаОпераций.Колонки.Добавить("Получатель");
			ТаблицаОпераций.Колонки.Добавить("НазначениеПлатежа");
			
			Для Каждого Операция Из Операции Цикл
				// Если платеж не исполнен, то пропускаем его
				Если Операция.Sts <> "BOOK" Тогда
					Продолжить;
				КонецЕсли;
				НовСтрока = ТаблицаОпераций.Добавить();
				СуммаСтрокой = Операция.Amt.Последовательность().ПолучитьТекст(0);
				НовСтрока.СуммаДокумента = XMLЗначение(Тип("Число"), СуммаСтрокой);
				НовСтрока.НаправлениеПлатежа = ?(Операция.CdtDbtInd = "DBIT", "1", "2");
				НовСтрока.Статус = ?(Операция.Sts = "BOOK", "1", "0");
				Если Операция.Свойства().Получить("BookgDt") <> Неопределено Тогда
					ДатаОперацииСтрокой = ?(Операция.BookgDt.Свойства().Получить("Dt") <> Неопределено, Операция.BookgDt.Dt,
						Операция.BookgDt.DtTm);
					НовСтрока.ДатаОперации = XMLЗначение(Тип("Дата"), ДатаОперацииСтрокой);
				КонецЕсли;
			
				Если Операция.Свойства().Получить("ValDt") <> Неопределено Тогда
					ДатаВалютированияСтрокой = ?(Операция.ValDt.Свойства().Получить("Dt") <> Неопределено, Операция.ValDt.Dt,
						Операция.ValDt.DtTm);
					НовСтрока.ДатаВалютирования = XMLЗначение(Тип("Дата"), ДатаВалютированияСтрокой);
				КонецЕсли;
				
				Если Операция.Свойства().Получить("AcctSvcrRef") <> Неопределено Тогда
					НовСтрока.ИдентификаторДокумента = Операция.AcctSvcrRef;
				КонецЕсли;
				
				Если Операция.Свойства().Получить("NtryDtls") <> Неопределено Тогда
					Если ТипЗнч(Операция.NtryDtls) = Тип("ОбъектXDTO") Тогда
						Транзакция = Операция.NtryDtls;
					Иначе
						Транзакция = Операция.NtryDtls[0];
					КонецЕсли;
					Если Транзакция.Свойства().Получить("TxDtls") <> Неопределено Тогда
						Если ТипЗнч(Транзакция.TxDtls) = Тип("ОбъектXDTO") Тогда
							ДетальТранзакции = Транзакция.TxDtls;
						Иначе
							ДетальТранзакции = Транзакция.TxDtls[0];
						КонецЕсли;
						
						Если ДетальТранзакции.Свойства().Получить("Refs") <> Неопределено
							И ДетальТранзакции.Refs.Свойства().Получить("EndToEndId") <> Неопределено Тогда
							НовСтрока.НомерДокумента = ДетальТранзакции.Refs.EndToEndId;
						КонецЕсли;

						Если ДетальТранзакции.Свойства().Получить("RltdPties") <> Неопределено Тогда // участники платежа
							
							Плательщик = Новый Структура;
							Если ДетальТранзакции.RltdPties.Свойства().Получить("Dbtr") <> Неопределено Тогда
								
								Если ДетальТранзакции.RltdPties.Dbtr.Свойства().Получить("Nm") <> Неопределено Тогда
									Плательщик.Вставить("НаименованиеМеждународное", ДетальТранзакции.RltdPties.Dbtr.Nm);
								КонецЕсли;
								Если ДетальТранзакции.RltdPties.Dbtr.Свойства().Получить("Id") <> Неопределено
									И ДетальТранзакции.RltdPties.Dbtr.Id.Свойства().Получить("OrgId") <> Неопределено
									И ДетальТранзакции.RltdPties.Dbtr.Id.OrgId.Свойства().Получить("Othr") <> Неопределено Тогда
										Плательщик.Вставить("ИНН", ДетальТранзакции.RltdPties.Dbtr.Id.OrgId.Othr.Id);
								КонецЕсли;
									
								Если ДетальТранзакции.RltdPties.Dbtr.Свойства().Получить("CtryOfRes") <> Неопределено Тогда
									АдресСтруктурированный = Новый Структура;
									Страна = Новый Структура;
									Страна.Вставить("ISOКод", ДетальТранзакции.RltdPties.Dbtr.CtryOfRes);
									АдресСтруктурированный.Вставить("Страна", Страна);
									Плательщик.Вставить("АдресСтруктурированный", АдресСтруктурированный);
								КонецЕсли;
									
							КонецЕсли;
							
							// Счет плательщика
							Если ДетальТранзакции.RltdPties.Свойства().Получить("DbtrAcct") <> Неопределено
								И ДетальТранзакции.RltdPties.DbtrAcct.Id.Свойства().Получить("Othr") <> Неопределено Тогда
								Плательщик.Вставить("РасчСчет", ДетальТранзакции.RltdPties.DbtrAcct.Id.Othr.Id);
							КонецЕсли;
							
							// Банк плательщика
							Если Плательщик.Количество() И ДетальТранзакции.Свойства().Получить("RltdAgts") <> Неопределено
								И ДетальТранзакции.RltdAgts.Свойства().Получить("DbtrAgt") <> Неопределено Тогда
								
								Банк = Новый Структура;
								
								Если ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.Свойства().Получить("BIC") <> Неопределено Тогда
									Банк.Вставить("SWIFT", ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.BIC);
								КонецЕсли;
								
								Если ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.Свойства().Получить("Nm") <> Неопределено Тогда
									Банк.Вставить("НаименованиеМеждународное", ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.Nm);
								КонецЕсли;
								
								Если  ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.Свойства().Получить("PstlAdr") <> Неопределено
									И ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.PstlAdr.Свойства().Получить("Ctry") <> Неопределено Тогда
										Страна = Новый Структура;
										Страна.Вставить("ISOКод", ДетальТранзакции.RltdAgts.DbtrAgt.FinInstnId.PstlAdr.Ctry);
										Банк.Вставить("Страна", Страна);
								КонецЕсли;

								Если Банк.Количество() Тогда
									Плательщик.Вставить("Банк", Банк);
								КонецЕсли;
								
							КонецЕсли;

							
							Если Плательщик.Количество() Тогда
								НовСтрока.Плательщик = Плательщик;
							КонецЕсли;
							
							Получатель = Новый Структура;
							Если ДетальТранзакции.RltdPties.Свойства().Получить("Cdtr") <> Неопределено Тогда
								
								Если ДетальТранзакции.RltdPties.Cdtr.Свойства().Получить("Nm") <> Неопределено Тогда
									Получатель.Вставить("Наименование", ДетальТранзакции.RltdPties.Cdtr.Nm);
								КонецЕсли;
								Если ДетальТранзакции.RltdPties.Cdtr.Свойства().Получить("Id") <> Неопределено
									И ДетальТранзакции.RltdPties.Cdtr.Id.Свойства().Получить("OrgId") <> Неопределено
									И ДетальТранзакции.RltdPties.Cdtr.Id.OrgId.Свойства().Получить("Othr") <> Неопределено Тогда
										Получатель.Вставить("ИНН", ДетальТранзакции.RltdPties.Cdtr.Id.OrgId.Othr.Id);
								КонецЕсли;
									
								Если ДетальТранзакции.RltdPties.Cdtr.Свойства().Получить("CtryOfRes") <> Неопределено Тогда
									АдресСтруктурированный = Новый Структура;
									Страна = Новый Структура;
									Страна.Вставить("ISOКод", ДетальТранзакции.RltdPties.Cdtr.CtryOfRes);
									АдресСтруктурированный.Вставить("Страна", Страна);
									Получатель.Вставить("АдресСтруктурированный", АдресСтруктурированный);
								КонецЕсли;
								
							КонецЕсли;
							
							// Счет получателя
							Если ДетальТранзакции.RltdPties.Свойства().Получить("CdtrAcct") <> Неопределено
								И ДетальТранзакции.RltdPties.CdtrAcct.Id.Свойства().Получить("Othr") <> Неопределено Тогда
								Получатель.Вставить("РасчСчет", ДетальТранзакции.RltdPties.CdtrAcct.Id.Othr.Id);
							КонецЕсли;
							
							// Банк получателя
							Если Получатель.Количество() И ДетальТранзакции.Свойства().Получить("RltdAgts") <> Неопределено
								И ДетальТранзакции.RltdAgts.Свойства().Получить("CdtrAgt") <> Неопределено Тогда
								
								Банк = Новый Структура;
								
								Если ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.Свойства().Получить("BIC") <> Неопределено Тогда
									Банк.Вставить("SWIFT", ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.BIC);
								КонецЕсли;
								
								Если ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.Свойства().Получить("Nm") <> Неопределено Тогда
									Банк.Вставить("НаименованиеМеждународное", ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.Nm);
								КонецЕсли;
								
								Если  ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.Свойства().Получить("PstlAdr") <> Неопределено
									И ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.PstlAdr.Свойства().Получить("Ctry") <> Неопределено Тогда
										Страна = Новый Структура;
										Страна.Вставить("ISOКод", ДетальТранзакции.RltdAgts.CdtrAgt.FinInstnId.PstlAdr.Ctry);
										Банк.Вставить("Страна", Страна);
								КонецЕсли;

								Если Банк.Количество() Тогда
									Получатель.Вставить("Банк", Банк);
								КонецЕсли;
								
							КонецЕсли;
							
							Если Получатель.Количество() Тогда
								НовСтрока.Получатель = Получатель;
							КонецЕсли;
						КонецЕсли;
						
						Если ДетальТранзакции.Свойства().Получить("RmtInf") <> Неопределено Тогда // детали документа
							Если ДетальТранзакции.RmtInf.Свойства().Получить("Ustrd") <> Неопределено Тогда // назначение платежа
								Если ТипЗнч(ДетальТранзакции.RmtInf.Ustrd) = Тип("Строка") Тогда
									НазначенияПлатежа = Новый Массив;
									НазначенияПлатежа.Добавить(ДетальТранзакции.RmtInf.Ustrd);
								Иначе
									НазначенияПлатежа = ДетальТранзакции.RmtInf.Ustrd;
								КонецЕсли;
								
								НазначениеПлатежаПолное = "";
								Для Каждого НазначениеПлатежа Из НазначенияПлатежа Цикл
									НазначениеПлатежаПолное = ?(ПустаяСтрока(НазначениеПлатежаПолное), "", НазначениеПлатежаПолное + Символы.ПС);
									НазначениеПлатежаПолное = НазначениеПлатежаПолное + НазначениеПлатежа;
								КонецЦикла;
								
								НовСтрока.НазначениеПлатежа = НазначениеПлатежаПолное;
							КонецЕсли;
							Если ДетальТранзакции.RmtInf.Свойства().Получить("Strd") <> Неопределено // структурные детали
								И ДетальТранзакции.RmtInf.Strd.Свойства().Получить("RfrdDocInf") <> Неопределено
								И ДетальТранзакции.RmtInf.Strd.RfrdDocInf.Свойства().Получить("RltdDt") <> Неопределено Тогда // дата документа
									НовСтрока.ДатаДокумента = XMLЗначение(Тип("Дата"), ДетальТранзакции.RmtInf.Strd.RfrdDocInf.RltdDt);
							КонецЕсли;
						КонецЕсли;
						
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
			СтрокаВыписки.Операции = ТаблицаОпераций;
			
		КонецЕсли;
	КонецЦикла;
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаВыписок, "Выписки");
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДанных", ДеревоДанных);
	
КонецПроцедуры

Процедура ПрочитатьПлатежноеПоручениеISO(ЭД, ДеревоРазбора, НовыйЭД)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭДОбменСБанками.ПоручениеНаПереводВалюты;
	ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторДокумента", ЭД.CstmrCdtTrfInitn.GrpHdr.MsgId);
	
	МассивВыписок = Новый Массив;
	Макет = Обработки.ОбменСБанками.ПолучитьМакет("ПоручениеНаПереводВалюты");
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоДокумента(Макет);
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата", ЭД.CstmrCdtTrfInitn.GrpHdr.CreDtTm);
	
	ИнформацияОПлатеже = ЭД.CstmrCdtTrfInitn.PmtInf.Получить(0);
	
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.НаименованиеМеждународное", ИнформацияОПлатеже.Dbtr.Nm);
		
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.РасчСчет", ИнформацияОПлатеже.DbtrAcct.Id.Othr.Id);
	
	Если ИнформацияОПлатеже.Dbtr.PstlAdr <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Страна.ISOКод", ИнформацияОПлатеже.Dbtr.PstlAdr.Ctry);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Город", ИнформацияОПлатеже.Dbtr.PstlAdr.TwnNm);
		Если ИнформацияОПлатеже.Dbtr.PstlAdr.AdrLine.Количество() Тогда
			ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Адрес",
				ИнформацияОПлатеже.Dbtr.PstlAdr.AdrLine.Получить(0));
		КонецЕсли;
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлательщика.АдресСтруктурированный.Индекс", ИнформацияОПлатеже.Dbtr.PstlAdr.PstCd);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Банк.НаименованиеМеждународное", ИнформацияОПлатеже.DbtrAgt.FinInstnId.Nm);
	ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, "РеквизитыПлательщика.Банк.SWIFT", ИнформацияОПлатеже.DbtrAgt.FinInstnId.BIC);
		
	Если ИнформацияОПлатеже.DbtrAgt.FinInstnId.PstlAdr <> Неопределено
		И ИнформацияОПлатеже.DbtrAgt.FinInstnId.PstlAdr.AdrLine.Количество() Тогда
		Адрес = ИнформацияОПлатеже.DbtrAgt.FinInstnId.PstlAdr.AdrLine.Получить(0);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.Банк.Адрес", Адрес);
	КонецЕсли;
	
	РеквизитыПоКредиту = ИнформацияОПлатеже.CdtTrfTxInf.Получить(0);
	
	Если РеквизитыПоКредиту.Cdtr <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.НаименованиеМеждународное", РеквизитыПоКредиту.Cdtr.Nm);
		Если РеквизитыПоКредиту.Cdtr.PstlAdr <> Неопределено Тогда
			ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Страна.ISOКод", РеквизитыПоКредиту.Cdtr.PstlAdr.Ctry);
			ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Город", РеквизитыПоКредиту.Cdtr.PstlAdr.TwnNm);
			Если РеквизитыПоКредиту.Cdtr.PstlAdr.AdrLine.Количество() Тогда
				ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Адрес",
					РеквизитыПоКредиту.Cdtr.PstlAdr.AdrLine.Получить(0));
			КонецЕсли;
			ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.АдресСтруктурированный.Индекс", РеквизитыПоКредиту.Cdtr.PstlAdr.PstCd);
		КонецЕсли;
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер", РеквизитыПоКредиту.PmtId.EndToEndId);
	КонецЕсли;
	
	Если РеквизитыПоКредиту.CdtrAgt <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.Банк.НаименованиеМеждународное", РеквизитыПоКредиту.CdtrAgt.FinInstnId.Nm);
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.Банк.SWIFT", РеквизитыПоКредиту.CdtrAgt.FinInstnId.BIC);
		Если РеквизитыПоКредиту.CdtrAgt.FinInstnId.PstlAdr <> Неопределено Тогда
			ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.Страна.ISOКод", РеквизитыПоКредиту.CdtrAgt.FinInstnId.PstlAdr.Ctry);
			Если РеквизитыПоКредиту.CdtrAgt.FinInstnId.PstlAdr.AdrLine.Количество() Тогда
				Адрес = РеквизитыПоКредиту.CdtrAgt.FinInstnId.PstlAdr.AdrLine.Получить(0);
				ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПолучателя.Банк.Адрес", Адрес);
			КонецЕсли;
		КонецЕсли;
		Если РеквизитыПоКредиту.CdtrAgt.FinInstnId.ClrSysMmbId <> Неопределено Тогда
			ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, "РеквизитыПолучателя.Банк.БИК", РеквизитыПоКредиту.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId);
		КонецЕсли;
	КонецЕсли;
	
	Если РеквизитыПоКредиту.CdtrAcct <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПолучателя.РасчСчет", РеквизитыПоКредиту.CdtrAcct.Id.Othr.Id);
	КонецЕсли;
	
	Если РеквизитыПоКредиту.IntrmyAgt1 <> Неопределено Тогда
		ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.SWIFT", РеквизитыПоКредиту.IntrmyAgt1.FinInstnId.BIC);
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлательщика.БанкПосредник.НаименованиеМеждународное",
			РеквизитыПоКредиту.IntrmyAgt1.FinInstnId.Nm);
	КонецЕсли;
	
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаПеревода.ISOКодВалюты", РеквизитыПоКредиту.Amt.InstdAmt.Ccy);
	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаПеревода.Сумма", РеквизитыПоКредиту.Amt.InstdAmt.__content);

	Если РеквизитыПоКредиту.RgltryRptg.Количество() Тогда
		Транзакция = РеквизитыПоКредиту.RgltryRptg.Получить(0);
		Если Транзакция.Dtls.Количество() Тогда
			ТаблицаКодовВидовОпераций = Новый ТаблицаЗначений;
			ТаблицаКодовВидовОпераций.Колонки.Добавить("КодВидаВалютнойОперации");
			ТаблицаКодовВидовОпераций.Колонки.Добавить("Сумма");
			ТаблицаКодовВидовОпераций.Колонки.Добавить("ISOКодВалюты");
			ТаблицаКодовВидовОпераций.Колонки.Добавить("НомерПаспортаСделки");
			Для Каждого КодВидаОперации Из Транзакция.Dtls Цикл
				СтрокаТаблицы = ТаблицаКодовВидовОпераций.Добавить();
				СтрокаТаблицы.КодВидаВалютнойОперации = КодВидаОперации.Cd;
				Если КодВидаОперации.Amt <> Неопределено Тогда
					СтрокаТаблицы.Сумма = КодВидаОперации.Amt.__content;
					СтрокаТаблицы.ISOКодВалюты = КодВидаОперации.Amt.Ccy;
				КонецЕсли;
				Если КодВидаОперации.Inf.Количество() Тогда
					СтрокаТаблицы.НомерПаспортаСделки = КодВидаОперации.Inf.Получить(0);
				КонецЕсли;
			КонецЦикла;
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(
				ДеревоДанных, ТаблицаКодовВидовОпераций, "КодыВидовВалютныхОпераций");
		КонецЕсли;
	КонецЕсли;
	
	Если РеквизитыПоКредиту.RmtInf <> Неопределено И РеквизитыПоКредиту.RmtInf.Ustrd <> Неопределено Тогда
		НазначениеПлатежа = "";
		Для Каждого СтрокаНазначения Из РеквизитыПоКредиту.RmtInf.Ustrd Цикл
			НазначениеПлатежа = НазначениеПлатежа + СтрокаНазначения + Символы.ПС;
		КонецЦикла;
		ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.НазначениеПлатежа", НазначениеПлатежа);
	КонецЕсли;
	
	ТипКомиссии = ИнформацияОПлатеже.ChrgBr;
	
	Если ТипКомиссии = "CRED" Тогда
		ТипКомиссии = "BEN";
	ИначеЕсли ТипКомиссии = "DEBT" Тогда
		ТипКомиссии = "OUR";
	ИначеЕсли ТипКомиссии = "SHAR" Тогда
		ТипКомиссии = "SHA";
	КонецЕсли;

	ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПлатежа.ТипКомиссии", ТипКомиссии);
	
	ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДанных", ДеревоДанных);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
