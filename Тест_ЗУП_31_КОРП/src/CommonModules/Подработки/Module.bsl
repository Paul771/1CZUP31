////////////////////////////////////////////////////////////////////////////////
// Подсистема подработок (кратковременных трудовых соглашений сотрудников).
// 
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

// Прекращает все действующие подработки сотрудников.
//
// Параметры:
// 	Регистратор - ДокументСсылка - документ, регистрирующий увольнение.
// Движения		- Коллекция движенний
// 	Сотрудники - ТаблицаЗначений
//					* Сотрудник - СправочникСсылка.Сотрудники - увольняемый основной сотрудник.
// 					* ДатаУвольнения - Дата - дата увольнения основного сотрудника.
//
Процедура ПрекратитьПодработкиСотрудников(Регистратор, Движения, Сотрудники) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Сотрудники", Сотрудники);
	
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Сотрудники.Сотрудник КАК Сотрудник,
		|	Сотрудники.ДатаУвольнения КАК ДатаУвольнения
		|ПОМЕСТИТЬ ВТГоловныеСотрудники
		|ИЗ
		|	&Сотрудники КАК Сотрудники
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Сотрудники.Ссылка КАК Сотрудник,
		|	ДОБАВИТЬКДАТЕ(ГоловныеСотрудники.ДатаУвольнения, ДЕНЬ, 1) КАК НачалоПериода,
		|	ДОБАВИТЬКДАТЕ(ГоловныеСотрудники.ДатаУвольнения, ДЕНЬ, 1) КАК ОкончаниеПериода
		|ПОМЕСТИТЬ ВТСотрудникиПериоды
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТГоловныеСотрудники КАК ГоловныеСотрудники
		|		ПО Сотрудники.ГоловнойСотрудник = ГоловныеСотрудники.Сотрудник";
		
	Запрос.Выполнить();
	
	ПрекратитьПодработкиСотрудниковПоВременнойТаблице(Регистратор, Движения, Запрос.МенеджерВременныхТаблиц);
	
КонецПроцедуры

Процедура ПрекратитьПодработкиСотрудниковПоВременнойТаблице(Регистратор, Движения, МенеджерВременныхТаблиц) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	ПараметрыПолученияПодработок = КадровыйУчет.ПараметрыДляЗапросВТРабочиеМестаСотрудниковПоВременнойТаблице();
	
	ПараметрыПолученияПодработок.РаботникиПоТрудовымДоговорам = Истина;
	ПараметрыПолученияПодработок.ПодработкиРаботниковПоТрудовымДоговорам = Истина;
	ПараметрыПолученияПодработок.РаботникиПоДоговорамГПХ = Ложь;
	
	КадровыйУчет.СоздатьВТРабочиеМестаСотрудниковПоВременнойТаблице(Запрос.МенеджерВременныхТаблиц, Истина, ПараметрыПолученияПодработок);
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	*,
		|	ДОБАВИТЬКДАТЕ(СотрудникиПериоды.ОкончаниеПериода, ДЕНЬ, -1) КАК ДатаУвольнения
		|
		|ИЗ
		|	ВТРабочиеМестаСотрудников КАК РабочиеМестаСотрудников
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСотрудникиПериоды КАК СотрудникиПериоды
		|		ПО РабочиеМестаСотрудников.Сотрудник = СотрудникиПериоды.Сотрудник
		|ГДЕ
		|	РабочиеМестаСотрудников.ГоловнойСотрудник <> РабочиеМестаСотрудников.Сотрудник";
	
	ПодработкиСотрудника = Запрос.Выполнить().Выгрузить();
	
	Если ПодработкиСотрудника.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	КадровыеСобытия =  Неопределено;
	Для Каждого Подработка Из ПодработкиСотрудника Цикл
		
		Если КадровыеСобытия = Неопределено Тогда
			КадровыеСобытия = Документы.ПрекращениеПодработки.КадровыеСобытияУвольнение(Подработка.Сотрудник, Подработка.ДатаУвольнения, Подработка.ФизическоеЛицо);
			Продолжить;
		КонецЕсли;
		
		КадровоеСобытие = Документы.ПрекращениеПодработки.КадровыеСобытияУвольнение(Подработка.Сотрудник, Подработка.ДатаУвольнения, Подработка.ФизическоеЛицо);
		ЗаполнитьЗначенияСвойств(КадровыеСобытия.Добавить(), КадровоеСобытие[0]);
	
	КонецЦикла;
	
	КадровыйУчет.СформироватьКадровыеДвижения(Регистратор, Движения, КадровыеСобытия);
	
	Для Каждого Подработка Из ПодработкиСотрудника Цикл
		
		// Прекращаем плановые начисления и удержания.
		РасчетЗарплатыРасширенный.ПрекратитьВсеПлановыеНачисленияУдержания(Движения, Подработка.Сотрудник, КонецДня(Подработка.ДатаУвольнения) + 1, Подработка.Организация, Ложь);
		
		// Регистрируем состояние
		СостоянияСотрудников.ЗарегистрироватьСостояниеСотрудника(Движения, Регистратор, Подработка.Сотрудник, Перечисления.СостоянияСотрудника.Увольнение, КонецДня(Подработка.ДатаУвольнения) + 1);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьДанныеДляРегистрацииПрекращенияПодработок(ДанныеДляПроведения, ДокументСсылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Увольнение.Сотрудник,
		|	Увольнение.ДатаУвольнения
		|ИЗ
		|	Документ.Увольнение КАК Увольнение
		|ГДЕ
		|	Увольнение.Ссылка = &Ссылка";
	
	Если ТипЗнч(ДокументСсылка) <> Тип("ДокументСсылка.Увольнение") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ.Увольнение", "Документ.УвольнениеСписком.Сотрудники");
	КонецЕсли;
	
	ДанныеДляПроведения.Вставить("ДанныеДляРегистрацииПрекращенияПодработок", Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры

#Область НастройкиВариантовОтчетов

// Содержит настройки размещения вариантов отчетов в панели отчетов.
// Описание см. ЗарплатаКадрыВариантыОтчетов.НастроитьВариантыОтчетов.
//
Процедура НастроитьВариантыОтчетов(Настройки) Экспорт
	
	ВариантыОтчетов.НастроитьОтчетВМодулеМенеджера(Настройки, Метаданные.Отчеты.Подработки);

КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Определяет объекты, в которых есть процедура ДобавитьКомандыПечати().
// Подробнее см. УправлениеПечатьюПереопределяемый.
//
// Параметры:
//  СписокОбъектов - Массив - список менеджеров объектов.
//
Процедура ПриОпределенииОбъектовСКомандамиПечати(СписокОбъектов) Экспорт
	
	СписокОбъектов.Добавить(Документы.НазначениеПодработки);
	СписокОбъектов.Добавить(Документы.ПрекращениеПодработки); 
	
КонецПроцедуры

Процедура ПроверкаЗаполненияДокументаНачальнаяШтатнаяРасстановка(Объект, Отказ, ПроверяемыеРеквизиты) Экспорт
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПодработки") Тогда
		Возврат;
	КонецЕсли;
	
	СтрокиПодработок = Объект.Сотрудники.НайтиСтроки(Новый Структура("ВидЗанятости", Перечисления.ВидыЗанятости.Подработка));
	Если СтрокиПодработок.Количество() > 0 Тогда
		ВызватьИсключение НСтр("ru='Для регистрации данных по подработкам необходимо включить настройку кадрового учета ""Использовать подработки""'");
	КонецЕсли; 
	
КонецПроцедуры


#Область ДатыЗапретаИзменения

Процедура ЗаполнитьИсточникиДанныхДляПроверкиЗапретаИзменения(ИсточникиДанных) Экспорт
	
	ДатыЗапретаИзменения.ДобавитьСтроку(ИсточникиДанных, "Документ.НазначениеПодработки", "Дата", "Зарплата", "Организация");
	ДатыЗапретаИзменения.ДобавитьСтроку(ИсточникиДанных, "Документ.ПрекращениеПодработки", "Дата", "Зарплата", "Организация");
	
КонецПроцедуры

#КонецОбласти

#Область МногофункциональныеДокументы

Функция ТипыМногофункциональныхДокументов() Экспорт 
	
	МногофункциональныеДокументы = Новый Соответствие;
	
	ОписаниеДокумента = ЗарплатаКадрыРасширенныйКлиентСервер.ОписаниеМногофункциональногоДокумента();
	ОписаниеДокумента.РеквизитСостояние = "Утверждено";
	ОписаниеДокумента.ВторойОтветственный = Неопределено;
	ОписаниеДокумента.ВидУчета = "ПлановыеНачисления";
	ОписаниеДокумента.СообщениеДокументНеУтвержден = НСтр("ru = '%1 - документ не утвержден.'");
	
	МногофункциональныеДокументы.Вставить(Тип("ДокументСсылка.НазначениеПодработки"), ОписаниеДокумента);
		
	Возврат МногофункциональныеДокументы;
	
КонецФункции
	
#КонецОбласти

#КонецОбласти