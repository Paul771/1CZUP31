
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// СтандартныеПодсистемы.ВерсионированиеОбъектов

// Определяет настройки объекта для подсистемы ВерсионированиеОбъектов.
//
// Параметры:
//  Настройки - Структура - настройки подсистемы.
Процедура ПриОпределенииНастроекВерсионированияОбъектов(Настройки) Экспорт

КонецПроцедуры

// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Возвращает описание состава документа
//
// Возвращаемое значение:
//  Структура - см. ЗарплатаКадрыСоставДокументов.НовоеОписаниеСоставаДокумента.
Функция ОписаниеСоставаДокумента() Экспорт
	
	МетаданныеДокумента = Метаданные.Документы.СправкиНДФЛДляПередачиВНалоговыйОрган;
	Возврат ЗарплатаКадрыСоставДокументов.ОписаниеСоставаДокументаПоМетаданнымФизическиеЛицаВТабличныхЧастях(МетаданныеДокумента);
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьСоответствиеПроверяемыхРеквизитовОткрываемымОбъектам(ДокументСсылка, ДанныеДляПроверки) Экспорт
	Возврат Новый Структура;
КонецФункции	

Функция ПолучитьСоответствиеРеквизитовПутиВФормеОбъекта() Экспорт
	Возврат УчетНДФЛ.ПолучитьСоответствиеРеквизитовПутиВФормеОбъекта();		
КонецФункции

Функция ПолучитьСоответствиеРеквизитовФормеОбъекта(ДанныеДляПроверки) Экспорт
	Возврат УчетНДФЛ.ПолучитьСоответствиеРеквизитовФормеОбъекта();	
КонецФункции

Функция ПолучитьПредставленияПроверяемыхРеквизитов() Экспорт
	Возврат УчетНДФЛ.ПолучитьПредставлениеПроверяемыхРеквизитовФизическихЛиц();	
КонецФункции	

Функция ПолучитьСтруктуруПроверяемыхДанных() Экспорт
	Возврат УчетНДФЛ.ПолучитьСтруктуруПроверяемыхДанныхФизическихЛиц();	
КонецФункции	

Функция ИмяФайла2НДФЛ(ДатаСоставления, ЭтоЮрЛицо, Знач КодНалоговогоОрганаПолучателя, КодНалоговогоОргана, ИНН, КПП, ИдентификаторФайла) Экспорт
	
	Возврат "NO_NDFL2"
			+ "_" + ?(ПустаяСтрока(КодНалоговогоОрганаПолучателя), КодНалоговогоОргана, КодНалоговогоОрганаПолучателя)
			+ "_" + КодНалоговогоОргана
			+ "_" + ?(ЭтоЮрЛицо, СокрЛП(ИНН) + СокрЛП(КПП), СокрЛП(ИНН))
			+ "_" + Формат(ДатаСоставления, "ДФ=ггггММдд")
			+ "_" + ИдентификаторФайла;

КонецФункции

Функция ПолучитьТаблицыДанныхДокументаДляПечати(Ссылка)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Ссылка КАК Ссылка,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.НомерСтроки,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Сотрудник,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИНН,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.НомерСправки,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Фамилия,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Имя,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Отчество,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Адрес,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ВидДокумента,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.СерияДокумента,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.НомерДокумента,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Гражданство,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИННвСтранеГражданства,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ДатаРождения,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.СтатусНалогоплательщика,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке9 КАК ПереданоНаВзыскание,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.АдресЗарубежом,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке5,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке9,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке10,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке13,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке35,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке30,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке15,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке3,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке6,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке7,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОбщаяСуммаДоходаПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ОблагаемаяСуммаДоходаПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИсчисленоПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.УдержаноПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗадолженностьПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ИзлишнеУдержаноПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ПеречисленоПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ЗачтеноАвансовыхПлатежейПоСтавке12,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.НомерУведомленияАвансовыеПлатежи,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.ДатаУведомленияАвансовыеПлатежи,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.КодНалоговогоОрганаУведомленияАвансовыеПлатежи
	|ИЗ
	|	Документ.СправкиНДФЛДляПередачиВНалоговыйОрган.Сотрудники КАК СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники
	|ГДЕ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСотрудники.Ссылка В(&Ссылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.Ссылка КАК Ссылка,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.НомерСтроки,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.Сотрудник,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.МесяцНалоговогоПериода,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.КодДохода,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.СуммаДохода,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.КодВычета,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.СуммаВычета,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.НомерСправки,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.Ставка
	|ИЗ
	|	Документ.СправкиНДФЛДляПередачиВНалоговыйОрган.СведенияОДоходах КАК СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах
	|ГДЕ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОДоходах.Ссылка В(&Ссылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.Ссылка КАК Ссылка,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.НомерСтроки,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.Сотрудник,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.КодВычета,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.СуммаВычета,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.НомерСправки
	|ИЗ
	|	Документ.СправкиНДФЛДляПередачиВНалоговыйОрган.СведенияОВычетах КАК СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах
	|ГДЕ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганСведенияОВычетах.Ссылка В(&Ссылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.Ссылка КАК Ссылка,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.НомерСтроки,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.Сотрудник,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.ДатаУведомления,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.НомерУведомления,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.КодНалоговогоОрганаУведомления,
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.ГруппаВычета
	|ИЗ
	|	Документ.СправкиНДФЛДляПередачиВНалоговыйОрган.УведомленияНОоПравеНаВычеты КАК СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты
	|ГДЕ
	|	СправкиНДФЛДляПередачиВНалоговыйОрганУведомленияНОоПравеНаВычеты.Ссылка В(&Ссылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка";
	
	Результаты = Запрос.ВыполнитьПакет();
	
	Возврат Новый Структура("Сотрудники, СведенияОДоходах, СведенияОВычетах, СведенияОбУведомлениях", Результаты[0].Выгрузить(), Результаты[1].Выгрузить(), Результаты[2].Выгрузить(), Результаты[3].Выгрузить());
	
КонецФункции

Функция НомерПервойСправки(Дата, НалоговыйПериод, Организация) Экспорт
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаДокумента", Дата);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("НалоговыйПериод", НалоговыйПериод);
	Запрос.Текст =  
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(СведенияОДоходахФизлицРаботникиОрганизации.НомерСтроки) КАК КоличествоСформированныхСправок
	|ИЗ
	|	Документ.СправкиНДФЛДляПередачиВНалоговыйОрган.Сотрудники КАК СведенияОДоходахФизлицРаботникиОрганизации
	|ГДЕ
	|	СведенияОДоходахФизлицРаботникиОрганизации.Ссылка.Дата < &ДатаДокумента
	|	И СведенияОДоходахФизлицРаботникиОрганизации.Ссылка.Проведен
	|	И СведенияОДоходахФизлицРаботникиОрганизации.Ссылка.Организация = &Организация
	|	И СведенияОДоходахФизлицРаботникиОрганизации.Ссылка.НалоговыйПериод = &НалоговыйПериод";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		НомерПервойСправки = ?(Выборка.КоличествоСформированныхСправок = NULL, 0, Выборка.КоличествоСформированныхСправок) + 1;
	Иначе	
		НомерПервойСправки = 1;
	КонецЕсли;  
	
	Возврат НомерПервойСправки;	
КонецФункции	

// Возвращает номер пачки документа
Функция НомерПачкиДокумента(Знач НомерДокумента) Экспорт
	
	НомерПачки = "";
	
	НомерДокумента = СокрП(НомерДокумента);
	
	// Возьмем все цифры в правой части номера
	ДлинаНомера = СтрДлина(НомерДокумента);
	Для НомерСимвола = 1 По ДлинаНомера Цикл
		Символ = Сред(НомерДокумента, ДлинаНомера- НомерСимвола+ 1, 1); 	
		Если (Символ>="0") И (Символ<="9") Тогда
			НомерПачки = Символ+НомерПачки;
		Иначе
			Прервать;
		КонецЕсли;	 
	КонецЦикла;	
	
	Если НомерПачки <> "" Тогда
		Возврат Формат(Число(Прав(НомерПачки, 5)), "ЧГ=0"); 
	Иначе
		Возврат "";
	КонецЕсли;
	
КонецФункции	 

#КонецОбласти

#Область ПроцедурыИФункцииПечати

// Заполняет список команд печати.
// 
// Параметры:
//   КомандыПечати - ТаблицаЗначений - состав полей см. в функции УправлениеПечатью.СоздатьКоллекциюКомандПечати.
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт

	// Справка о доходах (2-НДФЛ)
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Обработчик = "ЗарплатаКадрыКлиент.ВыполнитьКомандуПечати";
	КомандаПечати.Идентификатор = "Форма2НДФЛ";
	КомандаПечати.Представление = НСтр("ru = 'Справка о доходах (2-НДФЛ)'");
	КомандаПечати.Порядок = 10;
	КомандаПечати.ПроверкаПроведенияПередПечатью = Ложь;

	// Реестр
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Обработчик = "ЗарплатаКадрыКлиент.ВыполнитьКомандуПечати";
	КомандаПечати.Идентификатор = "Реестр2014";
	КомандаПечати.Представление = НСтр("ru = 'Реестр с 2014 г.'");
	КомандаПечати.Порядок = 20;
	КомандаПечати.ПроверкаПроведенияПередПечатью = Ложь;

	// Реестр 2014 (дополнительный)
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Обработчик = "ЗарплатаКадрыКлиент.ВыполнитьКомандуПечати";
	КомандаПечати.Идентификатор = "Реестр2014Дополнительный";
	КомандаПечати.Представление = НСтр("ru = 'Реестр (дополнительный с 2014 г.)'");
	КомандаПечати.Порядок = 30;
	КомандаПечати.ПроверкаПроведенияПередПечатью = Ложь;
	
	// Реестр
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Обработчик = "ЗарплатаКадрыКлиент.ВыполнитьКомандуПечати";
	КомандаПечати.Идентификатор = "Реестр2011";
	КомандаПечати.Представление = НСтр("ru = 'Реестр с 2011 г.'");
	КомандаПечати.Порядок = 40;
	КомандаПечати.ПроверкаПроведенияПередПечатью = Ложь;

	// Реестр (дополнительный)
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Обработчик = "ЗарплатаКадрыКлиент.ВыполнитьКомандуПечати";
	КомандаПечати.Идентификатор = "Реестр2011Дополнительный";
	КомандаПечати.Представление = НСтр("ru = 'Реестр (дополнительный с 2011 г.)'");
	КомандаПечати.Порядок = 50;
	КомандаПечати.ПроверкаПроведенияПередПечатью = Ложь;


КонецПроцедуры

Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Форма2НДФЛ") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Форма2НДФЛ", "Форма 2НДФЛ", СформироватьПечатнуюФорму2НДФЛ(МассивОбъектов, ОбъектыПечати));	
	КонецЕсли;
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Реестр2011") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Реестр2011", "Реестр", ПечатьРеестра(МассивОбъектов, ОбъектыПечати, "ПФ_MXL_Реестр2011"));	
	КонецЕсли;
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Реестр2011Дополнительный") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Реестр2011Дополнительный", "Реестр (дополнительный с 2011 г.)", ПечатьРеестра(МассивОбъектов, ОбъектыПечати, "ПФ_MXL_Реестр2011Дополнительный"));	
	КонецЕсли;
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Реестр2014") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Реестр2014", "Реестр", ПечатьРеестра(МассивОбъектов, ОбъектыПечати, "ПФ_MXL_Реестр2014"));	
	КонецЕсли;
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Реестр2014Дополнительный") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Реестр2014Дополнительный", "Реестр (дополнительный с 2014 г.)", ПечатьРеестра(МассивОбъектов, ОбъектыПечати, "ПФ_MXL_Реестр2014Дополнительный"));	
	КонецЕсли;
КонецПроцедуры	

Функция СформироватьПечатнуюФорму2НДФЛ(МассивОбъектов, ОбъектыПечати)
	
	ДанныеНА = УчетНДФЛ.СправкиНДФЛДанныеДляПечати(МассивОбъектов);
	ТаблицыДокумента = ПолучитьТаблицыДанныхДокументаДляПечати(МассивОбъектов);
	
	Возврат УчетНДФЛ.СформироватьПечатнуюФорму2НДФЛ(ОбъектыПечати, МассивОбъектов, ДанныеНА, ТаблицыДокумента.Сотрудники, ТаблицыДокумента.СведенияОДоходах, ТаблицыДокумента.СведенияОВычетах, ТаблицыДокумента.СведенияОбУведомлениях);
	
КонецФункции

Функция СформироватьЗапросПоСотрудникамДляПечатиРеестра(МассивОбъектов)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке13 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке30 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке9 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке15 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке35 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке3 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке5 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке6 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке7 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке10 + СправкиСотрудников.ОбщаяСуммаДоходаПоСтавке12 КАК ОбщаяСуммаДохода,
	|	СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке13 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке30 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке9 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке15 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке35 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке3 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке5 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке6 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке7 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке10 + СправкиСотрудников.ОблагаемаяСуммаДоходаПоСтавке12 КАК ОблагаемаяСуммаДохода,
	|	СправкиСотрудников.ИсчисленоПоСтавке13 + СправкиСотрудников.ИсчисленоПоСтавке30 + СправкиСотрудников.ИсчисленоПоСтавке9 + СправкиСотрудников.ИсчисленоПоСтавке15 + СправкиСотрудников.ИсчисленоПоСтавке35 + СправкиСотрудников.ИсчисленоПоСтавке3 + СправкиСотрудников.ИсчисленоПоСтавке5 + СправкиСотрудников.ИсчисленоПоСтавке6 + СправкиСотрудников.ИсчисленоПоСтавке7 + СправкиСотрудников.ИсчисленоПоСтавке10 + СправкиСотрудников.ИсчисленоПоСтавке12 КАК Исчислено,
	|	СправкиСотрудников.УдержаноПоСтавке13 + СправкиСотрудников.УдержаноПоСтавке30 + СправкиСотрудников.УдержаноПоСтавке9 + СправкиСотрудников.УдержаноПоСтавке15 + СправкиСотрудников.УдержаноПоСтавке35 + СправкиСотрудников.УдержаноПоСтавке3 + СправкиСотрудников.УдержаноПоСтавке5 + СправкиСотрудников.УдержаноПоСтавке6 + СправкиСотрудников.УдержаноПоСтавке7 + СправкиСотрудников.УдержаноПоСтавке10 + СправкиСотрудников.УдержаноПоСтавке12 КАК Удержано,
	|	СправкиСотрудников.ПеречисленоПоСтавке13 + СправкиСотрудников.ПеречисленоПоСтавке30 + СправкиСотрудников.ПеречисленоПоСтавке9 + СправкиСотрудников.ПеречисленоПоСтавке15 + СправкиСотрудников.ПеречисленоПоСтавке35 + СправкиСотрудников.ПеречисленоПоСтавке3 + СправкиСотрудников.ПеречисленоПоСтавке5 + СправкиСотрудников.ПеречисленоПоСтавке6 + СправкиСотрудников.ПеречисленоПоСтавке7 + СправкиСотрудников.ПеречисленоПоСтавке10 + СправкиСотрудников.ПеречисленоПоСтавке12 КАК Перечислено,
	|	СправкиСотрудников.ИзлишнеУдержаноПоСтавке13 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке30 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке9 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке15 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке35 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке3 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке5 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке6 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке7 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке10 + СправкиСотрудников.ИзлишнеУдержаноПоСтавке12 КАК ИзлишнеУдержано,
	|	СправкиСотрудников.ЗадолженностьПоСтавке13 + СправкиСотрудников.ЗадолженностьПоСтавке30 + СправкиСотрудников.ЗадолженностьПоСтавке9 + СправкиСотрудников.ЗадолженностьПоСтавке15 + СправкиСотрудников.ЗадолженностьПоСтавке35 + СправкиСотрудников.ЗадолженностьПоСтавке3 + СправкиСотрудников.ЗадолженностьПоСтавке5 + СправкиСотрудников.ЗадолженностьПоСтавке6 + СправкиСотрудников.ЗадолженностьПоСтавке7 + СправкиСотрудников.ЗадолженностьПоСтавке10 + СправкиСотрудников.ЗадолженностьПоСтавке12 КАК Задолженность,
	|	СправкиСотрудников.Сотрудник КАК Сотрудник,
	|	СправкиСотрудников.Фамилия,
	|	СправкиСотрудников.Имя,
	|	СправкиСотрудников.Отчество,
	|	СправкиСотрудников.ДатаРождения,
	|	СправкиСотрудников.НомерСправки КАК НомерСправки,
	|	СправкиСотрудников.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.СправкиНДФЛДляПередачиВНалоговыйОрган.Сотрудники КАК СправкиСотрудников
	|ГДЕ
	|	СправкиСотрудников.Ссылка В(&МассивОбъектов)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка,
	|	НомерСправки,
	|	Сотрудник";
	
	Возврат Запрос.Выполнить();
	
КонецФункции

// Формирует печатную форму - реестр справок о доходах
//
Функция ПечатьРеестра(МассивОбъектов, ОбъектыПечати, ИмяМакета = "ПФ_MXL_Реестр")
	
	ДанныеДокументов = УчетНДФЛ.СправкиНДФЛДанныеДляПечати(МассивОбъектов, Истина);
	
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.КлючПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_РеестрСправок2_НДФЛ";
	ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	
	ПервыйДокумент = Истина;
	
	Для Каждого СтруктураДанныхДокумента Из ДанныеДокументов Цикл
		
		ДанныеДокумента = СтруктураДанныхДокумента.Значение;
		
		// Документы нужно выводить на разных страницах.
		Если Не ПервыйДокумент Тогда
			ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;
		ПервыйДокумент = Ложь;
		
		// Запомним номер строки, с которой начали выводить текущий документ.
		НомерСтрокиНачало = ТабДокумент.ВысотаТаблицы + 1;
		
		СтруктураЗаголовка = Новый Структура("ИНН, НаименованиеПолное, КодНалоговогоОргана", ДанныеДокумента.ИННорг, ДанныеДокумента.НаименованиеПолное, ДанныеДокумента.КодНалоговогоОргана);
		
		СтруктураЗаголовка.Вставить("ОбщаяСуммаДохода", ДанныеДокумента.ОбщаяСуммаДохода);
		СтруктураЗаголовка.Вставить("Исчислено", ДанныеДокумента.Исчислено);
		СтруктураЗаголовка.Вставить("Удержано", ДанныеДокумента.Удержано);
		СтруктураЗаголовка.Вставить("Перечислено", ДанныеДокумента.Перечислено);
		
		СтруктураЗаголовка.Вставить("РуководительРасшифровкаПодписи", ДанныеДокумента.ФИОПодписавшего);
		Если ДанныеДокумента.ЭтоЮрЛицо Тогда
			СтруктураЗаголовка.Вставить("Разделитель", "/");
		Иначе
			СтруктураЗаголовка.Вставить("Разделитель", "");
		КонецЕсли;
		
		СтруктураЗаголовка.Вставить("Год", Формат(ДанныеДокумента.НалоговыйПериод,"ЧЦ=4; ЧДЦ=0; ЧГ=0"));
		СтруктураЗаголовка.Вставить("ДатаСоставления", Формат(ДанныеДокумента.Дата, "ДЛФ=D"));
		СтруктураЗаголовка.Вставить("НомерРеестра", НомерПачкиДокумента(ДанныеДокумента.Номер));
		СтруктураЗаголовка.Вставить("Признак", ДанныеДокумента.Признак);
		СтруктураЗаголовка.Вставить("ИмяФайла", ИмяФайла2НДФЛ(ДанныеДокумента.Дата, ДанныеДокумента.ЭтоЮрЛицо, ДанныеДокумента.КодНалоговогоОрганаПолучателя, ДанныеДокумента.КодНалоговогоОргана, ДанныеДокумента.ИННОрг, ДанныеДокумента.КПП, ДанныеДокумента.ИдентификаторФайла));
		СтруктураЗаголовка.Вставить("ОКАТО", ДанныеДокумента.ОКАТО);
		СтруктураЗаголовка.Вставить("ОКТМО", ДанныеДокумента.ОКТМО);
		СтруктураЗаголовка.Вставить("КПП", ДанныеДокумента.КПП);
		СтруктураЗаголовка.Вставить("КоличествоСправок", Формат(ДанныеДокумента.КоличествоСправок,"ЧЦ=4; ЧДЦ=0; ЧГ=0"));
		
		// запоминаем области макета
		Макет = УправлениеПечатью.МакетПечатнойФормы("Документ.СправкиНДФЛДляПередачиВНалоговыйОрган." + ИмяМакета);
		ОбластьМакетаШапка	= Макет.ПолучитьОбласть("Шапка"); // Шапка документа.
		ОбластьМакетаПодвал	= Макет.ПолучитьОбласть("Подвал");// Подвал документа
		ОбластьМакета 		= Макет.ПолучитьОбласть("Строка"); // область сотрудника
		
		ОбластьМакетаШапка.Параметры.Заполнить(СтруктураЗаголовка); // Шапка документа.
		
		// Начинаем формировать выходной документ
		ТабДокумент.Вывести(ОбластьМакетаШапка); // Шапка документа.
		
		ДанныеСотрудников = СформироватьЗапросПоСотрудникамДляПечатиРеестра(МассивОбъектов).Выбрать();
		
		Если ДанныеСотрудников.НайтиСледующий(Новый Структура("Ссылка", СтруктураДанныхДокумента.Ключ)) Тогда
			
			Пока ДанныеСотрудников.СледующийПоЗначениюПоля("НомерСправки") Цикл
				ОбластьМакета.Параметры.Заполнить(ДанныеСотрудников);
				ТабДокумент.Вывести(ОбластьМакета);
			КонецЦикла;
			
		КонецЕсли;
		
		ОбластьМакетаПодвал.Параметры.Заполнить(СтруктураЗаголовка);
		
		// выводим предварительно подготовленный Подвал документа.
		ТабДокумент.Вывести(ОбластьМакетаПодвал);
		ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		
		// В табличном документе необходимо задать имя области, в которую был 
		// выведен объект. Нужно для возможности печати покомплектно.
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабДокумент, НомерСтрокиНачало, ОбъектыПечати, СтруктураДанныхДокумента.Ключ);
		
	КонецЦикла;
	
	Возврат ТабДокумент;
	
КонецФункции

#КонецОбласти

#КонецЕсли